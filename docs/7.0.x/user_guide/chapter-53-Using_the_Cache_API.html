<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="generator" content="Asciidoctor 0.1.4"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>The Cache APIs</title> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style> <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css"> <style>
/* Foundation stylesheet for CodeRay (to match GitHub theme) | MIT License | http://foundation.zurb.com */
table.CodeRay { border-collapse: collapse; padding: 2px; margin-bottom: 0; border: 0; background: transparent; }
table.CodeRay td { padding: 0 .5em; vertical-align: top; }
table.CodeRay td.line-numbers { text-align: right; color: #999; border-right: 1px solid #e5e5e5; padding-left: 0; }
span.line-numbers { border-right: 1px solid #E5E5E5; color: #999; display: inline-block; margin-right: 0.5em; padding-right: 0.5em; }
.CodeRay td.line-numbers strong, .CodeRay span.line-numbers strong { font-weight: normal; }
.CodeRay .debug { color: white !important; background: blue !important; }
.CodeRay .annotation { color: #007; }
.CodeRay .attribute-name { color: #f08; }
.CodeRay .attribute-value { color: #700; }
.CodeRay .binary { color: #509; }
.CodeRay .comment  { color: #999; font-style: italic; }
.CodeRay .char { color: #04D; }
.CodeRay .char .content { color: #04D; }
.CodeRay .char .delimiter { color: #039; }
.CodeRay .class { color: #458; }
.CodeRay .complex { color: #A08; }
.CodeRay .constant { color: teal; }
.CodeRay .color { color: #0A0; }
.CodeRay .class-variable { color: #369; }
.CodeRay .decorator { color: #B0B; }
.CodeRay .definition { color: #099; }
.CodeRay .directive { color: #088; }
.CodeRay .delimiter { color: black; }
.CodeRay .doc { color: #970; }
.CodeRay .doctype { color: #34b; }
.CodeRay .doc-string { color: #D42; }
.CodeRay .escape  { color: #666; }
.CodeRay .entity { color: #800; }
.CodeRay .error { color: #808; }
.CodeRay .exception { color: #C00; }
.CodeRay .filename { color: #099; }
.CodeRay .function { color: #900; }
.CodeRay .global-variable { color: teal; }
.CodeRay .hex { color: #058; }
.CodeRay .integer  { color: #099; }
.CodeRay .include { color: #B44; }
.CodeRay .inline { color: black; }
.CodeRay .inline .inline { background: #ccc; }
.CodeRay .inline .inline .inline { background: #bbb; }
.CodeRay .inline .inline-delimiter { color: #D14; }
.CodeRay .inline-delimiter { color: #D14; }
.CodeRay .important { color: #f00; }
.CodeRay .interpreted { color: #B2B; }
.CodeRay .instance-variable { color: teal; }
.CodeRay .label { color: #970; }
.CodeRay .local-variable { color: #963; }
.CodeRay .octal { color: #40E; }
.CodeRay .predefined { color: #369; }
.CodeRay .preprocessor { color: #579; }
.CodeRay .pseudo-class { color: #00C; }
.CodeRay .predefined-type { color: #074; }
.CodeRay .reserved, .keyword  { color: #000; }
.CodeRay .key { color: #808; }
.CodeRay .key .delimiter { color: #606; }
.CodeRay .key .char { color: #80f; }
.CodeRay .value { color: #088; }
.CodeRay .regexp { background-color: #fff0ff; }
.CodeRay .regexp .content { color: #808; }
.CodeRay .regexp .delimiter { color: #404; }
.CodeRay .regexp .modifier { color: #C2C; }
.CodeRay .regexp .function  { color: #404; font-weight: bold; }
.CodeRay .string { color: #D20; }
.CodeRay .string .string { }
.CodeRay .string .string .string { background-color: #ffd0d0; }
.CodeRay .string .content { color: #D14; }
.CodeRay .string .char { color: #D14; }
.CodeRay .string .delimiter { color: #D14; }
.CodeRay .shell { color: #D14; }
.CodeRay .shell .content { }
.CodeRay .shell .delimiter { color: #D14; }
.CodeRay .symbol { color: #990073; }
.CodeRay .symbol .content { color: #A60; }
.CodeRay .symbol .delimiter { color: #630; }
.CodeRay .tag, .CodeRay .attribute-name { color: #070; }
.CodeRay .tag-special { color: #D70; }
.CodeRay .type { color: #339; }
.CodeRay .variable  { color: #036; }
.CodeRay .insert { background: #afa; }
.CodeRay .delete { background: #faa; }
.CodeRay .change { color: #aaf; background: #007; }
.CodeRay .head { color: #f8f; background: #505; }
.CodeRay .insert .insert { color: #080; }
.CodeRay .delete .delete { color: #800; }
.CodeRay .change .change { color: #66f; }
.CodeRay .head .head { color: #f4f; }

</style> </head> <body class="book"> <div id="header"> </div> <div id="content"> <div class="sect1"> <h2 id="_the_cache_apis"><a class="anchor" href="#_the_cache_apis"></a>1. The Cache APIs</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="_the_cache_interface"><a class="anchor" href="#_the_cache_interface"></a>1.1. The Cache interface</h3> <div class="paragraph"> <p>Infinispan exposes a simple, <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a> compliant <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html">Cache</a> interface.</p> </div> <div class="paragraph"> <p>The Cache interface exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface. Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial. </td> </tr> </table> </div> <div class="sect3"> <h4 id="_limitations_of_certain_map_methods"><a class="anchor" href="#_limitations_of_certain_map_methods"></a>1.1.1. Limitations of Certain Map Methods</h4> <div class="paragraph"> <p>Certain methods exposed in Map have certain limitations when used with Infinispan, such as <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#size%28%29">size()</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#values%28%29">values()</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#keySet%28%29">keySet()</a> and <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#entrySet%28%29">entrySet()</a> . Specifically, these methods are <em>unreliable</em> and only provide a best-effort guess. They do not acquire locks, either local or global, and concurrent modifications, additions and removals will not be considered in the result of any of these calls. Further, they only operate on the local node, and as such, do not give you a global(cluster) view of the state.</p> </div> <div class="paragraph"> <p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck. As such, these methods should only be used for informational or debugging purposes only.</p> </div> </div> <div class="sect3"> <h4 id="_mortal_and_immortal_data"><a class="anchor" href="#_mortal_and_immortal_data"></a>1.1.2. Mortal and Immortal Data</h4> <div class="paragraph"> <p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data. For example, simply using <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put%28K,%20V%29">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory). If, however, you put data in the cache using <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#put%28K,%20V,%20long,%20java.util.concurrent.TimeUnit%29">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p> </div> <div class="paragraph"> <p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration. Any combination of lifespans or maxIdles can be used.</p> </div> </div> <div class="sect3"> <h4 id="_example_of_using_expiry_and_mortal_data"><a class="anchor" href="#_example_of_using_expiry_and_mortal_data"></a>1.1.3. Example of Using Expiry and Mortal Data</h4> <div class="paragraph"> <p>See <a href="#_eviction_examples">these examples</a> of using mortal data with Infinispan.</p> </div> </div> <div class="sect3"> <h4 id="_putforexternalread_operation"><a class="anchor" href="#_putforexternalread_operation"></a>1.1.4. putForExternalRead operation</h4> <div class="paragraph"> <p>Infinispan&#8217;s <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different <em>put</em> operation called <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)">putForExternalRead</a> . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere. Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p> </div> <div class="paragraph"> <p>To achieve this, putForExternalRead acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. putForExternalRead is consider to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p> </div> <div class="paragraph"> <p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)">putForExternalRead</a> within the context of this example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
<span class="comment">// Id of the person to look up, provided by the application</span>
PersonId id = ...;

<span class="comment">// Get a reference to the cache where person instances will be stored</span>
Cache&lt;PersonId, Person&gt; cache = ...;

<span class="comment">// First, check whether the cache contains the person instance</span>
<span class="comment">// associated with with the given id</span>
Person cachedPerson = cache.get(id);

<span class="keyword">if</span> (cachedPerson == <span class="predefined-constant">null</span>) {
   <span class="comment">// The person is not cached yet, so query the data store with the id</span>
   Person person = dataStore.lookup(id);

   <span class="comment">// Cache the person along with the id so that future requests can</span>
   <span class="comment">// retrieve it from memory rather than going to the data store</span>
   cache.putForExternalRead(id, person);
} <span class="keyword">else</span> {
   <span class="comment">// The person was found in the cache, so return it to the application</span>
   <span class="keyword">return</span> cachedPerson;
}
</code></pre> </div> </div> <div class="paragraph"> <p>Please note that <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)">putForExternalRead</a> should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put(K, V)">put</a> operation, otherwise the possibility of caching corrupt data is likely.</p> </div> </div> </div> <div class="sect2"> <h3 id="_the_advancedcache_interface"><a class="anchor" href="#_the_advancedcache_interface"></a>1.2. The AdvancedCache interface</h3> <div class="paragraph"> <p>In addition to the simple Cache interface, Infinispan offers an <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors. The AdvancedCache offers the ability to inject custom interceptors, access certain internal components and to apply flags to alter the default behavior of certain cache methods. The following code snippet depicts how an AdvancedCache can be obtained:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">AdvancedCache advancedCache = cache.getAdvancedCache();
</code></pre> </div> </div> <div class="sect3"> <h4 id="_flags"><a class="anchor" href="#_flags"></a>1.2.1. Flags</h4> <div class="paragraph"> <p>Flags are applied to regular cache methods to alter the behavior of certain methods. For a list of all available flags, and their effects, see the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration. Flags are applied using <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag...%29">AdvancedCache.withFlags()</a> . This builder method can be used to apply any number of flags to a cache invocation, for example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.FORCE_SYNCHRONOUS)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">world</span><span class="delimiter">&quot;</span></span>);

</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_entry_retrieval"><a class="anchor" href="#_entry_retrieval"></a>1.2.2. Entry Retrieval</h4> <div class="paragraph"> <p>Bulk Map methods are not fully implemented for distributed caches (only uses local contents) as can be seen from their javadocs <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#entrySet()">entrySet</a>, <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#values()">values</a>, <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#keySet()">keySet</a>, and <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#size()">size</a></p> </div> <div class="paragraph"> <p>This is done because of the possible memory constraints of pulling all the values into a single node. It may desireable to still access all data and Infinispan allows this but through a different interface.</p> </div> <div class="paragraph"> <p>An <code>EntryIterable</code> is available by invoking the <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/AdvancedCache.html#filterEntries(org.infinispan.filter.KeyValueFilter)">filterEntries</a> method on <code>AdvancedCache</code>. Note you are required to provide a <code>KeyValueFilter</code>, this is to make sure users realize this can be an expensive operation and by filtering entries on the remote side will allow the operation to perform faster and more efficiently. This allows you to iterate over the contents in the cache in a memory sensitive way so out of memory errors should not occur. The size of contents held in memory by the iterator while being processed currently is limited by the state transfer chunk size configuration value.</p> </div> <div class="paragraph"> <p>Once the <code>EntryIterable</code> is retrieved, invocation of the iterator method will immediately start retrieving entries. Note each invocation of the iterator method will start a brand new entry request thus allowing the <code>Iterable</code> to be reused.</p> </div> <div class="paragraph"> <p><code>EntryIterable</code> also implements <code>AutoCloseable</code> so it should be done in a try with resource block to ensure that all resources can be closed properly after invocation.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">KeyValueFilter&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; filter = ...
try (EntryIterable&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; iterable = advancedCache.filterEntries(filter)) {
  <span class="keyword">for</span> (CacheEntry&lt;<span class="predefined-type">Object</span>, <span class="predefined-type">Object</span>&gt; entry : iterable) {
     <span class="comment">// Do something</span>
  }
}</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> The iterators produced do not obey the current transaction if there is one and thus will always retrieve the most current committed values from the cache. </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> Also the remove method is not supported on the iterators and will throw an <code>UnsupportedOperationException</code> if invoked. </td> </tr> </table> </div> <div class="paragraph"> <p>While the provided filter can be used to efficiently reduce what entries are returned to the local node, there is also the possibility of providing an optional <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/filter/Converter.html">Converter</a> which will convert the provided value to another object or even type, which is done on the remote side. This is useful to reduce payload size when you may want only a partial view of the object or even an object that is created from it.</p> </div> <div class="paragraph"> <p>In this case we have a converter that can be used to convert a Car instance to instead return one of its wheels as determined by the value passed to the converter when created.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">CarWheelConverter</span> <span class="directive">implements</span> Converter&lt;<span class="predefined-type">String</span>, Car, Wheel&gt; {
   <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> wheelPosition;

   <span class="directive">public</span> CarWheelConverter(<span class="type">int</span> wheelPosition) {
     <span class="local-variable">this</span>.wheelPosition = wheelPosition;
   }
   <span class="annotation">@Override</span>
   <span class="directive">public</span> Wheel convert(<span class="predefined-type">String</span> key, Car value, Metadata metadata) {
      <span class="keyword">return</span> value.getWheels().wheel(wheelPosition);
   }
}


<span class="keyword">try</span> (CloseableIterable&lt;CacheEntry&lt;<span class="predefined-type">String</span>, Wheel&gt;&gt; iterable = advancedCache.filterEntries(teslaCarFilter).converter(<span class="keyword">new</span> CarWheelConverter(<span class="integer">3</span>)) {
   <span class="keyword">for</span> (CacheEntry&lt;<span class="predefined-type">String</span>, Wheel&gt; entry : iterable) {
      <span class="comment">// Do something with the third wheel of the car</span>
   }
}</code></pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> Remember that both the <code>KeyValueFilter</code> and the <code>Converter</code> must either implement <code>Serializable</code> or have a provided Infinispan <code>Externalizer</code> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="_custom_interceptors"><a class="anchor" href="#_custom_interceptors"></a>1.2.3. Custom Interceptors</h4> <div class="paragraph"> <p>The AdvancedCache interface also offers advanced developers a mechanism with which to attach custom interceptors. Custom interceptors allow developers to alter the behavior of the cache API methods, and the AdvancedCache interface allows developers to attach these interceptors programmatically, at run-time. See the AdvancedCache Javadocs for more details.</p> </div> <div class="paragraph"> <p>For more information on writing custom interceptors, see <a href="#_custom_interceptors_chapter">this chapter</a>.</p> </div> </div> </div> <div class="sect2"> <h3 id="_Listeners_and_notifications_section"><a class="anchor" href="#_Listeners_and_notifications_section"></a>1.3. Listeners and Notifications</h3> <div class="paragraph"> <p>Infinispan offers a listener API, where clients can register for and get notified when events take place. This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p> </div> <div class="paragraph"> <p>Events trigger a notification which is dispatched to listeners. Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a> s annotated with <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications. </td> </tr> </table> </div> <div class="paragraph"> <p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PrintWhenAdded</span> {

<span class="error"> </span> <span class="annotation">@CacheEntryCreated</span>
<span class="error"> </span> <span class="directive">public</span> <span class="type">void</span> print(CacheEntryCreatedEvent event) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span> <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">New entry </span><span class="delimiter">&quot;</span></span> + event.getKey() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> created in the cache</span><span class="delimiter">&quot;</span></span>);
<span class="error"> </span> }

}
</code></pre> </div> </div> <div class="paragraph"> <p>For more comprehensive examples, please see the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p> </div> <div class="sect3"> <h4 id="_cache_level_notifications"><a class="anchor" href="#_cache_level_notifications"></a>1.3.1. Cache-level notifications</h4> <div class="paragraph"> <p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur. Note in a distributed cache these events are only raised on the owners of data being affected. Examples of cache-level events are entries being added, removed, modified, etc. These events trigger notifications to listeners registered to a specific cache.</p> </div> <div class="paragraph"> <p>Please see the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> Please refer to the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan. </td> </tr> </table> </div> <div class="sect4"> <h5 id="_cluster_listeners"><a class="anchor" href="#_cluster_listeners"></a>Cluster Listeners</h5> <div class="paragraph"> <p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p> </div> <div class="paragraph"> <p>To do so all that is required is set to annotate your listener as being clustered.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="annotation">@Listener</span> (clustered = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyClusterListener</span> { .... }
</code></pre> </div> </div> <div class="paragraph"> <p>There are some limitations to cluster listeners from a non clustered listener.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code> and <code>@CacheEntryRemoved</code> events. Note this means any other type of event will not be listened to for this listener.</p> </li> <li> <p>Only the post event is sent to a cluster listener, the pre event is ignored.</p> </li> </ol> </div> </div> <div class="sect4"> <h5 id="_event_filtering_and_conversion"><a class="anchor" href="#_event_filtering_and_conversion"></a>Event filtering and conversion</h5> <div class="paragraph"> <p>All applicable events on the node where the listener is installed will be raised to the listener. It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p> </div> <div class="paragraph"> <p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SpecificKeyFilter</span> <span class="directive">implements</span> KeyFilter&lt;<span class="predefined-type">String</span>&gt; {
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> keyToAccept;

    <span class="directive">public</span> SpecificKeyFilter(<span class="predefined-type">String</span> keyToAccept) {
      <span class="keyword">if</span> (keyToAccept == <span class="predefined-constant">null</span>) {
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">NullPointerException</span>();
      }
      <span class="local-variable">this</span>.keyToAccept = keyToAccept;
    }

    <span class="type">boolean</span> accept(<span class="predefined-type">String</span> key) {
      <span class="keyword">return</span> keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, <span class="keyword">new</span> SpecificKeyFilter(<span class="string"><span class="delimiter">&quot;</span><span class="content">Only Me</span><span class="delimiter">&quot;</span></span>));
...
</code></pre> </div> </div> <div class="paragraph"> <p>This can be useful when you want to limit what events you receive in a more efficient manner.</p> </div> <div class="paragraph"> <p>There is also a <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event. This can be nice to modularize any code that does value conversions.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener. This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to. This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter). </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="_initial_state_events"><a class="anchor" href="#_initial_state_events"></a>Initial State Events</h5> <div class="paragraph"> <p>When a listener is installed it will only be notified of events after it is fully installed.</p> </div> <div class="paragraph"> <p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache. Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> This only works for clustered listeners at this time. <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners. </td> </tr> </table> </div> </div> <div class="sect4"> <h5 id="_duplicate_events"><a class="anchor" href="#_duplicate_events"></a>Duplicate Events</h5> <div class="paragraph"> <p>It is possible in a non transactional cache to receive duplicate events. This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p> </div> <div class="paragraph"> <p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups. Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p> </div> <div class="paragraph"> <p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="annotation">@Listener</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyRetryListener</span> {
  <span class="annotation">@CacheEntryModified</span>
  <span class="directive">public</span> <span class="type">void</span> entryModified(CacheEntryModifiedEvent event) {
    <span class="keyword">if</span> (event.isCommandRetried()) {
      <span class="comment">// Do something</span>
    }
  }
}</code></pre> </div> </div> <div class="paragraph"> <p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p> </div> </div> </div> <div class="sect3"> <h4 id="_cache_manager_level_notifications"><a class="anchor" href="#_cache_manager_level_notifications"></a>1.3.2. Cache manager-level notifications</h4> <div class="paragraph"> <p>Cache manager-level events occur on a cache manager. These too are global and cluster-wide, but involve events that affect all caches created by a single cache manager. Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p> </div> <div class="paragraph"> <p>Please see the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all cache manager-level notifications, and their respective method-level annotations.</p> </div> </div> <div class="sect3"> <h4 id="_synchronicity_of_events"><a class="anchor" href="#_synchronicity_of_events"></a>1.3.3. Synchronicity of events</h4> <div class="paragraph"> <p>By default, all notifications are dispatched in the same thread that generates the event. This means that you <em>must</em> write your listener such that it does not block or do anything that takes too long, as it would prevent the thread from progressing. Alternatively, you could annotate your listener as <em>asynchronous</em> , in which case a separate thread pool will be used to dispatch the notification and prevent blocking the event originating thread. To do this, simply annotate your listener such:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="annotation">@Listener</span> (sync = <span class="predefined-constant">false</span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MyAsyncListener</span> { .... }
</code></pre> </div> </div> <div class="sect4"> <h5 id="_asynchronous_thread_pool"><a class="anchor" href="#_asynchronous_thread_pool"></a>Asynchronous thread pool</h5> <div class="paragraph"> <p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="http://docs.jboss.org/infinispan/5.0/apidocs/config.html#ce_global_asyncListenerExecutor"><code>&lt;asyncListenerExecutor /&gt;</code></a> XML element in your configuration file.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="_asynchronous_api"><a class="anchor" href="#_asynchronous_api"></a>1.4. Asynchronous API</h3> <div class="paragraph"> <p>In addition to synchronous API methods like <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put%28K,%20V%29">Cache.put()</a> , <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#remove%28java.lang.Object%29">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p> </div> <div class="paragraph"> <p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#putAsync%28K,%20V%29">Cache.putAsync()</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#removeAsync%28java.lang.Object%29">Cache.removeAsync()</a> , etc.  These asynchronous counterparts return a <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/Future.html">Future</a> containing the actual result of the operation.</p> </div> <div class="paragraph"> <p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns a <code>String</code>. <code>Cache.putAsync(String key, String value)</code> would return a <code>Future&lt;String&gt;</code>.</p> </div> <div class="sect3"> <h4 id="_why_use_such_an_api"><a class="anchor" href="#_why_use_such_an_api"></a>1.4.1. Why use such an API?</h4> <div class="paragraph"> <p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt; futures = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>&lt;<span class="predefined-type">Future</span>&lt;?&gt;&gt;();
futures.add(cache.putAsync(key1, value1)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key2, value2)); <span class="comment">// does not block</span>
futures.add(cache.putAsync(key3, value3)); <span class="comment">// does not block</span>

<span class="comment">// the remote calls for the 3 puts will effectively be executed</span>
<span class="comment">// in parallel, particularly useful if running in distributed mode</span>
<span class="comment">// and the 3 keys would typically be pushed to 3 different nodes</span>
<span class="comment">// in the cluster</span>

<span class="comment">// check that the puts completed successfully</span>
<span class="keyword">for</span> (<span class="predefined-type">Future</span>&lt;?&gt; f: futures) f.get();
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_which_processes_actually_happen_asynchronously"><a class="anchor" href="#_which_processes_actually_happen_asynchronously"></a>1.4.2. Which processes actually happen asynchronously?</h4> <div class="paragraph"> <p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation. These are, in order of cost:</p> </div> <div class="ulist"> <ul> <li> <p>network calls</p> </li> <li> <p>marshalling</p> </li> <li> <p>writing to a cache store (optional)</p> </li> <li> <p>locking</p> </li> </ul> </div> <div class="paragraph"> <p>As of Infinispan 4.0, using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.  In future, we plan to take these offline as well.  See <a href="http://lists.jboss.org/pipermail/infinispan-dev/2010-January/002219.html">this developer mail list thread</a> about this topic.</p> </div> </div> <div class="sect3"> <h4 id="_notifying_futures"><a class="anchor" href="#_notifying_futures"></a>1.4.3. Notifying futures</h4> <div class="paragraph"> <p>Strictly, these methods do not return JDK Futures, but rather a sub-interface known as a <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/util/concurrent/NotifyingFuture.html">NotifyingFuture</a> .  The main difference is that you can attach a listener to a NotifyingFuture such that you could be notified when the future completes.  Here is an example of making use of a notifying future:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
FutureListener futureListener = <span class="keyword">new</span> FutureListener() {

   <span class="directive">public</span> <span class="type">void</span> futureDone(<span class="predefined-type">Future</span> future) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span>   <span class="keyword">try</span> {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>future.get();
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="comment">// Future did not complete successfully</span>
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Help!</span><span class="delimiter">&quot;</span></span>);
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>}
<span class="error"> </span><span class="error"> </span><span class="error"> </span>}
};
<span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span><span class="error"> </span>
cache.putAsync(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>).attachListener(futureListener);
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_further_reading"><a class="anchor" href="#_further_reading"></a>1.4.4. Further reading</h4> <div class="paragraph"> <p>The Javadocs on the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html">Cache</a> interface has some examples on using the asynchronous API, as does <a href="http://infinispan.blogspot.com/2009/05/whats-so-cool-about-asynchronous-api.html">this article</a> by Manik Surtani introducing the API.</p> </div> </div> </div> <div class="sect2"> <h3 id="_invocation_flags"><a class="anchor" href="#_invocation_flags"></a>1.5. Invocation Flags</h3> <div class="paragraph"> <p>An important aspect of getting the most of Infinispan is the use of per-invocation flags in order to provide specific behaviour to each particular cache call. By doing this, some important optimizations can be implemented potentially saving precious time and network resources. One of the most popular usages of flags can be found right in Cache API, underneath the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)">putForExternalRead()</a> method which is used to load an Infinispan cache with data read from an external resource. In order to make this call efficient, Infinispan basically calls a normal put operation passing the following flags: <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/context/Flag.html#FAIL_SILENTLY">FAIL_SILENTLY</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/context/Flag.html#FORCE_ASYNCHRONOUS">FORCE_ASYNCHRONOUS</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/context/Flag.html#ZERO_LOCK_ACQUISITION_TIMEOUT">ZERO_LOCK_ACQUISITION_TIMEOUT</a></p> </div> <div class="paragraph"> <p>What Infinispan is doing here is effectively saying that when putting data read from external read, it will use an almost-zero lock acquisition time and that if the locks cannot be acquired, it will fail silently without throwing any exception related to lock acquisition. It also specifies that regardless of the cache mode, if the cache is clustered, it will replicate asynchronously and so won&#8217;t wait for responses from other nodes. The combination of all these flags make this kind of operation very efficient, and the efficiency comes from the fact this type of <em>putForExternalRead</em> calls are used with the knowledge that client can always head back to a persistent store of some sorts to retrieve the data that should be stored in memory. So, any attempt to store the data is just a best effort and if not possible, the client should try again if there&#8217;s a cache miss.</p> </div> <div class="sect3"> <h4 id="_decoratedcache"><a class="anchor" href="#_decoratedcache"></a>1.5.1. DecoratedCache</h4> <div class="paragraph"> <p>Another approach would be to use the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/DecoratedCache.html">DecoratedCache</a> wrapper. This allows you to reuse flags. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">AdvancedCache cache = ...
DecoratedCache strictlyLocal = <span class="keyword">new</span> DecoratedCache(cache, Flag.CACHE_MODE_LOCAL, Flag.SKIP_CACHE_STORE);
strictlyLocal.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local_1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);
strictlyLocal.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local_2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);
strictlyLocal.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local_3</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>This approach makes your code more readable.</p> </div> </div> <div class="sect3"> <h4 id="_examples"><a class="anchor" href="#_examples"></a>1.5.2. Examples</h4> <div class="paragraph"> <p>If you want to use these or any other flags available, which by the way are described in detail the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> , you simply need to get hold of the advanced cache and add the flags you need via the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag...)">withFlags()</a> method call. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Cache cache = ...
cache.getAdvancedCache()
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.SKIP_CACHE_STORE, Flag.CACHE_MODE_LOCAL)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>It&#8217;s worth noting that these flags are only active for the duration of the cache operation. If the same flags need to be used in several invocations, even if they&#8217;re in the same transaction, <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag...)">withFlags()</a> needs to be called repeatedly. Clearly, if the cache operation is to be replicated in another node, the flags are carried over to the remote nodes as well.</p> </div> <div class="sect4"> <h5 id="_suppressing_return_values_from_a_put_or_remove"><a class="anchor" href="#_suppressing_return_values_from_a_put_or_remove"></a>Suppressing return values from a put() or remove()</h5> <div class="paragraph"> <p>Another very important use case is when you want a write operation such as put() to <em>not</em> return the previous value. To do that, you need to use two flags to make sure that in a distributed environment, no remote lookup is done to potentially get previous value, and if the cache is configured with a cache loader, to avoid loading the previous value from the cache store. You can see these two flags in action in the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Cache cache = ...
cache.getAdvancedCache()
<span class="error"> </span><span class="error"> </span> .withFlags(Flag.SKIP_REMOTE_LOOKUP, Flag.SKIP_CACHE_LOAD)
<span class="error"> </span><span class="error"> </span> .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">local</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">only</span><span class="delimiter">&quot;</span></span>)
</code></pre> </div> </div> <div class="paragraph"> <p>For more information, please check the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> javadoc.</p> </div> </div> </div> </div> <div class="sect2"> <h3 id="_tree_api_module"><a class="anchor" href="#_tree_api_module"></a>1.6. Tree API Module</h3> <div class="paragraph"> <p><a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/package-summary.html">Infinispan&#8217;s tree API module</a> offers clients the possibility of storing data using a tree-structure like API. This API is similar to the one <a href="http://docs.jboss.org/jbosscache/3.2.1.GA/apidocs/org/jboss/cache/package-summary.html">provided by JBoss Cache</a>, hence the tree module is perfect for those users wanting to migrate their applications from JBoss Cache to Infinispan, who want to limit changes their codebase as part of the migration. Besides, it&#8217;s important to understand that Infinispan provides this tree API much more efficiently than JBoss Cache did, so if you&#8217;re a user of the tree API in JBoss Cache, you should consider migrating to Infinispan.</p> </div> <div class="sect3"> <h4 id="_what_is_tree_api_about"><a class="anchor" href="#_what_is_tree_api_about"></a>1.6.1. What is Tree API about?</h4> <div class="paragraph"> <p>The aim of this API is to store information in a hierarchical way. The hierarchy is defined using paths represented as <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/Fqn.html">Fqn or fully qualified names</a> , for example: <em>/this/is/a/fqn/path</em> or <em>/another/path</em> . In the hierarchy, there&#8217;s a special path called root which represents the starting point of all paths and it&#8217;s represented as: <em>/</em></p> </div> <div class="paragraph"> <p>Each FQN path is represented as a node where users can store data using a key/value pair style API (i.e. a Map). For example, in <em>/persons/john</em> , you could store information belonging to John, for example: surname=Smith, birthdate=05/02/1980&#8230;etc.</p> </div> <div class="paragraph"> <p>Please remember that users should not use root as a place to store data. Instead, users should define their own paths and store data there. The following sections will delve into the practical aspects of this API.</p> </div> </div> <div class="sect3"> <h4 id="_using_the_tree_api"><a class="anchor" href="#_using_the_tree_api"></a>1.6.2. Using the Tree API</h4> <div class="sect4"> <h5 id="_dependencies"><a class="anchor" href="#_dependencies"></a>Dependencies</h5> <div class="paragraph"> <p>For your application to use the tree API, you need to import infinispan-tree.jar which can be located in the Infinispan binary distributions, or you can simply add a dependency to this module in your pom.xml:</p> </div> <div class="listingblock"> <div class="title">pom.xml</div> <div class="content"> <pre class="CodeRay"><code class="xml language-xml">
<span class="tag">&lt;dependencies&gt;</span>
  ...
  <span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.infinispan<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>infinispan-tree<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>$put-infinispan-version-here<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;/dependency&gt;</span>
  ...
<span class="tag">&lt;/dependencies&gt;</span>
</code></pre> </div> </div> </div> </div> <div class="sect3"> <h4 id="_creating_a_tree_cache"><a class="anchor" href="#_creating_a_tree_cache"></a>1.6.3. Creating a Tree Cache</h4> <div class="paragraph"> <p>The first step to use the tree API is to actually create a tree cache. To do so, you need to <a href="#_configuring_cache">create an Infinispan Cache as you&#8217;d normally do, and using the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCacheFactory.html">TreeCacheFactory</a> , create an instance of <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> . A very important note to remember here is that the Cache instance passed to the factory must be configured with &lt;&lt;_batching, invocation batching</a>. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">org.infinispan.config.Configuration</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tree.TreeCacheFactory</span>;
<span class="keyword">import</span> <span class="include">org.infinispan.tree.TreeCache</span>;
...
Configuration config = <span class="keyword">new</span> <span class="predefined-type">Configuration</span>();
config.setInvocationBatchingEnabled(<span class="predefined-constant">true</span>);
Cache cache = <span class="keyword">new</span> DefaultCacheManager(config).getCache();
TreeCache treeCache = TreeCacheFactory.createTreeCache(cache);
</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_manipulating_data_in_a_tree_cache"><a class="anchor" href="#_manipulating_data_in_a_tree_cache"></a>1.6.4. Manipulating data in a Tree Cache</h4> <div class="paragraph"> <p>The Tree API effectively provides two ways to interact with the data:</p> </div> <div class="paragraph"> <p>Via <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> convenience methods: These methods are located within the TreeCache interface and enable users to <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCache.html#put(java.lang.String, K, V)">store</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCache.html#get(org.infinispan.tree.Fqn, K)">retrieve</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCache.html#move(org.infinispan.tree.Fqn, org.infinispan.tree.Fqn)">move</a> , <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/TreeCache.html#remove(org.infinispan.tree.Fqn, K)">remove</a> &#8230;etc data with a single call that takes the <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/Fqn.html">Fqn</a> , in String or Fqn format, and the data involved in the call. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">treeCache.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/persons/john</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">org.infinispan.tree.Fqn</span>;
...
Fqn johnFqn = Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons/john</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Calendar</span> calendar = <span class="predefined-type">Calendar</span>.getInstance();
calendar.set(<span class="integer">1980</span>, <span class="integer">5</span>, <span class="integer">2</span>);
treeCache.put(johnFqn, <span class="string"><span class="delimiter">&quot;</span><span class="content">birthdate</span><span class="delimiter">&quot;</span></span>, calendar.getTime()));
</code></pre> </div> </div> <div class="paragraph"> <p>Via <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/Node.html">Node</a> API: It allows finer control over the individual nodes that form the FQN, allowing manipulation of nodes relative to a particular node. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="keyword">import</span> <span class="include">org.infinispan.tree.Node</span>;
...
TreeCache treeCache = ...
Fqn johnFqn = Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>);
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Node persons = treeCache.getRoot().addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = persons.addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>Or even:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Fqn personsFqn = Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>);
Fqn johnFqn = Fqn.fromRelative(personsFqn, Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>);
</code></pre> </div> </div> <div class="paragraph"> <p>A node also provides the ability to access its <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/Node.html#getParent()">parent</a> or <a href="http://docs.jboss.org/infinispan/7.0/apidocs/org/infinispan/tree/Node.html#getChildren()">children</a> . For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; john = ...
Node persons = john.getParent();
</code></pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java"><span class="predefined-type">Set</span>&lt;Node&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; personsChildren = persons.getChildren();</code></pre> </div> </div> </div> <div class="sect3"> <h4 id="_common_operations"><a class="anchor" href="#_common_operations"></a>1.6.5. Common Operations</h4> <div class="paragraph"> <p>In the previous section, some of the most used operations, such as addition and retrieval, have been shown. However, there are other important operations that are worth mentioning, such as remove:</p> </div> <div class="paragraph"> <p>You can for example remove an entire node, i.e. <em>/persons/john</em> , using:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">treeCache.removeNode(<span class="string"><span class="delimiter">&quot;</span><span class="content">/persons/john</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or remove a child node, i.e. persons that a child of root, via:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">treeCache.getRoot().removeChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));</code></pre> </div> </div> <div class="paragraph"> <p>You can also remove a particular key/value pair in a node:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Node john = treeCache.getRoot().getChild(Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">surname</span><span class="delimiter">&quot;</span></span>);</code></pre> </div> </div> <div class="paragraph"> <p>Or you can remove all data in a node with:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">Node john = treeCache.getRoot().getChild(Fqn.fromElements(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
john.clearData();</code></pre> </div> </div> <div class="paragraph"> <p>Another important operation supported by Tree API is the ability to move nodes around in the tree. Imagine we have a node called "john" which is located under root node. The following example is going to show how to we can move "john" node to be under "persons" node:</p> </div> <div class="paragraph"> <p>Current tree structure:</p> </div> <div class="listingblock"> <div class="content"> <pre>
   /persons
   /john
</pre> </div> </div> <div class="paragraph"> <p>Moving trees from one FQN to another:</p> </div> <div class="listingblock"> <div class="content"> <pre class="CodeRay"><code class="java language-java">
Node john = treeCache.getRoot().addChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">john</span><span class="delimiter">&quot;</span></span>));
Node persons = treeCache.getRoot().getChild(Fqn.fromString(<span class="string"><span class="delimiter">&quot;</span><span class="content">persons</span><span class="delimiter">&quot;</span></span>));
treeCache.move(john.getFqn(), persons.getFqn());
</code></pre> </div> </div> <div class="paragraph"> <p>Final tree structure:</p> </div> <div class="listingblock"> <div class="content"> <pre>
   /persons/john
</pre> </div> </div> </div> <div class="sect3"> <h4 id="_locking_in_the_tree_api"><a class="anchor" href="#_locking_in_the_tree_api"></a>1.6.6. Locking in the Tree API</h4> <div class="paragraph"> <p>Understanding when and how locks are acquired when manipulating the tree structure is important in order to maximise the performance of any client application interacting against the tree, while at the same time maintaining consistency.</p> </div> <div class="paragraph"> <p>Locking on the tree API happens on a per node basis. So, if you&#8217;re putting or updating a key/value under a particular node, a write lock is acquired for that node. In such case, no write locks are acquired for parent node of the node being modified, and no locks are acquired for children nodes.</p> </div> <div class="paragraph"> <p>If you&#8217;re adding or removing a node, the parent is not locked for writing. In JBoss Cache, this behaviour was configurable with the default being that parent was not locked for insertion or removal.</p> </div> <div class="paragraph"> <p>Finally, when a node is moved, the node that&#8217;s been moved and any of its children are locked, but also the target node and the new location of the moved node and its children. To understand this better, let&#8217;s look at an example:</p> </div> <div class="paragraph"> <p>Imagine you have a hierarchy like this and we want to move c/ to be underneath b/:</p> </div> <div class="listingblock"> <div class="content"> <pre>        /
      --|--
     /     \
     a     c
     |     |
     b     e
     |
     d
</pre> </div> </div> <div class="paragraph"> <p>The end result would be something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>        /
        |         
        a    
        |    
        b    
      --|--
     /     \
     d     c
           |
           e
</pre> </div> </div> <div class="paragraph"> <p>To make this move, locks would have been acquired on:</p> </div> <div class="ulist"> <ul> <li> <p><em>/a/b</em> - because it&#8217;s the parent underneath which the data will be put</p> </li> <li> <p><em>/c</em> and <em>/c/e</em> - because they&#8217;re the nodes that are being moved</p> </li> <li> <p><em>/a/b/c</em> and <em>/a/b/c/e</em> - because that&#8217;s new target location for the nodes being moved</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-68355037_TreeAPIModule-Listenersfortreecacheevents"><a class="anchor" href="#sid-68355037_TreeAPIModule-Listenersfortreecacheevents"></a>1.6.7. Listeners for tree cache events</h4> <div class="paragraph"> <p>The current Infinispan listeners have been designed with key/value store notifications in mind, and hence they do not map to tree cache events correctly. Tree cache specific listeners that map directly to tree cache events (i.e. adding a child&#8230;etc) are desirable but these are not yet available. If you&#8217;re interested in this type of listeners, please follow <a href="https://issues.jboss.org/browse/ISPN-1935">this issue</a> to find out about any progress in this area.</p> </div> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2014-10-21 10:46:51 UTC </div> </div> </body> </html>