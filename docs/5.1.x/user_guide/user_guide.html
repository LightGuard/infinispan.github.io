<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="generator" content="Asciidoctor 0.1.4"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>New in Infinispan 4.1.0</title> <style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style> <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css"> <style>
/* Foundation stylesheet for CodeRay (to match GitHub theme) | MIT License | http://foundation.zurb.com */
table.CodeRay { border-collapse: collapse; padding: 2px; margin-bottom: 0; border: 0; background: transparent; }
table.CodeRay td { padding: 0 .5em; vertical-align: top; }
table.CodeRay td.line-numbers { text-align: right; color: #999; border-right: 1px solid #e5e5e5; padding-left: 0; }
span.line-numbers { border-right: 1px solid #E5E5E5; color: #999; display: inline-block; margin-right: 0.5em; padding-right: 0.5em; }
.CodeRay td.line-numbers strong, .CodeRay span.line-numbers strong { font-weight: normal; }
.CodeRay .debug { color: white !important; background: blue !important; }
.CodeRay .annotation { color: #007; }
.CodeRay .attribute-name { color: #f08; }
.CodeRay .attribute-value { color: #700; }
.CodeRay .binary { color: #509; }
.CodeRay .comment  { color: #999; font-style: italic; }
.CodeRay .char { color: #04D; }
.CodeRay .char .content { color: #04D; }
.CodeRay .char .delimiter { color: #039; }
.CodeRay .class { color: #458; }
.CodeRay .complex { color: #A08; }
.CodeRay .constant { color: teal; }
.CodeRay .color { color: #0A0; }
.CodeRay .class-variable { color: #369; }
.CodeRay .decorator { color: #B0B; }
.CodeRay .definition { color: #099; }
.CodeRay .directive { color: #088; }
.CodeRay .delimiter { color: black; }
.CodeRay .doc { color: #970; }
.CodeRay .doctype { color: #34b; }
.CodeRay .doc-string { color: #D42; }
.CodeRay .escape  { color: #666; }
.CodeRay .entity { color: #800; }
.CodeRay .error { color: #808; }
.CodeRay .exception { color: #C00; }
.CodeRay .filename { color: #099; }
.CodeRay .function { color: #900; }
.CodeRay .global-variable { color: teal; }
.CodeRay .hex { color: #058; }
.CodeRay .integer  { color: #099; }
.CodeRay .include { color: #B44; }
.CodeRay .inline { color: black; }
.CodeRay .inline .inline { background: #ccc; }
.CodeRay .inline .inline .inline { background: #bbb; }
.CodeRay .inline .inline-delimiter { color: #D14; }
.CodeRay .inline-delimiter { color: #D14; }
.CodeRay .important { color: #f00; }
.CodeRay .interpreted { color: #B2B; }
.CodeRay .instance-variable { color: teal; }
.CodeRay .label { color: #970; }
.CodeRay .local-variable { color: #963; }
.CodeRay .octal { color: #40E; }
.CodeRay .predefined { color: #369; }
.CodeRay .preprocessor { color: #579; }
.CodeRay .pseudo-class { color: #00C; }
.CodeRay .predefined-type { color: #074; }
.CodeRay .reserved, .keyword  { color: #000; }
.CodeRay .key { color: #808; }
.CodeRay .key .delimiter { color: #606; }
.CodeRay .key .char { color: #80f; }
.CodeRay .value { color: #088; }
.CodeRay .regexp { background-color: #fff0ff; }
.CodeRay .regexp .content { color: #808; }
.CodeRay .regexp .delimiter { color: #404; }
.CodeRay .regexp .modifier { color: #C2C; }
.CodeRay .regexp .function  { color: #404; font-weight: bold; }
.CodeRay .string { color: #D20; }
.CodeRay .string .string { }
.CodeRay .string .string .string { background-color: #ffd0d0; }
.CodeRay .string .content { color: #D14; }
.CodeRay .string .char { color: #D14; }
.CodeRay .string .delimiter { color: #D14; }
.CodeRay .shell { color: #D14; }
.CodeRay .shell .content { }
.CodeRay .shell .delimiter { color: #D14; }
.CodeRay .symbol { color: #990073; }
.CodeRay .symbol .content { color: #A60; }
.CodeRay .symbol .delimiter { color: #630; }
.CodeRay .tag, .CodeRay .attribute-name { color: #070; }
.CodeRay .tag-special { color: #D70; }
.CodeRay .type { color: #339; }
.CodeRay .variable  { color: #036; }
.CodeRay .insert { background: #afa; }
.CodeRay .delete { background: #faa; }
.CodeRay .change { color: #aaf; background: #007; }
.CodeRay .head { color: #f8f; background: #505; }
.CodeRay .insert .insert { color: #080; }
.CodeRay .delete .delete { color: #800; }
.CodeRay .change .change { color: #66f; }
.CodeRay .head .head { color: #f4f; }

</style> </head> <body class="book toc2 toc-left"> <div id="header"> <div id="toc" class="toc2"> <div id="toctitle">Table of Contents</div> <ul class="sectlevel1"> <li><a href="#sid-18645130_UserGuide-NewinInfinispan4.1.0">1. New in Infinispan 4.1.0</a></li> <li><a href="#sid-18645130_UserGuide-NewinInfinispan4.2.0">2. New in Infinispan 4.2.0</a></li> <li><a href="#sid-18645130_UserGuide-NewinInfinispan5.0.0">3. New in Infinispan 5.0.0</a></li> <li><a href="#sid-18645130_UserGuide-Integrationwithotherframeworks">4. Integration with other frameworks</a></li> <li><a href="#sid-18645131">5. Querying Infinispan</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645131_QueryingInfinispan-Theinfinispanquerymodule">5.1. The infinispan-query module</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645131_QueryingInfinispan-UsagewithInfinispan5">5.1.1. Usage with Infinispan 5</a></li> </ul> </li> <li><a href="#sid-18645131_QueryingInfinispan-Simpleexample">5.2. Simple example</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645131_QueryingInfinispan-NotabledifferenceswithHibernateSearch">5.2.1. Notable differences with Hibernate Search</a></li> </ul> </li> <li><a href="#sid-18645131_QueryingInfinispan-ConfigurationviaXML">5.3. Configuration via XML</a></li> <li><a href="#sid-18645131_QueryingInfinispan-Usingprogrammaticconfigurationandindexmapping">5.4. Using programmatic configuration and index mapping</a></li> <li><a href="#sid-18645131_QueryingInfinispan-Cachemodesandmanagingindexes">5.5. Cache modes and managing indexes</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645131_QueryingInfinispan-LOCAL">5.5.1. LOCAL</a></li> <li><a href="#sid-18645131_QueryingInfinispan-REPLICATION">5.5.2. REPLICATION</a></li> <li><a href="#sid-18645131_QueryingInfinispan-DISTRIBUTIONandINVALIDATION">5.5.3. DISTRIBUTION and INVALIDATION</a></li> <li><a href="#sid-18645131_QueryingInfinispan-SharingtheIndex">5.5.4. Sharing the Index</a></li> <li><a href="#sid-18645131_QueryingInfinispan-ClusteringtheIndexinInfinispan">5.5.5. Clustering the Index in Infinispan</a></li> </ul> </li> <li><a href="#sid-18645132">5.6. Infinispan Query v.4</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645132_InfinispanQueryv.4-Theinfinispanquerymodule">5.6.1. The infinispan-query module</a></li> <li><a href="#sid-18645132_InfinispanQueryv.4-ConfigurationviaXML">5.6.2. Configuration via XML</a></li> <li><a href="#sid-18645132_InfinispanQueryv.4-SamplecodewithInfinispan4howdoIenableandusetheQueryAPI%3F">5.6.3. Sample code with Infinispan 4 - how do I enable and use the Query API?</a></li> <li><a href="#sid-18645132_InfinispanQueryv.4-LoggingDependency">5.6.4. Logging Dependency</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645133">6. Configuring cache programmatically</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645133_Configuringcacheprogrammatically-ProgrammaticConfiguration">6.1. Programmatic Configuration</a></li> <li><a href="#sid-18645133_Configuringcacheprogrammatically-ConfigurationBuilderProgrammaticConfigurationAPI">6.2. ConfigurationBuilder Programmatic Configuration API</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645133_Configuringcacheprogrammatically-Advancedprogrammaticconfiguration">6.2.1. Advanced programmatic configuration</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645134">7. Grid File System</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645134_GridFileSystem-WebDAVdemo">7.1. WebDAV demo</a></li> </ul> </li> <li><a href="#sid-18645135">8. Infinispan WebSocket Server</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645135_InfinispanWebSocketServer-StartingTheServer">8.1. Starting The Server</a></li> <li><a href="#sid-18645135_InfinispanWebSocketServer-JavascriptAPI">8.2. Javascript API</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645135_InfinispanWebSocketServer-CreatingaClientSideCacheObjectInstance">8.2.1. Creating a Client-Side Cache Object Instance</a></li> <li><a href="#sid-18645135_InfinispanWebSocketServer-CacheOperations">8.2.2. Cache Operations</a></li> </ul> </li> <li><a href="#sid-18645135_InfinispanWebSocketServer-Samplecode">8.3. Sample code</a></li> <li><a href="#sid-18645135_InfinispanWebSocketServer-BrowserSupport">8.4. Browser Support</a></li> <li><a href="#sid-18645135_InfinispanWebSocketServer-Screencast">8.5. Screencast</a></li> <li><a href="#sid-18645135_InfinispanWebSocketServer-Status">8.6. Status</a></li> <li><a href="#sid-18645135_InfinispanWebSocketServer-Source">8.7. Source</a></li> </ul> </li> <li><a href="#sid-18645136">9. Using Infinispan Memcached Server</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-Introduction">9.1. Introduction</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-StartinganInfinispanmemcachedserver">9.2. Starting an Infinispan memcached server</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-CommandLineOptions">9.3. Command Line Options</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-EnablingStatistics">9.4. Enabling Statistics</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-CommandClarifications">9.5. Command Clarifications</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-FlushAll">9.5.1. Flush All</a></li> </ul> </li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-UnsupportedFeatures">9.6. Unsupported Features</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-IndividualStats">9.6.1. Individual Stats</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-StatisticSettings">9.6.2. Statistic Settings</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-SettingswithArgumentsParameter">9.6.3. Settings with Arguments Parameter</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-DeleteHoldTimeParameter">9.6.4. Delete Hold Time Parameter</a></li> <li><a href="#sid-18645136_UsingInfinispanMemcachedServer-VerbosityCommand">9.6.5. Verbosity Command</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645137">10. Asynchronous API</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645137_AsynchronousAPI-WhyusesuchanAPI%3F">10.1. Why use such an API?</a></li> <li><a href="#sid-18645137_AsynchronousAPI-Whichprocessesactuallyhappenasynchronously%3F">10.2. Which processes actually happen asynchronously?</a></li> <li><a href="#sid-18645137_AsynchronousAPI-Notifyingfutures">10.3. Notifying futures</a></li> <li><a href="#sid-18645137_AsynchronousAPI-Furtherreading">10.4. Further reading</a></li> </ul> </li> <li><a href="#sid-18645138">11. Tree API Module</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645138_TreeAPIModule-Introduction">11.1. Introduction</a></li> <li><a href="#sid-18645138_TreeAPIModule-WhatisTreeAPIabout%3F">11.2. What is Tree API about?</a></li> <li><a href="#sid-18645138_TreeAPIModule-UsingTreeAPI">11.3. Using Tree API</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645138_TreeAPIModule-Dependencies">11.3.1. Dependencies</a></li> <li><a href="#sid-18645138_TreeAPIModule-CreatingaTreeCache">11.3.2. Creating a Tree Cache</a></li> <li><a href="#sid-18645138_TreeAPIModule-ManipulatingdatainaTreeCache">11.3.3. Manipulating data in a Tree Cache</a></li> <li><a href="#sid-18645138_TreeAPIModule-CommonOperations">11.3.4. Common Operations</a></li> </ul> </li> <li><a href="#sid-18645138_TreeAPIModule-LockingInTreeAPI">11.4. Locking In Tree API</a></li> </ul> </li> <li><a href="#sid-18645139">12. Infinispan as a Directory for Lucene</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-AdditionalLinks">12.1. Additional Links</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Lucenecompatibility">12.2. Lucene compatibility</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Howtouseit">12.3. How to use it</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Limitations">12.4. Limitations</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Configuration">12.5. Configuration</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Demo">12.6. Demo</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Mavendependencies">12.7. Maven dependencies</a></li> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-UsingaCacheLoader">12.8. Using a CacheLoader</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645139_InfinispanasaDirectoryforLucene-Storingtheindexinadatabase">12.8.1. Storing the index in a database</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645140">13. Infinispan Server Modules</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645140_InfinispanServerModules-Introduction">13.1. Introduction</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645140_InfinispanServerModules-ClientServeroverPeertoPeer">13.1.1. Client-Server over Peer-to-Peer</a></li> <li><a href="#sid-18645140_InfinispanServerModules-PeertoPeeroverClientServer">13.1.2. to-Peer over Client-Server</a></li> </ul> </li> <li><a href="#sid-18645140_InfinispanServerModules-ServerModules">13.2. Server Modules</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645140_InfinispanServerModules-RESTServerModule">13.2.1. REST Server Module</a></li> <li><a href="#sid-18645140_InfinispanServerModules-MemcachedServerModule">13.2.2. Memcached Server Module</a></li> <li><a href="#sid-18645140_InfinispanServerModules-HotRodServerModule">13.2.3. Hot Rod Server Module</a></li> <li><a href="#sid-18645140_InfinispanServerModules-WebSocketServerModule">13.2.4. WebSocket Server Module</a></li> </ul> </li> <li><a href="#sid-18645140_InfinispanServerModules-ServerComparisonSummary">13.3. Server Comparison Summary</a></li> </ul> </li> <li><a href="#sid-18645141">14. Management Tooling</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645141_ManagementTooling-Introduction">14.1. Introduction</a></li> <li><a href="#sid-18645141_ManagementTooling-JMX">14.2. JMX</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645141_ManagementTooling-EnablingJMXStatistics">14.2.1. Enabling JMX Statistics</a></li> <li><a href="#sid-18645141_ManagementTooling-MultipleJMXDomains">14.2.2. Multiple JMX Domains</a></li> <li><a href="#sid-18645141_ManagementTooling-RegisteringMBeansInNonDefaultMBeanServers">14.2.3. Registering MBeans In Non-Default MBean Servers</a></li> </ul> </li> <li><a href="#sid-18645141_ManagementTooling-RHQ">14.3. RHQ</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645141_ManagementTooling-RHQmonitoringtips">14.3.1. RHQ monitoring tips</a></li> </ul> </li> <li><a href="#sid-18645141_ManagementTooling-Writingpluginsforothermanagementtools">14.4. Writing plugins for other management tools</a></li> </ul> </li> <li><a href="#sid-18645142">15. Asynchronous Options</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645142_AsynchronousOptions-Introduction">15.1. Introduction</a></li> <li><a href="#sid-18645142_AsynchronousOptions-AsynchronousCommunications">15.2. Asynchronous Communications</a></li> <li><a href="#sid-18645142_AsynchronousOptions-AsynchronousMarshalling">15.3. Asynchronous Marshalling</a></li> <li><a href="#sid-18645142_AsynchronousOptions-ReplicationQueue">15.4. Replication Queue</a></li> <li><a href="#sid-18645142_AsynchronousOptions-AsynchronousAPI">15.5. Asynchronous API</a></li> <li><a href="#sid-18645142_AsynchronousOptions-ReturnValues">15.6. Return Values</a></li> </ul> </li> <li><a href="#sid-18645143">16. Infinispan as Hibernate 2nd-Level Cache in JBoss AS 5.x</a></li> <li><a href="#sid-18645144">17. Clustered Configuration QuickStart</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645144_ClusteredConfigurationQuickStart-UsinganexternalJGroupsfile">17.1. Using an external JGroups file</a></li> <li><a href="#sid-18645144_ClusteredConfigurationQuickStart-UseoneofthepreconfiguredJGroupsfiles">17.2. Use one of the pre-configured JGroups files</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645144_ClusteredConfigurationQuickStart-FinetuningJGroupssettings">17.2.1. tuning JGroups settings</a></li> </ul> </li> <li><a href="#sid-18645144_ClusteredConfigurationQuickStart-Furtherreading">17.3. Further reading</a></li> </ul> </li> <li><a href="#sid-18645145">18. Locking and Concurrency</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645145_LockingandConcurrency-MVCCimplementationdetails">18.1. MVCC implementation details</a></li> <li><a href="#sid-18645145_LockingandConcurrency-Isolationlevels">18.2. Isolation levels</a></li> <li><a href="#sid-18645145_LockingandConcurrency-TheLockManager">18.3. The LockManager</a></li> <li><a href="#sid-18645145_LockingandConcurrency-Lockstriping">18.4. Lock striping</a></li> <li><a href="#sid-18645145_LockingandConcurrency-Concurrencylevels">18.5. Concurrency levels</a></li> <li><a href="#sid-18645145_LockingandConcurrency-Explicitandimplicitdistributedeagerlocking">18.6. Explicit and implicit distributed eager locking</a></li> <li><a href="#sid-18645145_LockingandConcurrency-Lockingasingleremotenode">18.7. Locking a single remote node</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645145_LockingandConcurrency-Consistency">18.7.1. Consistency</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645146">19. Configuring Cache declaratively</a></li> <li><a href="#sid-18645147">20. Configuration Migration Tools</a></li> <li><a href="#sid-18645148">21. Consistent Concurrent Updates With Hot Rod Versioned Operations</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-Introduction">21.1. Introduction</a></li> <li><a href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-DataConsistencyProblem">21.2. Data Consistency Problem</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-PeertoPeerSolution">21.2.1. to-Peer Solution</a></li> <li><a href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-ClientServerSolution">21.2.2. Client-Server Solution</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645149">22. CacheLoaders</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645149_CacheLoaders-Introduction">22.1. Introduction</a></li> <li><a href="#sid-18645149_CacheLoaders-Configuration">22.2. Configuration</a></li> <li><a href="#sid-18645149_CacheLoaders-CachePassivation">22.3. Cache Passivation</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645149_CacheLoaders-CacheLoaderBehaviorwithPassivationDisabledvsEnabled">22.3.1. Cache Loader Behavior with Passivation Disabled vs Enabled</a></li> </ul> </li> <li><a href="#sid-18645149_CacheLoaders-Filesystembasedcacheloaders">22.4. File system based cache loaders</a></li> <li><a href="#sid-18645149_CacheLoaders-JDBCbasedcacheloaders">22.5. JDBC based cache loaders</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645149_CacheLoaders-WhichJDBCcacheloadershouldIuse%3F">22.5.1. Which JDBC cache loader should I use?</a></li> <li><a href="#sid-18645149_CacheLoaders-Connectionmanagement%28pooling%29">22.5.2. Connection management (pooling)</a></li> <li><a href="#sid-18645149_CacheLoaders-Sampleconfigurations">22.5.3. Sample configurations</a></li> </ul> </li> <li><a href="#sid-18645149_CacheLoaders-Cloudcacheloader">22.6. Cloud cache loader</a></li> <li><a href="#sid-18645149_CacheLoaders-Remotecacheloader">22.7. Remote cache loader</a></li> <li><a href="#sid-18645149_CacheLoaders-Cassandracacheloader">22.8. Cassandra cache loader</a></li> <li><a href="#sid-18645149_CacheLoaders-Clustercacheloader">22.9. Cluster cache loader</a></li> </ul> </li> <li><a href="#sid-18645150">23. Portable Serialization For Hot Rod With Apache Avro</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-Introduction">23.1. Introduction</a></li> <li><a href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-LanguagesSupported">23.2. Languages Supported</a></li> <li><a href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-ObjectTypesSupported">23.3. Object Types Supported</a></li> <li><a href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-JavaConfiguration">23.4. Java Configuration</a></li> </ul> </li> <li><a href="#sid-18645151">24. The Grouping API</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645151_TheGroupingAPI-Howdoesitwork%3F">24.1. How does it work?</a></li> <li><a href="#sid-18645151_TheGroupingAPI-HowdoIusethegroupingAPI%3F">24.2. How do I use the grouping API?</a></li> </ul> </li> <li><a href="#sid-18645152">25. Infinispan transactions</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645152_Infinispantransactions-JTASupport">25.1. JTA Support</a></li> <li><a href="#sid-18645152_Infinispantransactions-Configuringtransactions">25.2. Configuring transactions</a></li> <li><a href="#sid-18645152_Infinispantransactions-Transactionalmodes">25.3. Transactional modes</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645152_Infinispantransactions-OptimisticTransactions">25.3.1. Optimistic Transactions</a></li> <li><a href="#sid-18645152_Infinispantransactions-PessimisticTransactions">25.3.2. Pessimistic Transactions</a></li> <li><a href="#sid-18645152_Infinispantransactions-Backwardcompatibility">25.3.3. Backward compatibility</a></li> <li><a href="#sid-18645152_Infinispantransactions-WhatdoIneedpessimisticoroptimistictransactions%3F">25.3.4. What do I need - pessimistic or optimistic transactions?</a></li> </ul> </li> <li><a href="#sid-18645152_Infinispantransactions-Deadlockdetection">25.4. Deadlock detection</a></li> <li><a href="#sid-18645152_Infinispantransactions-Transactionandexceptions">25.5. Transaction and exceptions</a></li> <li><a href="#sid-18645152_Infinispantransactions-Transactionrecoveryonnodefailures">25.6. Transaction recovery on node failures</a></li> <li><a href="#sid-18645152_Infinispantransactions-EnlistingSynchronization">25.7. Enlisting Synchronization</a></li> </ul> </li> <li><a href="#sid-18645153">26. Load Testing Infinispan Server Modules</a></li> <li><a href="#sid-18645154">27. Using Infinispan as JPA-Hibernate Second Level Cache Provider</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-Overview">27.1. Overview</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-Configuration">27.2. Configuration</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultConfigurationExplained">27.3. Default Configuration Explained</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforEntity%2FCollectionCaching">27.3.1. Defaults for Entity/Collection Caching</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforQueryCaching">27.3.2. Defaults for Query Caching</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforTimestampsCache">27.3.3. Defaults for Timestamps Cache</a></li> </ul> </li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-JTATransactionsConfiguration">27.4. JTA Transactions Configuration</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-StandaloneJTAforJPA%2FHibernateusingInfinispanas2LC">27.4.1. Standalone JTA for JPA/Hibernate using Infinispan as 2LC</a></li> </ul> </li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-AdvancedConfiguration">27.5. Advanced Configuration</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-IntegrationwithJBossApplicationServer">27.6. Integration with JBoss Application Server</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-UsingInfinispanasremoteSecondLevelCache%3F">27.7. Using Infinispan as remote Second Level Cache?</a></li> <li><a href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-FrequentlyAskedQuestions">27.8. Frequently Asked Questions</a></li> </ul> </li> <li><a href="#sid-18645155">28. Default Values For Property Based Attributes</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-asyncListenerExecutor">28.1. asyncListenerExecutor</a></li> <li><a href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-asyncTransportExecutor">28.2. asyncTransportExecutor</a></li> <li><a href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-evictionScheduledExecutor">28.3. evictionScheduledExecutor</a></li> <li><a href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-replicationQueueScheduledExecutor">28.4. replicationQueueScheduledExecutor</a></li> </ul> </li> <li><a href="#sid-18645156">29. Running Infinispan on Amazon Web Services</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645156_RunningInfinispanonAmazonWebServices-TCPPing%2CGossipRouter%2CS3Ping">29.1. TCPPing, GossipRouter, S3_Ping</a></li> <li><a href="#sid-18645156_RunningInfinispanonAmazonWebServices-GossipRouter">29.2. GossipRouter</a></li> <li><a href="#sid-18645156_RunningInfinispanonAmazonWebServices-S3Ping">29.3. S3_Ping</a></li> <li><a href="#sid-18645156_RunningInfinispanonAmazonWebServices-JDBCPING">29.4. JDBC_PING</a></li> <li><a href="#sid-18645156_RunningInfinispanonAmazonWebServices-Creatingaclusternodewithdistributedcache">29.5. Creating a cluster node with distributed cache</a></li> </ul> </li> <li><a href="#sid-18645157">30. Eviction Examples</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645157_EvictionExamples-Introduction">30.1. Introduction</a></li> <li><a href="#sid-18645157_EvictionExamples-Configuration">30.2. Configuration</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645157_EvictionExamples-Defaultvalues">30.2.1. Default values</a></li> <li><a href="#sid-18645157_EvictionExamples-Usingexpiration">30.2.2. Using expiration</a></li> </ul> </li> <li><a href="#sid-18645157_EvictionExamples-Evictiondesigns">30.3. Eviction designs</a></li> </ul> </li> <li><a href="#sid-18645158">31. Clustering modes</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645158_Clusteringmodes-Introduction">31.1. Introduction</a></li> <li><a href="#sid-18645158_Clusteringmodes-LocalMode">31.2. Local Mode</a></li> <li><a href="#sid-18645158_Clusteringmodes-ReplicatedMode">31.3. Replicated Mode</a></li> <li><a href="#sid-18645158_Clusteringmodes-InvalidationMode">31.4. Invalidation Mode</a></li> <li><a href="#sid-18645158_Clusteringmodes-DistributionMode">31.5. Distribution Mode</a></li> <li><a href="#sid-18645158_Clusteringmodes-L1Caching">31.6. L1 Caching</a></li> </ul> </li> <li><a href="#sid-18645159">32. Using Infinispan as a Spring Cache provider</a></li> <li><a href="#sid-18645160">33. Distributed Data Stream Processing Framework In Infinispan</a></li> <li><a href="#sid-18645161">34. Invocation Flags</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645161_Per-InvocationFlags-Examples">34.1. Examples</a></li> <li><a href="#sid-18645161_Per-InvocationFlags-DecoratedCache">34.2. DecoratedCache</a></li> <li><a href="#sid-18645161_Per-InvocationFlags-Suppressingreturnvaluesfromaput%28%29orremove%28%29">34.3. Suppressing return values from a put() or remove()</a></li> </ul> </li> <li><a href="#sid-18645162">35. Key affinity service</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645162_Keyaffinityservice-Introduction">35.1. Introduction</a></li> <li><a href="#sid-18645162_Keyaffinityservice-API">35.2. API</a></li> <li><a href="#sid-18645162_Keyaffinityservice-Lifecycle">35.3. Lifecycle</a></li> <li><a href="#sid-18645162_Keyaffinityservice-Topologychanges">35.4. Topology changes</a></li> </ul> </li> <li><a href="#sid-18645163">36. Transaction recovery</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645163_Transactionrecovery-Whentouserecovery">36.1. When to use recovery</a></li> <li><a href="#sid-18645163_Transactionrecovery-Howdoesitwork">36.2. How does it work</a></li> <li><a href="#sid-18645163_Transactionrecovery-Configuringrecovery%C2%A0%C2%A0%C2%A0">36.3. Configuring recovery   </a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645163_Transactionrecovery-EnableJMXsupport">36.3.1. Enable JMX support</a></li> <li><a href="#sid-18645163_Transactionrecovery-Recoverycache">36.3.2. Recovery cache</a></li> </ul> </li> <li><a href="#sid-18645163_Transactionrecovery-IntegrationwiththeTM">36.4. Integration with the TM</a></li> <li><a href="#sid-18645163_Transactionrecovery-Reconciliatestate">36.5. conciliate state</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645163_Transactionrecovery-Forcecommit%2FrollbackbasedonXID">36.5.1. Force commit/rollback based on XID</a></li> </ul> </li> <li><a href="#sid-18645163_Transactionrecovery-Wanttoknowmore%3F">36.6. Want to know more?</a></li> </ul> </li> <li><a href="#sid-18645164">37. Implementing standalone JPA JTA Hibernate application outside J2EE server using Infinispan 2nd level cache</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Introduction">37.1. Introduction</a></li> <li><a href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-JBossTransactions">37.2. JBoss Transactions</a></li> <li><a href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-JOTM">37.3. JOTM</a></li> <li><a href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Bitronix">37.4. Bitronix</a></li> <li><a href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Atominkos">37.5. Atominkos</a></li> </ul> </li> <li><a href="#sid-18645165">38. Infinispan Maven Archetypes</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645165_InfinispanMavenArchetypes-Playingwithyournewproject">38.1. Playing with your new project</a></li> <li><a href="#sid-18645165_InfinispanMavenArchetypes-Onthecommandline...">38.2. On the command line&#8230;</a></li> <li><a href="#sid-18645165_InfinispanMavenArchetypes-WritingatestcaseforInfinispan">38.3. Writing a test case for Infinispan</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645165_InfinispanMavenArchetypes-Onthecommandline...x">38.3.1. On the command line&#8230;</a></li> <li><a href="#sid-18645165_InfinispanMavenArchetypes-Availableprofiles">38.3.2. Available profiles</a></li> <li><a href="#sid-18645165_InfinispanMavenArchetypes-ContributingtestsbacktoInfinispan">38.3.3. Contributing tests back to Infinispan</a></li> </ul> </li> <li><a href="#_versions">38.4. Versions</a></li> <li><a href="#sid-18645165_InfinispanMavenArchetypes-SourceCode">38.5. Source Code</a></li> </ul> </li> <li><a href="#sid-18645167">39. Accessing data in Infinispan via RESTful interface</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Puttingdatain">39.1. Putting data in</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-PUT%2F%5C%2F%5C">39.1.1. PUT /{cachename}/{cachekey}</a></li> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-POST%2F%5C%2F%5C">39.1.2. POST /{cachename}/{cachekey}</a></li> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Headers%3A">39.1.3. Headers:</a></li> </ul> </li> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Gettingdatabackout">39.2. Getting data back out</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-GET%2F%5C%2F%5C">39.2.1. GET /{cachename}/{cachekey}</a></li> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-HEAD%2F%5C%2F%5C">39.2.2. HEAD /{cachename}/{cachekey}</a></li> </ul> </li> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Removingdata">39.3. Removing data</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-DELETE%2F%5C%2F%5C">39.3.1. DELETE /{cachename}/{cachekey}</a></li> <li><a href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-DELETE%2F%5C">39.3.2. DELETE /{cachename}</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645168">40. Infinispan Distributed Execution Framework</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Introduction">40.1. Introduction</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Scopeandobjectives">40.2. Scope and objectives</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Cachedataastaskinputdata">40.3. Cache data as task input data</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Loadbalancedexecutionbuiltinbydefault">40.4. Load balanced execution - built in by default</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Distributedtasksinput">40.5. Distributed tasks input</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Distributedtaskfailoverandmigration">40.6. Distributed task failover and migration</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Distributedexecutionmodel">40.7. Distributed execution model</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-MapReducemodel">40.8. MapReduce model</a></li> <li><a href="#sid-18645168_InfinispanDistributedExecutionFramework-Examples">40.9. Examples</a></li> </ul> </li> <li><a href="#sid-18645169">41. Listeners and Notifications</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645169_ListenersandNotifications-Cachelevelnotifications">41.1. Cache-level notifications</a></li> <li><a href="#sid-18645169_ListenersandNotifications-Cachemanagerlevelnotifications">41.2. Cache manager-level notifications</a></li> <li><a href="#sid-18645169_ListenersandNotifications-Synchronicity">41.3. Synchronicity</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645169_ListenersandNotifications-Asynchronousthreadpool">41.3.1. Asynchronous thread pool</a></li> </ul> </li> <li><a href="#sid-18645169_ListenersandNotifications-ListenersonRemoteCacheManager">41.4. Listeners on RemoteCacheManager</a></li> </ul> </li> <li><a href="#sid-18645170">42. Eviction</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645170_Eviction-Evictionin4.0">42.1. Eviction in 4.0</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645170_Eviction-NONE">42.1.1. NONE</a></li> <li><a href="#sid-18645170_Eviction-UNORDERED">42.1.2. UNORDERED</a></li> <li><a href="#sid-18645170_Eviction-FIFO">42.1.3. FIFO</a></li> <li><a href="#sid-18645170_Eviction-LRU">42.1.4. LRU</a></li> <li><a href="#sid-18645170_Eviction-Tuningtheevictionthread">42.1.5. Tuning the eviction thread</a></li> </ul> </li> <li><a href="#sid-18645170_Eviction-Evictionin4.1%2C4.2and5.x">42.2. Eviction in 4.1, 4.2 and 5.x</a></li> <li><a href="#sid-18645170_Eviction-AdvancedEvictionInternals">42.3. Advanced Eviction Internals</a></li> <li><a href="#sid-18645170_Eviction-Expiration">42.4. Expiration</a></li> </ul> </li> <li><a href="#sid-18645171">43. ServerHinting</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645171_ServerHinting-Whatisserverhinting%3F">43.1. What is server hinting?</a></li> <li><a href="#sid-18645171_ServerHinting-Version">43.2. Version</a></li> <li><a href="#sid-18645171_ServerHinting-Configuration">43.3. Configuration</a></li> <li><a href="#sid-18645171_ServerHinting-Algorithm">43.4. Algorithm</a></li> </ul> </li> <li><a href="#sid-18645172">44. Java Hot Rod client</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645172_JavaHotRodclient-Introduction">44.1. Introduction</a></li> <li><a href="#sid-18645172_JavaHotRodclient-BasicAPI">44.2. Basic API</a></li> <li><a href="#sid-18645172_JavaHotRodclient-VersionedAPI">44.3. Versioned API</a></li> <li><a href="#sid-18645172_JavaHotRodclient-AsyncAPI">44.4. Async API</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Unsupportedmethods">44.5. Unsupported methods</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Returnvalues">44.6. Return values</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Intelligence">44.7. Intelligence</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Hashdistributionawareclient">44.8. distribution-aware client</a></li> <li><a href="#sid-18645172_JavaHotRodclient-RequestBalancing">44.9. Request Balancing</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Persistentconnections">44.10. Persistent connections</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Marshallingdata">44.11. Marshalling data</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Statistics">44.12. Statistics</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Configuration">44.13. Configuration</a></li> <li><a href="#sid-18645172_JavaHotRodclient-MultiGetOperations">44.14. Multi-Get Operations</a></li> <li><a href="#sid-18645172_JavaHotRodclient-Moreinfo">44.15. More info</a></li> </ul> </li> <li><a href="#sid-18645173">45. Configuring cache</a></li> <li><a href="#sid-18645174">46. Write-Through And Write-Behind Caching</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-Introduction">46.1. Introduction</a></li> <li><a href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-WriteThrough%28Synchronous%29">46.2. Write-Through (Synchronous)</a></li> <li><a href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-WriteBehind%28Asynchronous%29">46.3. Write-Behind (Asynchronous)</a></li> <li><a href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-UnscheduledWriteBehindStrategy">46.4. Unscheduled Write-Behind Strategy</a></li> <li><a href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-ScheduledWriteBehindStrategy">46.5. Scheduled Write-Behind Strategy</a></li> </ul> </li> <li><a href="#sid-18645175">47. Using Hot Rod Server</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645175_UsingHotRodServer-Introduction">47.1. Introduction</a></li> <li><a href="#sid-18645175_UsingHotRodServer-StartinganInfinispanHotRodserver">47.2. Starting an Infinispan Hot Rod server</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645175_UsingHotRodServer-CommandLineOptions">47.2.1. Command Line Options</a></li> <li><a href="#sid-18645175_UsingHotRodServer-PredefiningHotRodCaches">47.2.2. Predefining Hot Rod Caches</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645176">48. Cassandra CacheStore</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645176_CassandraCacheStore-Version">48.1. Version</a></li> </ul> </li> <li><a href="#sid-18645177">49. Infinispan Custom Interceptors</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645177_InfinispanCustomInterceptors-Introduction">49.1. Introduction</a></li> <li><a href="#sid-18645177_InfinispanCustomInterceptors-Addingcustominterceptorsdeclaratively">49.2. Adding custom interceptors declaratively</a></li> <li><a href="#sid-18645177_InfinispanCustomInterceptors-Custominterceptordesign">49.3. Custom interceptor design</a></li> </ul> </li> <li><a href="#sid-18645178">50. Talking To Infinispan Memcached Servers From Non-Java Clients</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645178_TalkingToInfinispanMemcachedServersFromNon-JavaClients-MultiClusteredServerTutorial">50.1. Multi Clustered Server Tutorial</a></li> </ul> </li> <li><a href="#sid-18645179">51. Plugging Infinispan With User Defined Externalizers</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-Introduction">51.1. Introduction</a></li> <li><a href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-BenefitsofExternalizers">51.2. Benefits of Externalizers</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-UserFriendlyExternalizers">51.2.1. User Friendly Externalizers</a></li> <li><a href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-AdvancedExternalizers">51.2.2. Advanced Externalizers</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645180">52. Using the Cache API</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645180_UsingtheCacheAPI-TheCacheinterface">52.1. The Cache interface</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645180_UsingtheCacheAPI-LimitationsofCertainMapMethods">52.1.1. Limitations of Certain Map Methods</a></li> <li><a href="#sid-18645180_UsingtheCacheAPI-MortalandImmortalData">52.1.2. Mortal and Immortal Data</a></li> <li><a href="#sid-18645180_UsingtheCacheAPI-ExampleofUsingExpiryandMortalData">52.1.3. Example of Using Expiry and Mortal Data</a></li> <li><a href="#sid-18645180_UsingtheCacheAPI-%7B%7BputForExternalRead%7D%7Doperation">52.1.4. putForExternalRead operation</a></li> </ul> </li> <li><a href="#sid-18645180_UsingtheCacheAPI-TheAdvancedCacheinterface">52.2. The AdvancedCache interface</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645180_UsingtheCacheAPI-Flags">52.2.1. Flags</a></li> <li><a href="#sid-18645180_UsingtheCacheAPI-CustomInterceptors">52.2.2. Custom Interceptors</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645181">53. Local mode cache</a></li> <li><a href="#sid-18645182">54. Infinispan Command-line Console</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Whatisispncon%3F">54.1. What is ispncon ?</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Installation">54.2. Installation</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Basicusage">54.3. Basic usage</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Configuration">54.4. Configuration</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Cacheoperations">54.5. Cache operations</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-put">54.5.1. put</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-get">54.5.2. get</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-delete">54.5.3. delete</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-clear">54.5.4. clear</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-exists">54.5.5. exists</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-version">54.5.6. version</a></li> </ul> </li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Othercommands">54.6. Other commands</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-help">54.6.1. help</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-config">54.6.2. config</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-include">54.6.3. include</a></li> </ul> </li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-Interoperabilitywithjavaclients">54.7. Interoperability with java clients</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-HTTPclients">54.7.1. HTTP clients</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-HotRodJavaClient">54.7.2. Hot Rod Java Client</a></li> <li><a href="#sid-18645182_InfinispanCommand-lineConsole-SpyMemcachedJavaClient">54.7.3. SpyMemcached Java Client</a></li> </ul> </li> </ul> </li> <li><a href="#sid-18645183">55. Server Command Line Options</a></li> <li><a href="#sid-18645184">56. Interacting With Hot Rod Server From Within Same JVM</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-Introduction">56.1. Introduction</a></li> <li><a href="#sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-DataStoredDirectlyViaAHotRodClient">56.2. Data Stored Directly Via A Hot Rod Client</a></li> <li><a href="#sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-DataStoredViaRemoteCacheStore">56.3. Data Stored Via Remote Cache Store</a></li> </ul> </li> <li><a href="#sid-18645185">57. Multiple Tiers of Caches</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645185_MultipleTiersofCaches-Introduction">57.1. Introduction</a></li> <li><a href="#sid-18645185_MultipleTiersofCaches-Buildingblocks">57.2. Building blocks</a></li> <li><a href="#sid-18645185_MultipleTiersofCaches-Samplearchitecture%2Fnearcaching">57.3. Sample architecture/near caching</a></li> <li><a href="#sid-18645185_MultipleTiersofCaches-Wanttoknowmore%3F">57.4. Want to know more?</a></li> </ul> </li> <li><a href="#sid-18645187">58. Infinispan REST Server</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645187_InfinispanRESTServer-Introduction">58.1. Introduction</a></li> <li><a href="#sid-18645187_InfinispanRESTServer-Configuration">58.2. Configuration</a></li> <li><a href="#sid-18645187_InfinispanRESTServer-AccessingDataviaURLs">58.3. Accessing Data - via URLs</a></li> <li><a href="#sid-18645187_InfinispanRESTServer-Clientsidecode">58.4. Client side code</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645187_InfinispanRESTServer-Rubyclientcode%3A">58.4.1. Ruby client code:</a></li> <li><a href="#sid-18645187_InfinispanRESTServer-Pythonclientcode%3A">58.4.2. Python client code:</a></li> <li><a href="#sid-18645187_InfinispanRESTServer-Javaclientcode%3A">58.4.3. Java client code:</a></li> </ul> </li> <li><a href="#sid-18645187_InfinispanRESTServer-Future%3A">58.5. Future:</a></li> </ul> </li> <li><a href="#sid-18645188">59. CDI Support</a></li> <li> <ul class="sectlevel2"> <li><a href="#sid-18645188_CDISupport-Introduction">59.1. Introduction</a></li> <li><a href="#sid-18645188_CDISupport-MavenDependencies">59.2. Maven Dependencies</a></li> <li><a href="#sid-18645188_CDISupport-Embeddedcacheintegration">59.3. Embedded cache integration</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645188_CDISupport-Injectanembeddedcache">59.3.1. Inject an embedded cache</a></li> <li><a href="#sid-18645188_CDISupport-Overridethedefaultembeddedcachemanagerandconfiguration">59.3.2. Override the default embedded cache manager and configuration</a></li> <li><a href="#sid-18645188_CDISupport-Configurethetransportforclustereduse">59.3.3. Configure the transport for clustered use</a></li> </ul> </li> <li><a href="#sid-18645188_CDISupport-Remotecacheintegration">59.4. Remote cache integration</a></li> <li> <ul class="sectlevel3"> <li><a href="#sid-18645188_CDISupport-Injectaremotecache">59.4.1. Inject a remote cache</a></li> <li><a href="#sid-18645188_CDISupport-Overridethedefaultremotecachemanager">59.4.2. Override the default remote cache manager</a></li> </ul> </li> <li><a href="#sid-18645188_CDISupport-Useacustomremote%2Fembeddedcachemanagerforoneormorecache">59.5. Use a custom remote/embedded cache manager for one or more cache</a></li> <li><a href="#sid-18645188_CDISupport-UseaJBossAS7configuredcache">59.6. Use a JBoss AS 7 configured cache</a></li> <li><a href="#sid-18645188_CDISupport-UseJCachecachingannotations">59.7. Use JCache caching annotations</a></li> </ul> </li> </ul> </div> </div> <div id="content"> <div class="sect1"> <h2 id="sid-18645130_UserGuide-NewinInfinispan4.1.0"><a class="anchor" href="#sid-18645130_UserGuide-NewinInfinispan4.1.0"></a>1. New in Infinispan 4.1.0</h2> <div class="sectionbody"> <div class="olist arabic"> <ol class="arabic"> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737034">Grid File System</a> using on Infinispan</p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737048">Server modules</a></p> </li> <li> <p>Hot Rod</p> </li> <li> <p><a href="#sid-18645192">Protocol specification (version 1)</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146">Using the Hot Rod server module</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142">Java Hot Rod client</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737101">Consistent concurrent updates with Hot Rod versioned operations</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737163">Multiple layers of caches</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737162">Interacting With Hot Rod Server From Within Same JVM</a></p> </li> <li> <p>Memcached</p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737037">Using Infinispan Memcached server</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737150">Talking to Memcached from non-Java clients</a></p> </li> <li> <p>WebSocket</p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737036">Infinispan Websocket server</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737109">Load testing server modules</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737161">Command line options</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737123">Key affinity service</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.1/configdocs/">Configuration Reference</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.1/apidocs/jmxComponents.html">JMX attributes and operations</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.1/apidocs/index.html">API docs (javadocs)</a></p> </li> </ol> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645130_UserGuide-NewinInfinispan4.2.0"><a class="anchor" href="#sid-18645130_UserGuide-NewinInfinispan4.2.0"></a>2. New in Infinispan 4.2.0</h2> <div class="sectionbody"> <div class="olist arabic"> <ol class="arabic"> <li> <p>Distribution</p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737141">Server Hinting</a></p> </li> <li> <p>Starting a new project with Infinispan - check out <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737129">Infinispan Maven Archetypes</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.2/apidocs/config.html">Configuration Reference</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.2/apidocs/jmxComponents.html">JMX attributes and operations</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.2/apidocs/index.html">API docs (javadocs)</a></p> </li> </ol> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645130_UserGuide-NewinInfinispan5.0.0"><a class="anchor" href="#sid-18645130_UserGuide-NewinInfinispan5.0.0"></a>3. New in Infinispan 5.0.0</h2> <div class="sectionbody"> <div class="olist arabic"> <ol class="arabic"> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737123">Generating keys mapped to specific cluster nodes</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737105">Portable Serialization for Hot Rod with Apache Avro</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737151">Plugging Infinispan with user defined Externalizers</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737134">Distributed Executors Framework</a></p> </li> <li> <p><a href="#sid-18645133">Fluent Programmatic Configuration</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/5.0/apidocs/config.html">Configuration Reference</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/5.0/apidocs/jmxComponents.html">JMX attributes and operations</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/5.0/apidocs/index.html">API docs (javadocs)</a></p> </li> </ol> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645130_UserGuide-Integrationwithotherframeworks"><a class="anchor" href="#sid-18645130_UserGuide-Integrationwithotherframeworks"></a>4. Integration with other frameworks</h2> <div class="sectionbody"> <div class="olist arabic"> <ol class="arabic"> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737110">Using Infinispan as JPA/Hibernate Second Level Cache Provider</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737126">Standalone JTA for JPA/Hibernate using Infinispan as 2LC</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737057">Infinispan as Hibernate 2nd-Level Cache in JBoss AS 5.x</a></p> </li> <li> <p><a href="http://community.jboss.org/docs/16180">Using Infinispan in JBoss Application Server 6</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737118">Using Infinispan as Spring Cache provider</a></p> </li> </ol> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645131"><a class="anchor" href="#sid-18645131"></a>5. Querying Infinispan</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645131_QueryingInfinispan-Theinfinispanquerymodule"><a class="anchor" href="#sid-18645131_QueryingInfinispan-Theinfinispanquerymodule"></a>5.1. The infinispan-query module</h3> <div class="literalblock"> <div class="content"> <pre>This module adds querying capabilities to Infinispan. It uses link:$$https://www.hibernate.org/410.html$$[Hibernate Search] and link:$$http://lucene.apache.org/java/docs/index.html$$[Apache Lucene] to index and search objects in the cache. It allows users to obtain objects within the cache without needing to know the keys to each object that they want to obtain, so you can now search your objects basing on some of it's properties, for example to retrieve all red cars (exact metadata match), or all books about a specific topic (full text search and relevance scoring).</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-UsagewithInfinispan5"><a class="anchor" href="#sid-18645131_QueryingInfinispan-UsagewithInfinispan5"></a>5.1.1. Usage with Infinispan 5</h4> <div class="paragraph"> <p>Indexing must be enabled in the configuration (as explained in the next paragraph); then you interact with the Search capabilities via a SearchManager which exposes all needed functionality.</p> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645131_QueryingInfinispan-Simpleexample"><a class="anchor" href="#sid-18645131_QueryingInfinispan-Simpleexample"></a>5.2. Simple example</h3> <div class="literalblock"> <div class="content"> <pre>We're going to store _Book_ instances in Infinispan; each _Book_ will be defined as in the following example; we have to choose which properties are indexed, and for each property we can optionally choose advanced indexing options using the annotations defined in the Hibernate Search project.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>// example values stored in the cache and indexed:
import org.hibernate.search.annotations.*;

//to be indexed the object needs both @Indexed and @ProvidedId annotations:
@Indexed @ProvidedId
public class Book {
   @Field String title;
   @Field String description;
   @Field @DateBridge(resolution=Resolution.YEAR) Date publicationYear;
   @IndexedEmbedded Set&lt;Author&gt; authors = new HashSet&lt;Author&gt;();
}

public class Author {
   @Field String name;
   @Field String surname;
   // hashCode() and equals() omitted
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Now assuming we stored several _Book_ instances in our Infinispan _Cache_ , we can search them for any matching field as in the following example.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>// get the search manager from the cache:
SearchManager searchManager = org.infinispan.query.Search.getSearchManager(cache);

// create any standard Lucene query, via Lucene's QueryParser or any other means:
org.apache.lucene.search.Query fullTextQuery = //any Apache Lucene Query

// convert the Lucene query to a CacheQuery:
CacheQuery cacheQuery = searchManager.getQuery( fullTextQuery );

// get the results:
List&lt;Object&gt; found = cacheQuery.list();

</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>A Lucene Query is often created by parsing a query in text format such as "title:infinispan AND authors.name:sanne", or by using the query builder provided by Hibernate Search.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>// get the search manager from the cache:
SearchManager searchManager = org.infinispan.query.Search.getSearchManager( cache );

// you could make the queries via Lucene APIs, or use some helpers:
QueryBuilder queryBuilder = searchManager.buildQueryBuilderForClass( Book.class ).get();

// the queryBuilder has a nice fluent API which guides you through all options.
// this has some knowledge about your object, for example which Analyzers
// need to be applied, but the output is a failry standard Lucene Query.
org.apache.lucene.search.Query luceneQuery = queryBuilder.phrase()
                  .onField( "description" )
                  .andField( "title" )
                  .sentence( "a book on highly scalable query engines" )
                  .createQuery();

// the query API itself accepts any Lucene Query, and on top of that
// you can restrict the result to selected class types:
CacheQuery query = searchManager.getQuery( luceneQuery, Book.class );

// and there are your results!
List&lt;Book&gt; objectList = query.list();

for ( Book book : objectList ) {
      System.out.println( book.getTitle() );
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>A part from _list()_ you have the option for streaming results, or use pagination.</pre> </div> </div> <div class="paragraph"> <p>This barely scratches the surface of all what is possible to do: see the Hibernate Search reference documentation to learn about sorting, numeric fields, declarative filters, caching filters, complex object graph indexing, custom types and the powerfull faceting search API.</p> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-NotabledifferenceswithHibernateSearch"><a class="anchor" href="#sid-18645131_QueryingInfinispan-NotabledifferenceswithHibernateSearch"></a>5.2.1. Notable differences with Hibernate Search</h4> <div class="literalblock"> <div class="content"> <pre>Using _@DocumentId_ to mark a field as identifier is not supported; instead all _@Indexed_ objects should also be marked with _@ProvidedId_ : Infinispan will provide the identifier, which is the key used to store each value in the cache.</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645131_QueryingInfinispan-ConfigurationviaXML"><a class="anchor" href="#sid-18645131_QueryingInfinispan-ConfigurationviaXML"></a>5.3. Configuration via XML</h3> <div class="literalblock"> <div class="content"> <pre>To enable indexing via XML, you need to add the &amp;lt;indexing ... /&amp;gt; element to your cache configuration, and optionally pass additional properties to the embedded Hibernate Search engine:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;infinispan
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="urn:infinispan:config:5.1 http://www.infinispan.org/schemas/infinispan-config-5.1.xsd"
      xmlns="urn:infinispan:config:5.1"&gt;
   &lt;default&gt;
      &lt;indexing enabled="true" indexLocalOnly="true"&gt;
         &lt;properties&gt;
            &lt;property name="hibernate.search.default.directory_provider" value="ram" /&gt;
         &lt;/properties&gt;
      &lt;/indexing&gt;
   &lt;/default&gt;
&lt;/infinispan&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In this example the index is stored in memory, so when this nodes is shutdown the index is lost: good for a quick demo, but in real world cases you'll want to use the default (store on filesystem) or store the index in Infinispan as well. For the complete reference of properties to define, refer to the link:$$http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration$$[Hibernate Search documentation] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645131_QueryingInfinispan-Usingprogrammaticconfigurationandindexmapping"><a class="anchor" href="#sid-18645131_QueryingInfinispan-Usingprogrammaticconfigurationandindexmapping"></a>5.4. Using programmatic configuration and index mapping</h3> <div class="literalblock"> <div class="content"> <pre>In the following example we start Infinispan programmatically, avoiding XML configuration files, and also map an object _Author_ which is to be stored in the grid and made searchable on two properties but without annotating the class.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
SearchMapping mapping = new SearchMapping();
mapping.entity(Author.class).indexed().providedId()
      .property("name", ElementType.METHOD).field()
      .property("surname", ElementType.METHOD).field();

Properties properties = new Properties();
properties.put(org.hibernate.search.Environment.MODEL_MAPPING, mapping);
properties.put("hibernate.search.[other options]", "[...]");

Configuration infinispanConfiguration = new ConfigurationBuilder()
      .indexing()
         .enable()
         .indexLocalOnly(true)
         .withProperties(properties)
      .build();

DefaultCacheManager cacheManager = new DefaultCacheManager(infinispanConfiguration);

Cache&lt;Long, Author&gt; cache = cacheManager.getCache();
SearchManager sm = Search.getSearchManager(cache);

Author author = new Author(1, "Manik", "Surtani");
cache.put(author.getId(), author);

QueryBuilder qb = sm.buildQueryBuilderForClass(Author.class).get();
Query q = qb.keyword().onField("name").matching("Manik").createQuery();
CacheQuery cq = sm.getQuery(q, Author.class);
Assert.assertEquals(cq.getResultSize(), 1);
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645131_QueryingInfinispan-Cachemodesandmanagingindexes"><a class="anchor" href="#sid-18645131_QueryingInfinispan-Cachemodesandmanagingindexes"></a>5.5. Cache modes and managing indexes</h3> <div class="paragraph"> <p>Index management is currently controlled by the Configuration.setIndexLocalOnly() setter, or the &lt;indexing indexLocalOnly="true" /&gt; XML element. If you set this to true, only modifications made locally on each node are considered in indexing. Otherwise, remote changes are considered too.</p> </div> <div class="literalblock"> <div class="content"> <pre>Regarding actually configuring a Lucene directory, please refer to the link:$$http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration$$[Hibernate Search documentation] on how to pass in the appropriate Lucene configuration via the Properties object passed to QueryHelper.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-LOCAL"><a class="anchor" href="#sid-18645131_QueryingInfinispan-LOCAL"></a>5.5.1. LOCAL</h4> <div class="paragraph"> <p>In local mode, you may use any Lucene Directory implementation. And it doesn&#8217;t matter what you set indexLocalOnly to.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-REPLICATION"><a class="anchor" href="#sid-18645131_QueryingInfinispan-REPLICATION"></a>5.5.2. REPLICATION</h4> <div class="literalblock"> <div class="content"> <pre>In replication mode, each node can have it's own local copy of the index. So indexes can either be stored locally on each node (RAMDirectory, FSDirectory, etc) but you need to set _indexLocalOnly_ to _false_ , so that each node will apply needed updates it receives from other nodes in addition to the updates started locally. Any Directory implementation can be used, but you have to make sure that when a new node is started it receives an up to date copy of the index; typically rsync is well suited for this task, but being an external operation you might end up with a slightly out-of-sync index, especially if updates are very frequent.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Alternately, if you use some form of shared storage for indexes (see _Sharing the Index_ ), you then have to set _indexLocalOnly_ to _true_ so that each node will apply only the changes originated locally; in this case there's no risk in having an out-of-sync index, but to avoid write contention on the index you should make sure that a single node is "in charge" of updating the index. Again, the Hibernate Search reference documentation describes means to use link:$$http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#jms-backend$$[a JMS queue] or link:$$http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#jgroups-backend$$[JGroups] to send indexing tasks to a master node.</pre> </div> </div> <div class="paragraph"> <p>The diagram below shows a replicated deployment, in which each node has a local index.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-DISTRIBUTIONandINVALIDATION"><a class="anchor" href="#sid-18645131_QueryingInfinispan-DISTRIBUTIONandINVALIDATION"></a>5.5.3. DISTRIBUTION and INVALIDATION</h4> <div class="literalblock"> <div class="content"> <pre>For these 2 cache modes, you _need_ to use a shared index and set indexLocalOnly to true. In future, we will be able to deal with truly distributed queries, but that would be after link:$$https://jira.jboss.org/jira/browse/ISPN-200$$[ISPN-200] .</pre> </div> </div> <div class="paragraph"> <p>The diagram below shows a deployment with a shared index. Note that while not mandatory, a shared index can be used for replicated (vs. distributed) caches as well.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-SharingtheIndex"><a class="anchor" href="#sid-18645131_QueryingInfinispan-SharingtheIndex"></a>5.5.4. Sharing the Index</h4> <div class="paragraph"> <p>The most simple way to share an index is to use some form of shared storage for the indexes, like an FSDirectory on a shared disk; however this form is problematic as the FSDirectory relies on specific locking semantics which are often incompletely implemented on network filesystems, or not reliable enough; if you go for this approach make sure to search for potential problems on the Lucene mailing lists for other experiences and workarounds. Good luck, test well.</p> </div> <div class="literalblock"> <div class="content"> <pre>There are many alternative Directory implementations you can find, one of the most suited approaches when working with Infinispan is of course to store the index in an Infinispan cache: have a look at the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737047$$[InfinispanDirectoryProvider] , as all Infinispan based layers it can be combined with persistent CacheLoaders to keep the index on a shared filesystem withouth the locking issues, or alternatively in a database, cloud storage, or any other CacheLoader implementation; you could backup the index in the same store used to backup your values.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For full documentation on clustering the Lucene engine, refer to the link:$$http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#search-configuration$$[Hibernate Search documentation] to properly configure it clustered.</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645131_QueryingInfinispan-ClusteringtheIndexinInfinispan"><a class="anchor" href="#sid-18645131_QueryingInfinispan-ClusteringtheIndexinInfinispan"></a>5.5.5. Clustering the Index in Infinispan</h4> <div class="literalblock"> <div class="content"> <pre>Again the configuration details are in the Hibernate Search reference, in particular in the link:$$http://docs.jboss.org/hibernate/stable/search/reference/en-US/html_single/#infinispan-directories$$[infinispan-directories] section. This backend will by default start a secondary Infinispan CacheManager, and optionally take another Infinispan configuration file: don't reuse the same configuration or you will start grids recursively! It is currently not possible to share the same CacheManager.</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645132"><a class="anchor" href="#sid-18645132"></a>5.6. Infinispan Query v.4</h3> <div class="literalblock"> <div class="content"> <pre>This document is only relevant to the technology preview of Infinispan Query before version 5, as the API changed. Information about the latest version is link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737030$$[here] .</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645132_InfinispanQueryv.4-Theinfinispanquerymodule"><a class="anchor" href="#sid-18645132_InfinispanQueryv.4-Theinfinispanquerymodule"></a>5.6.1. The infinispan-query module</h4> <div class="literalblock"> <div class="content"> <pre>This module adds querying capabilities to Infinispan. It uses link:$$https://www.hibernate.org/410.html$$[Hibernate Search] and link:$$http://lucene.apache.org/java/docs/index.html$$[Apache Lucene] to index and search objects in the cache. It allows users to obtain objects within the cache without needing to know the keys to each object that they want to obtain, so you can now search your objects basing on some of it's properties, for example to retrieve all red cars (exact metadata match), or all books about a specific topic (full text search and relevance scoring).</pre> </div> </div> <div class="sect4"> <h5 id="sid-18645132_InfinispanQueryv.4-UsagewithInfinispan4"><a class="anchor" href="#sid-18645132_InfinispanQueryv.4-UsagewithInfinispan4"></a>Usage with Infinispan 4</h5> <div class="paragraph"> <p>Indexing must be enabled in the configuration of the Infinispan cache.</p> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645132_InfinispanQueryv.4-ConfigurationviaXML"><a class="anchor" href="#sid-18645132_InfinispanQueryv.4-ConfigurationviaXML"></a>5.6.2. Configuration via XML</h4> <div class="paragraph"> <p>To enable indexing via XML, you need to add the &lt;indexing &#8230; /&gt; element to your &lt;namedCache &#8230; /&gt; or &lt;default &#8230; /&gt; section:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;infinispan&gt;
     &lt;default&gt;
          &lt;indexing enabled="true" indexLocalOnly="false" /&gt;
     &lt;/default&gt;
&lt;/infinispan&gt;
</pre> </div> </div> <div class="paragraph"> <p>You still need to use the QueryHelper (see code example below) to specify the class types you wish to index. This is transparent to you in Infinispan 5.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645132_InfinispanQueryv.4-SamplecodewithInfinispan4howdoIenableandusetheQueryAPI%3F"><a class="anchor" href="#sid-18645132_InfinispanQueryv.4-SamplecodewithInfinispan4howdoIenableandusetheQueryAPI%3F"></a>5.6.3. Sample code with Infinispan 4 - how do I enable and use the Query API?</h4> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.Cache;
import org.infinispan.config.Configuration;
import org.infinispan.manager.DefaultCacheManager;
import org.infinispan.query.CacheQuery;
import org.infinispan.query.QueryFactory;
import org.infinispan.query.QueryIterator;
import org.infinispan.query.backend.QueryHelper;

import java.util.List;
import java.util.Properties;

public class MyFirstQueryClass  {

  public void queryMyCache()  {

     Configuration cfg = new Configuration();
     cfg.setIndexingEnabled(true);
     // set any other configuration attributes you may need
     // alternatively, you could configure this using XML

     Cache c = new DefaultCacheManager(cfg).getCache();

     // The QueryHelper must be instantiated before putting objects into the cache.
     QueryHelper qh = new QueryHelper(c, new Properties(), myClassToQuery.class);

     // Let's say I have a separate method that puts a bunch of things in the cache as per normal.
     putStuffInCache();

     // When I want to query objects in the cache, I will create a QueryFactory.
     QueryFactory qf = new QueryFactory(c, qh);

     // Let's say I'm searching on a field called "name" and looking for "John".
     CacheQuery cq = qf.getBasicQuery("name", "John");

     // Now I can put all my hits into a list!
     List found = cq.list();

     // I can also just get the number of hits that I have. This is cheap as it
     // doesn't load objects from the cache.
     int hits = cq.getResultSize();

     // The CacheQuery interface has 2 kinds of iterators. They both implement the same interface but
     // have different implementations under the hood. One loads all hits from the cache first and the
     // other on the fly. They both implement the QueryIterator interface.
     QueryIterator eagerIterator = cq.iterator();
     QueryIterator lazyIterator = cq.lazyIterator();

     // From here, there are various other API methods on the interface.
     // For example, I can pick out the first and last elements of all my hits.
     eagerIterator.first();
     Object first = eagerIterator.next();

     lazyIterator.last();
     Object last = lazyIterator.previous();
  }
}</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645132_InfinispanQueryv.4-LoggingDependency"><a class="anchor" href="#sid-18645132_InfinispanQueryv.4-LoggingDependency"></a>5.6.4. Logging Dependency</h4> <div class="paragraph"> <p>The query module uses Hibernate Search which in turn uses SLF4J as logging framework. This framework expects users to decide which SLF4J logging implementation they want use, either log4j, jdk&#8230;etc. Neither Hibernate Search nor the Infinispan query module make any assumptions which means that if you haven&#8217;t chosen any implementations, when you start your query module based app, you&#8217;ll get an exception like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>Exception in thread "pool-1-thread-1" java.lang.NoClassDefFoundError: org/slf4j/impl/StaticLoggerBinder
    at org.slf4j.LoggerFactory.getSingleton(LoggerFactory.java:223)
    at org.slf4j.LoggerFactory.bind(LoggerFactory.java:120)
    at org.slf4j.LoggerFactory.performInitialization(LoggerFactory.java:111)
    at org.slf4j.LoggerFactory.getILoggerFactory(LoggerFactory.java:269)
    at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:242)
    at org.hibernate.search.util.LoggerFactory.make(LoggerFactory.java:38)
    at org.hibernate.search.Version.&lt;clinit&gt;(Version.java:40)
    at org.hibernate.search.impl.SearchFactoryImpl.&lt;clinit&gt;(SearchFactoryImpl.java:102)
    at org.infinispan.query.backend.QueryHelper.&lt;init&gt;(QueryHelper.java:104)
    at org.infinispan.demo.InfinispanDemo$10.run(InfinispanDemo.java:377)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:619)
Caused by: java.lang.ClassNotFoundException: org.slf4j.impl.StaticLoggerBinder
    at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
    at java.security.AccessController.doPrivileged(Native Method)
    at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:307)
    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:248)
    ... 13 more
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>To get around it, make sure you select a SLF4J implementation and add the corresponding dependency. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;dependency&gt;
   &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
   &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
   &lt;version&gt;1.5.8&lt;/version&gt;
&lt;/dependency&gt;
</pre> </div> </div> <div class="paragraph"> <p>Infinispan versions 5.x use JBoss Logging, which will pick a logger without throwing exceptions.</p> </div> <div class="sect4"> <h5 id="sid-18645132_InfinispanQueryv.4-NotabledifferenceswithHibernateSearch"><a class="anchor" href="#sid-18645132_InfinispanQueryv.4-NotabledifferenceswithHibernateSearch"></a>Notable differences with Hibernate Search</h5> <div class="literalblock"> <div class="content"> <pre>Using _@DocumentId_ to mark a field as identifier is not supported; instead all _@Indexed_ objects should also be marked with _@ProvidedId_ : Infinispan will provide the identifier, which is the key used to store each value in the cache.</pre> </div> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645133"><a class="anchor" href="#sid-18645133"></a>6. Configuring cache programmatically</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645133_Configuringcacheprogrammatically-ProgrammaticConfiguration"><a class="anchor" href="#sid-18645133_Configuringcacheprogrammatically-ProgrammaticConfiguration"></a>6.1. Programmatic Configuration</h3> <div class="literalblock"> <div class="content"> <pre>Programmatic Infinispan configuration is centered around CacheManager and ConfigurationBuilder API. Although every single aspect of Infinispan configuration could be set programmatically, the most usual approach is to create a starting point in a form of XML configuration file and then in runtime, if needed, programmatically tune a specific configuration to suit the use case best.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
EmbeddedCacheManager manager = new DefaultCacheManager("my-config-file.xml");
Cache defaultCache = manager.getCache();
</pre> </div> </div> <div class="paragraph"> <p>Let assume that a new synchronously replicated cache is to be configured programmatically. First, a fresh instance of Configuration object is created using ConfigurationBuilder helper object, and the cache mode is set to synchronous replication. Finally, the configuration is defined/registered with a manager.</p> </div> <div class="listingblock"> <div class="content"> <pre>Configuration c = new ConfigurationBuilder().clustering().cacheMode(CacheMode.REPL_SYNC).build();

String newCacheName = "repl";
manager.defineConfiguration(newCacheName, c);
Cache&lt;String, String&gt; cache = manager.getCache(newCacheName);
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The default cache configuration (or any other cache configuration) can be used as a starting point for creation of a new cache. For example, lets say that infinispan-config-file.xml specifies a replicated cache as a default and that a distributed cache is desired with a specific L1 lifespan while at the same time retaining all other aspects of a default cache. Therefore, the starting point would be to read an instance of a default Configuration object and use ConfigurationBuilder to construct and modify cache mode and L1 lifespan on a new Configuration object. As a final step the configuration is defined/registered with a manager.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>EmbeddedCacheManager manager = new DefaultCacheManager("infinispan-config-file.xml");
Configuration dcc = cacheManager.getDefaultCacheConfiguration();
Configuration c = new ConfigurationBuilder().read(dcc).clustering().cacheMode(CacheMode.DIST_SYNC).l1().lifespan(60000L).build();

String newCacheName = "distributedWithL1";
manager.defineConfiguration(newCacheName, c);
Cache&lt;String, String&gt; cache = manager.getCache(newCacheName);
</pre> </div> </div> <div class="paragraph"> <p>As long as the based configuration is the default named cache, the previous code works perfectly fine. However, other times the base configuration might be another named cache. So, how can new configurations be defined based on other defined caches? Take the previous example and imagine that instead of taking the default cache as base, a named cache called "replicatedCache" is used as base. The code would look something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>EmbeddedCacheManager manager = new DefaultCacheManager("infinispan-config-file.xml");
Configuration rc = cacheManager.getCacheConfiguration("replicatedCache");
Configuration c = new ConfigurationBuilder().read(rc).clustering().cacheMode(CacheMode.DIST_SYNC).l1().lifespan(60000L).build();

String newCacheName = "distributedWithL1";
manager.defineConfiguration(newCacheName, c);
Cache&lt;String, String&gt; cache = manager.getCache(newCacheName);
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Refer to link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/manager/CacheManager.html$$[CacheManager] , link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/configuration/cache/ConfigurationBuilder.html$$[ConfigurationBuilder] , link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/configuration/cache/Configuration.html$$[Configuration] , and link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/configuration/global/GlobalConfiguration.html$$[GlobalConfiguration] javadocs for more details.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645133_Configuringcacheprogrammatically-ConfigurationBuilderProgrammaticConfigurationAPI"><a class="anchor" href="#sid-18645133_Configuringcacheprogrammatically-ConfigurationBuilderProgrammaticConfigurationAPI"></a>6.2. ConfigurationBuilder Programmatic Configuration API</h3> <div class="paragraph"> <p>However, users do not have to first read an XML based configuration and then modify it in runtime; they can start from scratch using only programmatic API. This is where powerful ConfigurationBuilder API comes to shine. The aim of this API is to make it easier to chain coding of configuration options in order to speed up the coding itself and make the configuration more readable. This new configuration can be used for both the global and the cache level configuration. GlobalConfiguration objects are constructed using GlobalConfigurationBuilder while Configuration objects are built using ConfigurationBuilder. Let&#8217;s look at some examples on configuring both global and cache level options with this new API:</p> </div> <div class="literalblock"> <div class="content"> <pre>One of the most commonly configured global option is the transport layer, where you indicate how an Infinispan node will discover the others:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfig = new GlobalConfigurationBuilder().transport()
        .clusterName("qa-cluster")
        .addProperty("configurationFile", "jgroups-tcp.xml")
        .machineId("qa-machine").rackId("qa-rack")
      .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Sometimes you might also want to get link:$$http://docs.jboss.org/infinispan/5.0/apidocs/jmxComponents.html$$[global JMX statistics] and information about the transport, or the cache manager in general. To enable global JMX statistics simply do:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfig = new GlobalConfigurationBuilder()
  .globalJmxStatistics()
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Further options at the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737050$$[global JMX statistics level] allows you for example to configure the cache manager name which comes handy when you have multiple cache managers running on the same system, or how to locate the JMX MBean Server:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfig = new GlobalConfigurationBuilder()
  .globalJmxStatistics()
    .cacheManagerName("SalesCacheManager")
    .mBeanServerLookupClass(JBossMBeanServerLookup.class)
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Some of the Infinispan features are powered by a group of the thread pool executors which can also be tweaked at this global level. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfig = new GlobalConfigurationBuilder()
  .replicationQueueScheduledExecutor()
    .factory(DefaultScheduledExecutorFactory.class)
    .addProperty("threadNamePrefix", "RQThread")
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>You can not only configure global, cache manager level, options, but you can also configure cache level options such as the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737115$$[cluster mode] :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Configuration config = new ConfigurationBuilder()
  .clustering()
    .cacheMode(CacheMode.DIST_SYNC)
    .sync()
    .l1().lifespan(25000L)
    .hash().numOwners(3)
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Or you can configure link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737139$$[eviction/expiration settings] to:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Configuration config = new ConfigurationBuilder()
           .eviction()
             .maxEntries(20000).strategy(EvictionStrategy.LIRS).expiration()
             .wakeUpInterval(5000L)
             .maxIdle(120000L)
           .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>An application might also want to interact with an Infinispan cache within the boundaries of JTA and to do that you need to configure the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737108$$[transaction layer] and optionally tweak the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737096$$[locking settings] . When interacting with transactional caches, you might want to link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737124$$[enable recovery] to deal with transactions that finished with an heuristic outcome and if you do that, you will often want to enable JMX management and statistics gathering too:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Configuration config = new ConfigurationBuilder()
  .locking()
    .concurrencyLevel(10000).isolationLevel(IsolationLevel.REPEATABLE_READ)
    .lockAcquisitionTimeout(12000L).useLockStriping(false).writeSkewCheck(true)
  .transaction()
    .recovery()
    .transactionManagerLookup(new GenericTransactionManagerLookup())
  .jmxStatistics()
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Configuring Infinispan with link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737103$$[one or several chained persistent stores] is simple too:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Configuration config = new ConfigurationBuilder()
      .loaders()
        .shared(false).passivation(false).preload(false)
        .addFileCacheStore().location("/tmp").streamBufferSize(1800).async().enable().threadPoolSize(20).build();</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645133_Configuringcacheprogrammatically-Advancedprogrammaticconfiguration"><a class="anchor" href="#sid-18645133_Configuringcacheprogrammatically-Advancedprogrammaticconfiguration"></a>6.2.1. Advanced programmatic configuration</h4> <div class="literalblock"> <div class="content"> <pre>The fluent configuration can also be used to configure more advanced or exotic options, such as link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737151$$[advanced externalizers] :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfig = new GlobalConfigurationBuilder()
  .serialization()
    .addAdvancedExternalizer(PersonExternalizer.class)
    .addAdvancedExternalizer(999, AddressExternalizer.class)
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Or, add link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737149$$[custom interceptors] :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Configuration config = new ConfigurationBuilder()
  .customInterceptors().interceptors()
    .add(new FirstInterceptor()).first()
    .add(new LastInterceptor()).last()
    .add(new FixPositionInterceptor()).atIndex(8)
    .add(new AfterInterceptor()).after(LockingInterceptor.class)
    .add(new BeforeInterceptor()).before(CallInterceptor.class)
  .build();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For information on the individual configuration options, please check the link:$$http://docs.jboss.org/infinispan/5.0/apidocs/config.html$$[configuration guide] .</pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645134"><a class="anchor" href="#sid-18645134"></a>7. Grid File System</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan&#8217;s GridFileSystem is a new, experimental API that exposes an Infinispan-backed data grid as a file system. This API is available in Infinispan 4.1.0 (from 4.1.0.ALPHA2 onwards).</p> </div> <div class="literalblock"> <div class="content"> <pre>Specifically, the API works as an extension to the JDK's link:$$http://java.sun.com/javase/6/docs/api/java/io/File.html$$[File] , link:$$http://java.sun.com/javase/6/docs/api/java/io/InputStream.html$$[InputStream] and link:$$http://java.sun.com/javase/6/docs/api/java/io/OutputStream.html$$[OutputStream] classes: specifically, link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/io/GridFile.html$$[GridFile] , link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/io/GridInputStream.html$$[GridInputStream] and link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/io/GridOutputStream.html$$[GridOutputStream] .  A helper class, link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/io/GridFilesystem.html$$[GridFilesystem] , is also included.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Essentially, the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/io/GridFilesystem.html$$[GridFilesystem] is backed by 2 Infinispan caches - one for metadata (typically replicated) and one for the actual data (typically distributed).  The former is replicated so that each node has metadata information locally and would not need to make RPC calls to list files, etc.  The latter is distributed since this is where the bulk of storage space is used up, and a scalable mechanism is needed here.  Files themselves are chunked and each chunk is stored as a cache entry, as a byte array.</pre> </div> </div> <div class="paragraph"> <p>Here is a quick code snippet demonstrating usage:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Cache&lt;String,byte[]&gt; data = cacheManager.getCache("distributed");
Cache&lt;String,GridFile.Metadata&gt; metadata = cacheManager.getCache("replicated");
GridFilesystem fs = new GridFilesystem(data, metadata);

// Create directories
File file=fs.getFile("/tmp/testfile/stuff");
fs.mkdirs(); // creates directories /tmp/testfile/stuff

// List all files and directories under "/usr/local"
file=fs.getFile("/usr/local");
File[] files=file.listFiles();

// Create a new file
file=fs.getFile("/tmp/testfile/stuff/README.txt");
file.createNewFile();
</pre> </div> </div> <div class="paragraph"> <p>Copying stuff to the grid file system:</p> </div> <div class="listingblock"> <div class="content"> <pre>InputStream in=new FileInputStream("/tmp/my-movies/dvd-image.iso");
OutputStream out=fs.getOutput("/grid-movies/dvd-image.iso");
byte[] buffer=new byte[20000];
int len;
while((len=in.read(buffer, 0, buffer.length)) != -1) out.write(buffer, 0, len);
in.close();
out.close();
</pre> </div> </div> <div class="paragraph"> <p>Reading stuff from the grid:</p> </div> <div class="listingblock"> <div class="content"> <pre>InputStream in=in.getInput("/grid-movies/dvd-image.iso");
OutputStream out=new FileOutputStream("/tmp/my-movies/dvd-image.iso");
byte[] buffer=new byte[200000];
int len;
while((len=in.read(buffer, 0, buffer.length)) != -1) out.write(buffer, 0, len);
in.close();
out.close();
</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645134_GridFileSystem-WebDAVdemo"><a class="anchor" href="#sid-18645134_GridFileSystem-WebDAVdemo"></a>7.1. WebDAV demo</h3> <div class="literalblock"> <div class="content"> <pre>Infinispan 4.1.0 also ships with a demo link:$$http://en.wikipedia.org/wiki/WebDAV$$[WebDAV] application that makes use of the grid file system APIs.  This demo app is packaged as a link:$$http://en.wikipedia.org/wiki/WAR_(Sun_file_format)$$[WAR] file which can be deployed in a servlet container, such as JBoss AS or Tomcat, and exposes the grid as a file system over WebDAV.  This could then be mounted as a remote drive on your operating system.</pre> </div> </div> <div class="paragraph"> <p>Here is a short video clip showcasing this demo:</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645135"><a class="anchor" href="#sid-18645135"></a>8. Infinispan WebSocket Server</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>The Infinispan WebSocket Server can be used to expose an Infinispan Cache instance over a link:$$http://dev.w3.org/html5/websockets/$$[WebSocket Interface] via a very simple Javascript "Cache" API.  The WebSocket Interface was introduced as part of the HTML 5 specification.  It defines a full-duplex communication channel to the browser, operating over a single socket (unlike Comet or Ajax) and is exposed to the browser via a Javascript interface.</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-StartingTheServer"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-StartingTheServer"></a>8.1. Starting The Server</h3> <div class="literalblock"> <div class="content"> <pre>The Infinispan WebSocket server is included in Infinispan distributions from _4.1.0.BETA1_ onwards, in both the -bin.zip and -all.zip archives.  To start the server, use the bin/startServer.sh (or bin\startServer.bat) command-line scripts, using the -r websocket switch.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>$ bin/startServer.sh -r websocket</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For more help on available switches, check out the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737161$$[server command line options article] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-JavascriptAPI"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-JavascriptAPI"></a>8.2. Javascript API</h3> <div class="literalblock"> <div class="content"> <pre>Writing a web page that uses the Infinispan Cache API is trivial.  The page simply needs to include a &amp;lt;script&amp;gt; declaration for the infinispan-ws.js Javascript source file.  This script is served up by WebSocket Server.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>So, for loading infinispan-ws.js from a WebSocket Server instance running on _www.acme.com:8181_ (default port):</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;script type="text/javascript" src="&lt;a href="http://www.acme.com:61999/infinispan-ws.js" target="_blank"&gt;http://www.acme.com:8181/infinispan-ws.js&lt;/a&gt;" /&gt;</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645135_InfinispanWebSocketServer-CreatingaClientSideCacheObjectInstance"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-CreatingaClientSideCacheObjectInstance"></a>8.2.1. Creating a Client-Side Cache Object Instance</h4> <div class="literalblock"> <div class="content"> <pre>The client-side interface to a server-side Infinispan cache is the Cache Javascript object.  It can be constructed as follows:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;script type="text/javascript"&gt;
    var cache = new Cache();
   
    // etc...
&lt;/script&gt;</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>By default, the Cache instance will interface to the default Infinispan Cache associated with the WebSocket Server from which the infinispan-ws.js Javascript source file was loaded.  So, in the above case, the Cache object instance will connect to the WebSocket Server running on _www.acme.com:8181_ (i.e. _ws://www.acme.com:8181_ ).</pre> </div> </div> <div class="paragraph"> <p>The Infinispan Cache name and WebSocket Server address can be specified in the {{cache} object constructor as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre>var cache = new Cache("omCache", "ws://ws.acmews.com:8181");
// etc...</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645135_InfinispanWebSocketServer-CacheOperations"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-CacheOperations"></a>8.2.2. Cache Operations</h4> <div class="literalblock"> <div class="content"> <pre>A number of cache operations can be performed via the Cache object instance such as _get_ , _put_ , _remove_ , _notify_ and _unnotify_ .</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The get and notify operations require a callback function to be registered with the Cache object instance.  This callback function receives all add/update/remove notifications on any cache entries for which the notify function was invoked.  It also asynchronously receives the result of a single invocation of the get function i.e. get can be thought of as "notify once, immediately".</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The callback function is registered with the Cache object instance via the registerCallback function.  The function should have 2 parameters - key and value , relating to the cache key and value.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>var cache = new Cache();

// Ask to be notified about some cache entries...
cache.notify("orderStatus");
cache.notify("expectedDeliveryTime");

// Register the callback function for receiving notifcations...
cache.registerCallback(cacheCallback);

// Cache callback function...
function cacheCallback(key, value) {
    // Handle notification...
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Getting and updating data in the cache is done by simply calling the get , put and remove functions on the Cache object instance.  These operations could be triggered by user interaction with a web form e.g.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;form onsubmit="return false;"&gt;

    &lt;!-- Other form components... --&gt;

    &lt;!-- Buttons for making cache updates... --&gt;
    &lt;input type="button" value="Put"
           onclick="cache.put(this.form.key.value, this.form.val.value)" /&gt;
    &lt;input type="button" value="Get"
           onclick="cache.get(this.form.key.value)" /&gt;
    &lt;input type="button" value="Remove"
           onclick="cache.remove(this.form.key.value)" /&gt;
&lt;/form&gt;
</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-Samplecode"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-Samplecode"></a>8.3. Sample code</h3> <div class="literalblock"> <div class="content"> <pre>Infinispan's source tree contains a sample HTML document that makes use of the WebSocket server.  Browse through the source of this HTML document link:$$http://fisheye.jboss.org/browse/Infinispan/trunk/server/websocket/src/main/distribution/sample-websocket-client.html$$[here] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-BrowserSupport"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-BrowserSupport"></a>8.4. Browser Support</h3> <div class="literalblock"> <div class="content"> <pre>At the time of writing, Google Chrome was the only browser with native WebSocket support.  However, the link:$$http://jwebsocket.org/$$[jWebSocket] project provides a client side Javascript library that adds WebSocket support to any Flash enabled browser.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-Screencast"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-Screencast"></a>8.5. Screencast</h3> <div class="literalblock"> <div class="content"> <pre>See the following link:$$http://www.screencast.com/t/ZGEzNDJlY$$[demo of the Infinispan WebSocket Server] in action.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-Status"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-Status"></a>8.6. Status</h3> <div class="paragraph"> <p>Prototype/Alpha.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645135_InfinispanWebSocketServer-Source"><a class="anchor" href="#sid-18645135_InfinispanWebSocketServer-Source"></a>8.7. Source</h3> <div class="literalblock"> <div class="content"> <pre>link:$$https://github.com/infinispan/infinispan/tree/master/server/websocket$$[Browse Infinispan's Git repository] .</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645136"><a class="anchor" href="#sid-18645136"></a>9. Using Infinispan Memcached Server</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645136_UsingInfinispanMemcachedServer-Introduction"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-Introduction"></a>9.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Starting with version 4.1, Infinispan distribution contains a server module that implements the link:$$http://github.com/memcached/memcached/blob/master/doc/protocol.txt$$[memcached text protocol] . This allows memcached clients to talk to one or serveral Infinispan backed memcached servers. These servers could either be working standalone just like memcached does where each server acts independently and does not communicate with the rest, or they could be clustered where servers replicate or distribute their contents to other Infinispan backed memcached servers, thus providing clients with failover capabilities.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645136_UsingInfinispanMemcachedServer-StartinganInfinispanmemcachedserver"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-StartinganInfinispanmemcachedserver"></a>9.2. Starting an Infinispan memcached server</h3> <div class="literalblock"> <div class="content"> <pre>The simplest way to start up an Infinispan memcached server is to simply unzip the all distribution and either run the startServer.bat or startServer.sh script passing memcached as the protocol to run. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>dnb:infinispan-4.0.0-SNAPSHOT galder$ ./bin/startServer.sh -r memcached</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>When the script is called without any further parameters, the started Infinispan memcached server bounds to _port 11211 on localhost_ (127.0.0.1) and uses a local (unclustered) Infinispan cache instance configured with default values underneath.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645136_UsingInfinispanMemcachedServer-CommandLineOptions"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-CommandLineOptions"></a>9.3. Command Line Options</h3> <div class="literalblock"> <div class="content"> <pre>You can optionally pass a set of parameters to the Infinispan memcached server that allow you to configure different parts of the server.  You can find detailed information in the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737161$$[server command line options article] .</pre> </div> </div> <div class="paragraph"> <p>Please note that the mapping between Infinispan Memcached server instances and Infinispan Cache instances is 1 to 1. Therefore, when passing an Infinispan configuration file to the Infinispan Memcache server, the cache created is based of the default cache configuration defined in the file.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645136_UsingInfinispanMemcachedServer-EnablingStatistics"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-EnablingStatistics"></a>9.4. Enabling Statistics</h3> <div class="paragraph"> <p>To be able to query stats, make sure you enable jmx statistics in the default cache via XML configuration. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;default&gt;
   ...
   &lt;jmxStatistics enabled="true"/&gt;
   ...
&lt;/default&gt;
</pre> </div> </div> <div class="paragraph"> <p>Note that since Infinispan 4.2.0.CR1, Infinispan Memcached server has jmx statistics enabled by default, so it&#8217;s not necessary to pass a configuration file with jmx statistics enabled in order to query Memcached statistics.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645136_UsingInfinispanMemcachedServer-CommandClarifications"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-CommandClarifications"></a>9.5. Command Clarifications</h3> <div class="sect3"> <h4 id="sid-18645136_UsingInfinispanMemcachedServer-FlushAll"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-FlushAll"></a>9.5.1. Flush All</h4> <div class="literalblock"> <div class="content"> <pre>Even in a clustered environment, flush_all command leads to the clearing of the Infinispan Memcached server where the call lands. There's no attempt to propagate this flush to other nodes in the cluster. This is done so that flush_all with delay use case can be reproduced with the Infinispan Memcached server. The aim of passing a delay to flush_all is so that different Memcached servers in a full can be flushed at different times, and hence avoid overloading the database with requests as a result of all Memcached servers being empty. For more info, check the link:$$http://github.com/memcached/memcached/blob/master/doc/protocol.txt$$[Memcached text protocol section on flush_all] .</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645136_UsingInfinispanMemcachedServer-UnsupportedFeatures"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-UnsupportedFeatures"></a>9.6. Unsupported Features</h3> <div class="paragraph"> <p>This section explains those parts of the memcached text protocol that for one reason or the other, are not currently supported by the Infinispan based memcached implementation.</p> </div> <div class="sect3"> <h4 id="sid-18645136_UsingInfinispanMemcachedServer-IndividualStats"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-IndividualStats"></a>9.6.1. Individual Stats</h4> <div class="paragraph"> <p>Due to difference in nature between the original memcached implementation which is C/C++ based and the Infinispan implementation which is Java based, there&#8217;re some general purpose stats that are not supported. For these unsupported stats, Infinispan memcached server always returns 0.</p> </div> <div class="paragraph"> <p>Here&#8217;s the list of currently unsupported stats:</p> </div> <div class="ulist"> <ul> <li> <p>pid</p> </li> <li> <p>pointer_size</p> </li> <li> <p>rusage_user</p> </li> <li> <p>rusage_system</p> </li> <li> <p>bytes</p> </li> <li> <p>curr_connections</p> </li> <li> <p>total_connections</p> </li> <li> <p>connection_structures</p> </li> <li> <p>auth_cmds</p> </li> <li> <p>auth_errors</p> </li> <li> <p>limit_maxbytes</p> </li> <li> <p>threads</p> </li> <li> <p>conn_yields</p> </li> <li> <p>reclaimed</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645136_UsingInfinispanMemcachedServer-StatisticSettings"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-StatisticSettings"></a>9.6.2. Statistic Settings</h4> <div class="paragraph"> <p>The settings statistics section of the text protocol has not been implemented due to its volatility.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645136_UsingInfinispanMemcachedServer-SettingswithArgumentsParameter"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-SettingswithArgumentsParameter"></a>9.6.3. Settings with Arguments Parameter</h4> <div class="literalblock"> <div class="content"> <pre>Since the arguments that can be send to the Memcached server are not documented, Infinispan Memcached server does not support passing any arguments to stats command. If any parameters are passed, the Infinispan Memcached server will respond with a CLIENT_ERROR .</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645136_UsingInfinispanMemcachedServer-DeleteHoldTimeParameter"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-DeleteHoldTimeParameter"></a>9.6.4. Delete Hold Time Parameter</h4> <div class="paragraph"> <p>Memcached does no longer honor optional hold time parameter to delete command and so the Infinispan based memcached server does not implement such feature either.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645136_UsingInfinispanMemcachedServer-VerbosityCommand"><a class="anchor" href="#sid-18645136_UsingInfinispanMemcachedServer-VerbosityCommand"></a>9.6.5. Verbosity Command</h4> <div class="paragraph"> <p>Verbosity command is not supported since Infinispan logging cannot be simplified to defining the logging level alone.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645137"><a class="anchor" href="#sid-18645137"></a>10. Asynchronous API</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>In addition to synchronous API methods like link:$$http://java.sun.com/javase/6/docs/api/java/util/Map.html#put%28K,%20V%29$$[Cache.put()] , link:$$http://java.sun.com/javase/6/docs/api/java/util/Map.html#remove%28java.lang.Object%29$$[Cache.remove()] , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#putAsync%28K,%20V%29$$[Cache.putAsync()] , link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#removeAsync%28java.lang.Object%29$$[Cache.removeAsync()] , etc.  These asynchronous counterparts return a link:$$http://download.oracle.com/javase/6/docs/api/java/util/concurrent/Future.html$$[Future] containing the actual result of the operation.</pre> </div> </div> <div class="paragraph"> <p>For example, in a cache paramerized as Cache&lt;String, String&gt;, Cache.put(String key, String value) returns a String.  Cache.putAsync(String key, String value) would return a Future&lt;String&gt;.</p> </div> <div class="sect2"> <h3 id="sid-18645137_AsynchronousAPI-WhyusesuchanAPI%3F"><a class="anchor" href="#sid-18645137_AsynchronousAPI-WhyusesuchanAPI%3F"></a>10.1. Why use such an API?</h3> <div class="paragraph"> <p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>Set&lt;Future&lt;?&gt;&gt; futures = new HashSet&lt;Future&lt;?&gt;&gt;();
futures.add(cache.putAsync(key1, value1)); // does not block
futures.add(cache.putAsync(key2, value2)); // does not block
futures.add(cache.putAsync(key3, value3)); // does not block

// the remote calls for the 3 puts will effectively be executed
// in parallel, particularly useful if running in distributed mode
// and the 3 keys would typically be pushed to 3 different nodes
// in the cluster

// check that the puts completed successfully
for (Future&lt;?&gt; f: futures) f.get();
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645137_AsynchronousAPI-Whichprocessesactuallyhappenasynchronously%3F"><a class="anchor" href="#sid-18645137_AsynchronousAPI-Whichprocessesactuallyhappenasynchronously%3F"></a>10.2. Which processes actually happen asynchronously?</h3> <div class="literalblock"> <div class="content"> <pre>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation.  These are, in terms of cost, network calls, marshalling, writing to a cache store (optional), and locking.  As of Infinispan 4.0, using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller's thread.  In future, we plan to take these offline as well.  See link:$$http://lists.jboss.org/pipermail/infinispan-dev/2010-January/002219.html$$[this developer mail list thread] about this topic.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645137_AsynchronousAPI-Notifyingfutures"><a class="anchor" href="#sid-18645137_AsynchronousAPI-Notifyingfutures"></a>10.3. Notifying futures</h3> <div class="literalblock"> <div class="content"> <pre>Strictly, these methods do not return JDK Futures, but rather a sub-interface known as a link:$$http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/util/concurrent/NotifyingFuture.html$$[NotifyingFuture] .  The main difference is that you can attach a listener to a NotifyingFuture such that you could be notified when the future completes.  Here is an example of making use of a notifying future:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
FutureListener futureListener = new FutureListener() {

   public void futureDone(Future future) {
      try {
         future.get();
      } catch (Exception e) {
         // Future did not complete successfully
         System.out.println("Help!");
      }
   }
};
     
cache.putAsync("key", "value").attachListener(futureListener);
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645137_AsynchronousAPI-Furtherreading"><a class="anchor" href="#sid-18645137_AsynchronousAPI-Furtherreading"></a>10.4. Further reading</h3> <div class="literalblock"> <div class="content"> <pre>The Javadocs on the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html$$[Cache] interface has some examples on using the asynchronous API, as does link:$$http://infinispan.blogspot.com/2009/05/whats-so-cool-about-asynchronous-api.html$$[this article] by Manik Surtani introducing the API.</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645138"><a class="anchor" href="#sid-18645138"></a>11. Tree API Module</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645138_TreeAPIModule-Introduction"><a class="anchor" href="#sid-18645138_TreeAPIModule-Introduction"></a>11.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>link:$$http://docs.jboss.org/infinispan/4.2/apidocs/org/infinispan/tree/package-summary.html$$[Infinispan's tree API module] offers clients the possibility of storing data using a tree-structure like API. This API is similar to the one link:$$http://docs.jboss.org/jbosscache/3.2.1.GA/apidocs/org/jboss/cache/package-summary.html$$[provided by JBoss Cache] , hence the tree module is perfect for those users wanting to migrate their applications from JBoss Cache to Infinispan, who want to limit changes their codebase as part of the migration. Besides, it's important to understand that Infinispan provides this tree API much more efficiently than JBoss Cache did, so if you're a user of the tree API in JBoss Cache, you should consider migrating to Infinispan.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645138_TreeAPIModule-WhatisTreeAPIabout%3F"><a class="anchor" href="#sid-18645138_TreeAPIModule-WhatisTreeAPIabout%3F"></a>11.2. What is Tree API about?</h3> <div class="literalblock"> <div class="content"> <pre>The aim of this API is to store information in a hierarchical way. The hierarchy is defined using paths represented as link:$$http://docs.jboss.org/infinispan/4.2/apidocs/org/infinispan/tree/Fqn.html$$[Fqn or fully qualified names] , for example: _/this/is/a/fqn/path_ or _/another/path_ . In the hierarchy, there's an special path called root which represents the starting point of all paths and it's represented as: _/_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Each FQN path is represented as a node where users can store data using a key/value pair style API (i.e. a Map). For example, in _/persons/john_ , you could store information belonging to John, for example: surname=Smith, birthdate=05/02/1980...etc.</pre> </div> </div> <div class="paragraph"> <p>Please remember that users should not use root as a place to store data. Instead, users should define their own paths and store data there. The following sections will delve into the practical aspects of this API.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645138_TreeAPIModule-UsingTreeAPI"><a class="anchor" href="#sid-18645138_TreeAPIModule-UsingTreeAPI"></a>11.3. Using Tree API</h3> <div class="sect3"> <h4 id="sid-18645138_TreeAPIModule-Dependencies"><a class="anchor" href="#sid-18645138_TreeAPIModule-Dependencies"></a>11.3.1. Dependencies</h4> <div class="literalblock"> <div class="content"> <pre>For your application to use the tree API, you need to import infinispan-tree.jar which can be located in the Infinispan binary distributions, or you can simply add a dependency to this module in your pom.xml:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;dependencies&gt;
  ...
  &lt;dependency&gt;
    &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
    &lt;artifactId&gt;infinispan-tree&lt;/artifactId&gt;
    &lt;version&gt;$put-infinispan-version-here&lt;/version&gt;
  &lt;/dependency&gt;
  ...
&lt;/dependencies&gt;
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645138_TreeAPIModule-CreatingaTreeCache"><a class="anchor" href="#sid-18645138_TreeAPIModule-CreatingaTreeCache"></a>11.3.2. Creating a Tree Cache</h4> <div class="literalblock"> <div class="content"> <pre>The first step to use the tree API is to actually create a tree cache. To do so, you need to link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737143$$[create an Infinispan Cache as you'd normally do] , and using the link:$$http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/TreeCacheFactory.html$$[TreeCacheFactory] , create an instance of link:$$http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/TreeCache.html$$[TreeCache] . A very important note to remember here is that the Cache instance passed to the factory must be configured with link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737131$$[invocation batching] . For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.config.Configuration;
import org.infinispan.tree.TreeCacheFactory;
import org.infinispan.tree.TreeCache;
...
Configuration config = new Configuration();
config.setInvocationBatchingEnabled(true);
Cache cache = new DefaultCacheManager(config).getCache();
TreeCache treeCache = TreeCacheFactory.createTreeCache(cache);
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645138_TreeAPIModule-ManipulatingdatainaTreeCache"><a class="anchor" href="#sid-18645138_TreeAPIModule-ManipulatingdatainaTreeCache"></a>11.3.3. Manipulating data in a Tree Cache</h4> <div class="paragraph"> <p>The Tree API effectively provides two ways to interact with the data:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Via <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> convenience methods: These methods are located within the TreeCache interface and enable users to <a href="http://docs.jboss.org/infinispan/4.2/apidocs/org/infinispan/tree/TreeCache.html#put(java.lang.String, K, V)">store</a> , <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/TreeCache.html#get(org.infinispan.tree.Fqn, K)">retrieve</a> , <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/TreeCache.html#move(org.infinispan.tree.Fqn, org.infinispan.tree.Fqn)">move</a> , <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/TreeCache.html#remove(org.infinispan.tree.Fqn, K)">remove</a> &#8230;etc data with a single call that takes the <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/Fqn.html">Fqn</a> , in String or Fqn format, and the data involved in the call. For example:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>treeCache.put("/persons/john", "surname", "Smith");</pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.tree.Fqn;
...
Fqn johnFqn = Fqn.fromString("persons/john");
Calendar calendar = Calendar.getInstance();
calendar.set(1980, 5, 2);
treeCache.put(johnFqn, "birthdate", calendar.getTime()));
</pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Via <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/Node.html">Node</a> API: It allows finer control over the individual nodes that form the FQN, allowing manipulation of nodes relative to a particular node. For example:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.tree.Node;
...
TreeCache treeCache = ...
Fqn johnFqn = Fqn.fromElements("persons", "john");
Node&lt;String, Object&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put("surname", "Smith");
</pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre>Node persons = treeCache.getRoot().addChild(Fqn.fromString("persons"));
Node&lt;String, Object&gt; john = persons.addChild(Fqn.fromString("john"));
john.put("surname", "Smith");
</pre> </div> </div> <div class="paragraph"> <p>Or even:</p> </div> <div class="listingblock"> <div class="content"> <pre>Fqn personsFqn = Fqn.fromString("persons");
Fqn johnFqn = Fqn.fromRelative(personsFqn, Fqn.fromString("john"));
Node&lt;String, Object&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put("surname", "Smith");
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>A node also provides the ability to access its link:$$http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/Node.html#getParent()$$[parent] or link:$$http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/tree/Node.html#getChildren()$$[children] . For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Node&lt;String, Object&gt; john = ...
Node persons = john.getParent();
</pre> </div> </div> <div class="paragraph"> <p>Or:</p> </div> <div class="listingblock"> <div class="content"> <pre>Set&lt;Node&lt;String, Object&gt;&gt; personsChildren = persons.getChildren();</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645138_TreeAPIModule-CommonOperations"><a class="anchor" href="#sid-18645138_TreeAPIModule-CommonOperations"></a>11.3.4. Common Operations</h4> <div class="paragraph"> <p>In the previous section, some of the most used operations, such as addition and retrieval, have been shown. However, there are other important operations that are worth mentioning, such as remove:</p> </div> <div class="literalblock"> <div class="content"> <pre>You can for example remove an entire node, i.e. _/persons/john_ , using:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>treeCache.removeNode("/persons/john");</pre> </div> </div> <div class="paragraph"> <p>Or remove a child node, i.e. persons that a child of root, via:</p> </div> <div class="listingblock"> <div class="content"> <pre>treeCache.getRoot().removeChild(Fqn.fromString("persons"));</pre> </div> </div> <div class="paragraph"> <p>You can also remove a particular key/value pair in a node:</p> </div> <div class="listingblock"> <div class="content"> <pre>Node john = treeCache.getRoot().getChild(Fqn.fromElements("persons", "john"));
john.remove("surname");</pre> </div> </div> <div class="paragraph"> <p>Or you can remove all data in a node with:</p> </div> <div class="listingblock"> <div class="content"> <pre>Node john = treeCache.getRoot().getChild(Fqn.fromElements("persons", "john"));
john.clearData();</pre> </div> </div> <div class="paragraph"> <p>Another important operation supported by Tree API is the ability to move nodes around in the tree. Imagine we have a node called "john" which is located under root node. The following example is going to show how to we can move "john" node to be under "persons" node:</p> </div> <div class="paragraph"> <p>Current tree structure:</p> </div> <div class="listingblock"> <div class="content"> <pre>
   /persons
   /john
</pre> </div> </div> <div class="paragraph"> <p>Moving trees from one FQN to another:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Node john = treeCache.getRoot().addChild(Fqn.fromString("john"));
Node persons = treeCache.getRoot().getChild(Fqn.fromString("persons"));
treeCache.move(john.getFqn(), persons.getFqn());
</pre> </div> </div> <div class="paragraph"> <p>Final tree structure:</p> </div> <div class="listingblock"> <div class="content"> <pre>
   /persons/john
</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645138_TreeAPIModule-LockingInTreeAPI"><a class="anchor" href="#sid-18645138_TreeAPIModule-LockingInTreeAPI"></a>11.4. Locking In Tree API</h3> <div class="paragraph"> <p>Understanding when and how locks are acquired when manipulating the tree structure is important in order to maximise the performance of any client application interacting against the tree, while at the same time maintaining consistency.</p> </div> <div class="paragraph"> <p>Locking on the tree API happens on a per node basis. So, if you&#8217;re putting or updating a key/value under a particular node, a write lock is acquired for that node. In such case, no write locks are acquired for parent node of the node being modified, and no locks are acquired for children nodes.</p> </div> <div class="paragraph"> <p>If you&#8217;re adding or removing a node, the parent is not locked for writing. In JBoss Cache, this behaviour was configurable with the default being that parent was not locked for insertion or removal.</p> </div> <div class="paragraph"> <p>Finally, when a node is moved, the node that&#8217;s been moved and any of its children are locked, but also the target node and the new location of the moved node and its children. To understand this better, let&#8217;s look at an example:</p> </div> <div class="paragraph"> <p>Imagine you have a hierarchy like this and we want to move c/ to be underneath b/:</p> </div> <div class="listingblock"> <div class="content"> <pre>        /
      --|--
     /     \
     a     c
     |     |
     b     e
     |
     d
</pre> </div> </div> <div class="paragraph"> <p>The end result would be something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>        /
        |         
        a    
        |    
        b    
      --|--
     /     \
     d     c
           |
           e
</pre> </div> </div> <div class="paragraph"> <p>To make this move, locks would have been acquired on:</p> </div> <div class="ulist"> <ul> <li> <p><em>/a/b</em> - because it&#8217;s the parent underneath which the data will be put</p> </li> <li> <p><em>/c</em> and <em>/c/e</em> - because they&#8217;re the nodes that are being moved</p> </li> <li> <p><em>/a/b/c</em> and <em>/a/b/c/e</em> - because that&#8217;s new target location for the nodes being moved</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645139"><a class="anchor" href="#sid-18645139"></a>12. Infinispan as a Directory for Lucene</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan is including a highly scalable distributed _Apache Lucene Directory_ implementation.</pre> </div> </div> <div class="paragraph"> <p>This directory closely mimicks the same semantics of the traditional filesystem and RAM-based directories, being able to work as a drop-in replacement for existing applications using Lucene and providing reliable index sharing and other features of Infinispan like node autodiscovery, automatic failover and rebalancing, optionally transactions, and can be backed by traditional storage solutions as filesystem, databases or cloud store engines.</p> </div> <div class="literalblock"> <div class="content"> <pre>The implementation extends Lucene's _org.apache.lucene.store.Directory_ so it can be used to _store_ the index in a cluster-wide shared memory, making it easy to distribute the index. Compared to rsync-based replication this solution is suited for use cases in which your application makes frequent changes to the index and you need them to be quickly distributed to all nodes, having configurable consistency levels, synchronicity and guarantees, total elasticity and autodiscovery; also changes applied to the index can optionally participate in a JTA transaction; since version 5 supporting XA transactions with recovery.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Two different _LockFactory_ implementations are provided to guarantee only one _IndexWriter_ at a time will make changes to the index, again implementing the same semantics as when opening an index on a local filesystem. As with other Lucene Directories, you can override the _LockFactory_ if you prefer to use an alternative implementation.</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-AdditionalLinks"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-AdditionalLinks"></a>12.1. Additional Links</h3> <div class="literalblock"> <div class="content"> <pre>Javadoc: link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/lucene/InfinispanDirectory.html$$[] Issue tracker: link:$$https://jira.jboss.org/browse/ISPN/component/12312732$$[] Source code: link:$$http://www.jboss.org/infinispan/sourcecode.html$$[]</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-Lucenecompatibility"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Lucenecompatibility"></a>12.2. Lucene compatibility</h3> <div class="literalblock"> <div class="content"> <pre>Current version was developed and compiled against _Lucene 3.5.0_ , and also tested to work with Lucene versions from 3.0.x to 3.4.0, version 2.9.x, and  the older 2.4.1.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-Howtouseit"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Howtouseit"></a>12.3. How to use it</h3> <div class="literalblock"> <div class="content"> <pre>To create a Directory instance:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>import org.apache.lucene.store.Directory;
import org.infinispan.lucene.InfinispanDirectory;
import org.infinispan.Cache;

Cache cache = // create an Infinispan cache, configured as you like
Directory indexDir = new InfinispanDirectory(cache, "indexName");</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The _indexName_ is a unique key to identify your index. It takes the same role as the path did on filesystem based indexes: you can create several different indexes giving them different names. When you use the same _indexName_ in another instance connected to the same network (or instantiated on the same machine, useful for testing) they will join, form a cluster and share all content.</pre> </div> </div> <div class="paragraph"> <p>New nodes can be added or removed dynamically, making the service administration very easy and also suited for cloud environments: it&#8217;s simple to react to load spikes, as adding more memory and CPU power to the search system is done by just starting more nodes.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-Limitations"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Limitations"></a>12.4. Limitations</h3> <div class="literalblock"> <div class="content"> <pre>As when using an _IndexWriter_ on a filesystem based _Directory_ , even on the clustered edition only one _IndexWriter_ can be opened across the whole cluster. link:$$http://search.hibernate.org$$[Hibernate Search] , which includes integration with this Lucene Directory since version 3.3, sends index change requests across a JMS queue, or a _JGroups_ channel. Other valid approaches are to proxy the remote _IndexWriter_ or just design your application in such a way that only one node attempts to write it. Reading (searching) is of course possible in parallel, from any number of threads on each node; changes applied to the single IndexWriter are affecting results of all threads on all nodes in a very short time.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-Configuration"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Configuration"></a>12.5. Configuration</h3> <div class="literalblock"> <div class="content"> <pre>This works with local only configurations and also with any clustering mode supported by Infinispan. A transaction manager is not mandatory, while batching needs to be enabled. An example configuration:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>public static Configuration createTestConfiguration() {
      Configuration c = new Configuration();
      c.setCacheMode(Configuration.CacheMode.DIST_SYNC);
      c.setInvocationBatchingEnabled(true);
      return c;
}</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>As better explained in the javadocs of _org.infinispan.lucene.InfinispanDirectory_ , it's possible for it to use more than a single cache, using specific configurations for different purposes. When using readlocks, make sure to not enable transactions on this cache.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-Demo"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Demo"></a>12.6. Demo</h3> <div class="literalblock"> <div class="content"> <pre>There is a simple command-line demo of it's capabilities distributed with Infinispan under demos/lucene-directory; make sure you grab the _"Binaries, server and demos"_ package from link:$$http://www.jboss.org/infinispan/downloads$$[download page] , which contains all demos.</pre> </div> </div> <div class="paragraph"> <p>Start several instances, then try adding text in one instance and searching for it on the other. The configuration is not tuned at all, but should work out-of-the box without any changes. If your network interface has multicast enabled, it will cluster across the local network with other instances of the demo.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-Mavendependencies"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Mavendependencies"></a>12.7. Maven dependencies</h3> <div class="literalblock"> <div class="content"> <pre>All you need is _org.infinispan:infinispan-lucene-directory_ :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;dependencies&gt;
   &lt;dependency&gt;
      &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
      &lt;artifactId&gt;infinispan-lucene-directory&lt;/artifactId&gt;
      &lt;version&gt;5.1.1.FINAL&lt;/version&gt;
   &lt;/dependency&gt;
&lt;/dependencies&gt;
</pre> </div> </div> <div class="paragraph"> <p>In early versions the Infinispan Lucene Directory was needing a transaction manager, this is no longer needed but it&#8217;s still optionally possible to use one to wrap all changes you make to the index in a transaction.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645139_InfinispanasaDirectoryforLucene-UsingaCacheLoader"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-UsingaCacheLoader"></a>12.8. Using a CacheLoader</h3> <div class="literalblock"> <div class="content"> <pre>Using a CacheLoader you can have the index content backed up to a permanent storage; you can use a shared store for all nodes or one per node, see &lt;&lt;sid-18645149&gt;&gt; for more details. When using a CacheLoader to store a Lucene index, to get best write performance you would need to configure the CacheLoader with _async=true_ .</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645139_InfinispanasaDirectoryforLucene-Storingtheindexinadatabase"><a class="anchor" href="#sid-18645139_InfinispanasaDirectoryforLucene-Storingtheindexinadatabase"></a>12.8.1. Storing the index in a database</h4> <div class="literalblock"> <div class="content"> <pre>It might be useful to store the Lucene index in a relational database; this would be very slow but Infinispan can act as an efficient cache between the application and the JDBC interface, making this configuration useful in both clustered and non-clustered configurations. When storing indexes in a JDBC database, it's suggested to use the _JdbcStringBasedCacheStore_ , which will need this attribute:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;property name="key2StringMapperClass" value="org.infinispan.lucene.LuceneKey2StringMapper" /&gt;
</pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645140"><a class="anchor" href="#sid-18645140"></a>13. Infinispan Server Modules</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645140_InfinispanServerModules-Introduction"><a class="anchor" href="#sid-18645140_InfinispanServerModules-Introduction"></a>13.1. Introduction</h3> <div class="paragraph"> <p>Traditionally, clients have interacted with Infinispan in a peer-to-peer (p2p) fashion where Infinispan and the client code that accessed it lived within the same VM. When Infinispan is queried in this way, it is considered to be accessed in an embedded fashion, as shown in the screenshot below</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="sect3"> <h4 id="sid-18645140_InfinispanServerModules-ClientServeroverPeertoPeer"><a class="anchor" href="#sid-18645140_InfinispanServerModules-ClientServeroverPeertoPeer"></a>13.1.1. Client-Server over Peer-to-Peer</h4> <div class="literalblock"> <div class="content"> <pre>However, there are situations when accessing Infinispan in a client-server mode might make more sense than accessing it via p2p. For example, when trying to _access Infinispan from a non-JVM environment_ . Since Infinispan is written in Java, if someone had a $$C++$$ application that wanted to access it, it couldn't just do it in a p2p way. On the other hand, client-server would be perfectly suited here assuming that a language neutral protocol was used and the corresponding client and server implementations were available.</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>In other situations, Infinispan users want to have an _elastic application tier_ where you start/stop business processing servers very regularly. Now, if users deployed Infinispan configured with distribution or state transfer, startup time could be greatly influenced by the shuffling around of data that happens in these situations. So in the following diagram, assuming Infinispan was deployed in p2p mode, the app in the second server could not access Infinispan until state transfer had completed.</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>This effectively means that bringing up new application-tier servers is impacted by things like state transfer because applications cannot access Infinispan until these processes have finished and if the state being shifted around is large, this could take some time. This is undesirable in an elastic environment where you want quick application-tier server turnaround and predictable startup times. Problems like this can be solved by accessing Infinispan in a client-server mode because starting a new application-tier server is just a matter of starting a lightweight client that can connect to the backing data grid server. No need for rehashing or state transfer to occur and as a result server startup times can be more predictable which is very important for modern cloud-based deployments where elasticity in your application tier is important.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>Other times, it's common to find multiple applications needing access to data storage. In this cases, you could in theory deploy an Infinispan instance per each of those applications but this could be wasteful and difficult to maintain. Thing about databases here, you don't deploy a database alongside each of your applications, do you? So, alternatively you could deploy Infinispan in client-server mode keeping a pool of Infinispan data grid nodes acting as a _shared storage tier for your applications_ .</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>Deploying Infinispan in this way also allows you to manage each tier independently, for example, you can upgrade you application or app server without bringing down your Infinispan data grid nodes.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645140_InfinispanServerModules-PeertoPeeroverClientServer"><a class="anchor" href="#sid-18645140_InfinispanServerModules-PeertoPeeroverClientServer"></a>13.1.2. to-Peer over Client-Server</h4> <div class="paragraph"> <p>Before talking about individual Infinispan server modules, it&#8217;s worth mentioning that in spite of all the benefits, client-server Infinispan still has disadvantages over p2p. Firstly, p2p deployments are simpler than client-server ones because in p2p, all peers are equals to each other and hence this simplifies deployment. So, if this is the first time you&#8217;re using Infinispan, p2p is likely to be easier for you to get going compared to client-server.</p> </div> <div class="paragraph"> <p>Client-server Infinispan requests are likely to take longer compared to p2p requests, due to the serialization and network cost in remote calls. So, this is an important factor to take in account when designing your application. For example, with replicated Infinispan caches, it might be more performant to have lightweight HTTP clients connecting to a server side application that accesses Infinispan in p2p mode, rather than having more heavyweight client side apps talking to Infinispan in client-server mode, particularly if data size handled is rather large. With distributed caches, the difference might not be so big because even in p2p deployments, you&#8217;re not guaranteed to have all data available locally.</p> </div> <div class="paragraph"> <p>Environments where application tier elasticity is not so important, or where server side applications access state-transfer-disabled, replicated Infinispan cache instances are amongst scenarios where Infinispan p2p deployments can be more suited than client-server ones.</p> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645140_InfinispanServerModules-ServerModules"><a class="anchor" href="#sid-18645140_InfinispanServerModules-ServerModules"></a>13.2. Server Modules</h3> <div class="paragraph"> <p>So, now that it&#8217;s clear when it makes sense to deploy Infinispan in client-server mode, what are available solutions? All Infinispan server modules are based on the same pattern where the server backend creates an embedded Infinispan instance and if you start multiple backends, they can form a cluster and share/distribute state if configured to do so. The server types below primarily differ in the type of listener endpoint used to handle incoming connections. Here&#8217;s a brief look at each of them:</p> </div> <div class="sect3"> <h4 id="sid-18645140_InfinispanServerModules-RESTServerModule"><a class="anchor" href="#sid-18645140_InfinispanServerModules-RESTServerModule"></a>13.2.1. REST Server Module</h4> <div class="ulist"> <ul> <li> <p><a href="http://community.jboss.org/docs/14095">This module</a> , which is distributed as a WAR file, can be deployed in any servlet container to allow Infinispan to be accessed via <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737132">a RESTful HTTP interface</a> .</p> </li> <li> <p>To connect to it, you can use any HTTP client out there and there&#8217;re tons of different client implementations available out there for pretty much any language or system.</p> </li> <li> <p>This module is particularly recommended for those environments where HTTP port is the only access method allowed between clients and servers.</p> </li> <li> <p>Clients wanting to load balance or failover between different Infinispan REST servers can do so using any standard HTTP load balancer such as <a href="http://www.jboss.org/mod_cluster">mod_cluster</a> . It&#8217;s worth noting though these load balancers maintain a static view of the servers in the backend and if a new one was to be added, it would require manual update of the load balancer.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645140_InfinispanServerModules-MemcachedServerModule"><a class="anchor" href="#sid-18645140_InfinispanServerModules-MemcachedServerModule"></a>13.2.2. Memcached Server Module</h4> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737037">This module</a> is an implementation of the <a href="http://github.com/memcached/memcached/blob/master/doc/protocol.txt">Memcached text protocol</a> backed by Infinispan.</p> </li> <li> <p>To connect to it, you can use any of the <a href="http://code.google.com/p/memcached/wiki/Clients">existing Memcached clients</a> which are pretty diverse.</p> </li> <li> <p>As opposed to Memcached servers, Infinispan based Memcached servers can actually be clustered and hence they can replicate or distribute data using consistent hash algorithms around the cluster. So, this module is particularly of interest to those users that want to provide failover capabilities to the data stored in Memcached servers.</p> </li> <li> <p>In terms of load balancing and failover, there&#8217;re a few clients that can load balance or failover given a static list of server addresses (perl&#8217;s Cache::Memcached for example) but any server addition or removal would require manual intervention.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645140_InfinispanServerModules-HotRodServerModule"><a class="anchor" href="#sid-18645140_InfinispanServerModules-HotRodServerModule"></a>13.2.3. Hot Rod Server Module</h4> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146">This module</a> is an implementation of the <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083">Hot Rod binary protocol</a> backed by Infinispan which allows clients to do dynamic load balancing and failover and smart routing.</p> </li> <li> <p>So far, a single <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142">Java client</a> , which is the reference implementation, has been fully developed. A beta version of the Python client is <a href="http://infinispan.blogspot.com/2011/02/infinispan-python-client-beta-for-hot.html">available</a> , and a <a href="https://github.com/noelo/hotrod-jruby">JRuby</a> and <a href="https://github.com/torquebox/infinispan-ruby-client">pure Ruby</a> clients are in the making.</p> </li> <li> <p>If you&#8217;re clients are running Java, this should be your defacto server module choice because it allows for dynamic load balancing and failover. This means that Hot Rod clients can dynamically detect changes in the topology of Hot Rod servers as long as these are clustered, so when new nodes join or leave, clients update their Hot Rod server topology view. On top of that, when Hot Rod servers are configured with distribution, clients can detect where a particular key resides and so they can route requests smartly.</p> </li> <li> <p>Load balancing and failover is dynamically provided by Hot Rod client implementations using information provided by the server.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645140_InfinispanServerModules-WebSocketServerModule"><a class="anchor" href="#sid-18645140_InfinispanServerModules-WebSocketServerModule"></a>13.2.4. WebSocket Server Module</h4> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737036">This module</a> enables Infinispan to be exposed over a <a href="http://en.wikipedia.org/wiki/WebSockets">Websocket</a> interface via a Javascript API.</p> </li> <li> <p>This module is very specifically designed for Javascript clients and so that is the only client implementation available.</p> </li> <li> <p>This module is particularly suited for developers wanting to enable access to Infinispan instances from their Javascript codebase.</p> </li> <li> <p>Since websockets work on the same HTTP port, any HTTP load balancer would do to load balance and failover.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645140_InfinispanServerModules-ServerComparisonSummary"><a class="anchor" href="#sid-18645140_InfinispanServerModules-ServerComparisonSummary"></a>13.3. Server Comparison Summary</h3> <div class="paragraph"> <p>Here&#8217;s a table comparing and summarizing the capabilities of distinct server modules:</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645141"><a class="anchor" href="#sid-18645141"></a>14. Management Tooling</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645141_ManagementTooling-Introduction"><a class="anchor" href="#sid-18645141_ManagementTooling-Introduction"></a>14.1. Introduction</h3> <div class="paragraph"> <p>Management of Infinispan instances is all about exposing as much relevant statistical information that allows administrators to get view of the state of each Infinispan instance. Taking in account that a single installation could be made up of several tens or hundreds Infinispan instances, providing clear and concise information in an efficient manner is imperative. The following sections dive into the range of management tooling that Infinispan provides.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645141_ManagementTooling-JMX"><a class="anchor" href="#sid-18645141_ManagementTooling-JMX"></a>14.2. JMX</h3> <div class="literalblock"> <div class="content"> <pre>Over the years, link:$$http://java.sun.com/javase/technologies/core/mntr-mgmt/javamanagement/$$[JMX] has become the de facto standard for management and administration of middleware and as a result, the Infinispan team has decided to standarize on this technology for the exposure of management or statistical information.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645141_ManagementTooling-EnablingJMXStatistics"><a class="anchor" href="#sid-18645141_ManagementTooling-EnablingJMXStatistics"></a>14.2.1. Enabling JMX Statistics</h4> <div class="paragraph"> <p>JMX reporting can be enabled at 2 different levels:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>CacheManager level: The CacheManager is the entity that governs all the cache instances that have been created from it. Details on the information exposed at the CacheManager level can be found below. For the moment, let&#8217;s just focus on how to enable the CacheManager to report management data via JMX.</p> <div class="ulist"> <ul> <li> <p>If configuring the CacheManager via XML, make sure you add the following XML under the &lt;global&gt; element:</p> </li> </ul> </div> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>&lt;globalJmxStatistics enabled="true"/&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>If configuring the CacheManager programmatically, simply add the following code:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfiguration = ...
globalConfiguration.setExposeGlobalJmxStatistics(true);
</pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Cache level: At this level, you will receive management information generated by individual cache instances. Details on the information exposed at the Cache level are explained below. For the moment, let&#8217;s just focus on how to enable the Cache to report management data via JMX:</p> <div class="ulist"> <ul> <li> <p>If configuring the Cache via XML, make sure you add the following XML under the either &lt;default&gt;, if you&#8217;re configuring the default Cache instance, or under the corresponding &lt;namedCache&gt;:</p> </li> </ul> </div> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>&lt;jmxStatistics enabled="true"/&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>If configuring the Cache programmatically, simply add the following code:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>Configuration configuration = ...
configuration.setExposeJmxStatistics(true);
</pre> </div> </div> <div class="paragraph"> <p>Understanding The MBeans</p> </div> <div class="literalblock"> <div class="content"> <pre>Once you have enabled JMX reporting at either the CacheManager or Cache level, you should be able to connect to VM(s) where Infinispan is running using a standard JMX GUI such as link:$$http://java.sun.com/developer/technicalArticles/J2SE/jconsole.html$$[JConsole] or link:$$http://java.sun.com/javase/6/docs/technotes/guides/visualvm/$$[VisualVM] , and you should find the following MBeans:</pre> </div> </div> <div class="sect4"> <h5 id="sid-18645141_ManagementTooling-Infinispan4.1orearlier"><a class="anchor" href="#sid-18645141_ManagementTooling-Infinispan4.1orearlier"></a>Infinispan 4.1 or earlier</h5> <div class="ulist"> <ul> <li> <p>If you enabled CacheManager level JMX statistics, you should see an MBean called infinispan:cache-name=[global],jmx-resource=CacheManager with <a href="http://docs.jboss.org/infinispan/4.0/apidocs/jmxComponents.html#CacheManager">properties specified by the CacheManager MBean</a> .</p> </li> <li> <p>If you enabled Cache level JMX statistics, you should see several different MBeans depending on which configuration options have been enabled. For example, if you have configured a write behind cache store, you should see an MBean exposing properties belonging to the cache store component. All Cache level MBeans will follow the same format though which is the following: infinispan:cache-name=&lt;name-of-cache&gt;(&lt;cache-mode&gt;),jmx-resource=&lt;component-name&gt; where: </p> </li> <li> <p>&lt;name-of-cache&gt; has been substituted by the actual cache name. If this cache represents the default cache, its name will be "___defaultcache".</p> </li> <li> <p>&lt;cache mode&gt; has been substituted by the cache mode of the cache. The cache mode is represented by the lower case version of the possible enumeration values shown <a href="http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/config/Configuration.CacheMode.html">here</a> .</p> </li> <li> <p>&lt;component-name&gt; has been substituted by one of the JMX component names in the <a href="http://docs.jboss.org/infinispan/4.0/apidocs/jmxComponents.html">JMX reference documentation</a> .</p> </li> </ul> </div> <div class="paragraph"> <p>For example, the cache store JMX component MBean for a default cache configured with synchronous distribution would have the following name:infinispan:cache-name=___defaultcache(dist_sync),jmx-resource=CacheStore</p> </div> <div class="paragraph"> <p>Please note that any cache names that contain <em>:</em> or <em>=</em> characters will be substituted by <em>_</em> character. Infinispan does this because <em>:</em> and <em>=</em> are control characters for JMX object names.</p> </div> </div> <div class="sect4"> <h5 id="sid-18645141_ManagementTooling-Infinispan4.2orlater"><a class="anchor" href="#sid-18645141_ManagementTooling-Infinispan4.2orlater"></a>Infinispan 4.2 or later</h5> <div class="ulist"> <ul> <li> <p>If you enabled CacheManager level JMX statistics, without further configuration, you should see an MBean called <em>org.infinispan:type=CacheManager,name="DefaultCacheManager"</em> with <a href="http://docs.jboss.org/infinispan/4.2/apidocs/jmxComponents.html#CacheManager">properties specified by the CacheManager MBean</a> .</p> </li> <li> <p>Using the cacheManagerName attribute in globalJmxStatistics XML element, or using the corresponding GlobalConfiguration.setCacheManagerName() call, you can name the cache manager in such way that the name is used as part of the JMX object name. So, if the name had been "Hibernate2LC", the JMX name for the cache manager would have been: <em>org.infinispan:type=CacheManager,name="Hibernate2LC"</em> . This offers a nice and clean way to manage environments where multiple cache managers are deployed, which follows <a href="http://java.sun.com/javase/technologies/core/mntr-mgmt/javamanagement/best-practices.jsp">JMX best practices</a> .</p> </li> <li> <p>If you enabled Cache level JMX statistics, you should see several different MBeans depending on which configuration options have been enabled. For example, if you have configured a write behind cache store, you should see an MBean exposing properties belonging to the cache store component. All Cache level MBeans follow the same format though which is the following: <em>org.infinispan:type=Cache,name="&lt;name-of-cache&gt;(&lt;cache-mode&gt;)",manager="&lt;name-of-cache-manager&gt;",component=&lt;component-name&gt;</em> where:</p> </li> <li> <p>&lt;name-of-cache&gt; has been substituted by the actual cache name. If this cache represents the default cache, it&#8217;s name will be <em>"</em> _ <em>defaultCache"</em> .</p> </li> <li> <p>&lt;cache-mode&gt; has been substituted by the cache mode of the cache. The cache mode is represented by the lower case version of the possible enumeration values shown here.</p> </li> <li> <p>&lt;name-of-cache-manager&gt; has been substituted by the name of the cache manager to which this cache belongs. The name is derived from the cacheManagerName attribute value in globalJmxStatistics element.</p> </li> <li> <p>&lt;component-name&gt; has been substituted by one of the JMX component names in the <a href="http://docs.jboss.org/infinispan/4.2/apidocs/jmxComponents.html">JMX reference documentation</a> .</p> <div class="literalblock"> <div class="content"> <pre>For example, the cache store JMX component MBean for a default cache configured with synchronous distribution would have the following name: _org.infinispan:type=Cache,name="_ _ _$$defaultcache(dist_sync)", manager="DefaultCacheManager",component=CacheStore$$_</pre> </div> </div> </li> </ul> </div> <div class="paragraph"> <p>Please note that cache and cache manager names are quoted to protect against illegal characters being used in these user-defined names.</p> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645141_ManagementTooling-MultipleJMXDomains"><a class="anchor" href="#sid-18645141_ManagementTooling-MultipleJMXDomains"></a>14.2.2. Multiple JMX Domains</h4> <div class="paragraph"> <p>There can be situations where several CacheManager instances are created in a single VM, or Cache names belonging to different CacheManagers under the same VM clash.</p> </div> <div class="sect4"> <h5 id="sid-18645141_ManagementTooling-Infinispan4.1orearlierx"><a class="anchor" href="#sid-18645141_ManagementTooling-Infinispan4.1orearlierx"></a>Infinispan 4.1 or earlier</h5> <div class="paragraph"> <p>In order to cope with such situations, Infinispan enabled users to define a particular JMX domain prefix for their MBeans. For example, either of these two options could be used to configure a JMX domain prefix called "myInfinispan" for the CacheManager JMX statistics:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;globalJmxStatistics enabled="true" jmxDomain="myInfinispan"/&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfiguration = ...
globalConfiguration.setExposeGlobalJmxStatistics(true);
globalConfiguration.setJmxDomain("myInfinispan");
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Using either of these options should result on the CacheManager MBean name being: _myInfinispan:cache-name=[global],jmx-resource=CacheManager_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>As you probably have guessed by now, the default JMX domain prefix is called " _infinispan_ ".</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Another related configuration option for both CacheManager and Cache JMX statistics allows for duplicate JMX domains to be discovered. Internally, when duplicates are allowed, Infinispan takes the duplicating JMX domain prefix, adds an index that starts at number 2 to the existing prefix and uses that JMX prefix from then onwards. So, for example, if two CacheManagers were started with global JMX statistics enabled, no particular JMX domain was configured, and JMX domain duplicates were allowed, the first CacheManager would be registered under " _infinispan..._ ", whereas the second one would be registered under: " _infinispan2..._ ". To allow JMX duplicate domains, do the following:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Via XML:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;globalJmxStatistics enabled="true" allowDuplicateDomains="true"/&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfiguration = ...
globalConfiguration.setExposeGlobalJmxStatistics(true);
globalConfiguration.setAllowDuplicateDomains(true)
</pre> </div> </div> <div class="paragraph"> <p>Remember that by default, duplicate domains are disallowed.</p> </div> </div> <div class="sect4"> <h5 id="sid-18645141_ManagementTooling-Infinispan4.2orlaterx"><a class="anchor" href="#sid-18645141_ManagementTooling-Infinispan4.2orlaterx"></a>Infinispan 4.2 or later</h5> <div class="paragraph"> <p>Using different JMX domains for multi cache manager environments should be last resort. Instead, as mentioned in previous section, it&#8217;s now possible to name a cache manager in such way that it can easily be identified and used by monitoring tools such as RHQ. For example:</p> </div> <div class="ulist"> <ul> <li> <p>Via XML:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;globalJmxStatistics enabled="true" cacheManagerName="Hibernate2LC"/&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfiguration = ...
globalConfiguration.setExposeGlobalJmxStatistics(true);
globalConfiguration.setCacheManagerName("Hibernate2LC");
</pre> </div> </div> <div class="paragraph"> <p>Using either of these options should result on the CacheManager MBean name being: org.infinispan:type=CacheManager,name="Hibernate2LC"</p> </div> <div class="literalblock"> <div class="content"> <pre>Please note as well that since 4.2, the default domain names has changed from "infinispan" to "org.infinispan", as per link:$$http://java.sun.com/javase/technologies/core/mntr-mgmt/javamanagement/best-practices.jsp$$[JMX best practices] .</pre> </div> </div> <div class="paragraph"> <p>For the time being, you can still set your own jmxDomain if you need to and we also allow duplicate domains, or rather duplicate JMX names, but these should be limited to very special cases where different cache managers within the same JVM are named equally.</p> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645141_ManagementTooling-RegisteringMBeansInNonDefaultMBeanServers"><a class="anchor" href="#sid-18645141_ManagementTooling-RegisteringMBeansInNonDefaultMBeanServers"></a>14.2.3. Registering MBeans In Non-Default MBean Servers</h4> <div class="literalblock"> <div class="content"> <pre>To finish up with this JMX section, let's quickly discuss where Infinispan registers all these MBeans. By default, Infinispan registers them in the link:$$http://java.sun.com/j2se/1.5.0/docs/api/java/lang/management/ManagementFactory.html#getPlatformMBeanServer()$$[standard JVM MBeanServer plattform] . However, users might want to register these MBeans in a different MBeanServer instance. For example, an application server might work with a different MBeanServer instance to the default plattform one. In such cases, users should implement the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/jmx/MBeanServerLookup.html$$[MBeanServerLookup interface] provided by Infinispan so that the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/jmx/MBeanServerLookup.html#getMBeanServer()$$[getMBeanServer() method] returns the MBeanServer under which Infinispan should register the management MBeans. You can find an example in the default link:$$http://anonsvn.jboss.org/repos/infinispan/tags/4.0.0.FINAL/core/src/main/java/org/infinispan/jmx/PlatformMBeanServerLookup.java$$[PlatformMBeanServerLookup class] used by Infinispan. So, once you have your implementation ready, simply configure Infinispan with the fully qualified name of this class. For example:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Via XML:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;globalJmxStatistics enabled="true" mBeanServerLookup="com.acme.MyMBeanServerLookup"/&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Programmatically:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfiguration globalConfiguration = ...
globalConfiguration.setExposeGlobalJmxStatistics(true);
globalConfiguration.setMBeanServerLookup("com.acme.MyMBeanServerLookup")
</pre> </div> </div> <div class="paragraph"> <p>MBean additions in Infinispan 5.0</p> </div> <div class="paragraph"> <p>There has been a couple of noticeable additions in Infinispan 5.0 in terms of MBean exposed:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>MBeans related to Infinispan servers are now available that for the moment focus on the transport layer. So, if the Infinispan servers are configured with global JMX statistics, a brand new MBean in <em>org.infinispan:type=Server,name=&lt;Memcached|Hotrod&gt;,component=Transport</em> is now available which offers information such as: host name, port, bytes read, byte written, number of worker threads&#8230;etc.</p> </li> <li> <p>When global JMX statistics are enabled, JGroups MBeans are also registered automatically, so you can get key information of the group communication transport layer that&#8217;s used to cluster Infinispan instances. To find out more about the information provided, check the <a href="http://community.jboss.org/docs/10938">JGroups JMX documentation</a> .</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645141_ManagementTooling-RHQ"><a class="anchor" href="#sid-18645141_ManagementTooling-RHQ"></a>14.3. RHQ</h3> <div class="paragraph"> <p>The preferred way to manage multiple Infinispan instances spread accross different servers is to use RHQ, which is JBoss' enterprise management solution. Thanks to RHQ&#8217;s agent and auto discovery capabilities, monitoring both Cache Manager and Cache instances is a very simple task. With RHQ, administrators have access to graphical views of key runtime parameters or statistics and can also be notified be these exceed or go below certain limits. The Infinispan specific statistics shown by RHQ are a reflection of the JMX information exposed by Infinispan which has been formatted for consumption by RHQ. Please follow these steps to get started with RHQ and have Infinispan instances monitored with it:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Firstly, download and install an RHQ server and install and start at least one RHQ agent. The job of the RHQ agent is to send information about the Infinispan instance back to the server which is the one that shows the information via a nice GUI. You can find detailed information on the installation process in <a href="http://support.rhq-project.org/display/JOPR2/Installation">RHQ&#8217;s installation guide</a> and you can find information on how to run an agent in the <a href="http://support.rhq-project.org/display/JOPR2/Running+the+RHQ+Agent">RHQ agent guide</a> .</p> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Careful with H2 database installation</div> <div class="literalblock"> <div class="content"> <pre>If you're just building a demo or testing RHQ server, you can avoid the need to install a fully fledged database and use an in-memory H2 database instead. However, you might encounter issues after testing database connection as shown link:$$https://fedorahosted.org/pipermail/rhq-users/2010-June/000045.html$$[here] . Simply repeating the installation avoiding testing the connection should work.</pre> </div> </div> </td> </tr> </table> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Where do I install the RHQ agent?</div> <div class="paragraph"> <p>The most common set up is to have the RHQ agent installed in the same machine where Infinispan is running. If you have multiple machines, an agent can be installed in each machine.</p> </div> </td> </tr> </table> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>By now, you should have an RHQ server and agent running. It&#8217;s time now to download the latest Infinispan binary distribution (*-bin.zip or *-all.zip should do) from the <a href="http://www.jboss.org/infinispan/downloads.html">downloads</a> section and locate the RHQ plugin jar file which should be named something like infinispan-rhq-plugin.jar . This is located under the modules/rhq-plugin directory.</p> </li> <li> <p>The <a href="http://rhq-project.org/display/JOPR2/Adding+and+Updating+Agent+Plugins">adding and updating plugins section</a> on the RHQ guide contains some more detailed information on how to update both RHQ servers and agents with new plugins, but essentially, this process involves uploading a new plugin to the RHQ server and then pushing the plugin to one, or several, RHQ agents.</p> </li> </ol> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Speeding up plugin installation</div> <div class="literalblock"> <div class="content"> <pre>If you're simply demoing or testing and you only have a single agent, once the plugin has been uploaded to the server, simply go to the agent command line interface and type: plugins update .This will force the agent to retrieve the latest plugins from the server. Doing this can be considerably faster than some of the other alternatives.</pre> </div> </div> </td> </tr> </table> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>At this point, RHQ is ready to start monitoring Infinispan instances, but before firing them up, make sure you start them with the following system properties so that RHQ agents can discover them:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>-Dcom.sun.management.jmxremote.port=6996 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false</pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Remote JMX port value</div> <div class="paragraph"> <p>The actual port value used does not really matter here, but what matters is that a port is given, otherwise Infinispan instances cannot be located. So, you can easily start multiple Infinispan instances in a single machine, each with a different remote JMX port, and a locally running agent will be able to discover them all without any problems.</p> </div> </td> </tr> </table> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Once Infinispan instances have been discovered, you should see a new resource for each of the cache manager running appearing in the <a href="http://rhq-project.org/display/JOPR2/Initial+Auto-discovery+and+Import">Inventory/Discovery Queue</a> of the RHQ server. Simply import it now and you should see each cache manager appearing with as many child cache resources as caches are running in each cache manager. You&#8217;re now ready to monitor Infinispan!</p> </li> </ol> </div> <div class="sect3"> <h4 id="sid-18645141_ManagementTooling-RHQmonitoringtips"><a class="anchor" href="#sid-18645141_ManagementTooling-RHQmonitoringtips"></a>14.3.1. RHQ monitoring tips</h4> <div class="paragraph"> <p>This section focuses on the lessons learned while developing the Infinispan RHQ plugin that are likely to be useful to anyone using RHQ.</p> </div> <div class="ulist"> <ul> <li> <p>By default, at least in version 2.3.1 of RHQ, the RHQ agent sends an availability report of any managed resources every 5 minutes. The problem with this is that if you&#8217;re testing whether your Infinispan instance is automatically discovered by the RHQ server, it can take up to 5 minutes to do so! Also, it can take 5 minutes for the RHQ server to figure out that you&#8217;ve shutdown your Infinispan instance. You can change this setting by the following property (default value is 300 seconds) in rhq-agent/conf/agent-configuration.xml. For example, if you wanted the availability to be sent every 1 minute, simply change the value to 60:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;entry key="rhq.agent.plugins.availability-scan.period-secs" value="60"/&gt;</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Careful with agent configuration changes</div> <div class="literalblock"> <div class="content"> <pre>Please bear in mind the instructions given in the link:$$http://support.rhq-project.org/display/JOPR2/RHQ+Agent+Installation$$[RHQ agent installation] and more specifically the paragraph below with regards to changes made to properties in agent-configuration.xml:</pre> </div> </div> <div class="quoteblock"> <blockquote> <div class="paragraph"> <p>Once the agent is configured, it persists its configuration in the Java Preferences backing store. Once this happens, agent-configuration.xml is no longer needed or used. Editing agent-configuration.xml will no longer have any effect on the agent, even if you restart the agent. If you want the agent to pick up changes you make to agent-configuration.xml, you must either restart the agent with the "--cleanconfig" command line option or use the "config --import" agent prompt command.</p> </div> </blockquote> </div> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645141_ManagementTooling-Writingpluginsforothermanagementtools"><a class="anchor" href="#sid-18645141_ManagementTooling-Writingpluginsforothermanagementtools"></a>14.4. Writing plugins for other management tools</h3> <div class="paragraph"> <p>As mentioned in the previous section, RHQ consumes the JMX data exposed by Infinispan, and in similar fashion, plugins could be written for other 3rd party management tools that were able to transform these data into the correct representation in these tools, for example graphs,&#8230;etc.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645142"><a class="anchor" href="#sid-18645142"></a>15. Asynchronous Options</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645142_AsynchronousOptions-Introduction"><a class="anchor" href="#sid-18645142_AsynchronousOptions-Introduction"></a>15.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>When Infinispan instances are clustered, regardless of the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737115$$[clustering mode] , data can be propagated to other nodes in a synchronous or asynchronous way. When synchronous, the sender waits for replies from the receivers and when asynchronous, the sender sends the data and does not wait for replies from other nodes in the cluster.</pre> </div> </div> <div class="paragraph"> <p>With asynchronous modes, speed is more important than consistency and this is particularly advantageous in use cases such as HTTP session replication with sticky sessions enabled. In these scenarios, data, or in this case a particular session, is always accessed on the same cluster node and only in case of failure is data accessed in a different node. This type of architectures allow consistency to be relaxed in favour of increased performance.</p> </div> <div class="paragraph"> <p>In order to choose the asynchronous configuration that best suits your application, it&#8217;s important to understand the following configuration settings:</p> </div> </div> <div class="sect2"> <h3 id="sid-18645142_AsynchronousOptions-AsynchronousCommunications"><a class="anchor" href="#sid-18645142_AsynchronousOptions-AsynchronousCommunications"></a>15.2. Asynchronous Communications</h3> <div class="literalblock"> <div class="content"> <pre>Whenever you add link:$$http://docs.jboss.org/infinispan/5.1/configdocs/urn_infinispan_config_5.1/complexType/configuration.clustering.async.html$$[&amp;lt;async&amp;gt;] element within &amp;lt;clustering&amp;gt;, you're telling the underlying JGroups layer in Infinispan to use asynchronous communication. What this means is that JGroups will send any replication/distribution/invalidation request to the wire but will not wait for a reply from the receiver.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645142_AsynchronousOptions-AsynchronousMarshalling"><a class="anchor" href="#sid-18645142_AsynchronousOptions-AsynchronousMarshalling"></a>15.3. Asynchronous Marshalling</h3> <div class="literalblock"> <div class="content"> <pre>This is a configurable boolean property of link:$$http://docs.jboss.org/infinispan/5.1/configdocs/urn_infinispan_config_5.1/complexType/configuration.clustering.async.html$$[&amp;lt;async&amp;gt;] element that indicates whether the actual call from Infinispan to the JGroups layer is done on a separate thread or not. When set to true, once Infinispan has figured out that a request needs to be sent to another node, it submits it to the async transport executor so that it can talk to the underlying JGroups layer.</pre> </div> </div> <div class="paragraph"> <p>With asynchronous marshalling, Infinispan requests can return back to the client quicker compared to when async marshalling is set to false. The downside though is that client requests can be reordered before they have reached the JGroups layer. In other words, JGroups provides ordering guarantees even for async messages but with async marshalling turned on, requests can reach the JGroups in a different order in which they&#8217;re called. This can effectively lead to data consistency issues in applications making multiple modifications on the same key/value pair. For example, with async marshalling turned on:</p> </div> <div class="paragraph"> <p>App calls:</p> </div> <div class="listingblock"> <div class="content"> <pre>cache.put("car", "bmw");
cache.remove("car");
</pre> </div> </div> <div class="paragraph"> <p>Other nodes could receive these operations in this order:</p> </div> <div class="listingblock"> <div class="content"> <pre>cache.remove("car");
cache.put("car", "bmw");
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The end result is clearly different which is often not desirable. So, if your application makes multiple modifications on the same key, you should either: turned off asynchronous marshalling, or set link:$$http://docs.jboss.org/infinispan/4.1/apidocs/config.html#ce_global_asyncTransportExecutor$$[&amp;lt;asyncTransportExecutor&amp;gt;] element's maxThreads to 1. The first modification only applies to a particular named cache, whereas the second option affects all named caches in configuration file that are configured with async marshalling. It's worth noting though that having this type of executor configured with a single thread would defeat its purpose adding unnecessary contention point. It'd be better to simply switch off async marshalling.</pre> </div> </div> <div class="paragraph"> <p>On the contrary, if your application only ever makes one modification per key/value pair and there&#8217;s no happens-before relationship between them, then async marshalling is a very valid optimization that can increase performance of your application without data consistency risks.</p> </div> <div class="literalblock"> <div class="content"> <pre>If you have async marshalling turned on and see exceptions related to java.util.concurrent.RejectedExecutionException , as explained in the &lt;&lt;sid-18645051,technical faq page&gt;&gt; , you should also consider switching off async marshalling.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Back in Infinispan 4.0, when &amp;lt;async&amp;gt; element was used, this property was set to true by default. However due to reordering risks mentioned earlier, the default has changed to false from Infinispan 4.1 onwards.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645142_AsynchronousOptions-ReplicationQueue"><a class="anchor" href="#sid-18645142_AsynchronousOptions-ReplicationQueue"></a>15.4. Replication Queue</h3> <div class="paragraph"> <p>The aim of the replication queue is to batch the individual cache operations and send them as one, as opposed to sending each cache operation individually. As a result, replication queue enabled configurations perform generally better compared to those that have it switched off because less RPC messages are sent, fewer envelopes are used&#8230;etc. The only real trade off to the replication queue is that the queue is flushed periodically (based on time or queue size) and hence it might take longer for the replication/distribution/invalidation to be realised across the cluster. When replication queue is turned off, data is placed directly on the wire and hence it takes less for data to arrive to other nodes.</p> </div> <div class="paragraph"> <p>Until Infinispan 4.1.0.CR2, replication queue always flushed data with async marshalling turned on, which meant that there was a small gap where flush calls could be reordered. Since 4.1.0.CR3, async marshalling configuration is taken into account, and decides whether the flush calls goes directly to the JGroups layer, or whether an intermediate handing over to a different thread occurs. The advantages of using async marshalling with replication queue are less than clear because replication queue itself already makes client requests return faster, so it&#8217;s generally recommended to have async marshalling turned off, or &lt;asyncTransportExecutor&gt; element&#8217;s maxThreads set to 1, when replication queue is turned on.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645142_AsynchronousOptions-AsynchronousAPI"><a class="anchor" href="#sid-18645142_AsynchronousOptions-AsynchronousAPI"></a>15.5. Asynchronous API</h3> <div class="literalblock"> <div class="content"> <pre>Finally, the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737045$$[asynchronous API] can be used to emulate non-blocking APIs, whereby calls are handed over to a different thread and asynchronous API calls return to the client immediately. Similar to async marshalling, using this API can lead to reordering, so you should avoid calling modifying asynchronous methods on the same keys.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645142_AsynchronousOptions-ReturnValues"><a class="anchor" href="#sid-18645142_AsynchronousOptions-ReturnValues"></a>15.6. Return Values</h3> <div class="literalblock"> <div class="content"> <pre>Regardless of the asynchronous option used, the return values of cache operations are reliable. If talking about return values of cache operations that return previous value, the correctness of these returns are guaranteed as well regardless of the clustering mode. With replication, the previous value is already available locally, and with distribution, regardless of whether it's asynchronous or synchronous, Infinispan sends a synchronous request to get the previous value if not present locally. If on the other hand the asynchronous API is used, client code needs to get hold of the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/util/concurrent/NotifyingFuture.html$$[NotifiyngFuture] returned by the async operation in order to be able to query the previous value.</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645143"><a class="anchor" href="#sid-18645143"></a>16. Infinispan as Hibernate 2nd-Level Cache in JBoss AS 5.x</h2> <div class="sectionbody"> <div class="paragraph"> <p>A JBoss AS 5.x application can be configured to use Infinispan 4.x as the Hibernate 2nd-level cache, replacing JBoss Cache.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Add the attached jar files to the ear lib directory. These include the core 4.1.0.GA Infinispan jar (infinispan-core.jar), the Hibernate/Infinispan integration jar back-ported from Hibernate 3.5 (hibernate-infinispan-3.3.2.GA_CP03.jar), the JGroups jar required by Infinispan 4.1.0 (jgroups-2.10.0.GA.jar), and other required 3rd party jars (river-1.2.3.GA.jar, marshalling-api-1.2.3.GA.jar)</p> </li> <li> <p>Isolate the classloading to be ear-scoped by adding META-INF/jboss-classloading.xml</p> </li> </ol> </div> <div class="paragraph"> <p>.</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;classloading xmlns="urn:jboss:classloading:1.0" domain="simple-scoped" parent-first="false" /&gt;</pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Configure persistence.xml to use Infinispan instead of JBoss Cache:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"
   version="1.0"&gt;
&lt;persistence-unit name="jpa-test"&gt;
    &lt;jta-data-source&gt;java:/PostgresDS&lt;/jta-data-source&gt;
        &lt;properties&gt;
            &lt;property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect" /&gt;

            &lt;property name="hibernate.session_factory_name" value="SessionFactories/infinispan" /&gt;

            &lt;property name="hibernate.cache.use_query_cache" value="true" /&gt;
            &lt;property name="hibernate.cache.use_second_level_cache" value="true" /&gt;
            &lt;property name="hibernate.generate_statistics" value="true" /&gt;
            &lt;property name="hibernate.cache.use_structured_entries" value="true" /&gt;

            &lt;property name="hibernate.cache.region_prefix" value="infinispan" /&gt;

            &lt;property name="hibernate.show_sql" value="true" /&gt;

            &lt;property name="hibernate.hbm2ddl.auto" value="validate" /&gt;

            &lt;!-- Infinispan second level cache configuration --&gt;
            &lt;property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.infinispan.InfinispanRegionFactory" /&gt;
        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645144"><a class="anchor" href="#sid-18645144"></a>17. Clustered Configuration QuickStart</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan ships with _pre-configured_ JGroups stacks that make it easy for you to jump-start a clustered configuration.</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645144_ClusteredConfigurationQuickStart-UsinganexternalJGroupsfile"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-UsinganexternalJGroupsfile"></a>17.1. Using an external JGroups file</h3> <div class="literalblock"> <div class="content"> <pre>If you are configuring your cache programmatically, all you need to do is:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>// ...
GlobalConfiguration gc = new GlobalConfigurationBuilder().transport().addProperty("configurationFile", "jgroups.xml").build();
// ...
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>and if you happen to use an XML file to configure Infinispan, just use:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;infinispan&gt;
  &lt;global&gt;
    &lt;transport&gt;
      &lt;properties&gt;
        &lt;property name="configurationFile" value="jgroups.xml" /&gt;
      &lt;/properties&gt;
    &lt;/transport&gt;
  &lt;/global&gt;

  ...

&lt;/infinispan&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In both cases above, Infinispan looks for _jgroups.xml_ first in your classpath, and then for an absolute path name if not found in the classpath.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645144_ClusteredConfigurationQuickStart-UseoneofthepreconfiguredJGroupsfiles"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-UseoneofthepreconfiguredJGroupsfiles"></a>17.2. Use one of the pre-configured JGroups files</h3> <div class="paragraph"> <p>Infinispan ships with a few different JGroups files (packaged in infinispan-core.jar) which means they will already be on your classpath by default. All you need to do is specify the file name, e.g., instead of jgroups.xml above, specify jgroups-tcp.xml.</p> </div> <div class="paragraph"> <p>The configurations available are:</p> </div> <div class="ulist"> <ul> <li> <p>jgroups-udp.xml - Uses UDP as a transport, and UDP multicast for discovery. Usually suitable for larger (over 100 nodes) clusters <em>or</em> if you are using <a href="http://community.jboss.org/docs/DOC-14853#replicated">replication or invalidation</a> . Minimises opening too many sockets.</p> </li> <li> <p>jgroups-tcp.xml - Uses TCP as a transport and UDP multicast for discovery. Better for smaller clusters (under 100 nodes) <em>only if</em> you are using <a href="http://community.jboss.org/docs/DOC-14853#distribution">distribution</a> , as TCP is more efficient as a point-to-point protocol</p> </li> <li> <p>jgroups-ec2.xml - Uses TCP as a transport and <a href="http://community.jboss.org/docs/DOC-15925">S3_PING</a> for discovery. Suitable on <a href="http://">Amazon EC2</a> nodes where UDP multicast isn&#8217;t available.</p> </li> </ul> </div> <div class="sect3"> <h4 id="sid-18645144_ClusteredConfigurationQuickStart-FinetuningJGroupssettings"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-FinetuningJGroupssettings"></a>17.2.1. tuning JGroups settings</h4> <div class="paragraph"> <p>The settings above can be further tuned without editing the XML files themselves. Passing in certain system properties to your JVM at startup can affect the behaviour of some of these settings. The table below shows you which settings can be configured in this way. E.g.,</p> </div> <div class="listingblock"> <div class="content"> <pre>$ java -cp ... -Djgroups.tcp.port=1234 -Djgroups.tcp.address=10.11.12.13</pre> </div> </div> <div class="sect4"> <h5 id="sid-18645144_ClusteredConfigurationQuickStart-jgroupsudp.xml"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-jgroupsudp.xml"></a>jgroups-udp.xml</h5> <div class="literalblock"> <div class="content"> <pre>_System Property_ _Description_ _Default_ Required? _No_ _No_ _No_ |</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:25%;"> <col style="width:25%;"> <col style="width:25%;"> <col style="width:25%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_addr</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for multicast (both for communications and discovery). Must be a valid <a href="http://compnetworking.about.com/od/workingwithipaddresses/l/aa042400b.htm">Class D</a> IP address, suitable for IP multicast.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">228.6.7.8</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for multicast socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">46655</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.ip_ttl</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the time-to-live (TTL) for IP multicast packets. The value here refers to the number of network hops a packet is allowed to make before it is dropped</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="sid-18645144_ClusteredConfigurationQuickStart-jgroupstcp.xml"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-jgroupstcp.xml"></a>jgroups-tcp.xml</h5> <div class="literalblock"> <div class="content"> <pre>_System Property_ _Description_ _Default_ Required? _No_ _No_ _No_ _No_ _No_ |</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:25%;"> <col style="width:25%;"> <col style="width:25%;"> <col style="width:25%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_addr</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for multicast (for discovery). Must be a valid <a href="http://compnetworking.about.com/od/workingwithipaddresses/l/aa042400b.htm">Class D</a> IP address, suitable for IP multicast.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">228.6.7.8</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.mcast_port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for multicast socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">46655</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.udp.ip_ttl</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the time-to-live (TTL) for IP multicast packets. The value here refers to the number of network hops a packet is allowed to make before it is dropped</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> </tbody> </table> </div> <div class="sect4"> <h5 id="sid-18645144_ClusteredConfigurationQuickStart-jgroupsec2.xml"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-jgroupsec2.xml"></a>jgroups-ec2.xml</h5> <div class="literalblock"> <div class="content"> <pre>_System Property_ _Description_ _Default_ _Required?_ _No_ _No_ _Yes_ _Yes_ _Yes_ |</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:25%;"> <col style="width:25%;"> <col style="width:25%;"> <col style="width:25%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.address</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">IP address to use for the TCP transport.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">127.0.0.1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.tcp.port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to use for TCP socket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">7800</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.access_key</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The Amazon S3 access key used to access an S3 bucket</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.secret_access_key</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The Amazon S3 secret key used to access an S3 bucket</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">jgroups.s3.bucket</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Name of the Amazon S3 bucket to use. Must be unique and must already exist</p></td> <td class="tableblock halign-left valign-top"></td> <td class="tableblock halign-left valign-top"><p class="tableblock"> </p></td> </tr> </tbody> </table> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645144_ClusteredConfigurationQuickStart-Furtherreading"><a class="anchor" href="#sid-18645144_ClusteredConfigurationQuickStart-Furtherreading"></a>17.3. Further reading</h3> <div class="literalblock"> <div class="content"> <pre>JGroups also supports more system property overrides, details of which can be found on this page: link:$$http://community.jboss.org/docs/12352$$[SystemProps]</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In addition, the JGroups configuration files shipped with Infinispan are intended as a jumping off point to getting something up and running, and working.  More often than not though, you will want to fine-tune your JGroups stack further to extract every ounce of performance from your network equipment.  For this, your next stop should be the JGroups manual which has a link:$$http://jgroups.org/manual/html/protlist.html$$[detailed section] on configuring each of the protocols you see in a JGroups configuration file.</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645145"><a class="anchor" href="#sid-18645145"></a>18. Locking and Concurrency</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan makes use of multi-versioned concurrency control ( link:$$http://en.wikipedia.org/wiki/Multiversion_concurrency_control$$[MVCC] ) - a concurrency scheme popular with relational databases and other data stores. MVCC offers many advantages over coarse-grained Java synchronization and even JDK Locks for access to shared data, including:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>allowing concurrent readers and writers</p> </li> <li> <p>readers and writers do not block one another</p> </li> <li> <p>write skews can be detected and handled</p> </li> <li> <p>internal locks can be striped</p> </li> </ul> </div> <div class="paragraph"> <p>The rest of this wiki page is broken down into the following sections:</p> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-MVCCimplementationdetails"><a class="anchor" href="#sid-18645145_LockingandConcurrency-MVCCimplementationdetails"></a>18.1. MVCC implementation details</h3> <div class="literalblock"> <div class="content"> <pre>Infinispan's MVCC implementation makes use of minimal locks and synchronizations, leaning heavily towards lock-free techniques such as link:$$http://en.wikipedia.org/wiki/Compare-and-swap$$[compare-and-swap] and lock-free data structures wherever possible, which helps optimize for multi-CPU and multi-core environments.</pre> </div> </div> <div class="paragraph"> <p>In particular, Infinispan&#8217;s MVCC implementation is heavily optimized for readers.  Reader threads do not acquire explicit locks for entries, and instead directly read the entry in question.</p> </div> <div class="literalblock"> <div class="content"> <pre>Writers, on the other hand, need to acquire a write lock.  This ensures only one concurrent writer per entry, causing concurrent writers to queue up to change an entry.  To allow concurrent reads, writers make a copy of the entry they intend to modify, by wrapping the entry in a link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/container/entries/MVCCEntry.html$$[MVCCEntry] .  This copy isolates concurrent readers from seeing partially modified state.  Once a write has completed, MVCCEntry.commit() will flush changes to the data container and subsequent readers will see the changes written.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-Isolationlevels"><a class="anchor" href="#sid-18645145_LockingandConcurrency-Isolationlevels"></a>18.2. Isolation levels</h3> <div class="literalblock"> <div class="content"> <pre>Infinispan offers two isolation levels - link:$$http://en.wikipedia.org/wiki/Isolation_level#READ_COMMITTED$$[READ_COMMITTED] (the default) and link:$$http://en.wikipedia.org/wiki/Isolation_level#REPEATABLE_READ$$[REPEATABLE_READ] , configurable via the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/config.html#ce_default_locking$$[&amp;lt;locking /&amp;gt;] configuration element.  These isolation levels determine when readers see a concurrent write, and are implemented using different subclasses of link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/container/entries/MVCCEntry.html$$[MVCCEntry] , which have different behaviour in how state is committed back to the data container.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-TheLockManager"><a class="anchor" href="#sid-18645145_LockingandConcurrency-TheLockManager"></a>18.3. The LockManager</h3> <div class="paragraph"> <p>The LockManager is a component that is responsible for locking an entry for writing.  The LockManager makes use of a LockContainer to locate/hold/create locks.  LockContainers come in two broad flavours, with support for lock striping and with support for one lock per entry.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-Lockstriping"><a class="anchor" href="#sid-18645145_LockingandConcurrency-Lockstriping"></a>18.4. Lock striping</h3> <div class="paragraph"> <p>Lock striping entails the use of a fixed-size, shared collection of locks for the entire cache, with locks being allocated to entries based on the entry&#8217;s key&#8217;s hash code.  Similar to the way the JDK&#8217;s ConcurrentHashMap allocates locks, this allows for a highly scalable, fixed-overhead locking mechanism in exchange for potentially unrelated entries being blocked by the same lock.</p> </div> <div class="literalblock"> <div class="content"> <pre>The alternative is to disable lock striping - which would mean a _new_ lock is created per entry.  This approach _may_ give you greater concurrent throughput, but it will be at the cost of additional memory usage, garbage collection churn, etc.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>By default, lock striping is enabled.  The size of the shared lock collection used by lock striping can be tuned using the concurrencyLevel attribute of the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/config.html#ce_default_locking$$[&amp;lt;locking /&amp;gt;] configuration element.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-Concurrencylevels"><a class="anchor" href="#sid-18645145_LockingandConcurrency-Concurrencylevels"></a>18.5. Concurrency levels</h3> <div class="paragraph"> <p>In addition to determining the size of the striped lock container, this concurreny level is also used to tune any JDK ConcurrentHashMap based collections where related, such as internal to DataContainers.  Please refer to the JDK ConcurrentHashMap Javadocs for a detailed discussion of concurrency levels, as this parameter is used in exactly the same way in Infinispan.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-Explicitandimplicitdistributedeagerlocking"><a class="anchor" href="#sid-18645145_LockingandConcurrency-Explicitandimplicitdistributedeagerlocking"></a>18.6. Explicit and implicit distributed eager locking</h3> <div class="paragraph"> <p>Infinispan, by default, acquires remote locks lazily.  Locks are acquired locally on a node that runs a transaction while other cluster nodes attempt to lock cache keys involved in a transaction during two-phase prepare/commit phase. However, if desired, Infinispan can eagerly lock cache keys either explicitly or implicitly.</p> </div> <div class="paragraph"> <p>Infinispan cache interface exposes lock API that allows cache users to explicitly lock set of cache keys eagerly during a transaction. Lock call attempts to lock specified cache keys across all cluster nodes and it either succeeds or fails. All locks are released during commit or rollback phase.</p> </div> <div class="paragraph"> <p>Consider a transaction running on one of the cache nodes:</p> </div> <div class="listingblock"> <div class="content"> <pre>tx.begin()
cache.lock(K)    // acquire cluster wide lock on K
cache.put(K,V5)  // guaranteed to succeed
tx.commit()      // releases locks
</pre> </div> </div> <div class="paragraph"> <p>Implicit locking goes one step ahead and locks cache keys behind the scene as keys are accessed for modification operations.</p> </div> <div class="paragraph"> <p>Consider a transaction running on one of the cache nodes:</p> </div> <div class="listingblock"> <div class="content"> <pre>tx.begin()
cache.put(K,V)    // acquire cluster wide lock on K
cache.put(K2,V2)  // acquire cluster wide lock on K2
cache.put(K,V5)   // no-op, we already own cluster wide lock for K
tx.commit()       // releases locks
</pre> </div> </div> <div class="paragraph"> <p>Implicit eager locking locks cache keys across cluster nodes only if it is necessary to do so. In a nutshell, if implicit eager locking is turned on then for each modification Infinispan checks if cache key is locked locally. If it is then a global cluster wide lock has already been obtained, otherwise a cluster wide lock request is sent and lock is acquired.</p> </div> <div class="paragraph"> <p>Implicit eager locking is enabled as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;transaction useEagerLocking="true" /&gt;</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645145_LockingandConcurrency-Lockingasingleremotenode"><a class="anchor" href="#sid-18645145_LockingandConcurrency-Lockingasingleremotenode"></a>18.7. Locking a single remote node</h3> <div class="paragraph"> <p>Starting with 4.2, Infinispan allows eagerLockSingleNode configuration option. This only applies for DIST modes. Having this enabled would make the number of remote locks acquired to be always 1, disregarding the configured numOwners. Following diagrams are intended to explain better this option. All diagrams represent an cluster having 5 nodes, with numOwners=2.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>Above diagram shows the situation where eagerLockSingleNode=false (default configuration). On each lock request, numOwners remote calls are performed (in our example 2).</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>Above diagram shows how lock on the same key are acquired when eagerLockSingleNode=true. The number of remote calls being performed is always 1, disregarding numOwners values (it can actually be 0, as we&#8217;ll see later on).</p> </div> <div class="paragraph"> <p>In this scenario, if the lock owner fails (Node_C) then the transaction that holds the lock, which originated on Node_A is marked for rollback.</p> </div> <div class="literalblock"> <div class="content"> <pre>Combining eagerLockSingleNode with the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737123$$[KeyAffinityService] can bring some interesting advantages. The next diagram shows this:</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>By using link:$$http://$$[KeyAffinityService] one can generate keys that would always map to the local node. If eagerLockSingleNode=true, then the remote lock acquisition happens locally: this way one can benefit from eager locking semantics and having the same performance as non eager locking. The optimisation is affected by cluster topology changes, so keys might get relocated. But for clusters where topology changes are rather rare this can bring  a lot of value.</pre> </div> </div> <div class="paragraph"> <p>The following xml snippet shows how can be configured:</p> </div> <div class="listingblock"> <div class="content"> <pre>
      &lt;transaction
            transactionManagerLookupClass="org.infinispan.transaction.lookup.GenericTransactionManagerLookup"
            syncRollbackPhase="false"
            syncCommitPhase="false"
            useEagerLocking="true" eagerLockSingleNode="true"/&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
      &lt;transaction
            transactionManagerLookupClass="org.infinispan.transaction.lookup.GenericTransactionManagerLookup"
            syncRollbackPhase="false"
            syncCommitPhase="false"
            useEagerLocking="true" eagerLockSingleNode="true"/&gt;
</pre> </div> </div> <div class="paragraph"> <p>Note that the configuration is ignored if eager locking is disabled or cache mode is not DIST.</p> </div> <div class="sect3"> <h4 id="sid-18645145_LockingandConcurrency-Consistency"><a class="anchor" href="#sid-18645145_LockingandConcurrency-Consistency"></a>18.7.1. Consistency</h4> <div class="paragraph"> <p>The fact that a single owner is locked (as opposed to all owners being locked) does not break the following consistency guarantee: if key K is hashed to nodes {A, B} and transaction TX1 acquires a lock for K, let&#8217;s say on A. If another transaction, TX2, is started on B (or any other node) and TX2 tries to lock K then it will fail with a timeout as the lock is already held by TX1. The reason for this is the that the lock for a key K is always, deterministically, acquired on the same node of the cluster, regardless of where the transaction originates.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645146"><a class="anchor" href="#sid-18645146"></a>19. Configuring Cache declaratively</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>One of the major goals of Infinispan is to aim for zero configuration. A simple XML configuration file containing nothing more than a single infinispan element is enough to get you started. The configuration file listed below provides sensible defaults and is perfectly valid.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;infinispan /&gt;
</pre> </div> </div> <div class="paragraph"> <p>However, that would only give you the most basic, local mode, non-clustered cache. Non basic configurations are very likely to use customized global and default cache elements.</p> </div> <div class="literalblock"> <div class="content"> <pre>Declarative configuration is the most common approach to configuring Infinispan cache instances. In order to read XML configuration files one would typically construct an instance of CacheManager by pointing to an XML file containing Infinispan configuration. Once configuration file is read you can obtain reference to the default cache instance.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
CacheManager manager = new DefaultCacheManager("my-config-file.xml");
Cache defaultCache = manager.getCache();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>or any other named instance specified in "my-config-file.xml".</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
Cache someNamedCache = manager.getCache("someNamedCache");
</pre> </div> </div> <div class="paragraph"> <p>Every time you define &lt;namedCache&gt; element in XML configuration file, in addition to &lt;default&gt; cache element, you are effectively configuring additional caches whose settings are inheriting and/or overriding the default cache.</p> </div> <div class="literalblock"> <div class="content"> <pre>Refer to Infinispan configuration link:$$http://docs.jboss.org/infinispan/5.1/configdocs$$[reference] for more details. If you are using XML editing tools for configuration writing you can use provided Infinispan link:$$http://www.infinispan.org/schemas/infinispan-config-5.1.xsd$$[schema] to assist you.</pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645147"><a class="anchor" href="#sid-18645147"></a>20. Configuration Migration Tools</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan has a number of scripts for importing configurations from other cache products. Currently we have scripts to import configurations from:</p> </div> <div class="ulist"> <ul> <li> <p>JBoss Cache 3.x</p> </li> <li> <p>EHCache 1.x</p> </li> <li> <p>Coherence 3.x</p> <div class="literalblock"> <div class="content"> <pre>JBoss Cache 3.x itself supports configuration link:$$http://jbosscache.blogspot.com/2008/07/configuration-changes-in-jboss-cache-3.html$$[migration] from previous (2.x) versions, so JBoss Cache 2.x configurations can be migrated indirectly.</pre> </div> </div> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>If you wish to help write conversion tools for other caching systems, please contact &lt;a href="https://lists.jboss.org/mailman/listinfo/infinispan-dev"&gt;infinispan-dev&lt;/a&gt;. </pre> </div> </div> <div class="paragraph"> <p>There is a single scripts for importing configurations: ${infinispan_home}/bin/importConfig.sh and an equivalent .BAT script for Windows. Just run it and you should get a help message to assist you with the import:</p> </div> <div class="listingblock"> <div class="content"> <pre>C:\infinispan\bin&gt; importConfig.bat
Missing 'source', cannot proceed
Usage:
importConfig [-source &lt;the file to be transformed&gt;]
[-destination &lt;where to store resulting XML&gt;]
[-type &lt;the type of the source, possible values being: [JBossCache3x, Ehcache1x, Coherence35x] &gt;]

C:\infinispan\bin&gt;
</pre> </div> </div> <div class="paragraph"> <p>Here is how a JBoss Cache 3.x configuration file is imported:</p> </div> <div class="listingblock"> <div class="content"> <pre>C:\infinispan\bin&gt;importConfig.bat -source in\jbosscache_all.xml -destination out.xml -type JBossCache3x

WARNING! Preload elements cannot be automatically transformed, please do it manually!

WARNING! Please configure cache loader props manually!

WARNING! Singleton store was changed and needs to be configured manually!

IMPORTANT: Please take a look at the generated file
for (possible) TODOs about the elements that couldn't be converted automatically!

---

New configuration file [out.xml] successfully created.

---

C:\infinispan\bin&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Please read all warning messages _carefully_ and inspect the generated XML for potential TODO statements that indicate the need for manual intervention. In the case of JBoss Cache 3.x this would usually have to do with custom extensions, such as custom CacheLoaders that cannot be automatically migrated.</pre> </div> </div> <div class="paragraph"> <p>For EHCache and Coherence these may also contain suggestions and warnings for configuration options that may not have direct equivalents in Infinispan.</p> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645148"><a class="anchor" href="#sid-18645148"></a>21. Consistent Concurrent Updates With Hot Rod Versioned Operations</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-Introduction"><a class="anchor" href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-Introduction"></a>21.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Data structures, such as Infinispan link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/Cache.html$$[Cache] , that are accessed and modified concurrently can suffer from data consistency issues unless there're mechanisms to guarantee data correctness. Infinispan Cache, since it implements link:$$http://download.oracle.com/docs/cd/E17409_01/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html?is-external=true$$[ConcurrentMap] , provides operations such as link:$$http://download.oracle.com/docs/cd/E17409_01/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#replace(K, V, V)$$[conditional replace] , link:$$http://download.oracle.com/docs/cd/E17409_01/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#putIfAbsent(K, V)$$[putIfAbsent] , and link:$$http://download.oracle.com/docs/cd/E17409_01/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#remove(java.lang.Object, java.lang.Object)$$[conditional remove] to its clients in order to guarantee data correctness. It even allows clients to operate against cache instances within JTA transactions, hence providing the necessary data consistency guarantees.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>However, when it comes to link:$$http://community.jboss.org/wiki/HotRodProtocol$$[Hot Rod protocol] backed link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146$$[servers] , clients do not yet have the ability to start remote transactions but they can call instead versioned operations to mimic the conditional methods provided by the embedded Infinispan cache instance API.  Let's look at a real example to understand how it works.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-DataConsistencyProblem"><a class="anchor" href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-DataConsistencyProblem"></a>21.2. Data Consistency Problem</h3> <div class="paragraph"> <p>Imagine you have two ATMs that connect using Hot Rod to a bank where an account&#8217;s balance is stored. Two closely followed operations to retrieve the latest balance could return 500 CHF (swiss francs) as shown below:</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>Next a customer connects to the first ATM and requests 400 CHF to be retrieved. Based on the last value read, the ATM could calculate what the new balance is, which is 100 CHF, and request a put with this new value. Let&#8217;s imagine now that around the same time another customer connects to the ATM and requests 200 CHF to be retrieved. Let&#8217;s assume that the ATM thinks it has the latest balance and based on its calculations it sets the new balance to 300 CHF:</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>Obviously, this would be wrong. Two concurrent updates have resulted in an incorrect account balance. The second update should not have been allowed since the balance the second ATM had was incorrect. Even if the ATM would have retrieved the balance before calculating the new balance, someone could have updated between the new balance being retrieved and the update. Before finding out how to solve this issue in a client-server scenario with Hot Rod, let&#8217;s look at how this is solved when Infinispan clients run in peer-to-peer mode where clients and Infinispan live within the same JVM.</p> </div> <div class="sect3"> <h4 id="sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-PeertoPeerSolution"><a class="anchor" href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-PeertoPeerSolution"></a>21.2.1. to-Peer Solution</h4> <div class="literalblock"> <div class="content"> <pre>If the ATM and the Infinispan instance storing the bank account lived in the same JVM, the ATM could use the link:$$http://download.oracle.com/docs/cd/E17409_01/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html#replace(K, V, V)$$[conditional replace API] referred at the beginning of this article.  So, it could send the previous known value to verify whether it has changed since it was last read.  By doing so, the first operation could double check that the balance is still 500 CHF when it was to update to 100 CHF.  Now, when the second operation comes, the current balance would not be 500 CHF any more and hence the conditional replace call would fail, hence avoiding data consistency issues:</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> </div> <div class="sect3"> <h4 id="sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-ClientServerSolution"><a class="anchor" href="#sid-18645148_ConsistentConcurrentUpdatesWithHotRodVersionedOperations-ClientServerSolution"></a>21.2.2. Client-Server Solution</h4> <div class="paragraph"> <p>In theory, Hot Rod could use the same p2p solution but sending the previous value would be not practical. In this example, the previous value is just an integer but the value could be a lot bigger and hence forcing clients to send it to the server would be rather wasteful. Instead, Hot Rod offers versioned operations to deal with this situation.</p> </div> <div class="literalblock"> <div class="content"> <pre>Basically, together with each key/value pair, Hot Rod stores a version number which uniquely identifies each modification. So, using an operation called link:$$http://community.jboss.org/wiki/HotRodProtocol#getWithVersion_response$$[getVersioned or getWithVersion] , clients can retrieve not only the value associated with a key, but also the current version. So, if we look at the previous example once again, the ATMs could call getVersioned and get the balance's version:</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>When the ATMs wanted to modify the balance, instead of just calling put, they could call link:$$http://community.jboss.org/wiki/HotRodProtocol#removeIfUnmodified_request$$[replaceIfUnmodified] operation passing the latest version number of which the clients are aware of.  The operation will only succeed if the version passed matches the version in the server.  So, the first modification by the ATM would be allowed since the client passes 1 as version and the server side version for the balance is also 1.  On the other hand, the second ATM would not be able to make the modification because after the first ATMs modification the version would have been incremented to 2, and now the passed version (1) and the server side version (2) would not match:</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>Finally, to find out how to call these operations from a Java environment, checkout link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142$$[the Java Hot Rod Client article] .</pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645149"><a class="anchor" href="#sid-18645149"></a>22. CacheLoaders</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Introduction"><a class="anchor" href="#sid-18645149_CacheLoaders-Introduction"></a>22.1. Introduction</h3> <div class="paragraph"> <p>Cache loader is Infinispan&#8217;s connection to a (persistent) data store. Cache loader fetches data from a store when that data is not in the cache, and when modifications are made to data in the cache the CacheLoader is called to store those modifications back to the store. Cache loaders are associated with individual caches, i.e. different caches from the same cache manager might have different cache store configurations.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Configuration"><a class="anchor" href="#sid-18645149_CacheLoaders-Configuration"></a>22.2. Configuration</h3> <div class="paragraph"> <p>Cache loaders can be configured in a chain. Cache read operations will look at all of the cache loaders in the order they&#8217;ve been configured until it finds a valid, non-null element of data. When performing writes all cache loaders are written to except if the ignoreModifications element has been set to true for a specific cache loader. See the configuration section below for details.</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;loaders passivation="false" shared="false" preload="true"&gt;
   &lt;!-- We can have multiple cache loaders, which get chained --&gt;
   &lt;loader class="org.infinispan.loaders.file.FileCacheStore"
           fetchPersistentState="true"
           purgerThreads="3"
           purgeSynchronously="true"
           ignoreModifications="false"
           purgeOnStartup="false"&gt;
      &lt;!-- See the documentation for more configuration examples and flags. --&gt;
      &lt;properties&gt;
         &lt;property name="location" value="${java.io.tmpdir}"/&gt;
      &lt;/properties&gt;
      &lt;singletonStore enabled="true" pushStateWhenCoordinator="true" pushStateTimeout="20000"/&gt;
      &lt;async enabled="true" flushLockTimeout="15000" threadPoolSize="5"/&gt;
   &lt;/loader&gt;
&lt;/loaders&gt;
</pre> </div> </div> <div class="ulist"> <ul> <li> <p>passivation (false by default) has a significant impact on how Infinispan interacts with the loaders, and it is discussed <a href="http://community.jboss.org/docs/DOC-14893#Cache_Passivation">here</a> .</p> </li> <li> <p>shared (false by default) indicates that the cache loader is shared among different cache instances, for example where all instances in a cluster use the same JDBC settings to talk to the same remote, shared database. Setting this to true prevents repeated and unnecessary writes of the same data to the cache loader by different cache instances.</p> </li> <li> <p>preload (false by default) if true, when the cache starts, data stored in the cache loader will be pre-loaded into memory. This is particularly useful when data in the cache loader is needed immediately after startup and you want to avoid cache operations being delayed as a result of loading this data lazily. Can be used to provide a <em>warm-cache</em> on startup, however there is a performance penalty as startup time is affected by this process. Note that preloading is done in a local fashion, so any data loaded is only stored locally in the node. No replication or distribution of the preloaded data happens. Also, Infinispan only preloads up to the maximum configured number of entries in eviction.</p> </li> <li> <p>class attribute (mandatory) defines the class of the cache loader implementation.</p> </li> <li> <p>fetchPersistentState (false by default) determines whether or not to fetch the persistent state of a cache when joining a cluster. The aim here is to take the persistent state of a cache and apply it to the local cache store of the joining node. Hence, if cache store is configured to be shared, since caches access the same cache store, fetch persistent state is ignored. Only one configured cache loader may set this property to true; if more than one cache loader does so, a configuration exception will be thrown when starting your cache service.</p> </li> <li> <p>purgeSynchronously will control whether the expiration takes place in the eviction thread, i.e. if purgeSynchronously (false by default) is set to true, the eviction thread will block until the purging is finished, otherwise would return immediately. If the cache loader supports multi-threaded purge then purgeThreads (1 by default) are used for purging expired entries. There are cache loaders that support multi-threaded purge (e.g. FileCacheStore) and caches that don&#8217;t (e.g. JDBCCacheStore); check the actual cache loader configuration in order to see that.</p> </li> <li> <p>ignoreModifications(false by default) determines whether write methods are pushed down to the specific cache loader. Situations may arise where transient application data should only reside in a file based cache loader on the same server as the in-memory cache, for example, with a further JDBC based cache loader used by all servers in the network. This feature allows you to write to the <em>local</em> file cache loader but not the shared JDBCCacheLoader.</p> </li> <li> <p>purgeOnStatup empties the specified cache loader (if ignoreModifications is false) when the cache loader starts up.</p> </li> <li> <p>properties element contains configurations specific to each cache loader, e.g. the location property in the previous example refers to where the FileCacheStore will keep the files that contain data.</p> </li> <li> <p>singletonStore (default for enabled is false) element enables modifications to be stored by only one node in the cluster, the coordinator. Essentially, whenever any data comes in to some node it is always replicated(or distributed) so as to keep the caches in-memory states in sync; the coordinator, though, has the sole responsibility of pushing that state to disk. This functionality can be activated setting the enabled attribute to true in all nodes, but again only the coordinator of the cluster will the modifications in the underlying cache loader as defined in loader element. You cannot define a shared and with singletonStore enabled at the same time.</p> </li> <li> <p>pushStateWhenCoordinator (true by default) If true, when a node becomes the coordinator, it will transfer in-memory state to the underlying cache loader. This can be very useful in situations where the coordinator crashes and the new coordinator is elected.</p> </li> <li> <p>async element has to do with cache loader persisting data (a)synchronously to the actual store. It is discussed in detail <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737144">here</a> .</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-CachePassivation"><a class="anchor" href="#sid-18645149_CacheLoaders-CachePassivation"></a>22.3. Cache Passivation</h3> <div class="paragraph"> <p>A cache loader can be used to enforce entry passivation and activation on eviction in a cache. Cache passivation is the process of removing an object from in-memory cache and writing it to a secondary data store (e.g., file system, database) on eviction. Cache Activation is the process of restoring an object from the data store into the in-memory cache when it&#8217;s needed to be used. In both cases, the configured cache loader will be used to read from the data store and write to the data store.</p> </div> <div class="paragraph"> <p>When an eviction policy in effect evicts an entry from the cache, if passivation is enabled, a notification that the entry is being passivated will be emitted to the cache listeners and the entry will be stored. When a user attempts to retrieve a entry that was evicted earlier, the entry is (lazily) loaded from the cache loader into memory. When the entry and its children have been loaded, they&#8217;re removed from the cache loader and a notification is emitted to the cache listeners that the entry has been activated. In order to enable passivation just set passivation to true (false by default). When passivation is used, only the first cache loader configured is used and all others are ignored.</p> </div> <div class="sect3"> <h4 id="sid-18645149_CacheLoaders-CacheLoaderBehaviorwithPassivationDisabledvsEnabled"><a class="anchor" href="#sid-18645149_CacheLoaders-CacheLoaderBehaviorwithPassivationDisabledvsEnabled"></a>22.3.1. Cache Loader Behavior with Passivation Disabled vs Enabled</h4> <div class="paragraph"> <p>When passivation is disabled, whenever an element is modified, added or removed, then that modification is persisted in the backend store via the cache loader. There is no direct relationship between eviction and cache loading. If you don&#8217;t use eviction, what&#8217;s in the persistent store is basically a copy of what&#8217;s in memory. If you do use eviction, what&#8217;s in the persistent store is basically a superset of what&#8217;s in memory (i.e. it includes entries that have been evicted from memory). When passivation is enabled, there is a direct relationship between eviction and the cache loader. Writes to the persistent store via the cache loader only occur as part of the eviction process. Data is deleted from the persistent store when the application reads it back into memory. In this case, what&#8217;s in memory and what&#8217;s in the persistent store are two subsets of the total information set, with no intersection between the subsets. Following is a simple example, showing what state is in RAM and in the persistent store after each step of a 6 step process:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Insert  keyOne</p> </li> <li> <p>Insert  keyTwo # Eviction thread runs, evicts keyOne</p> </li> <li> <p>Read  keyOne # Eviction thread runs, evicts keyTwo</p> </li> <li> <p>Remove  keyTwo</p> <div class="literalblock"> <div class="content"> <pre>When passivation is _disabled_ :</pre> </div> </div> </li> <li> <p>Memory: keyOne Disk: keyOne</p> </li> <li> <p>Memory: keyOne, keyTwo Disk: keyOne, keyTwo</p> </li> <li> <p>Memory: keyTwo Disk: keyOne, keyTwo</p> </li> <li> <p>Memory: keyOne, keyTwo Disk: keyOne, keyTwo</p> </li> <li> <p>Memory: keyOne Disk: keyOne, keyTwo</p> </li> <li> <p>Memory: keyOne Disk: keyOne</p> <div class="literalblock"> <div class="content"> <pre>When passivation is _enabled_ :</pre> </div> </div> </li> <li> <p>Memory: keyOne Disk:</p> </li> <li> <p>Memory: keyOne, keyTwo Disk:</p> </li> <li> <p>Memory: keyTwo Disk: keyOne</p> </li> <li> <p>Memory: keyOne, keyTwo Disk:</p> </li> <li> <p>Memory: keyOne Disk: keyTwo</p> </li> <li> <p>Memory: keyOne Disk:</p> </li> </ol> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Filesystembasedcacheloaders"><a class="anchor" href="#sid-18645149_CacheLoaders-Filesystembasedcacheloaders"></a>22.4. File system based cache loaders</h3> <div class="paragraph"> <p>Infinispan ships with several cache loaders that utilize the file system as a data store. They all require that the &lt;properties&gt; element within &lt;loader&gt; contains a location property, which maps to a directory to be used as a persistent store. (e.g.,  location=/tmp/myDataStore  ).</p> </div> <div class="ulist"> <ul> <li> <p>FileCacheStore , which is a simple filesystem-based implementation. The FileCacheStore has some severe limitations which restrict its use in a production environment, or if used in such an environment, it should be used with due care and sufficient understanding of these limitations. Usage on shared filesystems like NFS, Windows shares, etc. should be avoided as these do not implement proper file locking and can cause data corruption. File systems are inherently not transactional, so when attempting to use your cache in a transactional context, failures when writing to the file (which happens during the commit phase) cannot be recovered. As a rule of thumb, it is recommended that the FileCacheStore not be used in a highly concurrent, transactional or stressful environment, and its use is restricted to testing. Please visit the <a href="http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/loaders/file/FileCacheStoreConfig.html">file cache store configuration documentation</a> for more information on the configurable parameters of this store. As a rule of thumb, it is recommended that the FileCacheStore not be used in a highly concurrent, transactional or stressful environment, and its use is restricted to testing.</p> </li> <li> <p>BdbjeCacheStore, which is a cache loader implementation based on the <a href="http://www.oracle.com/database/berkeley-db/je/index.html">Oracle/Sleepycat&#8217;s BerkeleyDB Java Edition</a> .</p> </li> <li> <p><a href="http://jdbm.sourceforge.net/">JdbmCacheStore</a> , which is a cache loader implementation based on the JDBM engine, a fast and free alternative to BerkeleyDB.</p> <div class="literalblock"> <div class="content"> <pre>Note that the BerkeleyDB implementation is much more efficient than the filesystem-based implementation, and provides transactional guarantees,  but requires a commercial license if distributed with an application (see link:$$http://www.oracle.com/database/berkeley-db/index.html$$[] for details).</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For detailed description of all the parameters supported by the stores, please consult the link:$$http://infinispan.sourceforge.net/4.0/apidocs/$$[javadoc] .</pre> </div> </div> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-JDBCbasedcacheloaders"><a class="anchor" href="#sid-18645149_CacheLoaders-JDBCbasedcacheloaders"></a>22.5. JDBC based cache loaders</h3> <div class="paragraph"> <p>Based on the type of keys to be persisted, there are three JDBC cache loaders:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/binary/JdbcBinaryCacheStore.html">JdbcBinaryCacheStore</a> - can store any type of keys. It stores all the keys that have the same hash value (hashCode method on key) in the same table row/blob, having as primary key the hash value. While this offers great flexibility (can store any key type), it impacts concurrency/throughput. E.g. If storing k1,k2 and k3 keys, and keys had same hash code, then they&#8217;d persisted in the same table row. Now, if 3 threads try to concurrently update k1, k2 and k3 respectively, they would need to do it sequentially since these threads would be updating the same row.</p> </li> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStore.html">JdbcStringBasedCacheStore</a> - stores each key in its own row, increasing throughput under concurrent load. In order to store each key in its own column, it relies on a (pluggable) bijection that maps the each key to a String object. The bijection is defined by the Key2StringMapper interface. Infinispans ships a default implementation (smartly named <a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/DefaultKey2StringMapper.html">DefaultKey2StringMapper</a> ) that knows how to handle primitive types.</p> </li> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/mixed/JdbcMixedCacheStore.html">JdbcMixedCacheStore</a> - it is a hybrid implementation that, based on the key type, delegates to either <a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/binary/JdbcBinaryCacheStore.html">JdbcBinaryCacheStore</a> or <a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStore.html">JdbcStringBasedCacheStore</a> .</p> </li> </ul> </div> <div class="sect3"> <h4 id="sid-18645149_CacheLoaders-WhichJDBCcacheloadershouldIuse%3F"><a class="anchor" href="#sid-18645149_CacheLoaders-WhichJDBCcacheloadershouldIuse%3F"></a>22.5.1. Which JDBC cache loader should I use?</h4> <div class="literalblock"> <div class="content"> <pre>It is generally preferable to use link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStore.html$$[JdbcStringBasedCacheStore] when you are in control of the key types, as it offers better throughput under heavy load. One scenario in which it is not possible to use it though, is when you can't write an link:$$http://infinispan.sourceforge.net/4.0/apidocs/$$[Key2StringMapper] to map the keys to to string objects (e.g. when you don't have control over the types of the keys, for whatever reason). Then you should use either link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/binary/JdbcBinaryCacheStore.html$$[JdbcBinaryCacheStore] or link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/mixed/JdbcMixedCacheStore.html$$[JdbcMixedCacheStore] . The later is preferred to the former when the majority of the keys are handled by link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStore.html$$[JdbcStringBasedCacheStore] , but you still have some keys you cannot convert through link:$$http://infinispan.sourceforge.net/4.0/apidocs/$$[Key2StringMapper] .</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645149_CacheLoaders-Connectionmanagement%28pooling%29"><a class="anchor" href="#sid-18645149_CacheLoaders-Connectionmanagement%28pooling%29"></a>22.5.2. Connection management (pooling)</h4> <div class="literalblock"> <div class="content"> <pre>In order to obtain a connection to the database all the JDBC cache loaders rely on an link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/connectionfactory/ConnectionFactory.html$$[ConnectionFactory] implementation. The connection factory can be specified through the _connectionFactoryClass_ configuration attribute. Infinispan ships with three ConnectionFactoy implementations:</pre> </div> </div> <div class="ulist"> <ul> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/connectionfactory/PooledConnectionFactory.html">PooledConnectionFactory</a> is a factory based on <a href="http://sourceforge.net/projects/c3p0/">C3P0</a> . Refer to <a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/connectionfactory/PooledConnectionFactory.html">javadoc</a> for details on configuring it.</p> </li> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/connectionfactory/ManagedConnectionFactory.html">ManagedConnectionFactory</a> is a connection factory that can be used within managed environments, such as application servers. It knows how to look into the JNDI tree at a certain location (configurable) and delegate connection management to the DataSource. Refer to javadoc <a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/connectionfactory/ManagedConnectionFactory.html">javadoc</a> for details on how this can be configured.</p> </li> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/connectionfactory/SimpleConnectionFactory.html">SimpleConnectionFactory</a> is a factory implementation that will create database connection on a per invocation basis. Not recommended in production.</p> </li> </ul> </div> <div class="paragraph"> <p>The PooledConnectionFactory is generally recommended for stand-alone deployments (i.e. not running within AS or Servlet container). ManagedConnectionFactory can be used when running in a managed environment where a DataSource is present, so that connection pooling is performed within the DataSource.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645149_CacheLoaders-Sampleconfigurations"><a class="anchor" href="#sid-18645149_CacheLoaders-Sampleconfigurations"></a>22.5.3. Sample configurations</h4> <div class="literalblock"> <div class="content"> <pre>Bellow is  an sample configuration for the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/binary/JdbcBinaryCacheStore.html$$[JdbcBinaryCacheStore] . For detailed  description of all the parameters used refer to the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/binary/JdbcBinaryCacheStoreConfig.html$$[javadoc] .</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;loaders&gt;
   &lt;loader class="org.infinispan.loaders.jdbc.binary.JdbcBinaryCacheStore" fetchPersistentState="false"ignoreModifications="false"
purgeOnStartup="false"&gt;
      &lt;properties&gt;
         &lt;property name="bucketTableNamePrefix" value="ISPN_BUCKET_TABLE"/&gt;
         &lt;property name="idColumnName" value="ID_COLUMN"/&gt;
         &lt;property name="dataColumnName" value="DATA_COLUMN"/&gt;
         &lt;property name="timestampColumnName" value="TIMESTAMP_COLUMN"/&gt;
         &lt;property name="timestampColumnType" value="BIGINT"/&gt;
         &lt;property name="connectionFactoryClass" value="org.infinispan.loaders.jdbc.connectionfactory.PooledConnectionFactory"/&gt;
         &lt;property name="connectionUrl" value="jdbc:h2:mem:infinispan_binary_based;DB_CLOSE_DELAY=-1"/&gt;
         &lt;property name="userName" value="sa"/&gt;
         &lt;property name="driverClass" value="org.h2.Driver"/&gt;
         &lt;property name="idColumnType" value="VARCHAR(255)"/&gt;
         &lt;property name="dataColumnType" value="BINARY"/&gt;
         &lt;property name="dropTableOnExit" value="true"/&gt;
         &lt;property name="createTableOnStart" value="true"/&gt;
      &lt;/properties&gt;
   &lt;/loader&gt;
&lt;/loaders&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Bellow is  an sample configuration for the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStore.html$$[JdbcStringBasedCacheStore] . For detailed  description of all the parameters used refer to the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/stringbased/JdbcStringBasedCacheStoreConfig.html$$[javadoc] .</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;loaders&gt;

   &lt;loader class="org.infinispan.loaders.jdbc.stringbased.JdbcStringBasedCacheStore" fetchPersistentState="false" ignoreModifications="false"
purgeOnStartup="false"&gt;
      &lt;properties&gt;
         &lt;property name="stringsTableNamePrefix" value="ISPN_STRING_TABLE"/&gt;
         &lt;property name="idColumnName" value="ID_COLUMN"/&gt;
         &lt;property name="dataColumnName" value="DATA_COLUMN"/&gt;
         &lt;property name="timestampColumnName" value="TIMESTAMP_COLUMN"/&gt;
         &lt;property name="timestampColumnType" value="BIGINT"/&gt;
         &lt;property name="connectionFactoryClass" value="org.infinispan.loaders.jdbc.connectionfactory.PooledConnectionFactory"/&gt;
         &lt;property name="connectionUrl" value="jdbc:h2:mem:string_based_db;DB_CLOSE_DELAY=-1"/&gt;
         &lt;property name="userName" value="sa"/&gt;
         &lt;property name="driverClass" value="org.h2.Driver"/&gt;
         &lt;property name="idColumnType" value="VARCHAR(255)"/&gt;
         &lt;property name="dataColumnType" value="BINARY"/&gt;
         &lt;property name="dropTableOnExit" value="true"/&gt;
         &lt;property name="createTableOnStart" value="true"/&gt;
      &lt;/properties&gt;
   &lt;/loader&gt;
&lt;/loaders&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Bellow is  an sample configuration for the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/mixed/JdbcMixedCacheStore.html$$[JdbcMixedCacheStore] . For detailed  description of all the parameters used refer to the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/jdbc/mixed/JdbcMixedCacheStoreConfig.html$$[javadoc] .</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;loaders&gt;
   &lt;loader class="org.infinispan.loaders.jdbc.mixed.JdbcMixedCacheStore" fetchPersistentState="false"
           ignoreModifications="false" purgeOnStartup="false"&gt;

      &lt;properties&gt;
         &lt;property name="tableNamePrefixForStrings" value="ISPN_MIXED_STR_TABLE"/&gt;
         &lt;property name="tableNamePrefixForBinary" value="ISPN_MIXED_BINARY_TABLE"/&gt;
         &lt;property name="idColumnNameForStrings" value="ID_COLUMN"/&gt;
         &lt;property name="idColumnNameForBinary" value="ID_COLUMN"/&gt;
         &lt;property name="dataColumnNameForStrings" value="DATA_COLUMN"/&gt;
         &lt;property name="dataColumnNameForBinary" value="DATA_COLUMN"/&gt;
         &lt;property name="timestampColumnNameForStrings" value="TIMESTAMP_COLUMN"/&gt;
         &lt;property name="timestampColumnNameForBinary"value="TIMESTAMP_COLUMN"/&gt;
         &lt;property name="timestampColumnTypeForStrings" value="BIGINT"/&gt;
         &lt;property name="timestampColumnTypeForBinary" value="BIGINT"/&gt;
         &lt;property name="connectionFactoryClass" value="org.infinispan.loaders.jdbc.connectionfactory.PooledConnectionFactory"/&gt;
         &lt;property name="connectionUrl" value="jdbc:h2:mem:infinispan_mixed_cs;DB_CLOSE_DELAY=-1"/&gt;
         &lt;property name="userName" value="sa"/&gt;
         &lt;property name="driverClass" value="org.h2.Driver"/&gt;
         &lt;property name="idColumnTypeForStrings" value="VARCHAR(255)"/&gt;
         &lt;property name="idColumnTypeForBinary" value="VARCHAR(255)"/&gt;
         &lt;property name="dataColumnTypeForStrings" value="BINARY"/&gt;
         &lt;property name="dataColumnTypeForBinary" value="BINARY"/&gt;
         &lt;property name="dropTableOnExitForStrings" value="false"/&gt;
         &lt;property name="dropTableOnExitForBinary" value="false"/&gt;
         &lt;property name="createTableOnStartForStrings" value="true"/&gt;
         &lt;property name="createTableOnStartForBinary" value="true"/&gt;
         &lt;property name="createTableOnStartForStrings" value="true"/&gt;
         &lt;property name="createTableOnStartForBinary" value="true"/&gt;
      &lt;/properties&gt;
   &lt;/loader&gt;
&lt;/loaders&gt;
</pre> </div> </div> <div class="paragraph"> <p>Finally, please find a below an example of a JDBC cache store with a managed connection factory:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;loader class="org.infinispan.loaders.jdbc.stringbased.JdbcStringBasedCacheStore" fetchPersistentState="false"
        ignoreModifications="false" purgeOnStartup="false"&gt;
   &lt;properties&gt;
      &lt;property name="stringsTableNamePrefix" value="ISPN_STRING_TABLE"/&gt;
      &lt;property name="idColumnName" value="ID_COLUMN"/&gt;
      &lt;property name="dataColumnName" value="DATA_COLUMN"/&gt;
      &lt;property name="timestampColumnName" value="TIMESTAMP_COLUMN"/&gt;
      &lt;property name="timestampColumnType" value="BIGINT"/&gt;
      &lt;property name="connectionFactoryClass"
                value="org.infinispan.loaders.jdbc.connectionfactory.ManagedConnectionFactory"/&gt;
      &lt;property name="datasourceJndiLocation" value="java:/StringStoreWithManagedConnectionTest/DS"/&gt;
      &lt;property name="idColumnType" value="VARCHAR(255)"/&gt;
      &lt;property name="dataColumnType" value="BINARY"/&gt;
      &lt;property name="dropTableOnExit" value="true"/&gt;
      &lt;property name="createTableOnStart" value="true"/&gt;
   &lt;/properties&gt;
&lt;/loader&gt;
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Apache Derby users</div> <div class="literalblock"> <div class="content"> <pre>If you're connecting to an Apache Derby database, make sure you set dataColumnType to BLOB :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
      &lt;property name="dataColumnType" value="BLOB"/&gt;
</pre> </div> </div> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Cloudcacheloader"><a class="anchor" href="#sid-18645149_CacheLoaders-Cloudcacheloader"></a>22.6. Cloud cache loader</h3> <div class="literalblock"> <div class="content"> <pre>The CloudCacheStore implementation utilizes link:$$http://code.google.com/p/jclouds/$$[JClouds] to communicate with cloud storage providers such as link:$$http://aws.amazon.com/s3/$$[Amazon's S3] , Rackspace's link:$$http://www.rackspacecloud.com/cloud_hosting_products/files$$[Cloudfiles] or any other such provider supported by JClouds. If you're planning to use Amazon S3 for storage, consider using it with Infinispan. Infinispan itself provides in-memory caching for your data  to minimize the amount of remote access calls, thus reducing the latency and cost of fetching your Amazon S3 data. With cache replication, you are also able to load data from your local cluster without having to  remotely access it every time. Note that Amazon S3 does not support transactions. If transactions are used in  your application then there is some possibility of state inconsistency  when using this cache loader. However, writes are atomic, in that if a  write fails nothing is considered written and data is never corrupted. For a list of configuration refer to the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/loaders/cloud/CloudCacheStoreConfig.html$$[javadoc] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Remotecacheloader"><a class="anchor" href="#sid-18645149_CacheLoaders-Remotecacheloader"></a>22.7. Remote cache loader</h3> <div class="literalblock"> <div class="content"> <pre>The RemoteCacheStore is a cache loader implementation that stores data in a remote infinispan cluster. In order to communicate with the remote cluster, the RemoteCacheStore uses the HotRod client/server architecture. HotRod bering the load balancing and fault tolerance of calls and the possibility to fine-tune the connection between the RemoteCacheStore and the actual cluster. Please refer to HotRod for more information on the protocol, link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142$$[client] and link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146$$[server] configuration. For a list of RemoteCacheStore configuration refer to the link:$$http://docs.jboss.org/infinispan/4.2/apidocs/org/infinispan/loaders/remote/RemoteCacheStore.html$$[javadoc] . Example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;loaders passivation="false" shared="true" preload="false"&gt;
   &lt;loader class="org.infinispan.loaders.remote.RemoteCacheStore" fetchPersistentState="false"
           ignoreModifications="false" purgeOnStartup="false"&gt;
      &lt;properties&gt;
         &lt;property name="hotRodClientPropertiesFile" value="hotrod-client.properties"/&gt;
         &lt;property name="useDefaultRemoteCache" value="true"/&gt;
      &lt;/properties&gt;
   &lt;/loader&gt;
&lt;/loaders&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In this sample configuration, the remote cache store is configured with a Hot Rod client properties file contained in the same path as the XML configuration file. For more info on the contents of this properties file, see the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142$$[Hot Rod client] page.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Cassandracacheloader"><a class="anchor" href="#sid-18645149_CacheLoaders-Cassandracacheloader"></a>22.8. Cassandra cache loader</h3> <div class="literalblock"> <div class="content"> <pre>The CassandraCacheStore was introduced in Infinispan 4.2. Read the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737148$$[specific page] for details on implementation and configuration.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645149_CacheLoaders-Clustercacheloader"><a class="anchor" href="#sid-18645149_CacheLoaders-Clustercacheloader"></a>22.9. Cluster cache loader</h3> <div class="paragraph"> <p>The ClusterCacheLoader is a cache loader implementation that retrieves data from other cluster members.</p> </div> <div class="literalblock"> <div class="content"> <pre>It is a cache loader only as it doesn't persist anything (it is not a Store), therefore features like _fetchPersistentState_ (and like) are not applicable.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>A cluster cache loader can be used as a non-blocking (partial) alternative to _stateTransfer_ : keys not already available in the local node are fetched on-demand from other nodes in the cluster. This is a kind of lazy-loading of the cache content.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>{code:xml}
&lt;loaders&gt;
   &lt;loader class="org.infinispan.loaders.cluster.ClusterCacheLoader /&gt;
&lt;/loaders&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>{code} For a list of ClusterCacheLoader configuration refer to the link:$$http://docs.jboss.org/infinispan/4.2/apidocs/org/infinispan/loaders/cluster/ClusterCacheLoaderConfig.html$$[javadoc] .</pre> </div> </div> <div class="paragraph"> <p>Note: The ClusterCacheLoader does not support preloading(preload=true). It also won&#8217;t provide state if fetchPersistentSate=true.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645150"><a class="anchor" href="#sid-18645150"></a>23. Portable Serialization For Hot Rod With Apache Avro</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645150_PortableSerializationForHotRodWithApacheAvro-Introduction"><a class="anchor" href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-Introduction"></a>23.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Starting with Infinispan 5.0, Hot Rod clients can be configured with a marshaller that produces plattform independent payloads using link:$$http://avro.apache.org/$$[Apache Avro] . This means that payloads generated by a Java, Avro-based, marshaller could be read by a Python, Avro-based, marshaller. When Hot Rod clients in other languages such as Python or Ruby become available, this will mean that for example, data stored via Java Hot Rod client will be readable by a Python Hot Rod client.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645150_PortableSerializationForHotRodWithApacheAvro-LanguagesSupported"><a class="anchor" href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-LanguagesSupported"></a>23.2. Languages Supported</h3> <div class="paragraph"> <p>Avro currently supports providing portable serialization payloads for the following languages:</p> </div> <div class="ulist"> <ul> <li> <p>C</p> </li> <li> <p>C++</p> </li> <li> <p>Java</p> </li> <li> <p>Python</p> </li> <li> <p>Ruby</p> </li> </ul> </div> <div class="paragraph"> <p>So interoperability of payloads is limited to these languages. The choice of Avro over other existing portable serialization libraries (i.e. Google Protocol Buffers, Apache Thrift, MessagePack&#8230;etc) was done based languages supported, ease of use, and payload size.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645150_PortableSerializationForHotRodWithApacheAvro-ObjectTypesSupported"><a class="anchor" href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-ObjectTypesSupported"></a>23.3. Object Types Supported</h3> <div class="paragraph"> <p>Avro based marshaller currently supports basic type and collection marshalling:</p> </div> <div class="ulist"> <ul> <li> <p>Basic types include:</p> </li> <li> <p>UTF-8 string</p> </li> <li> <p>Integer</p> </li> <li> <p>Long</p> </li> <li> <p>Float</p> </li> <li> <p>Double</p> </li> <li> <p>Boolean</p> </li> <li> <p>Byte Array</p> </li> <li> <p>Collections composed of the basic types :</p> </li> <li> <p>Arrays</p> </li> <li> <p>Lists</p> </li> <li> <p>Maps</p> </li> <li> <p>Sets</p> <div class="literalblock"> <div class="content"> <pre>Marshalling of complex objects is not supported because it's not fully solvable as some language don't support some concepts other languages offer. Instead, it is recommended that for any complex object marshalling requirements, users serialize these complex objects into byte arrays using portable serialization libraries such as link:$$http://code.google.com/apis/protocolbuffers/$$[Google Protocol Buffers] , link:$$http://incubator.apache.org/thrift/$$[Apache Thrift] , link:$$http://msgpack.org/$$[MessagePack] , or link:$$http://avro.apache.org/$$[Apache Avro] . Once the byte array has been created, simply pass it to the Hot Rod client API which will handle it accordingly.</pre> </div> </div> </li> </ul> </div> <div class="paragraph"> <p>Therefore, it&#8217;s clear that users are free to use any portable serialization library to transform their complex objects into byte arrays, regardless of the fact that Infinispan uses Apache Avro for basic type and collection marshalling. The only limitation here is that the target language used to serialize complex objects needs to be amongst the languages that Apache Avro supports.</p> </div> <div class="literalblock"> <div class="content"> <pre>Short and Byte Java primitive types are not supported per se. Instead, clients should pass integers which will be encoded efficiently using link:$$http://lucene.apache.org/java/2_4_0/fileformats.html#VInt$$[variable-length] link:$$http://code.google.com/apis/protocolbuffers/docs/encoding.html#types$$[zig zag] coding. Primitive arrays not supported except byte arrays. Instead, use their object counter partners, i.e. Integer...etc.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645150_PortableSerializationForHotRodWithApacheAvro-JavaConfiguration"><a class="anchor" href="#sid-18645150_PortableSerializationForHotRodWithApacheAvro-JavaConfiguration"></a>23.4. Java Configuration</h3> <div class="literalblock"> <div class="content"> <pre>To configure a Java Hot Rod client with Avro marshaller, simply pass a infinispan.client.hotrod.marshaller property to the RemoteCacheManager constructor containing the value of org.infinispan.client.hotrod.marshall.ApacheAvroMarshaller . For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Properties props = new Properties();
props.put("infinispan.client.hotrod.marshaller",
   "org.infinispan.client.hotrod.marshall.ApacheAvroMarshaller");
RemoteCacheManager remoteCacheManager = new RemoteCacheManager(props);
</pre> </div> </div> <div class="paragraph"> <p>Note however that if all you&#8217;re gonna be using are Java Hot Rod clients, there&#8217;s no need to configure Avro based marshaller. The default marshaller is capable of transforming any Serializable or Externalizable java object into a byte array in a quick and efficient manner.</p> </div> <div class="paragraph"> <p>Please remember as well that when remote java clients are configured with the apache avro marshaller, the server&#8217;s marshaller does not need changing. This is because the server does not make any attempt at unmarshalling the data that&#8217;s been passed to it. Internally, it keeps the data as byte arrays.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645151"><a class="anchor" href="#sid-18645151"></a>24. The Grouping API</h2> <div class="sectionbody"> <div class="paragraph"> <p>In some cases you may wish to co-locate a group of entries onto a particular node. In this, the group API will be useful for you.</p> </div> <div class="sect2"> <h3 id="sid-18645151_TheGroupingAPI-Howdoesitwork%3F"><a class="anchor" href="#sid-18645151_TheGroupingAPI-Howdoesitwork%3F"></a>24.1. How does it work?</h3> <div class="paragraph"> <p>Infinispan allocates each node a portion of the total hash space. Normally, when you store an entry, Infinispan will take a hash of the key, and store the entry on the node which owns that portion of the hash space. Infinispan always uses an algorithm to locate a key in the hash space, never allowing the node on which the entry is stored to be specified manually. This scheme allows any node to know which nodes owns a key, without having to distribute such ownership information. This reduces the overhead of Infinispan, but more importantly improves redundancy as there is no need to replicate the ownership information in case of node failure.</p> </div> <div class="literalblock"> <div class="content"> <pre>If you use the grouping API , then Infinispan will ignore the hash of the key when deciding which _node_ to store the entry on, and instead use a hash of the group. Infinispan still uses the hash of the key to store the entry on a node. When the group API is in use, it is important that every node can still compute, using an algorithm, the owner of every key. For this reason, the group cannot be specified manually. The group can either be intrinsic to the entry (generated by the key class) or extrinsic (generated by an external function).</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645151_TheGroupingAPI-HowdoIusethegroupingAPI%3F"><a class="anchor" href="#sid-18645151_TheGroupingAPI-HowdoIusethegroupingAPI%3F"></a>24.2. How do I use the grouping API?</h3> <div class="paragraph"> <p>First, you must enable groups. If you are configuring Infinispan programmatically, then call:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Configuration c = new ConfigurationBuilder().clustering().hash().groups().enabled().build();
</pre> </div> </div> <div class="paragraph"> <p>Or, if you are using XML:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;clustering&gt;
  &lt;hash&gt;
     &lt;groups enabled="true" /&gt;
  &lt;/hash&gt;
&lt;/clustering&gt;
</pre> </div> </div> <div class="paragraph"> <p>If you have control of the key class (you can alter the class definition, it&#8217;s not part of an unmodifiable library), and the determination of the group is not an orthogonal concern to the key class, then we recommend you use an intrinsic group. The intrinsic group can be specified using the @Group annotation placed on the method. Let&#8217;s take a look at an example:</p> </div> <div class="listingblock"> <div class="content"> <pre>
class User {

   ...
   String office;
   ...

   int hashCode() {
      // Defines the hash for the key, normally used to determine location
      ...
   }

   // Override the location by specifying a group, all keys in the same
   // group end up with the same owner
   @Group
   String getOffice() {
      return office;
   }

}
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="literalblock"> <div class="content"> <pre>The group must be a String .</pre> </div> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>If you don&#8217;t have control over the key class, or the determination of the group is an orthogonal concern to the key class, we recommend you use an extrinsic group. In extrinsic group is specified by implementing the Grouper interface, which has a single method computeGroup, which should return the group. Grouper acts as an interceptor, passing the previously computed value in. The group passed to the first Grouper will be that determined by @Group (if @Groupis defined). This allows you even greater control over the group when using an intrinsic group. For a grouper to be used when determining the group for a key, it&#8217;s keyType must be assignable from the key being grouped.</p> </div> <div class="paragraph"> <p>Let&#8217;s take a look at an example of a Grouper:</p> </div> <div class="listingblock"> <div class="content"> <pre>
public class KXGrouper implements Grouper&lt;String&gt; {

   // A pattern that can extract from a "kX" (e.g. k1, k2) style key
   // The pattern requires a String key, of length 2, where the first character is
   // "k" and the second character is a digit. We take that digit, and perform
   // modular arithmetic on it to assign it to group "1" or group "2".
   private static Pattern kPattern = Pattern.compile("(^k)(&lt;a&gt;\\d&lt;/a&gt;)$");

    public String computeGroup(String key, String group) {
        Matcher matcher = kPattern.matcher(key);
        if (matcher.matches()) {
            String g = Integer.parseInt(matcher.group(2)) % 2 + "";
            return g;
        } else
            return null;
    }

    public Class&lt;String&gt; getKeyType() {
        return String.class;
    }

}
</pre> </div> </div> <div class="paragraph"> <p>Here we determine a simple grouper that can take the key class and extract from the group from the key using a pattern. We ignore any group information specified on the key class.</p> </div> <div class="paragraph"> <p>You must register every grouper you wish to have used. If you are configuring Infinispan programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Configuration c = new ConfigurationBuilder().clustering().hash().groups().addGrouper(new KXGrouper()).build();
</pre> </div> </div> <div class="paragraph"> <p>Or, if you are using XML:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;clustering&gt;
  &lt;hash&gt;
     &lt;groups enabled="true"&gt;
        &lt;grouper class="com.acme.KXGrouper" /&gt;
     &lt;/groups&gt;
  &lt;/hash&gt;
&lt;/clustering&gt;
</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645152"><a class="anchor" href="#sid-18645152"></a>25. Infinispan transactions</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-JTASupport"><a class="anchor" href="#sid-18645152_Infinispantransactions-JTASupport"></a>25.1. JTA Support</h3> <div class="paragraph"> <p>Infinispan can be configured to use and to participate in JTA compliant transactions. Alternatively, if transaction support is disabled, it is equivalent to using autocommit in JDBC calls, where modifications are potentially replicated after every change (if replication is enabled).</p> </div> <div class="paragraph"> <p>On every cache operation Infinispan does the following:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Retrieves the current <a href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api/javax/transaction/Transaction.html">Transaction</a> associated with the thread 2. If not already done, registers <a href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api/javax/transaction/xa/XAResource.html">XAResource</a> with the transaction manager to be notified when a transaction commits or is rolled back.</p> <div class="literalblock"> <div class="content"> <pre>In order to do this, the cache has to be provided with a reference to the environment's link:$$http://java.sun.com/j2ee/sdk_1.3/techdocs/api/javax/transaction/TransactionManager.html$$[TransactionManager] . This is usually done by configuring the cache with the class name of an implementation of the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/transaction/lookup/TransactionManagerLookup.html$$[TransactionManagerLookup] interface. When the cache starts, it will create an instance of this class and invoke its getTransactionManager() method, which returns a reference to the TransactionManager.</pre> </div> </div> </li> </ol> </div> <div class="paragraph"> <p>Infinispan ships with several transaction manager lookup classes:</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/transaction/lookup/DummyTransactionManagerLookup.html">DummyTransactionManagerLookup</a> : This provides with a dummy transaction manager which should only be used for testing. Being a dummy, this is not recommended for production use a it has some severe limitations to do with concurrent transactions and recovery.</p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/transaction/lookup/JBossStandaloneJTAManagerLookup.html">JBossStandaloneJTAManagerLookup</a> : If you&#8217;re running Infinispan in a standalone environment, this should be your default choice for transaction manager. It&#8217;s a fully fledged transaction manager based on <a href="http://www.jboss.org/jbosstm">JBoss Transactions</a> which overcomes all the deficiencies of the dummy transaction manager.</p> </li> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/transaction/lookup/GenericTransactionManagerLookup.html">GenericTransactionManagerLookup</a> : This is a lookup class that locate transaction managers in the most popular Java EE application servers. If no transaction manager can be found, it defaults on the dummy transaction manager.</p> </li> <li> <p><a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/transaction/lookup/JBossTransactionManagerLookup.html">JBossTransactionManagerLookup</a> : This lookup class locates the transaction manager running within a JBoss Application Server instance.</p> </li> </ul> </div> <div class="paragraph"> <p>Once initialized, the TransactionManager can also be obtained from the Cache itself:</p> </div> <div class="listingblock"> <div class="content"> <pre>
//the cache must have a transactionManagerLookupClass defined
Cache cache = cacheManager.getCache();

//equivalent with calling TransactionManagerLookup.getTransactionManager();
TransactionManager tm = cache.getAdvancedCache().getTransactionManager();
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-Configuringtransactions"><a class="anchor" href="#sid-18645152_Infinispantransactions-Configuringtransactions"></a>25.2. Configuring transactions</h3> <div class="paragraph"> <p>Transactions are being configured at cache level; bellow is a sample configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;transaction
      transactionManagerLookupClass="org.infinispan.transaction.lookup.GenericTransactionManagerLookup"
      transactionMode="TRANSACTIONAL"
      lockingMode="OPTIMISTIC"/&gt;
</pre> </div> </div> <div class="ulist"> <ul> <li> <p>transactionManagerLookupClass fully qualified class name of a class that looks up a reference to a javax.transaction.TransactionManager</p> </li> <li> <p>transactionMode - configures whether the cache is transactional or not</p> </li> <li> <p>lockingMode - configures whether the cache uses optimistic or pessimistic locking.</p> <div class="literalblock"> <div class="content"> <pre>For more details on how two phase commit (2PC) is implemented in Infinispan and how locks are being acquired see the section below. All possible transactional settings are available in link:$$http://docs.jboss.org/infinispan/5.1/configdocs/$$[Configuration reference]</pre> </div> </div> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-Transactionalmodes"><a class="anchor" href="#sid-18645152_Infinispantransactions-Transactionalmodes"></a>25.3. Transactional modes</h3> <div class="paragraph"> <p>Starting with Infinispan 5.1 release a cache can accessed either transactionally or non-transactionally. The mixed access mode is no longer supported. There are several reasons for going this path, but one of them most important is a cleaner semantic on how concurrency is managed between multiple requestors for the same cache entry.</p> </div> <div class="paragraph"> <p>By default, all Infinispan caches are non-transactional. A cache can be made transactional by changing the transactionMode attribute:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;namedCache name="transactional"&gt;
  &lt;transaction transactionMode="TRANSACTIONAL"/&gt;
&lt;/namedCache&gt;
</pre> </div> </div> <div class="paragraph"> <p>transactionMode can only take two values: TRANSACTIONAL and NON_TRANSACTIONAL; one can configure a transactional cache programatically as well:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Configuration c = new ConfigurationBuilder().transaction().transactionMode(TransactionMode.TRANSACTIONAL).build();
assert c.transaction().transactionalCache();
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>Do not forget to configure a TransactionManagerLookup for transactional caches.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Supported transaction models are optimistic and pessimistic. Optimistic model is an improvement over the old transaction model as it completely defers lock acquisition to transaction prepare time. New approach reduces lock acquisition duration and increases throughput which in turn avoids deadlocks significantly. In pessimistic model, cluster wide-locks are acquired on each write operation only being released after the transaction completed.</p> </div> <div class="sect3"> <h4 id="sid-18645152_Infinispantransactions-OptimisticTransactions"><a class="anchor" href="#sid-18645152_Infinispantransactions-OptimisticTransactions"></a>25.3.1. Optimistic Transactions</h4> <div class="paragraph"> <p>With optimistic transactions locks are being acquired at transaction prepare time and are only being held up to the point the transaction commits (or rollbacks). This is different from the 5.0 default locking model where local locks are being acquire on writes and cluster locks are being acquired during prepare time.</p> </div> <div class="paragraph"> <p>Optimistic transactions can be enabled in the configuration file:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;namedCache name="transactional"&gt;
  &lt;transaction transactionMode="TRANSACTIONAL" lockingMode="OPTIMISTIC"/&gt;
&lt;/namedCache&gt;
</pre> </div> </div> <div class="paragraph"> <p>or programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Configuration c = new ConfigurationBuilder().transaction().lockingMode(LockingMode.OPTIMISTIC).build();
assert c.transaction().lockingMode() == LockingMode.OPTIMISTIC;
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>By default, a transactional cache is optimistic.</p> </div> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="sid-18645152_Infinispantransactions-PessimisticTransactions"><a class="anchor" href="#sid-18645152_Infinispantransactions-PessimisticTransactions"></a>25.3.2. Pessimistic Transactions</h4> <div class="paragraph"> <p>From a lock acquisition perspective, pessimistic transactions obtain locks on keys at the time the key is written. E.g.</p> </div> <div class="listingblock"> <div class="content"> <pre>
transactionManager.begin();
cache.put(k1,v1); //k1 is locked
cache.remove(k2); //k2 is locked when this returns
transactionManager.commit();
</pre> </div> </div> <div class="paragraph"> <p>When cache.put(k1,v1) returns k1 is locked and no other transaction running anywhere in the cluster can write to it. Reading k1 is still possible. The lock on k1 is released when the transaction completes (commits or rollbacks).</p> </div> <div class="paragraph"> <p>Pessimistic transactions can be enabled in the configuration file:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;namedCache name="transactional"/&gt;
  &lt;transaction transactionMode="TRANSACTIONAL" lockingMode="PESSIMISTIC"/&gt;
&lt;/namedCache&gt;
</pre> </div> </div> <div class="paragraph"> <p>or programatically:</p> </div> <div class="listingblock"> <div class="content"> <pre>
Configuration c = new ConfigurationBuilder().transaction().lockingMode(LockingMode.PESSIMISTIC).build();
assert c.transaction().lockingMode() == LockingMode.PESSIMISTIC;
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645152_Infinispantransactions-Backwardcompatibility"><a class="anchor" href="#sid-18645152_Infinispantransactions-Backwardcompatibility"></a>25.3.3. Backward compatibility</h4> <div class="paragraph"> <p>The autoCommit attribute was added in order to assure backward compatibility. If a cache is transactional and autoCommit is enabled (defaults to true) then any call that is performed outside of a transaction&#8217;s scope is transparently wrapped within a transaction. In other words Infinispan adds the logic for starting a transaction before the call and committing it after the call.</p> </div> <div class="paragraph"> <p>Therefore if your code accesses a cache both transactionally and non-transactionally all you have to do when migrating to Infinispan 5.1 is mark the cache as transactional and enable autoCommit (that&#8217;s actually enabled by default)</p> </div> <div class="paragraph"> <p>The autoCommit feature can be managed through configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;namedCache name="transactional"&gt;;
  &lt;transaction transactionMode="TRANSACTIONAL" autoCommit="true"/&gt;
&lt;/namedCache&gt;
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645152_Infinispantransactions-WhatdoIneedpessimisticoroptimistictransactions%3F"><a class="anchor" href="#sid-18645152_Infinispantransactions-WhatdoIneedpessimisticoroptimistictransactions%3F"></a>25.3.4. What do I need - pessimistic or optimistic transactions?</h4> <div class="literalblock"> <div class="content"> <pre>From a use case perspective, optimistic transactions should be used when there is _not_ a lot of contention between multiple transactions running at the same time. That is because the optimistic transactions rollback if data has changed between the time it was read and the time it was committed (writeSkewCheck).</pre> </div> </div> <div class="paragraph"> <p>On the other hand, pessimistic transactions might be a better fit when there is high contention on the keys and transaction rollbacks are less desirable. Pessimistic transactions are more costly by their nature: each write operation potentially involves a RPC for lock acquisition.</p> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-Deadlockdetection"><a class="anchor" href="#sid-18645152_Infinispantransactions-Deadlockdetection"></a>25.4. Deadlock detection</h3> <div class="literalblock"> <div class="content"> <pre>Deadlocks can significantly (up to one order of magnitude, see benchmarks) reduce the throughput of a system, especially when multiple transactions are operating agains the same key set. Deadlock detection is disabled by default, but can be enabled/configured per cache (i.e. under namedCache config element) by adding the following:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;deadlockDetection enabled="true" spinDuration="1000"/&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Some clues on when to enable deadlock detection. A high number of transaction rolling back due to link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/util/concurrent/TimeoutException.html$$[TimeoutException] is an indicator that this functionality might help. TimeoutException might be caused by other causes as well, but deadlocks will always result in this exception being thrown. Generally, when you have a high contention on a set of keys, deadlock detection may help. But the best way is not to guess the performance improvement but to benchmark and monitor it: you can have access to statistics (e.g. number of deadlocks detected) through JMX, as it is exposed via the DeadlockDetectingLockManager MBean. For more details on how deadlock detection works, benchmarks and design details refer to link:$$http://infinispan.blogspot.com/2009/07/increase-transactional-throughput-with.html$$[this] article.</pre> </div> </div> <div class="paragraph"> <p>Note: deadlock detection only runs on an a per cache basis: deadlocks that spread over two or more caches won&#8217;t be detected.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-Transactionandexceptions"><a class="anchor" href="#sid-18645152_Infinispantransactions-Transactionandexceptions"></a>25.5. Transaction and exceptions</h3> <div class="literalblock"> <div class="content"> <pre>If a link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/CacheException.html$$[CacheException] (or a subclass of it) is thrown by a cache method within the scope of a JTA transaction, then the transaction is automatically marked for rollback.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-Transactionrecoveryonnodefailures"><a class="anchor" href="#sid-18645152_Infinispantransactions-Transactionrecoveryonnodefailures"></a>25.6. Transaction recovery on node failures</h3> <div class="literalblock"> <div class="content"> <pre>Transaction recovery is discussed in link:$$http://community.jboss.org/docs/DOC-16646?uniqueTitle=false$$[this] document.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645152_Infinispantransactions-EnlistingSynchronization"><a class="anchor" href="#sid-18645152_Infinispantransactions-EnlistingSynchronization"></a>25.7. Enlisting Synchronization</h3> <div class="literalblock"> <div class="content"> <pre>By default Infinispan registers itself as a first class participant in distributed transactions through link:$$http://download.oracle.com/javaee/1.3/api/javax/transaction/xa/XAResource.html$$[XAResource] . There are situations where Infinispan is not required to be a participant in the transaction, but only to be notified by its lifecycle (prepare, complete): e.g. in the case Infinispan is used as a 2nd level cache in Hiberenate.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Starting with 5.0  release, Infinispan allows transaction enlistment through link:$$http://download.oracle.com/javaee/1.3/api/javax/transaction/Synchronization.html$$[Synchronisation] . This can be enabled through the _useSynchronization_ attribute on the _transaction_ element:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;transaction useSynchronization="true"/&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>link:$$http://download.oracle.com/javaee/1.3/api/javax/transaction/Synchronization.html$$[Synchronisation] s have the advantage that they allow TransactionManager to optimize 2PC with a 1PC where only one other resource is enlisted with that transaction ( link:$$http://docs.redhat.com/docs/en-US/JBoss_Enterprise_Web_Platform/5/html/Administration_And_Configuration_Guide/ch09s04.html$$[last resource commit optimization] ). E.g. Hibernate second level cache: if Infinispan registers itself with the TransactionManager as a link:$$http://download.oracle.com/javaee/1.3/api/javax/transaction/xa/XAResource.html$$[XAResource] than at commit time, the TransactionManager sees two link:$$http://download.oracle.com/javaee/1.3/api/javax/transaction/xa/XAResource.html$$[XAResource] (cache and database) and does not make this optimization. Having to coordinate between two resources it needs to write the tx log to disk. On the other hand, registering Infinispan as a link:$$http://download.oracle.com/javaee/1.3/api/javax/transaction/Synchronization.html$$[Synchronisation] makes the TransactionManager skip wrtting the log to the disk (performance improvement).</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645153"><a class="anchor" href="#sid-18645153"></a>26. Load Testing Infinispan Server Modules</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan comes with different server implementations that allow Infinispan to be accessed remotely. You can find an overview about these servers link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737048$$[here] .</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>This wiki explains how to load test and benchmark these server implementations using link:$$http://grinder.sourceforge.net/$$[Grinder] , which is a Java load testing framework that makes it easy to run a distributed test using many load injector machines.</pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>First of all, <a href="http://grinder.sourceforge.net/download.html">download Grinder version 3.4 or higher</a> and unzip it somewhere locally.</p> </li> <li> <p>Next, <a href="http://www.jboss.org/infinispan/downloads.html">download</a> and unzip the Infinispan version that you want to be testing. Make sure you download the -all.zip distribution to run these tests. Note that although Infinispan REST server was included in 4.0, Memcached and Hot Rod servers are only included from 4.1 onwards.</p> </li> <li> <p>Download Infinispan Grinder scripts and other material from <a href="http://github.com/galderz/infinispan-server-grinder/archives/master">this source repository</a> .</p> </li> <li> <p>Next up, modify bin/setGrinderEnv.sh file to set correct environment paths. Primarily, you should be looking at setting the following properties correctly (The rest of properties not mentioned below can be left as they are) :</p> </li> <li> <p>INFINISPAN_HOME : It should point to the location where Infinispan was unzipped.</p> </li> <li> <p>GRINDER_HOME : It should point to where Grinder was unzipped.</p> </li> <li> <p>GRINDER_PROPERTIES : It should point to the grinder.properties provided with the Infinispan Grinder scripts</p> </li> <li> <p>SPYMEMCACHED_HOME : It should only be modified to point to Spymemcached Memcached client library if you&#8217;re planning to load test Infinispan Memcached server.</p> </li> <li> <p>It is time now to start the Infinispan server that you want to be testing. For detailed information on starting up a Hot Rod server, check <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146">this wiki</a> . If you want to start the Hot Rod server quickly, the following command should do the job:</p> </li> <li> <p>$INFINISPAN_HOME/bin/startServer.sh -r hotrod -l 0.0.0.0</p> </li> <li> <p>Finally, let&#8217;s start the load test. Currently, a single load test exists which after a warmup phase, it does a certain amount of put/get calls on a pool of keys with a configurable distribution. By default, it executes 20% put operations and 80% get operations. So, if you&#8217;re going to start the Hot Rod test, you&#8217;d simply do:</p> </li> <li> <p>cd infinispan-server-grinder/</p> </li> <li> <p>./bin/startHotRodAgent.sh</p> </li> <li> <p>Once the test has finished, the output can be located in infinispan-server-grinder/log/out-&lt;host&gt;-0.log and will show something like this at the bottom:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>         Tests    Errors   Mean Test   Test Time   TPS        
                           Time (ms)   Standard                
                                       Deviation               
                                       (ms)                    

Test 1   25       0        13742.56    457.22      0.29      "Warmup (1000 ops)"
Test 2   400136   0        1.92        2.55        4687.08   "Read (20000 ops per thread)"
Test 3   99864    0        2.41        4.97        1169.78   "Put (20000 ops per thread)"

Totals   500025   0        2.70        97.26       1952.38 
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>   The output is saying that it first run 25 threads, each sending 1000 operations in order to warm up the cache. Afterwards, each of these 25 threads send 20.000 operations making a total of 500.000 operations, out of which 400136 were get calls and 99864 were put calls, and the test here indicates what was the mean test time for each of these operations, including standard deviation and how many operations per second (TPS) were executed. In this case, 4686 get operations per second and 1169 put operations per second.</pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645154"><a class="anchor" href="#sid-18645154"></a>27. Using Infinispan as JPA-Hibernate Second Level Cache Provider</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-Overview"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-Overview"></a>27.1. Overview</h3> <div class="literalblock"> <div class="content"> <pre>Following some of the principles set out by Brian Stansberry in link:$$http://community.jboss.org/docs/14247$$[Using JBoss Cache 3 as a Hibernate 3.5 Second Level Cache] and taking in account improvements introduced by Infinispan, an Infinispan JPA/Hibernate second level cache provider has just been developed. This wiki will explain how to configure JPA/Hibernate to use the Infinispan and for those keen on lower level details, the key design decisions made and differences with previous JBoss Cache based cache providers.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>If you're unfamiliar with JPA/Hibernate Secone Level Caching, I'd suggest you have a read to Chapter 2.1 in link:$$http://www.jboss.org/jbossclustering/docs/hibernate-jbosscache-guide-3.pdf$$[this guide] which explains the different types of data that can be cached.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-Configuration"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-Configuration"></a>27.2. Configuration</h3> <div class="olist arabic"> <ol class="arabic"> <li> <p>First of all, to enable JPA/Hibernate second level cache with query result caching enabled ( <em>Note</em> : Query result caching, or for that matter entity caching, may not improve application performance. Be sure to benchmark your application with and without caching.), add either of the following:</p> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.use_second_level_cache" value="true" /&gt;
&lt;property name="hibernate.cache.use_query_cache" value="true" /&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.use_second_level_cache"&gt;true&lt;/property&gt;
&lt;property name="hibernate.cache.use_query_cache"&gt;true&lt;/property&gt;
</pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Now, configure the Infinispan cache region factory using one of the two options below:</p> </li> </ol> </div> <div class="paragraph"> <p>• If the Infinispan CacheManager instance happens to be bound to JNDI select JndiInfinispanRegionFactory as the cacheregion factory and add the cache manager&#8217;s JNDI name:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.infinispan.JndiInfinispanRegionFactory" /&gt;
&lt;property name="hibernate.cache.infinispan.cachemanager" value="java:CacheManager" /&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.region.factory_class"&gt;org.hibernate.cache.infinispan.JndiInfinispanRegionFactory&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.cachemanager"&gt;java:CacheManager/entity&lt;/property&gt;
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">JBoss Application Server</div> <div class="literalblock"> <div class="content"> <pre>JBoss Application Server 6 and 7 deploy a shared Infinispan cache manager that can be used by all services, so when trying to configure applications with Infinispan second level cache, you should use the JNDI name for the cache manager responsible for the second level cache. By default, this is "java:CacheManager/entity". In any other application server, you can still deploy your own cache manager and link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=5832910$$[bind the CacheManager to JNDI] , but in this cases, it's generally preferred that the following method is used.</pre> </div> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>• If running JPA/Hibernate and Infinispan standalone or within third party Application Server, select InfinispanRegionFactory as the cache region factory:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.infinispan.InfinispanRegionFactory"/&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.region.factory_class"&gt;org.hibernate.cache.infinispan.InfinispanRegionFactory&lt;/property&gt;
</pre> </div> </div> <div class="paragraph"> <p>This is all the configuration you need to run JPA/Hibernate with the Infinispan cache provider with the default settings. This should suit the majority of use cases but sometimes, further configuration is required and to help with such situations, please check the following section where more advanced settings are discussed.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultConfigurationExplained"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultConfigurationExplained"></a>27.3. Default Configuration Explained</h3> <div class="paragraph"> <p>The aim of this section is to explain the default settings for each of the different global data type (entity, collection, query and timestamps) caches, why these were chosen and what are the available alternatives.</p> </div> <div class="sect3"> <h4 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforEntity%2FCollectionCaching"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforEntity%2FCollectionCaching"></a>27.3.1. Defaults for Entity/Collection Caching</h4> <div class="ulist"> <ul> <li> <p>By default, for all entities and collections, whenever an new <em>entity or collection is read from database</em> and needs to be cached, <em>it&#8217;s only cached locally</em> in order to reduce intra-cluster traffic. This option cannot be changed.</p> </li> <li> <p>By default, all <em>entities and collections are configured to use a synchronous invalidation</em> as clustering mode. This means that when an entity is updated, the updated cache will send a message to the other members of the cluster telling them that the entity has been modified. Upon receipt of this message, the other nodes will remove this data from their local cache, if it is stored there. This option can be changed to use replication by configuring entities or collections to use "replicated-entity" cache but it&#8217;s not recommended.</p> </li> <li> <p>By default, all <em>entities and collections have initial state transfer disabled</em> since there&#8217;s no need for it. It it&#8217;s not recommended that this is enabled.</p> </li> <li> <p>By default, <em>entities and collections are configured to use READ_COMMITTED</em> as cache isolation level. It would only make sure to configure REPEATABLE_READ if the application evicts/clears entities from the Hibernate Session and then expects to repeatably re-read them in the same transaction. Otherwise, the Session&#8217;s internal cache provides a repeatable-read semantic. If you really need to use REPEATABLE_READ, you can simply configure entities or collections to use "entity-repeatable" cache.</p> </li> <li> <p>By default, entities and collections are configured with eviction settings:</p> </li> <li> <p>Eviction wake up interval is 5 seconds.</p> </li> <li> <p>Max number of entries are 10.000</p> </li> <li> <p>Max idle time before expiration is 100 seconds</p> <div class="literalblock"> <div class="content"> <pre>       You can change these settings on a per entity or collection basis or per individual entity or collection type.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>       More information in the "Advanced Configuration" section below.</pre> </div> </div> </li> <li> <p>Finally, by default, both <em>entites and collections are configured with lazy deserialization</em> which helps deserialization when entities or collections are stored in isolated deployments. If you&#8217;re sure you&#8217;ll never deploy your entities or collections in classloader isolated deployment archives, you can disable this settting.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforQueryCaching"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforQueryCaching"></a>27.3.2. Defaults for Query Caching</h4> <div class="ulist"> <ul> <li> <p>By default, query cache is configured so that <em>queries are only cached locally</em> . Alternatively, you can configure query caching to use replication by selecting the "replicated-query" as query cache name. However, replication for query cache only makes sense if, and only if, all of this conditions are true:</p> </li> <li> <p>query is quite expensive</p> </li> <li> <p>query is very likely to be repeated in different cluster nodes</p> </li> <li> <p>and query is unlikely to be invalidated out of the cache (Note: Hibernate must agressively invalidate query results from the cache any time any instance of one of the entity classes involved in the query&#8217;s WHERE clause changes. All such query results are invalidated, even if the change made to the entity instance would not have affected the query result)</p> </li> <li> <p>By default, <em>query cache</em> uses the <em>same cache isolation levels and eviction/expiration settings as for entities/collections</em> .</p> </li> <li> <p>By default, <em>query cache has initial state transfer disabled</em> . It is not recommended that this is enabled.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforTimestampsCache"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-DefaultsforTimestampsCache"></a>27.3.3. Defaults for Timestamps Cache</h4> <div class="ulist"> <ul> <li> <p>By default, <em>timestamps cache is configured with asynchronous replication</em> as clustering mode. Local or invalidated cluster modes are not allowed, since all cluster nodes must store all timestamps. As a result, <em>no eviction/expiration is allowed for timestamp caches either</em> .</p> </li> <li> <p>By default, <em>timestamps is configured with a cluster cache loader (in Hibernate 3.6.0 or earlier it had state transfer enabled)</em> so that joining nodes can get all timestamps. You shouldn&#8217;t attempt disable the cluster cache loader for timestamps cache.</p> </li> </ul> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-JTATransactionsConfiguration"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-JTATransactionsConfiguration"></a>27.4. JTA Transactions Configuration</h3> <div class="paragraph"> <p>It is highly recommended that Hibernate is configured with JTA transactions so that both Hibernate and Infinispan cooperate within the same transaction and the interaction works as expected.</p> </div> <div class="paragraph"> <p>Otherwise, if Hibernate is configured for example with JDBC transactions, Hibernate will create a Transaction instance via java.sql.Connection and Infinispan will create a transaction via whatever TransactionManager returned by hibernate.transaction.manager_lookup_class. If hibernate.transaction.manager_lookup_class has not been populated, it will default on the dummy transaction manager. So, any work on the 2nd level cache will be done under a different transaction to the one used to commit the stuff to the database via HIbernate. In other words, your operations on the database and the 2LC are not treated as a single unit. Risks here include failures to update the 2LC leaving it with stale data while the database committed data correctly. It has also been observed that under some circumstances where JTA was not used, commit/rollbacks are not propagated to Infinispan.</p> </div> <div class="paragraph"> <p>To sum up, if you configure Hibernate with Infinispan, apply the following changes to your configuration file:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Unless your application uses JPA, you need to select the correct Hibernate transaction factory via hibernate.transaction.factory_class property:</p> <div class="ulist"> <ul> <li> <p>If you&#8217;re running within an application server, it&#8217;s recommended that you use:</p> </li> </ul> </div> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.transaction.factory_class" value="org.hibernate.transaction.CMTTransactionFactory"/&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.transaction.factory_class"&gt;org.hibernate.transaction.CMTTransactionFactory&lt;/property&gt;
</pre> </div> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running in a standalone environment and you wanna enable JTA transaction factory, use:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.transaction.factory_class" value="org.hibernate.transaction.JTATransactionFactory"/&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.transaction.factory_class"&gt;org.hibernate.transaction.JTATransactionFactory&lt;/property&gt;
</pre> </div> </div> <div class="paragraph"> <p>The reason why JPA does not require a transaction factory class to be set up is because the entity manager already sets it to a variant of CMTTransactionFactory.</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Select the correct Hibernate transaction manager lookup:</p> <div class="ulist"> <ul> <li> <p>If you&#8217;re running within an application server, select the appropriate lookup class according to <a href="http://docs.jboss.org/hibernate/core/3.3/reference/en/html/session-configuration.html#configuration-optional-transactionstrategy">"JTA Transaction Managers" table</a> . Example, if you were running with JBoss Application Server, you&#8217;d select:</p> </li> </ul> </div> </li> </ol> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.transaction.manager_lookup_class"
   value="org.hibernate.transaction.JBossTransactionManagerLookup"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.transaction.manager_lookup_class"&gt;
   org.hibernate.transaction.JBossTransactionManagerLookup
&lt;/property&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>If you&#8217;re running standalone and you want to add a JTA transaction manager lookup, things get a bit more complicated. Due to a current limitation, Hibernate does not support injecting a JTA TransactionManager or JTA UserTransaction that are not bound to JNDI. In other words, if you want to use JTA, Hibernate expects your TransactionManager to be bound to JNDI and it also expects that UserTransaction instances are retrieved from JNDI. This means that in an standalone environment, you need to add some code that binds your TransactionManager and UserTransaction to JNDI. With this in mind and with the help of one of our community contributors, we&#8217;ve created an example that does just that: <a href="http://anonsvn.jboss.org/repos/hibernate/core/trunk/cache-infinispan/src/test/java/org/hibernate/test/cache/infinispan/tm/JBossStandaloneJtaExampleTest.java">JBoss Standalone JTA Example</a> . Once you have the code in place, it&#8217;s just a matter of selecting the correct Hibernate transaction manager lookup class, based on the JNDI names given. If you take JBossStandaloneJtaExample as an example, you simply have to add:</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.transaction.manager_lookup_class"
   value="org.hibernate.transaction.JBossTransactionManagerLookup"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.transaction.manager_lookup_class"&gt;
   org.hibernate.transaction.JBossTransactionManagerLookup
&lt;/property&gt;</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>As you probably have noted through this section, there wasn't a single mention of the need to configure link:$$http://docs.jboss.org/infinispan/4.0/apidocs/config.html#ce_default_transaction$$[Infinispan's transaction manager lookup] and there's a good reason for that. Basically, the code within Infinispan cache provider takes the transaction manager that has been configured at the Hibernate level and uses that. Otherwise, if no Hibernate transaction manager lookup class has been defined, Infinispan uses a default dummy transaction manager.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Since Hibernate 4.0, the way Infinispan hooks into the transaction manager can be configured. By default, since 4.0, Infinispan interacts with the transaction manager as an JTA synchronization, resulting link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737108$$[in a faster interaction with the 2LC thanks to some key optimisations that the transaction manager can apply] . However if desired, users can configure Infinispan to act as an XA resource (just like it did in 3.6 and earlier) by disabling the use of the synchronization. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.use_synchronization"  value="false"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.use_synchronization"&gt;
   false
&lt;/property&gt;</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-StandaloneJTAforJPA%2FHibernateusingInfinispanas2LC"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-StandaloneJTAforJPA%2FHibernateusingInfinispanas2LC"></a>27.4.1. Standalone JTA for JPA/Hibernate using Infinispan as 2LC</h4> <div class="literalblock"> <div class="content"> <pre>The JBoss standalone JTA example referred to in the previous section is inspired by the great work of Guenther Demetz, one of the members of the Infinispan community, who wrote an link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737126$$[impressive wiki explaining how to set up standalone JTA with different transaction managers running outside of an EE server, and how to get this to work with an Infinispan backed JPA/Hibernate application] .</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-AdvancedConfiguration"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-AdvancedConfiguration"></a>27.5. Advanced Configuration</h3> <div class="paragraph"> <p>Infinispan has the capability of exposing statistics via JMX and since Hibernate 3.5.0.Beta4, you can enable such statistics from the Hibernate/JPA configuration file. By default, Infinispan statistics are turned off but when these are disabled via the following method, statistics for the Infinispan Cache Manager and all the managed caches (entity, collection,&#8230;etc) are enabled:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.statistics" value="true"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.statistics"&gt;true&lt;/property&gt;</pre> </div> </div> <div class="paragraph"> <p>The Infinispan cache provider jar file contains an Infinispan configuration file, which is the one used by default when configuring the Infinispan standalone cache region factory. This file contains default cache configurations for all Hibernate data types that should suit the majority of use cases. However, if you want to use a different configuration file, you can configure it via the following property:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.cfg"
   value="/home/infinispan/cacheprovider-configs.xml"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.cfg"&gt;
   /home/infinispan/cacheprovider-configs.xml
&lt;/property&gt;</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For each Hibernate cache data types, Infinispan cache region factory has defined a default cache name to look up in either the default, or the user defined, Infinispan cache configuration file. These default values can be found in the link:$$http://docs.jboss.org/hibernate/core/4.0/javadocs/constant-values.html#org.hibernate.cache.infinispan.InfinispanRegionFactory.INFINISPAN_CONFIG_RESOURCE_PROP$$[Infinispan cache provider javadoc] . You can change these cache names using the following properties:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.entity.cfg"
   value="custom-entity"/&gt;
&lt;property name="hibernate.cache.infinispan.collection.cfg"
   value="custom-collection"/&gt;
&lt;property name="hibernate.cache.infinispan.query.cfg"
   value="custom-collection"/&gt;
&lt;property name="hibernate.cache.infinispan.timestamp.cfg"
   value="custom-timestamp"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.entity.cfg"&gt;
   custom-entity
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.collection.cfg"&gt;
   custom-collection
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.query.cfg"&gt;
   custom-collection
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.timestamp.cfg"&gt;
   custom-timestamp
&lt;/property&gt;</pre> </div> </div> <div class="paragraph"> <p>One of the key improvements brought in by Infinispan is the fact that cache instances are more lightweight than they used to be in JBoss Cache. This has enabled a radical change in the way entity/collection type cache management works. With the Infinispan cache provider, each entity/collection type gets each own cache instance, whereas in old JBoss Cache based cache providers, all entity/collection types would be sharing the same cache instance. As a result of this, locking issues related to updating different entity/collection types concurrently are avoided completely.</p> </div> <div class="paragraph"> <p>This also has an important bearing on the meaning of hibernate.cache.infinispan.entity.cfg and hibernate.cache.infinispan.collection.cfg properties. These properties define the template cache name that should be used for all entity/collection data types. So, with the above hibernate.cache.infinispan.entity.cfg configuration, when a region needs to be created for entity com.acme.Person, the cache instance to be assigned to this entity will be based on a "custom-entity" named cache.</p> </div> <div class="paragraph"> <p>On top of that, this finer grained cache definition enables users to define cache settings on a per entity/collection basis. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.cfg"
   value="person-entity"/&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.addresses.cfg"
   value="addresses-collection"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.cfg"&gt;
   person-entity
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.addresses.cfg"&gt;
   addresses-collection
&lt;/property&gt;</pre> </div> </div> <div class="paragraph"> <p>Here, we&#8217;re configuring the Infinispan cache provider so that for com.acme.Person entity type, the cache instance assigned will be based on a "person-entity" named cache, and for com.acme.Person.addresses collection type, the cache instance assigned will be based on a "addresses-collection" named cache. If either of these two named caches did not exist in the Infinispan cache configuration file, the cache provider would create a cache instance for com.acme.Person entity and com.acme.Person.addresses collection based on the default cache in the configuration file.</p> </div> <div class="paragraph"> <p>Furthermore, thanks to the excellent feedback from the Infinispan community and in particular, Brian Stansberry, we&#8217;ve decided to allow users to define the most commonly tweaked Infinispan cache parameters via hibernate.cfg.xml or persistence.xml, for example eviction/expiration settings. So, with the Infinispan cache provider, you can configure eviction/expiration this way:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.entity.eviction.strategy"
   value= "LRU"/&gt;
&lt;property name="hibernate.cache.infinispan.entity.eviction.wake_up_interval"
   value= "2000"/&gt;
&lt;property name="hibernate.cache.infinispan.entity.eviction.max_entries"
   value= "5000"/&gt;
&lt;property name="hibernate.cache.infinispan.entity.expiration.lifespan"
   value= "60000"/&gt;
&lt;property name="hibernate.cache.infinispan.entity.expiration.max_idle"
   value= "30000"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.entity.eviction.strategy"&gt;
   LRU
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.entity.eviction.wake_up_interval"&gt;
   2000
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.entity.eviction.max_entries"&gt;
   5000
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.entity.expiration.lifespan"&gt;
   60000
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.entity.expiration.max_idle"&gt;
   30000
&lt;/property&gt;</pre> </div> </div> <div class="paragraph"> <p>With the above configuration, you&#8217;re overriding whatever eviction/expiration settings were defined for the default entity cache name in the Infinispan cache configuration used, regardless of whether it&#8217;s the default one or user defined. More specifically, we&#8217;re defining the following:</p> </div> <div class="ulist"> <ul> <li> <p>All entities to use LRU eviction strategy</p> </li> <li> <p>The eviction thread to wake up every 2000 milliseconds</p> </li> <li> <p>The maximum number of entities for each entity type to be 5000 entries</p> </li> <li> <p>The lifespan of each entity instance to be 600000 milliseconds</p> </li> <li> <p>The maximum idle time for each entity instance to be 30000</p> </li> </ul> </div> <div class="paragraph"> <p>You can also override eviction/expiration settings on a per entity/collection type basis in such way that the overriden settings only afftect that particular entity (i.e. com.acme.Person) or collection type (i.e. com.acme.Person.addresses). For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.eviction.strategy"
   value= "FIFO"/&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.eviction.wake_up_interval"
   value= "2500"/&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.eviction.max_entries"
   value= "5500"/&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.expiration.lifespan"
   value= "65000"/&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.expiration.max_idle"
   value= "35000"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.eviction.strategy"&gt;
   FIFO
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.eviction.wake_up_interval"&gt;
   2500
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.eviction.max_entries"&gt;
   5500
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.expiration.lifespan"&gt;
   65000
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.com.acme.Person.expiration.max_idle"&gt;
   35000
&lt;/property&gt;</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The aim of these configuration capabilities is _to reduce the number of files needed to modify in order to define the most commonly tweaked parameters_ . So, by enabling eviction/expiration configuration on a per generic Hibernate data type or particular entity/collection type via hibernate.cfg.xml or persistence.xml, users don't have to touch to Infinispan's cache configuration file any more. We believe users will like this approach and so, if you there're any other Infinispan parameters that you often tweak and these cannot be configured via hibernate.cfg.xml or persistence.xml, please let the Infinispan team know by sending an email to infinispan-dev@lists.jboss.org</pre> </div> </div> <div class="paragraph"> <p>Please note that query/timestamp caches work the same way they did with JBoss Cache based cache providers. In other words, there&#8217;s a query cache instance and timestamp cache instance shared by all. It&#8217;s worth noting that eviction/expiration settings are allowed for query cache but not for timestamp cache. So configuring an eviction strategy other than NONE for timestamp cache would result in a failure to start up.</p> </div> <div class="paragraph"> <p>Finally, from Hibernate 3.5.4 and 3.6 onwards, queries with specific cache region names are stored under matching cache instances. This means that you can now set query cache region specific settings. For example, assuming you had a query like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>Query query = sessionFactory.getCurrentSession().createQuery(
  "select account.branch from Account as account where account.holder = ?");
query.setCacheable(true);
query.setCacheRegion("AccountRegion");
</pre> </div> </div> <div class="paragraph"> <p>The query would be stored under "AccountRegion" cache instance and users could control settings in similar fashion to what was done with entities and collections. So, for example, you could define specific eviction settings for this particular query region doing something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to JPA, add to your persistence.xml --&gt;
&lt;property name="hibernate.cache.infinispan.AccountRegion.eviction.strategy"
   value= "FIFO"/&gt;
&lt;property name="hibernate.cache.infinispan.AccountRegion.eviction.wake_up_interval"
   value= "10000"/&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;!-- If using to Hibernate, add to your hibernate.cfg.xml --&gt;
&lt;property name="hibernate.cache.infinispan.AccountRegion.eviction.strategy"&gt;
   FIFO
&lt;/property&gt;
&lt;property name="hibernate.cache.infinispan.AccountRegion.eviction.wake_up_interval"&gt;
   10000
&lt;/property&gt;</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-IntegrationwithJBossApplicationServer"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-IntegrationwithJBossApplicationServer"></a>27.6. Integration with JBoss Application Server</h3> <div class="literalblock"> <div class="content"> <pre>In JBoss Application Server 7, Infinispan is the default second level cache provider and you can find details about its configuration link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=8094254$$[the AS7 JPA reference guide] .</pre> </div> </div> <div class="paragraph"> <p>Infinispan based Hibernate 2LC was developed as part of Hibernate 3.5 release and so it currently only works within AS 6 or higher. This is due to limitations within Hibernate 3.5 which is not designed to work with AS/EAP 5.x or lower. To be able to run Infinispan based Hibernate 2LC in a lower AS version such as 5.1, the Infinispan 2LC module would require porting to Hibernate 3.3.</p> </div> <div class="literalblock"> <div class="content"> <pre>Recently, William Decoste has helped migrate the Infinispan 2LC module to Hibernate 3.3, and link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737057$$[in this wiki] , he explains how to integrate Infinispan Hibernate 2LC with JBoss AS/EAP 5.x.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-UsingInfinispanasremoteSecondLevelCache%3F"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-UsingInfinispanasremoteSecondLevelCache%3F"></a>27.7. Using Infinispan as remote Second Level Cache?</h3> <div class="literalblock"> <div class="content"> <pre>Lately, several questions ( link:$$http://community.jboss.org/message/575814#575814$$[here] &amp;amp; link:$$http://community.jboss.org/message/585841#585841$$[here] ) have appeared in the Infinispan user forums asking whether it'd be possible to have an Infinispan second level cache that instead of living in the same JVM as the Hibernate code, it resides in a remote server, i.e. an Infinispan Hot Rod server. It's important to understand that trying to set up second level cache in this way is generally not a good idea for the following reasons:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>The purpouse of a JPA/Hibernate second level cache is to store entities/collections recently retrieved from database or to maintain results of recent queries. So, part of the aim of the second level cache is to have data accessible locally rather than having to go to the database to retrieve it everytime this is needed. Hence, if you decide to set the second level cache to be remote as well, you&#8217;re losing one of the key advantages of the second level cache: the fact that the cache is local to the code that requires it.</p> </li> <li> <p>Setting a remote second level cache can have a negative impact in the overall performance of your application because it means that cache misses require accessing a remote location to verify whether a particular entity/collection/query is cached. With a local second level cache however, these misses are resolved locally and so they&#8217;re much faster to execute than with a remote second level cache.</p> </li> </ul> </div> <div class="paragraph"> <p>There&#8217;re however some edge cases where it might make sense to have a remote second level cache, for example:</p> </div> <div class="ulist"> <ul> <li> <p>You are having memory issues in the JVM where JPA/Hibernate code and the second level cache is running. Off loading the second level cache to remote Hot Rod servers could be an interesting way to separate systems and allow you find the culprit of the memory issues more easily.</p> </li> <li> <p>Your application layer cannot be clustered but you still want to run multiple application layer nodes. In this case, you can&#8217;t have multiple local second level cache instances running because they won&#8217;t be able to invalidate each other for example when data in the second level cache is updated. In this case, having a remote second level cache could be a way out to make sure your second level cache is always in a consistent state, will all nodes in the application layer pointing to it.</p> </li> <li> <p>Rather than having the second level cache in a remote server, you want to simply keep the cache in a separate VM still within the same machine. In this case you would still have the additional overhead of talking across to another JVM, but it wouldn&#8217;t have the latency of across a network. The benefit of doing this is that:</p> </li> <li> <p>Size the cache separate from the application, since the cache and the application server have very different memory profiles. One has lots of short lived objects, and the other could have lots of long lived objects.</p> </li> <li> <p>To pin the cache and the application server onto different CPU cores (using numactl), and even pin them to different physically memory based on the NUMA nodes.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-FrequentlyAskedQuestions"><a class="anchor" href="#sid-18645154_UsingInfinispanasJPA-HibernateSecondLevelCacheProvider-FrequentlyAskedQuestions"></a>27.8. Frequently Asked Questions</h3> <div class="literalblock"> <div class="content"> <pre>To find out more please go to the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=5832912$$[Hibernate 2nd level cache  section] in the &lt;&lt;sid-18645051,Technical FAQ wiki&gt;&gt; .</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645155"><a class="anchor" href="#sid-18645155"></a>28. Default Values For Property Based Attributes</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>The aim of this article is to complement the link:$$http://docs.jboss.org/infinispan/5.1/configdocs$$[configuration reference] documentation with information on default values that could not be automatically generated. Please find below the name of the XML elements and their corresponding property default values:</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645155_DefaultValuesForPropertyBasedAttributes-asyncListenerExecutor"><a class="anchor" href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-asyncListenerExecutor"></a>28.1. asyncListenerExecutor</h3> <div class="ulist"> <ul> <li> <p>maxThreads = 1</p> </li> <li> <p>threadNamePrefix = "notification-thread"</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645155_DefaultValuesForPropertyBasedAttributes-asyncTransportExecutor"><a class="anchor" href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-asyncTransportExecutor"></a>28.2. asyncTransportExecutor</h3> <div class="ulist"> <ul> <li> <p>maxThreads = 25</p> </li> <li> <p>threadNamePrefix = "transport-thread"</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645155_DefaultValuesForPropertyBasedAttributes-evictionScheduledExecutor"><a class="anchor" href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-evictionScheduledExecutor"></a>28.3. evictionScheduledExecutor</h3> <div class="ulist"> <ul> <li> <p>maxThreads = 1 (cannot be changed)</p> </li> <li> <p>threadNamePrefix = "eviction-thread"</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645155_DefaultValuesForPropertyBasedAttributes-replicationQueueScheduledExecutor"><a class="anchor" href="#sid-18645155_DefaultValuesForPropertyBasedAttributes-replicationQueueScheduledExecutor"></a>28.4. replicationQueueScheduledExecutor</h3> <div class="ulist"> <ul> <li> <p>maxThreads = 1 (cannot be changed)</p> </li> <li> <p>threadNamePrefix = "replicationQueue-thread"</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645156"><a class="anchor" href="#sid-18645156"></a>29. Running Infinispan on Amazon Web Services</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan can be used on the Amazon Web Service (AWS) platform and similar cloud based environment in several ways. As Infinispan uses JGroups as the underlying communication technology, the majority of the configuration work is done JGroups. The default auto discovery won&#8217;t work on EC2 as multicast is not allowed, but JGroups provides several other discovery protocols so we only have to choose one.</p> </div> <div class="sect2"> <h3 id="sid-18645156_RunningInfinispanonAmazonWebServices-TCPPing%2CGossipRouter%2CS3Ping"><a class="anchor" href="#sid-18645156_RunningInfinispanonAmazonWebServices-TCPPing%2CGossipRouter%2CS3Ping"></a>29.1. TCPPing, GossipRouter, S3_Ping</h3> <div class="literalblock"> <div class="content"> <pre>The TCPPing approach contains a static list of the IP address of each member of the cluster in the JGroups configuration file. While this works it doesn't really help when cluster nodes are dynamically added to the cluster. See link:$$http://community.jboss.org/wiki/JGroupsTCPPING$$[] for more information about TCPPing. Sample TCPPing configuration</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;config xmlns="urn:org:jgroups"
     xmlns:xsi="[http://www.w3.org/2001/XMLSchema-instance]"     
     xsi:schemaLocation="urn:org:jgroups      file:schema/JGroups-2.8.xsd"&gt;
      &lt;TCP bind_port="7800" /&gt;
      &lt;TCPPING timeout="3000"
           initial_hosts="$\{jgroups.tcpping.initial_hosts:localhost\[7800\],localhost\[7801\]\}"
           port_range="1"
           num_initial_members="3"/&gt;
      &lt;MERGE2 max_interval="30000"  min_interval="10000"/&gt;
      &lt;FD_SOCK/&gt;
      &lt;FD timeout="10000" max_tries="5" /&gt;
      &lt;VERIFY_SUSPECT timeout="1500"  /&gt;
      &lt;pbcast.NAKACK
           use_mcast_xmit="false" gc_lag="0"
           retransmit_timeout="300,600,1200,2400,4800"
           discard_delivered_msgs="true"/&gt;
      &lt;UNICAST timeout="300,600,1200" /&gt;
      &lt;pbcast.STABLE stability_delay="1000" desired_avg_gossip="50000"  max_bytes="400000"/&gt;
      &lt;pbcast.GMS print_local_addr="true" join_timeout="3000"   view_bundling="true"/&gt;
      &lt;FC max_credits="2000000"  min_threshold="0.10"/&gt;
      &lt;FRAG2 frag_size="60000"  /&gt;
      &lt;pbcast.STREAMING_STATE_TRANSFER/&gt;
&lt;/config&gt;
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645156_RunningInfinispanonAmazonWebServices-GossipRouter"><a class="anchor" href="#sid-18645156_RunningInfinispanonAmazonWebServices-GossipRouter"></a>29.2. GossipRouter</h3> <div class="literalblock"> <div class="content"> <pre>Another approach is to have a central server (Gossip, which each node will be configured to contact. This central server will tell each node in the cluster about each other node. More on Gossip Router @ link:$$http://community.jboss.org/docs/DOC-10890$$[http://www.jboss.org/community/wiki/JGroupsGossipRouter]</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The address (ip:port) that the Gossip router is listening on can be injected into the JGroups configuration used by Infinispan. To do this pass the gossip routers address as a system property to the JVM e.g. -DGossipRouterAddress="10.10.2.4[12001]" and reference this property in the JGroups configuration that Infinispan is using e.g. _Sample JGroups configuration for Gossip Router_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>&amp;lt;config&amp;gt;     &amp;lt;TCP bind_port="7800" /&amp;gt;     &amp;lt;TCPGOSSIP timeout="3000" initial_hosts="${GossipRouterAddress}" num_initial_members="3" /&amp;gt; . . &amp;lt;/config&amp;gt;</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645156_RunningInfinispanonAmazonWebServices-S3Ping"><a class="anchor" href="#sid-18645156_RunningInfinispanonAmazonWebServices-S3Ping"></a>29.3. S3_Ping</h3> <div class="literalblock"> <div class="content"> <pre>Finally you can configure your JGroups instances to use a shared storage to exchange the details of the cluster nodes. S3_ping was added to JGroups in 2.6.12 and 2.8, and allows the Amazon S3 to be used as the shared storage. It is experimental at the moment but offers another method of clustering without a central server. Be sure that you have signed up for Amazon S3 as well as EC2 to use this method. Sample S3_Ping configuration</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;config&gt;     &lt;TCP bind_port="7800" /&gt;     &lt;S3_PING secret_access_key="replace this with you secret access key" access_key="replace this with your           access key" location="replace this with your S3 bucket location" /&gt;     &lt;MERGE2 max_interval="30000" min_interval="10000" /&gt;     &lt;FD_SOCK /&gt;     &lt;FD timeout="10000" max_tries="5" /&gt;     &lt;VERIFY_SUSPECT timeout="1500" /&gt;     &lt;pbcast.NAKACK use_mcast_xmit="false" gc_lag="0" retransmit_timeout="300,600,1200,2400,4800"          discard_delivered_msgs="true" /&gt;     &lt;UNICAST timeout="300,600,1200,2400,3600" /&gt;     &lt;pbcast.STABLE stability_delay="1000" desired_avg_gossip="50000" max_bytes="400000" /&gt;     &lt;VIEW_SYNC avg_send_interval="60000" /&gt;     &lt;pbcast.GMS print_local_addr="true" join_timeout="60000" view_bundling="true" /&gt;     &lt;FC max_credits="20000000" min_threshold="0.10" /&gt;     &lt;FRAG2 frag_size="60000" /&gt;     &lt;pbcast.STATE_TRANSFER /&gt;     &lt;pbcast.FLUSH timeout="0" /&gt;&lt;/config&gt;
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645156_RunningInfinispanonAmazonWebServices-JDBCPING"><a class="anchor" href="#sid-18645156_RunningInfinispanonAmazonWebServices-JDBCPING"></a>29.4. JDBC_PING</h3> <div class="literalblock"> <div class="content"> <pre>A similar approach to S3_PING, but using a JDBC connection to a shared database. On EC2 that is quite easy using Amazon RDS. See the link:$$http://community.jboss.org/wiki/JDBCPING$$[JDBC_PING Wiki page] for details.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645156_RunningInfinispanonAmazonWebServices-Creatingaclusternodewithdistributedcache"><a class="anchor" href="#sid-18645156_RunningInfinispanonAmazonWebServices-Creatingaclusternodewithdistributedcache"></a>29.5. Creating a cluster node with distributed cache</h3> <div class="literalblock"> <div class="content"> <pre>_Creating a cluster_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
GlobalConfiguration gc = GlobalConfiguration.getClusteredDefault();
gc.setClusterName("infinispan-test-cluster");
gc.setTransportClass(JGroupsTransport.class.getName());
//Load the jgroups properties
Properties p = newProperties();
p.setProperty("configurationFile","jgroups-config.xml");
gc.setTransportProperties(p);
Configuration c = new Configuration();
//Distributed cache mode
c.setCacheMode(Configuration.CacheMode.DIST_SYNC);
c.setExposeJmxStatistics(true);
// turn functionality which returns the previous value when setting
c.setUnsafeUnreliableReturnValues(true);
//data will be distributed over 3 nodes
c.setNumOwners(3);
c.setL1CacheEnabled(true);
//Allow batching
c.setInvocationBatchingEnabled(true);
c.setL1Lifespan(6000000);
cache_manager = new DefaultCacheManager(gc, c, false);
</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645157"><a class="anchor" href="#sid-18645157"></a>30. Eviction Examples</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645157_EvictionExamples-Introduction"><a class="anchor" href="#sid-18645157_EvictionExamples-Introduction"></a>30.1. Introduction</h3> <div class="olist arabic"> <ol class="arabic"> <li> <p><em>Expiration</em> is a top-level construct, represented in the configuration as well as in the cache API. More on this later.</p> </li> <li> <p>While eviction is <em>local to each cache instance</em> , expiration is <em>cluster-wide</em> . Expiration lifespans and maxIdle values are replicated along with the cache entry.</p> </li> <li> <p>Expiration lifespan and maxIdle are also persisted in CacheStores, so this information survives eviction/passivation.</p> </li> <li> <p>Four eviction strategies are shipped, <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/eviction/EvictionStrategy.html#NONE">EvictionStrategy.NONE</a> , <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/eviction/EvictionStrategy.html#LRU">EvictionStrategy.LRU</a> , <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/eviction/EvictionStrategy.html#UNORDERED">EvictionStrategy.UNORDERED</a> , and <a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/eviction/EvictionStrategy.html#LIRS">EvictionStrategy.LIRS</a> .</p> </li> </ol> </div> </div> <div class="sect2"> <h3 id="sid-18645157_EvictionExamples-Configuration"><a class="anchor" href="#sid-18645157_EvictionExamples-Configuration"></a>30.2. Configuration</h3> <div class="paragraph"> <p>Eviction may be configured using the Configuration bean or the XML file. Eviction configuration is on a per-cache basis. Valid eviction-related configuration elements are:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;eviction strategy="FIFO" wakeupInterval="1000" maxEntries="2000"/&gt;
&lt;expiration lifespan="1000" maxIdle="500" /&gt;
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">XML changes in Infinispan 5.0</div> <div class="literalblock"> <div class="content"> <pre>From Infinispan 5.0 onwards, wakeupInterval attribute has been moved to expiration XML element. This is because since 4.1, eviction happens in the user thread, and so the old eviction thread now simply purges expired entries from memory and any attached cache store. So, effectively, wakeUpInterval controls how often this purging occurs:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;eviction strategy="FIFO" maxEntries="2000"/&gt;
&lt;expiration lifespan="1000" maxIdle="500" wakeupInterval="1000"/&gt;
</pre> </div> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Programmatically, the same would be defined using:</p> </div> <div class="listingblock"> <div class="content"> <pre>Configuration c = new ConfigurationBuilder().eviction().strategy(EvictionStrategy.LRU)
               .maxEntries(2000).expiration().wakeUpInterval(5000l).lifespan(1000l).maxIdle(1000l)
               .build();
</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645157_EvictionExamples-Defaultvalues"><a class="anchor" href="#sid-18645157_EvictionExamples-Defaultvalues"></a>30.2.1. Default values</h4> <div class="paragraph"> <p>Eviction is disabled by default. If enabled (using an empty &lt;eviction /&gt; element), certain default values are used:</p> </div> <div class="ulist"> <ul> <li> <p>strategy: EvictionStrategy.NONE is assumed, if a strategy is not specified..</p> </li> <li> <p>wakeupInterval: 5000 is used if not specified.</p> </li> <li> <p>If you wish to disable the eviction thread, set wakeupInterval to -1.</p> </li> <li> <p>maxEntries: -1 is used if not specified, which means unlimited entries.</p> </li> <li> <p>0 means no entries, and the eviction thread will strive to keep the cache empty.</p> </li> </ul> </div> <div class="paragraph"> <p>Expiration lifespan and maxIdle both default to -1.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645157_EvictionExamples-Usingexpiration"><a class="anchor" href="#sid-18645157_EvictionExamples-Usingexpiration"></a>30.2.2. Using expiration</h4> <div class="paragraph"> <p>Expiration allows you to set either a lifespan or a maximum idle time on each key/value pair stored in the cache. This can either be set cache-wide using the configuration, as described above, or it can be defined per-key/value pair using the Cache interface. Any values defined per key/value pair overrides the cache-wide default for the specific entry in question.</p> </div> <div class="paragraph"> <p>For example, assume the following configuration:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;expiration lifespan="1000" /&gt;
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>// this entry will expire in 1000 millis
cache.put("pinot noir", pinotNoirPrice);

// this entry will expire in 2000 millis
cache.put("chardonnay", chardonnayPrice, 2, TimeUnit.SECONDS);

// this entry will expire 1000 millis after it is last accessed
cache.put("pinot grigio", pinotGrigioPrice, -1,
          TimeUnit.SECONDS, 1, TimeUnit.SECONDS);

// this entry will expire 1000 millis after it is last accessed, or
// in 5000 millis, which ever triggers first
cache.put("riesling", rieslingPrice, 5,
          TimeUnit.SECONDS, 1, TimeUnit.SECONDS);
</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645157_EvictionExamples-Evictiondesigns"><a class="anchor" href="#sid-18645157_EvictionExamples-Evictiondesigns"></a>30.3. Eviction designs</h3> <div class="paragraph"> <p>Central to eviction is an EvictionManager - which is only available if eviction or expiration is configured.</p> </div> <div class="paragraph"> <p>The purpose of the EvictionManager is to drive the eviction/expiration thread which periodically purges items from the DataContainer. If the eviction thread is disabled (wakeupInterval set to -1) eviction can be kicked off manually using EvictionManager.processEviction(), for example from another maintenance thread that may run periodically in your application.</p> </div> <div class="paragraph"> <p>The eviction manager processes evictions in the following manner:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Causes the data container to purge expired entries</p> </li> <li> <p>Causes cache stores (if any) to purge expired entries</p> </li> <li> <p>Prunes the data container to a specific size, determined by maxElements</p> </li> </ol> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645158"><a class="anchor" href="#sid-18645158"></a>31. Clustering modes</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645158_Clusteringmodes-Introduction"><a class="anchor" href="#sid-18645158_Clusteringmodes-Introduction"></a>31.1. Introduction</h3> <div class="paragraph"> <p>Infinispan can be configured to be either local (standalone) or clustered. If in a cluster, the cache can be configured to replicate changes to all nodes, to invalidate changes across nodes and finally to be used in distributed mode - state changes are replicated to a small subset of nodes enough to be fault tolerant but not to many nodes to prevent scalability.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645158_Clusteringmodes-LocalMode"><a class="anchor" href="#sid-18645158_Clusteringmodes-LocalMode"></a>31.2. Local Mode</h3> <div class="literalblock"> <div class="content"> <pre>While Infinispan is particularly interesting in clustered mode, it also offers a very capable local mode, where it acts as a simple, in-memory data cache similar to JBoss Cache and EHCache. But why would one use a local cache rather than a map? Caches offer a lot of features over and above a simple map, including write-through and write-behind caching to persist data, eviction of entries to prevent running out of memory, and support for expirable entries. Infinispan, specifically, is built around a high-performance, read-biased data container which uses modern techniques like MVCC locking - which buys you non-blocking, thread-safe reads even when concurrent writes are taking place. Infinispan also makes heavy use of compare-and-swap and other lock-free algorithms, making it ideal for high-throughput, multi-CPU/multi-core environments. Further, Infinispan's Cache API extends the JDK's ConcurrentMap - making migration from a map to Infinispan trivial. For more details refer to link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737159$$[Non-clustered, LOCAL mode] section.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645158_Clusteringmodes-ReplicatedMode"><a class="anchor" href="#sid-18645158_Clusteringmodes-ReplicatedMode"></a>31.3. Replicated Mode</h3> <div class="paragraph"> <p>Replication is a simple clustered mode where cache instances automatically discover neighboring instances on other JVMs on the same local network, and form a cluster. Entries added to any of these cache instances will be replicated to all other cache instances in the cluster, and can be retrieved locally from any instance. This clustered mode provides a quick and easy way to share state across a cluster, however replication practically only performs well in small clusters (under 10 servers), due to the number of replication messages that need to happen - as the cluster size increases. Infinispan can be configured to use UDP multicast which mitigates this problem to some degree.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>                                                        Figure 1. Replication mode</pre> </div> </div> <div class="paragraph"> <p>Replication can be synchronous or asynchronous. Use of either one of the options is application dependent. Synchronous replication blocks the caller (e.g. on a put() ) until the modifications have been replicated successfully to all nodes in a cluster. Asynchronous replication performs replication in the background (the put() returns immediately). Infinispan offers a replication queue, where modifications are replicated periodically (i.e. interval-based), or when the queue size exceeds a number of elements, or a combination thereof. A replication queue can therefore offer much higher performance as the actual replication is performed by a background thread.</p> </div> <div class="paragraph"> <p>Asynchronous replication is faster (no caller blocking), because synchronous replication requires acknowledgments from all nodes in a cluster that they received and applied the modification successfully (round-trip time). However, when a synchronous replication returns successfully, the caller knows for sure that all modifications have been applied to all cache instances, whereas this is not be the case with asynchronous replication. With asynchronous replication, errors are simply written to a log. Even when using transactions, a transaction may succeed but replication may not succeed on all cache instances.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645158_Clusteringmodes-InvalidationMode"><a class="anchor" href="#sid-18645158_Clusteringmodes-InvalidationMode"></a>31.4. Invalidation Mode</h3> <div class="paragraph"> <p>Invalidation is a clustered mode that does not actually share any data at all, but simply aims to remove data that may be stale from remote caches. This cache mode only makes sense if you have another, permanent store for your data such as a database and are only using Infinispan as an optimization in a read-heavy system, to prevent hitting the database every time you need some state. If a cache is configured for invalidation rather than replication, every time data is changed in a cache other caches in the cluster receive a message informing them that their data is now stale and should be evicted from memory.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>                                                            Figure 2. Invalidation mode</pre> </div> </div> <div class="paragraph"> <p>Invalidation, when used with a shared cache loader would cause remote caches to refer to the shared cache loader to retrieve modified data. The benefit of this is twofold: network traffic is minimized as invalidation messages are very small compared to replicating updated data, and also that other caches in the cluster look up modified data in a lazy manner, only when needed.</p> </div> <div class="paragraph"> <p>Invalidation messages are sent after each modification (no transactions or batches), or at the end of a transaction or batch, upon successful commit. This is usually more efficient as invalidation messages can be optimized for the transaction as a whole rather than on a per-modification basis.</p> </div> <div class="paragraph"> <p>Invalidation too can be synchronous or asynchronous, and just as in the case of replication, synchronous invalidation blocks until all caches in the cluster receive invalidation messages and have evicted stale data while asynchronous invalidation works in a <em>fire-and-forget</em> mode, where invalidation messages are broadcast but doesn&#8217;t block and wait for responses.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645158_Clusteringmodes-DistributionMode"><a class="anchor" href="#sid-18645158_Clusteringmodes-DistributionMode"></a>31.5. Distribution Mode</h3> <div class="literalblock"> <div class="content"> <pre>Distribution is a powerful clustering mode which allows Infinispan to scale linearly as more servers are added to the cluster. Distribution makes use of a link:$$http://en.wikipedia.org/wiki/Consistent_hashing$$[consistent hash] algorithm to determine where in a cluster entries should be stored. Hashing algorithm is configured with the number of copies each cache entry should be maintained cluster-wide. Number of copies represents the tradeoff between performance and durability of data. The more copies you maintain, the lower performance will be, but also the lower the risk of losing data due to server outages. Regardless of how many copies are maintained, distribution still scales linearly and this is key to Infinispan scalability. Another feature of the consistent hash algorithm is that it is deterministic in locating entries without resorting to multicasting requests or maintaining expensive metadata. Doing a PUT would result in at most num_copies remote calls, and doing a GET anywhere in the cluster would result in at most 1 remote call. In reality, num_copies remote calls are made even for a GET, but these are done in parallel and as soon as any one of these returns, the entry is passed back to the caller.</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>                                                       Figure 3. Distribution mode</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645158_Clusteringmodes-L1Caching"><a class="anchor" href="#sid-18645158_Clusteringmodes-L1Caching"></a>31.6. L1 Caching</h3> <div class="paragraph"> <p>To prevent repeated remote calls when doing multiple GETs, L1 caching can be enabled. L1 caching places remotely received values in a near cache for a short period of time (configurable) so repeated lookups would not result in remote calls. In the above diagram, if L1 was enabled, a subsequent GET for the same key on Server3 would not result in any remote calls.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>                                                            Figure 4. L1 caching</pre> </div> </div> <div class="paragraph"> <p>L1 caching is not free though. Enabling it comes at a cost, and this cost is that every time a key is updated, an invalidation message needs to be multicast to ensure nodes with the entry in L1 invalidates the entry. L1 caching causes the requesting node to cache the retrieved entry locally and listen for changes to the key on the wire. L1-cached entries are given an internal expiry to control memory usage. Enabling L1 will improve performance for repeated reads of non-local keys, but will increase memory consumption to some degree. It offers a nice tradeoff between the "read-mostly" performance of an invalidated data grid with the scalability of a distributed one. Is L1 caching right for you? The correct approach is to benchmark your application with and without L1 enabled and see what works best for your access pattern.</p> </div> <div class="listingblock"> <div class="content"> <pre>Looking for Buddy Replication?  Buddy Replication - from JBoss Cache - does not exist in Infinispan.  See this blog article which discusses the reasons why Buddy Replication was not implemented in Infinispan, and how the same effects can be achieved using Infinispan -
&lt;a href="http://infinispan.blogspot.com/2009/08/distribution-instead-of-buddy.html"&gt;http://infinispan.blogspot.com/2009/08/distribution-instead-of-buddy.html&lt;/a&gt;
</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645159"><a class="anchor" href="#sid-18645159"></a>32. Using Infinispan as a Spring Cache provider</h2> <div class="sectionbody"> <div class="listingblock"> <div class="content"> <pre>h1. Introduction

Starting with 3.1 Spring offers a [cache abstraction|&lt;a href="http://blog.springsource.com/2011/02/23/spring-3-1-m1-caching/"&gt;http://blog.springsource.com/2011/02/23/spring-3-1-m1-caching/&lt;/a&gt;], enabling users to declaratively add caching support to applications via two simple annotations, {font:monospace}@Cacheable{font} and {font:monospace}@CacheEvict{font}. While out of the box Spring 3.1's caching support is backed by [Ehcache|&lt;a href="http://ehcache.org/"&gt;http://ehcache.org/&lt;/a&gt;] it has been designed to easily support different cache providers. To that end Spring 3.1 defines a simple and straightforward SPI other caching solutions may implement. Infinispan's very own spring module does - amongst other things - exactly this and therefore users invested in Spring's programming model may easily have all their caching needs fulfilled through Infinispan. Here's how.

(Note that the following is based on a small but fully functional example that is part of Spring Infinispan's test suite. For further details you are encouraged to look at {font:monospace}org.infinispan.spring.provider.sample.CachingBookDaoContextTest{font} and its ilk.)

h1. Activating Spring Cache support

You activate Spring's cache support via putting
{code:xml}
&lt;beans xmlns="&lt;a href="http://www.springframework.org/schema/beans"&gt;http://www.springframework.org/schema/beans&lt;/a&gt;"
            xmlns:xsi="&lt;a href="http://www.w3.org/2001/XMLSchema-instance"&gt;http://www.w3.org/2001/XMLSchema-instance&lt;/a&gt;"
            xmlns:cache="&lt;a href="http://www.springframework.org/schema/cache"&gt;http://www.springframework.org/schema/cache&lt;/a&gt;"
            xsi:schemaLocation="
                &lt;a href="http://www.springframework.org/schema/beans"&gt;http://www.springframework.org/schema/beans&lt;/a&gt;
                &lt;a href="http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;http://www.springframework.org/schema/beans/spring-beans.xsd&lt;/a&gt;
                &lt;a href="http://www.springframework.org/schema/cache"&gt;http://www.springframework.org/schema/cache&lt;/a&gt;
                &lt;a href="http://www.springframework.org/schema/cache/spring-cache.xsd"&gt;http://www.springframework.org/schema/cache/spring-cache.xsd&lt;/a&gt;"&gt;

  &lt;cache:annotation-driven /&gt;

&lt;/beans&gt;
</pre> </div> </div> <div class="paragraph"> <p>somewhere in your application context. This will tell Spring to be on the lookout for {font:monospace}@Cacheable{font} and {font:monospace}@CacheEvict{font} within your application code.Now, assuming you&#8217;ve already {font:monospace}infinispan.jar{font} and its dependencies on your classpath, all that&#8217;s left to do is installing {font:monospace}infinispan-spring{font} and {font:monospace}spring{font}. For maven users this translates into</p> </div> <div class="listingblock"> <div class="content"> <pre>
     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework&lt;/groupId&gt;
         &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
         &lt;version&gt;3.1.0.M1&lt;/version&gt;
         &lt;scope&gt;compile&lt;/scope&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
         &lt;artifactId&gt;infinispan-spring&lt;/artifactId&gt;
         &lt;version&gt;5.0.0&lt;/version&gt;
         &lt;scope&gt;compile&lt;/scope&gt;
      &lt;/dependency&gt;
</pre> </div> </div> <div class="paragraph"> <p>{font:monospace}Gradle{font} users will most likely know how to adapt this to their needs. Those leaning towards a more &#8230; pedestrian way of managing their dependencies will need to download {font:monospace}Spring 3.1.0 M1{font} and install it manually alongside {font:monospace}infinispan-spring.jar{font} from the Infinispan distribution.h1. Telling Spring to use Infinispan as its caching providerSpring 3.1&#8217;s cache provider SPI comprises two interfaces, {font:monospace}org.springframework.cache.CacheManager{font} and {font:monospace}org.springframework.cache.Cache{font} where a {font:monospace}CacheManager{font} serves as a factory for named {font:monospace}Cache{font} instances. By default Spring will look at runtime for a {font:monospace}CacheManager{font} implementation having the bean name "cacheManager" in an application&#8217;s application context. So by putting</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;!-- Infinispan cache manager --&gt;
&lt;bean id="cacheManager"
          class="org.infinispan.spring.provider.SpringEmbeddedCacheManagerFactoryBean"
          p:configurationFileLocation="classpath:/org/infinispan/spring/provider/sample/books-infinispan-config.xml" /&gt;
</pre> </div> </div> <div class="paragraph"> <p>somewhere in your application context you tell Spring to henceforth use Infinispan as its caching provider.h1. Adding caching to your application codeAs outlined above enabling caching in your application code is as simple as adding {font:monospace}@Cacheable{font} and {font:monospace}@CacheEvict{font} to select methods. Suppose you&#8217;ve got a DAO for, say, books and you want book instances to be cached once they&#8217;ve been loaded from the underlying database using {font:monospace}BookDao#findBook(Integer bookId){font}. To that end you annotate {font:monospace}findBook(Integer bookId){font} with {font:monospace}@Cacheable{font}, as in</p> </div> <div class="listingblock"> <div class="content"> <pre>
@Transactional
@Cacheable(value = "books", key = "#bookId")
Book findBook(Integer bookId) {...}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>This will tell Spring to cache Book instances returned from calls to {font:monospace}findBook(Integer bookId){font} in a named cache "books", using the parameter's "bookId" value as a cache key. Here, "#bookId" is an expression in the [Spring Expression Language| link:$$http://static.springsource.org/spring/docs/current/spring-framework-reference/html/expressions.html$$[] ] that evaluates to the {font:monospace}bookId{font} argument. If you don't specify the {font:monospace}key{font} attribute Spring will generate a hash from the supplied method arguments - in this case only {font:monospace}bookId{font} - and use that as a cache key. Essentially, you relinquish control over what cache key to use to Spring. Which may or may not be fine depending on your application's needs.Though the notion of actually deleting a book will undoubtedly seem alien and outright abhorrent to any sane reader there might come the time when your application needs to do just that. For whatever reason. In this case you will want for such a book to be removed not only from the underlying database but from the cache, too. So you annotate {font:monospace}deleteBook(Integer bookId){font} with {font:monospace}@CacheEvict{font} as in</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
@Transactional
@CacheEvict(value = "books", key = "#bookId")
void deleteBook(Integer bookId) {...}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>and you may rest assured that no stray books be left in your application once you decide to remove them.h1. OutroHopefully you enjoyed our quick tour of Infinispan's support for Spring's cache abstraction and saw how easy it is for all your caching woes to be taken care of by Infinispan. More information may be found in Spring's as usual rather excellent [reference documentation| link:$$http://static.springsource.org/spring/docs/3.1.0.M1/spring-framework-reference/html/cache.html$$[] ] and [javadocs| link:$$http://static.springsource.org/spring/docs/3.1.0.M1/javadoc-api/index.html?org/springframework/cache/package-summary.html$$[] ]. Also see [this| link:$$http://blog.springsource.com/2011/02/23/spring-3-1-m1-caching/$$[] ] very nice posting on the official Spring blog for a somewhat more comprehensive introduction to Spring's cache abstraction.{code}</pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645160"><a class="anchor" href="#sid-18645160"></a>33. Distributed Data Stream Processing Framework In Infinispan</h2> <div class="sectionbody"> </div> </div> <div class="sect1"> <h2 id="sid-18645161"><a class="anchor" href="#sid-18645161"></a>34. Invocation Flags</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>An important aspect of getting the most of Infinispan is the use of per-invocation flags in order to provide specific behaviour to each particular cache call. By doing this, some important optimizations can be implemented potentially saving precious time and network resources. One of the most popular usages of flags can be found right in Cache API, underneath the link:$$http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)$$[putForExternalRead()] method which is used to load an Infinispan cache with data read from an external resource. In order to make this call efficient, Infinispan basically calls a normal put operation passing the following flags: link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/context/Flag.html#FAIL_SILENTLY$$[FAIL_SILENTLY] , link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/context/Flag.html#FORCE_ASYNCHRONOUS$$[FORCE_ASYNCHRONOUS] , link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/context/Flag.html#ZERO_LOCK_ACQUISITION_TIMEOUT$$[ZERO_LOCK_ACQUISITION_TIMEOUT]</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>What Infinispan is doing here is effectively saying that when putting data read from external read, it will use an almost-zero lock acquisition time and that if the locks cannot be acquired, it will fail silently without throwing any exception related to lock acquisition. It also specifies that regardless of the cache mode, if the cache is clustered, it will replicate asynchronously and so won't wait for responses from other nodes. The combination of all these flags make this kind of operation very efficient, and the efficiency comes from the fact this type of _putForExternalRead_ calls are used with the knowledge that client can always head back to a persistent store of some sorts to retrieve the data that should be stored in memory. So, any attempt to store the data is just a best effort and if not possible, the client should try again if there's a cache miss.</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645161_Per-InvocationFlags-Examples"><a class="anchor" href="#sid-18645161_Per-InvocationFlags-Examples"></a>34.1. Examples</h3> <div class="literalblock"> <div class="content"> <pre>If you want to use these or any other flags available, which by the way are described in detail the link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/context/Flag.html$$[Flag enumeration] , you simply need to get hold of the advanced cache and add the flags you need via the link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag...)$$[withFlags()] method call. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Cache cache = ...
cache.getAdvancedCache()
   .withFlags(Flag.SKIP_CACHE_STORE, Flag.CACHE_MODE_LOCAL)
   .put("local", "only");
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>It's worth noting that these flags are only active for the duration of the cache operation. If the same flags need to be used in several invocations, even if they're in the same transaction, link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag...)$$[withFlags()] needs to be called repeatedly. Clearly, if the cache operation is to be replicated in another node, the flags are carried over to the remote nodes as well.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645161_Per-InvocationFlags-DecoratedCache"><a class="anchor" href="#sid-18645161_Per-InvocationFlags-DecoratedCache"></a>34.2. DecoratedCache</h3> <div class="literalblock"> <div class="content"> <pre>Another approach would be to use the link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/DecoratedCache.html$$[DecoratedCache] wrapper. This allows you to reuse flags. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>AdvancedCache cache = ...
DecoratedCache strictlyLocal = new DecoratedCache(cache, Flag.CACHE_MODE_LOCAL, Flag.SKIP_CACHE_STORE);
strictlyLocal.put("local_1", "only");
strictlyLocal.put("local_2", "only");
strictlyLocal.put("local_3", "only");
</pre> </div> </div> <div class="paragraph"> <p>This approach makes your code more readable.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645161_Per-InvocationFlags-Suppressingreturnvaluesfromaput%28%29orremove%28%29"><a class="anchor" href="#sid-18645161_Per-InvocationFlags-Suppressingreturnvaluesfromaput%28%29orremove%28%29"></a>34.3. Suppressing return values from a put() or remove()</h3> <div class="literalblock"> <div class="content"> <pre>Another very important use case is when you want a write operation such as put() to _not_ return the previous value. To do that, you need to use two flags to make sure that in a distributed environment, no remote lookup is done to potentially get previous value, and if the cache is configured with a cache loader, to avoid loading the previous value from the cache store. You can see these two flags in action in the following example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Cache cache = ...
cache.getAdvancedCache()
   .withFlags(Flag.SKIP_REMOTE_LOOKUP, Flag.SKIP_CACHE_LOAD)
   .put("local", "only")
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For more information, please check the link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/context/Flag.html$$[Flag enumeration] javadoc.</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645162"><a class="anchor" href="#sid-18645162"></a>35. Key affinity service</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645162_Keyaffinityservice-Introduction"><a class="anchor" href="#sid-18645162_Keyaffinityservice-Introduction"></a>35.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>The key affinity service solves the following problem: for a distributed Infinispan cluster one wants to make sure that a value is placed in a certain node. Based on a supplied cluster link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/remoting/transport/Address.html$$[address] identifying the node, the service returns a key that will be hashed to that particular node.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645162_Keyaffinityservice-API"><a class="anchor" href="#sid-18645162_Keyaffinityservice-API"></a>35.2. API</h3> <div class="paragraph"> <p>Following code snippet depicts how a reference to this service can be obtained and used.</p> </div> <div class="listingblock"> <div class="content"> <pre>//1. obtain a reference to a cache manager
EmbeddedCacheManager cacheManager = getCacheManager();//obtain a reference to a cache manager
Cache cache = cacheManager.getCache();
 
//2. create the affinity service
KeyAffinityService keyAffinityService = KeyAffinityServiceFactory.newLocalKeyAffinityService(cache, new RndKeyGenerator(),
                                 Executors.newSingleThreadExecutor(), 100);
 
//3. obtain a key to be mapped to a certain address
Object localKey = keyAffinityService.getKeyForAddress(cacheManager.getAddress());
 
//4. this put makes sure that the key resigns on the local node (as obtained cacheManager.getAddress())
cache.put(localKey, "yourValue");
</pre> </div> </div> <div class="paragraph"> <p>The service is started at step 2: after this point it uses the supplied Excutor to generate and queue keys. At step 3, we obtain a key for this service, and use it at step 4, with that guarantee that it is distributed in node identified by cacheManager.getAddress().</p> </div> </div> <div class="sect2"> <h3 id="sid-18645162_Keyaffinityservice-Lifecycle"><a class="anchor" href="#sid-18645162_Keyaffinityservice-Lifecycle"></a>35.3. Lifecycle</h3> <div class="literalblock"> <div class="content"> <pre>KeyAffinityService extends Lifecycle, which allows stopping and (re)starting it:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>public interface Lifecycle {
   void start();
   void stop();
}
</pre> </div> </div> <div class="paragraph"> <p>The service is instantiated through KeyAffinityServiceFactory. All the factory method have an Executors parameter, that is used for asynchronous key generation (so that it won&#8217;t happen in the caller&#8217;s thread). It is user&#8217;s responsibility to handle the shutdown of this Executor.</p> </div> <div class="paragraph"> <p>The KeyAffinityService, once started, needs to be explicitly stopped. This stops the async key generation and releases other held resources.</p> </div> <div class="paragraph"> <p>The only situation in which KeyAffinityService stops by itself is when the cache manager with wich it was registered is shutdown.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645162_Keyaffinityservice-Topologychanges"><a class="anchor" href="#sid-18645162_Keyaffinityservice-Topologychanges"></a>35.4. Topology changes</h3> <div class="literalblock"> <div class="content"> <pre>It is _very important_ to note that while the KeyAffinityService generates keys that would use the local node as the primary owner in distributed mode, this may not hold true after a topology change, since key ownership may migrate.  To ensure keys are always mapped locally, application code must register a &lt;&lt;sid-18645169,listener&gt;&gt; to be notified of topology changes, and test keys previously generated to see if they are still mapped locally.  If not, user code as two options:</pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Create a new key, which will map to the local node under the new topology. Then copy values from the old key to the new key, delete the old key from the system and use the new key only.</p> </li> <li> <p>Migrate any transactions, sessions, etc that work on the key to the node which is the new primary owner of that key.</p> </li> </ol> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645163"><a class="anchor" href="#sid-18645163"></a>36. Transaction recovery</h2> <div class="sectionbody"> <div id="sid-18645163_Transactionrecovery-" class="paragraph"> <p>===</p> </div> <div class="sect2"> <h3 id="sid-18645163_Transactionrecovery-Whentouserecovery"><a class="anchor" href="#sid-18645163_Transactionrecovery-Whentouserecovery"></a>36.1. When to use recovery</h3> <div class="paragraph"> <p>Consider a distributed transaction in which money are transfered from an account stored in the database to an account stored in Infinispan. When TransactionManager.commit() is invoked, both resources prepare successfully(1st phase). During commit (2nd phase), the database successfully applies the changes whilst Infinispan fails before receiving the commit request from the TransactionManager. At this point the system is in an inconsistent state: money are taken from the datbase account but not visible yet in Infinispan(locks are only released during 2nd phase of 2PC). Recovery deals with this situation to make sure data in both the database and Infinispan ends up in a consistent state.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645163_Transactionrecovery-Howdoesitwork"><a class="anchor" href="#sid-18645163_Transactionrecovery-Howdoesitwork"></a>36.2. How does it work</h3> <div class="paragraph"> <p>Recovery is coordinated by the TransactionManager &#8482;. The TM works with Infinispan to determine the list of in-doubt transactions that require manual intervention and informs the system administrator (SA) (email, logs). This process is TM specific, but generally requires some configuration on TM&#8217;s side.  </p> </div> <div class="literalblock"> <div class="content"> <pre>Knowing the in-doubt transaction ids, the SA can now connect to the Infinispan cluster and replay the commit of transactions or force the rollback. Infinispan provides JMX tooling for this - this is explained extensively in the link:$$http://community.jboss.org/docs/DOC-16646?uniqueTitle=false#Reconciliate_state$$[Reconciliate state] section.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645163_Transactionrecovery-Configuringrecovery%C2%A0%C2%A0%C2%A0"><a class="anchor" href="#sid-18645163_Transactionrecovery-Configuringrecovery%C2%A0%C2%A0%C2%A0"></a>36.3. Configuring recovery   </h3> <div class="literalblock"> <div class="content"> <pre>Recovery is _not_ enabled by default in Infinispan. If disabled the TransactionManager won't be able to work with Infinispan to determine the in-doubt transactions. In order to enable recovery through xml configuration:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;transaction useEagerLocking="true" eagerLockSingleNode="true"&gt;
    &lt;recovery enabled="true" recoveryInfoCacheName="noRecovery"/&gt;
&lt;/transaction&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Note:  the _recoveryInfoCacheName_ attribute is not mandatory. More information about it can be found in the  _Recovery Cache_ section below.</pre> </div> </div> <div class="paragraph"> <p>Alternatively you can enable it through the fluent configuration API as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre>//simply calling .recovery() enables it
configuration.fluent().transaction().recovery();

//then you can disable it
configuration.fluent().transaction().recovery().disable();

//or just check its status
boolean isRecoveryEnabled = configuration.isTransactionRecoveryEnabled();
</pre> </div> </div> <div class="paragraph"> <p>Recovery can be enabled/disabled o a per cache level: e..g it is possible to have a transaction spanning a cache that is has it enabled and another one that doesn&#8217;t.</p> </div> <div class="sect3"> <h4 id="sid-18645163_Transactionrecovery-EnableJMXsupport"><a class="anchor" href="#sid-18645163_Transactionrecovery-EnableJMXsupport"></a>36.3.1. Enable JMX support</h4> <div class="literalblock"> <div class="content"> <pre>_Important:_ In order to be able to use JMX for managing recovery JMX support must be explicitly enabled. More about enabling JMX link:$$http://community.jboss.org/docs/DOC-14865#Enabling_JMX_Statistics$$[here] .</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645163_Transactionrecovery-Recoverycache"><a class="anchor" href="#sid-18645163_Transactionrecovery-Recoverycache"></a>36.3.2. Recovery cache</h4> <div class="paragraph"> <p>In order to track in-doubt transactions and be able to reply them Infinispan caches all transaction state for future use. This state is held only for in-doubt transaction, being removed for successfully completed transactions after the commit/rollback phase completed.</p> </div> <div class="paragraph"> <p>This in-doubt transaction data is held within a local cache: this allows one to configure swapping this info to disk through cache loader in the case it gets too big. This cache can be specified through the  "recoveryInfoCacheName" configuration attribute. If not specified infinispan will configure a local cache for you.</p> </div> <div class="literalblock"> <div class="content"> <pre>It is possible (though not mandated) to share same recovery cache between all the Infinispan caches that have recovery enabled.  If default recovery cache is overridden then the specified recovery cache must use a link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/transaction/lookup/class-use/TransactionManagerLookup.html$$[TransactionManagerLookup] that returns a different TM than the one used by the cache itself.</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645163_Transactionrecovery-IntegrationwiththeTM"><a class="anchor" href="#sid-18645163_Transactionrecovery-IntegrationwiththeTM"></a>36.4. Integration with the TM</h3> <div class="paragraph"> <p>Even though this is TM specific, generally the TM would need a reference to a XAResource imlementation in order to run XAResource.recover on it. In order to obtain a reference to a Infinispan XAResource following API can be used:</p> </div> <div class="listingblock"> <div class="content"> <pre>XAResource xar = cache.getAdvancedCache().getXAResource(); 
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Note: It is a common practice to run the recovery in a different process than the one running the transaction. At the moment it is not possible to do this with infinispan: the recovery must be run from the same process where the infinispan instance exists. This limitation will be dropped once link:$$https://issues.jboss.org/browse/ISPN-375$$[ransactions over HotRod are available] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645163_Transactionrecovery-Reconciliatestate"><a class="anchor" href="#sid-18645163_Transactionrecovery-Reconciliatestate"></a>36.5. conciliate state</h3> <div class="paragraph"> <p>The TM informs the SA on in-doubt transaction in a proprietary way. At this stage it is assumed that the SA knows transaction&#8217;s XID (byte array).</p> </div> <div class="paragraph"> <p>A normal recovery flow is:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>SA connects to an Infinispan server through JMX, and lists the in doubt transactions</p> </li> </ol> </div> <div class="paragraph"> <p>The image below is taken with JCosole connecting to an Infinispan node that has an in doubt transaction.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>The status of each in-doubt transaction is displayed(in this example " _PREPARED_ "). There might be multiple elements in the status field, e.g. "PREPARED" and "COMMITTED" in the case the transaction committed on certain nodes but not on all of them.  </pre> </div> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>SA visually maps the XID received from the TM to an Infinispna internal id, represented as a number. This step is needed because the XID, a byte array, cannot conveniently be passed to the JMX tool (e.g. JConsole) and then re-assembled on infinispan&#8217;s side.</p> </li> <li> <p>SA forces the transaction&#8217;s commit/rollback through the corresponding jmx operation, based on the internal id.</p> </li> </ol> </div> <div class="paragraph"> <p>The image below is obtained by forcing the commit of the transaction based on its internal id.</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>_Note:_ All JMX operations described above can be executed on any node, disregarding where the transaction originated.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645163_Transactionrecovery-Forcecommit%2FrollbackbasedonXID"><a class="anchor" href="#sid-18645163_Transactionrecovery-Forcecommit%2FrollbackbasedonXID"></a>36.5.1. Force commit/rollback based on XID</h4> <div class="paragraph"> <p>XID-based JMX operations for forcing in-doubt transactions' commit/rollback are available as well: these methods receive byte[] arrays describing the XID instead of the number associated with the transactions (as previously described at step 2). These can be useful e.g. if one wants to set up an automatic completion job for certain in-doubt transactions. This process is plugged into TM&#8217;s recovery and has access to the TM&#8217;s XID objects.</p> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645163_Transactionrecovery-Wanttoknowmore%3F"><a class="anchor" href="#sid-18645163_Transactionrecovery-Wanttoknowmore%3F"></a>36.6. Want to know more?</h3> <div class="paragraph"> <p>The recovery design document describes in more detail the insides of transaction recovery implementation.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645164"><a class="anchor" href="#sid-18645164"></a>37. Implementing standalone JPA JTA Hibernate application outside J2EE server using Infinispan 2nd level cache</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Introduction"><a class="anchor" href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Introduction"></a>37.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Infinispans predecessor link:$$http://www.jboss.org/file-access/default/members/jbossclustering/freezone/docs/hibernate-caching/3.3/en-US/html/introduction-requirements.html$$[JBossCache requires integration with JTA] when used as 2L-cache for a Hibernate application.  At the moment of writing this article (Hibernate 3.5.0.Beta3) also Infinspan requires integration with JTA.  Hibernate integrated with JTA is already largely used in EJB applications servers, but most users using Hibernate with Java SE outside any EJB container, still use the plain JDBC approach instead to use JTA.</pre> </div> </div> <div class="paragraph"> <p>According Hiberante documentation it should also possible to integrate JTA in a standalone application outside any EJB container, but I did hardly find any documentation how to do that in detail. (probably the reason is, that probably 95% of people is using hibernate within a EJB app. server or using SPRING). This article should give you some example how to realize a standalone Hibernate app. outside of a EJB container with JTA integration (and using Infinispan 2nd level cache).</p> </div> <div class="paragraph"> <p>As first thing you have to choose which implementation of TransactionManager to take. This article comes with examples for following OpenSource TransactionManagers:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>JBoss</p> </li> <li> <p>JOTM</p> </li> <li> <p>Bitronix</p> </li> <li> <p>Atomikos</p> </li> </ol> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Datasource/Transaction interaction</div> <div class="paragraph"> <p>A very important aspect is not forgetting to couple the datasource with your transaction manager. In other words, the corresponding XAResource must be onto the transaction manager, otherwise only DML-statements but no commits/rollbacks are propagated to your database.</p> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-JBossTransactions"><a class="anchor" href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-JBossTransactions"></a>37.2. JBoss Transactions</h3> <div class="paragraph"> <p>The example with JBoss Transactions Transaction Manager was the most complex to implement, as JBoss&#8217;s TransactionManager and UserTransaction objects are not declared serializable whilst it&#8217;s JNDI-server isn&#8217;t able to bind non serializable objects out of the box. Special use of NonSerializableFactory is needed, requiring some additional custom code:</p> </div> <div class="listingblock"> <div class="content"> <pre>import hello.A;  // a persistent class
import java.io.Serializable;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.Name;
import javax.naming.NameNotFoundException;
import javax.naming.Reference;
import javax.naming.StringRefAddr;
import javax.persistence.EntityManager;
import javax.persistence.Persistence;
import javax.transaction.TransactionManager;
import javax.transaction.UserTransaction;

import org.enhydra.jdbc.standard.StandardXADataSource;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.ejb.HibernateEntityManagerFactory;
import org.hibernate.transaction.JBossTransactionManagerLookup;
import org.infinispan.transaction.lookup.JBossStandaloneJTAManagerLookup;
import org.jboss.util.naming.NonSerializableFactory;
import org.jnp.interfaces.NamingContext;
import org.jnp.server.Main;
import org.jnp.server.NamingServer;

public class JTAStandaloneExampleJBossTM  {
   
    static JBossStandaloneJTAManagerLookup _ml =  new JBossStandaloneJTAManagerLookup();
   

    public static void main(String[] args) {
        try {
            // Create an in-memory jndi
            NamingServer namingServer = new NamingServer();
            NamingContext.setLocal(namingServer);
            Main namingMain = new Main();
            namingMain.setInstallGlobalService(true);
            namingMain.setPort(-1);
            namingMain.start();
           
            Properties props = new Properties();
            props.put(Context.INITIAL_CONTEXT_FACTORY, "org.jnp.interfaces.NamingContextFactory");
            props.put("java.naming.factory.url.pkgs", "org.jboss.naming:org.jnp.interfaces");
          
            InitialContext ictx = new InitialContext( props );
 
           
            // as JBossTransactionManagerLookup extends JNDITransactionManagerLookup we must also register the TransactionManager
            bind("java:/TransactionManager", _ml.getTransactionManager(), _ml.getTransactionManager().getClass(), ictx);
           
            // also the UserTransaction must be registered on jndi: org.hibernate.transaction.JTATransactionFactory#getUserTransaction() requires this
            bind(new JBossTransactionManagerLookup().getUserTransactionName(),_ml.getUserTransaction(),_ml.getUserTransaction().getClass(), ictx);
           
            ExtendedXADataSource xads = new ExtendedXADataSource(); 
            xads.setDriverName("org.hsqldb.jdbcDriver");
            xads.setDriverName("com.p6spy.engine.spy.P6SpyDriver"); // comment this line if you don't want p6spy-logging
            xads.setUrl("jdbc:hsqldb:hsql://localhost");   
            //xads.setTransactionManager(_ml.getTransactionManager()); useless here as this information is not serialized
                                                                  
            ictx.bind("java:/MyDatasource", xads);         

            final HibernateEntityManagerFactory emf =  (HibernateEntityManagerFactory) Persistence.createEntityManagerFactory("helloworld");         
      
            UserTransaction userTransaction = _ml.getUserTransaction();
            userTransaction.setTransactionTimeout(300000);
            //SessionFactory sf = (SessionFactory) ictx.lookup("java:/hibernate/MySessionFactory"); // if hibernate.session_factory_name set
            final SessionFactory sf = emf.getSessionFactory();

            userTransaction.begin();
            EntityManager em = emf.createEntityManager();
           
            // do here your persistent work
            A a = new A();
            a.name= "firstvalue";
            em.persist(a);
            em.flush();     // do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?

            System.out.println("\nCreated and flushed instance a with id : " + a.oid + "  a.name set to:" + a.name);

            System.out.println("Calling userTransaction.commit() (Please check if the commit is effectively executed!)");
            userTransaction.commit();
          
           
            ictx.close();
            namingMain.stop();
            emf.close();
               
        } catch (Exception e) {
            e.printStackTrace();
        }
        System.exit(0);
    }
   
   public static class ExtendedXADataSource extends StandardXADataSource { // XAPOOL
       
        @Override
        public Connection getConnection() throws SQLException {
           
            if (getTransactionManager() == null) { // although already set before, it results null again after retrieving the datasource by jndi 
                TransactionManager tm;  // this is because the TransactionManager information is not serialized.
                try {
                    tm = _ml.getTransactionManager();
                } catch (Exception e) {
                    throw new SQLException(e);
                }
                setTransactionManager(tm);  //  resets the TransactionManager on the datasource retrieved by jndi,
                                            //  this makes the datasource JTA-aware
            }
           
            // According to Enhydra documentation, here we must return the connection of our XAConnection
            // see http://cvs.forge.objectweb.org/cgi-bin/viewcvs.cgi/xapool/xapool/examples/xapooldatasource/DatabaseHelper.java?sortby=rev
            return super.getXAConnection().getConnection();
        }
    }
   
    /**
     * Helper method that binds the a non serializable object to the JNDI tree.
     *
     * @param jndiName Name under which the object must be bound
     * @param who Object to bind in JNDI
     * @param classType Class type under which should appear the bound object
     * @param ctx Naming context under which we bind the object
     * @throws Exception Thrown if a naming exception occurs during binding
     */
    private static void bind(String jndiName, Object who, Class classType, Context ctx) throws Exception {
       // Ah ! This service isn't serializable, so we use a helper class
       NonSerializableFactory.bind(jndiName, who);
       Name n = ctx.getNameParser("").parse(jndiName);
       while (n.size() &gt; 1) {
          String ctxName = n.get(0);
          try {
             ctx = (Context) ctx.lookup(ctxName);
          } catch (NameNotFoundException e) {
             System.out.println("Creating subcontext:" + ctxName);
             ctx = ctx.createSubcontext(ctxName);
          }
          n = n.getSuffix(1);
       }

       // The helper class NonSerializableFactory uses address type nns, we go on to
       // use the helper class to bind the service object in JNDI
       StringRefAddr addr = new StringRefAddr("nns", jndiName);
       Reference ref = new Reference(classType.getName(), addr, NonSerializableFactory.class.getName(), null);
       ctx.rebind(n.get(0), ref);
    }
   
    private static void unbind(String jndiName, Context ctx) throws Exception {
       NonSerializableFactory.unbind(jndiName);
       ctx.unbind(jndiName);
    }

}
</pre> </div> </div> <div class="paragraph"> <p>The content of the corresponding complete persistence.xml:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;persistence xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"   xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"  version="1.0"&gt;
   &lt;persistence-unit name="helloworld" transaction-type="JTA"&gt;
      &lt;jta-data-source&gt;java:/MyDatasource&lt;/jta-data-source&gt;
      &lt;properties&gt;
       &lt;property name="hibernate.hbm2ddl.auto" value = "create"/&gt;
       &lt;property name="hibernate.archive.autodetection" value="class, hbm"/&gt;
           &lt;property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/&gt;

           &lt;property name="hibernate.jndi.class" value="org.jnp.interfaces.NamingContextFactory"/&gt;
           &lt;property name="hibernate.transaction.manager_lookup_class" value="org.hibernate.transaction.JBossTransactionManagerLookup"/&gt;

        &lt;property name="current_session_context_class" value="jta"/&gt;
           &lt;!-- &lt;property name="hibernate.session_factory_name" value="java:/hibernate/MySessionFactory"/&gt; optional --&gt;
           &lt;property name="hibernate.transaction.factory_class" value="org.hibernate.transaction.JTATransactionFactory"/&gt;
           &lt;property name="hibernate.connection.release_mode" value="auto"/&gt;
           &lt;!-- setting above is important using XA-DataSource on SQLServer,
                otherwise SQLServerException: The function START: has failed. No transaction cookie was returned.--&gt;

         &lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
            &lt;property name="hibernate.cache.use_query_cache" value="true"/&gt;
    
         &lt;property name="hibernate.cache.region.factory_class"   value="org.hibernate.cache.infinispan.InfinispanRegionFactory"/&gt;
        
      &lt;/properties&gt;
   &lt;/persistence-unit&gt;
&lt;/persistence&gt;
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-JOTM"><a class="anchor" href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-JOTM"></a>37.3. JOTM</h3> <div class="paragraph"> <p>The example with JOTM is more simple, but apparently it&#8217;s JNDI implementation is not useable without wasting any rmi port. So it is not completely <em>standalone</em> as the JNDI service is exposed outside your virtual machine.</p> </div> <div class="listingblock"> <div class="content"> <pre>
import hello.A; // a persistent class

import java.sql.Connection;
import java.sql.SQLException;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;
import javax.transaction.TransactionManager;
import javax.transaction.UserTransaction;

import org.enhydra.jdbc.standard.StandardXADataSource;
import org.hibernate.transaction.JOTMTransactionManagerLookup;
import org.objectweb.jotm.Jotm;
import org.objectweb.transaction.jta.TMService;


public class JTAExampleJOTM {
   
 static JOTMTransactionManagerLookup _ml =  new JOTMTransactionManagerLookup();

 public static class ExtendedXADataSource extends StandardXADataSource { // XAPOOL  
        @Override
        public Connection getConnection() throws SQLException {
            if (getTransactionManager() == null) { // although already set before, it results null again after retrieving the datasource by jndi 
                TransactionManager tm;  // this is because the TransactionManager information is not serialized.
                try {
                    tm = _ml.getTransactionManager(null);
                } catch (Exception e) {
                    throw new SQLException(e);
                }
                setTransactionManager(tm);  //  resets the TransactionManager on the datasource retrieved by jndi,
                                            //  this makes the datasource JTA-aware
            }
           
            // According to Enhydra documantation, here we must return the connection of our XAConnection
            // see http://cvs.forge.objectweb.org/cgi-bin/viewcvs.cgi/xapool/xapool/examples/xapooldatasource/DatabaseHelper.java?sortby=rev
            return super.getXAConnection().getConnection();
        }
    }

   
    public static void main( String[] args )
    {
        try
        {
            java.rmi.registry.LocateRegistry.createRegistry(1099); // also possible to lauch by command line rmiregistry
            System.out.println("RMI registry ready.");

           
           // following properties can be left out if specifying thes values in a file jndi.properties located into classpath
            Properties props = new Properties();
            props.put(Context.INITIAL_CONTEXT_FACTORY, "org.ow2.carol.jndi.spi.MultiOrbInitialContextFactory");
           InitialContext jndiCtx = new InitialContext(props);
          
      
        // XAPOOL
           ExtendedXADataSource xads = new ExtendedXADataSource(); 
           xads.setDriverName("org.hsqldb.jdbcDriver");
           xads.setDriverName("com.p6spy.engine.spy.P6SpyDriver");
           xads.setUrl("jdbc:hsqldb:hsql://localhost");
         
           jndiCtx.bind("java:/MyDatasource", xads);
        

          
           /* startup JOTM */
           TMService jotm = new Jotm(true, false);
           jotm.getUserTransaction().setTransactionTimeout(36000); // secs, important JOTM default is only 60 secs !
          
          
           /* and get a UserTransaction */
           UserTransaction userTransaction = jotm.getUserTransaction();
          

           jndiCtx.bind("java:comp/UserTransaction", jotm.getUserTransaction()); // this is needed by hibernates JTATransactionFactory

           /* get the Hibernate SessionFactory */
           EntityManagerFactory emf =    Persistence.createEntityManagerFactory("helloworld");
           //SessionFactory sf = (SessionFactory) jndiCtx.lookup("java:/hibernate/MySessionFactory");
          
           // begin a new Transaction
           userTransaction.begin();
           EntityManager em = emf.createEntityManager();
         
           A a = new A();
           a.name= "firstvalue";
           em.persist(a);
           em.flush();     // do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?

           System.out.println("Calling userTransaction.commit() (Please check if the commit is effectively executed!)");
           userTransaction.commit();
          
          
           // stop the transaction manager
           jotm.stop();
           jndiCtx.close();
           emf.close();
          
         
        }
        catch( Exception e )
        {
           e.printStackTrace();
        }
        System.exit(0);
     }

}
</pre> </div> </div> <div class="paragraph"> <p>Adjust following 2 properties in your persistence.xml:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;property name="hibernate.jndi.class" value="org.ow2.carol.jndi.spi.MultiOrbInitialContextFactory"/&gt;
&lt;property name="hibernate.transaction.manager_lookup_class" value="org.hibernate.transaction.JOTMTransactionManagerLookup"/&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For using the JTA Hibernate application as servlet in tomcat please read  link:$$http://jotm.objectweb.org/current/jotm/doc/howto-tomcat-jotm.html$$[] and also link:$$https://forum.hibernate.org/viewtopic.php?f=1&amp;amp;t=1003866$$[]</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Bitronix"><a class="anchor" href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Bitronix"></a>37.4. Bitronix</h3> <div class="literalblock"> <div class="content"> <pre>The Transaction Manager comes bundled with a fake in memory jndi-implementation which is ideal for standalone purpose. To integrate with Infinispan I did need a ad-hoc pre-alpha improvement (see attached link:$$https://docs.jboss.org/author/download/attachments/18645164/btm-ispn.jar?version=1&amp;amp;modificationDate=1308852871000$$[btm-ispn.jar] by courtesy of  Mr. Ludivic Orban). BitronixTM offers the so-called Last Resource Commit optimization (aka Last Resource Gambit or Last Agent optimization) and it allows a single non-XA database to participate in a XA transaction by cleverly ordering the resources. "Last Resource Commit" is not part of the XA spec as it doesn't cover the transaction-recovery aspect, so if your database does not support XA (or if you don't wish to have the Xa-driver performance overhead against the plain jdbc) then the "Last Resource Commit" feature should be ideal for the combination 1 single database plus infinispan.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
import hello.A; // a persistent class

import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.persistence.EntityManager;
import javax.persistence.Persistence;
import javax.transaction.UserTransaction;

import org.hibernate.cache.infinispan.InfinispanRegionFactory;
import org.hibernate.ejb.HibernateEntityManagerFactory;
import org.hibernate.impl.SessionFactoryImpl;
import org.infinispan.manager.CacheManager;

import bitronix.tm.resource.ResourceRegistrar;
import bitronix.tm.resource.infinispan.InfinispanCacheManager;
import bitronix.tm.resource.jdbc.PoolingDataSource;



public class JTAExampleBTM  {
    public static void main(String[] args) {
        try {
             Properties props = new Properties();
             props.put(Context.INITIAL_CONTEXT_FACTORY, "bitronix.tm.jndi.BitronixInitialContextFactory");
             // Attention: BitronixInitialContextFactory is'nt a real jndi implementation: you can't do explicit bindings
             // It is ideal for hiberante standalone usage, as it automatically 'binds' the needed things: datasource + usertransaction
           
             System.out.println("create initial context");
             InitialContext ictx = new InitialContext(props);
           
             PoolingDataSource myDataSource = new PoolingDataSource();
             myDataSource.setClassName("bitronix.tm.resource.jdbc.lrc.LrcXADataSource");
            
             myDataSource.setMaxPoolSize(5);
             myDataSource.setAllowLocalTransactions(true);
            
             myDataSource.getDriverProperties().setProperty("driverClassName", "com.p6spy.engine.spy.P6SpyDriver");
             myDataSource.getDriverProperties().setProperty("url", "jdbc:hsqldb:hsql://localhost");
             myDataSource.getDriverProperties().setProperty("user", "sa");
             myDataSource.getDriverProperties().setProperty("password", "");
             myDataSource.setUniqueName("java:/MyDatasource");
             myDataSource.setAutomaticEnlistingEnabled(true); // important to keep it to true (default), otherwise commits/rollbacks are not propagated
             myDataSource.init(); // does also register the datasource on the Fake-JNDI with Unique Name
            
             org.hibernate.transaction.BTMTransactionManagerLookup lokhiberante = new org.hibernate.transaction.BTMTransactionManagerLookup();

             HibernateEntityManagerFactory emf =  (HibernateEntityManagerFactory)  Persistence.createEntityManagerFactory("helloworld");
             SessionFactoryImpl sfi = (SessionFactoryImpl) emf.getSessionFactory();
             InfinispanRegionFactory infinispanregionfactory = (InfinispanRegionFactory) sfi.getSettings().getRegionFactory();
             CacheManager manager = infinispanregionfactory.getCacheManager();
            
             // register Inifinispan as a BTM resource
             InfinispanCacheManager icm = new InfinispanCacheManager();
             icm.setUniqueName("infinispan");
             ResourceRegistrar.register(icm);
             icm.setManager(manager);

            final UserTransaction userTransaction = (UserTransaction) ictx.lookup(lokhiberante.getUserTransactionName());

            // begin a new Transaction
            userTransaction.begin();
            EntityManager em = emf.createEntityManager();
          
            A a = new A();
            a.name= "firstvalue";
            em.persist(a);
            em.flush();     // do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?

            System.out.println("Calling userTransaction.commit() (Please check if the commit is effectively executed!)");
            userTransaction.commit();
          
            emf.close();

        } catch (Exception e) {
            e.printStackTrace();
            System.exit(1);
        }
         System.exit(0);
  
    }
}
</pre> </div> </div> <div class="paragraph"> <p>Adjust following 2 properties in your corresponding persistence.xml:</p> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;property name="hibernate.jndi.class" value="bitronix.tm.jndi.BitronixInitialContextFactory"/&gt;
&lt;property name="hibernate.transaction.manager_lookup_class" value="org.hibernate.transaction.BTMTransactionManagerLookup"/&gt;
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Atominkos"><a class="anchor" href="#sid-18645164_ImplementingstandaloneJPAJTAHibernateapplicationoutsideJ2EEserverusingInfinispan2ndlevelcache-Atominkos"></a>37.5. Atominkos</h3> <div class="literalblock"> <div class="content"> <pre>Last but not least, the Atomikos Transaction manager. It is currently the unique Transaction manager I've found with a online-documentation on link:$$http://www.atomikos.com/Documentation/HibernateIntegration#Without_Spring$$[how to integrate with Hiberante] link:$$http://www.atomikos.com/Documentation/HibernateIntegration#Without_Spring$$[without Spring, outside any J2EE container.] . It seems to be the unique supporting XaDataSource together with Pooling, so it doesn't matter that It does not come  with it's own JNDI implementation (we will use the one of JBoss in following example).</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
import hello.A; // a persistent class

import java.io.Serializable;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.Name;
import javax.naming.NameNotFoundException;
import javax.naming.Reference;
import javax.naming.StringRefAddr;
import javax.persistence.EntityManager;
import javax.persistence.Persistence;
import javax.transaction.TransactionManager;
import javax.transaction.UserTransaction;

import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.ejb.HibernateEntityManagerFactory;
import org.hibernate.impl.SessionFactoryImpl;

import org.jboss.util.naming.NonSerializableFactory;
import org.jnp.interfaces.NamingContext;
import org.jnp.server.Main;
import org.jnp.server.NamingServer;

import com.atomikos.icatch.jta.hibernate3.TransactionManagerLookup;
import com.atomikos.jdbc.AtomikosDataSourceBean;
import com.atomikos.jdbc.SimpleDataSourceBean;

public class JTAStandaloneExampleAtomikos  {
   
    public static void main(String[] args) {
        try {
            // Create an in-memory jndi
            NamingServer namingServer = new NamingServer();
            NamingContext.setLocal(namingServer);
            Main namingMain = new Main();
            namingMain.setInstallGlobalService(true);
            namingMain.setPort(-1);
            namingMain.start();
           
            Properties props = new Properties();
            props.put(Context.INITIAL_CONTEXT_FACTORY, "org.jnp.interfaces.NamingContextFactory");
            props.put("java.naming.factory.url.pkgs", "org.jboss.naming:org.jnp.interfaces");
          
            InitialContext ictx = new InitialContext( props );
 
            AtomikosDataSourceBean ds = new AtomikosDataSourceBean();
            ds.setUniqueResourceName("sqlserver_ds");
            ds.setXaDataSourceClassName("com.microsoft.sqlserver.jdbc.SQLServerXADataSource");
            Properties p = new Properties();
            p.setProperty ( "user" , "sa" );
            p.setProperty ( "password" , "" );
            p.setProperty ( "serverName" , "myserver" );
            ds.setXaProperties ( p );
            ds.setPoolSize(5);
            bind("java:/MyDatasource", ds, ds.getClass(), ictx);
           
            TransactionManagerLookup _ml = new TransactionManagerLookup();
            UserTransaction userTransaction = new com.atomikos.icatch.jta.UserTransactionImp();
           
            bind("java:/TransactionManager", _ml.getTransactionManager(null), _ml.getTransactionManager(null).getClass(), ictx);
            bind("java:comp/UserTransaction", userTransaction, userTransaction.getClass(), ictx);

            HibernateEntityManagerFactory emf =  (HibernateEntityManagerFactory) Persistence.createEntityManagerFactory("helloworld");         

            // begin a new Transaction
            userTransaction.begin();
            EntityManager em = emf.createEntityManager();
          
            A a = new A();
            a.name= "firstvalue";
            em.persist(a);
            em.flush();     // do manually flush here as apparently FLUSH_BEFORE_COMPLETION seems not work, bug ?

            System.out.println("Calling userTransaction.commit() (Please check if the commit is effectively executed!)");
            userTransaction.commit();
          
            emf.close();
           
        } catch (Exception e) {
            e.printStackTrace();
            System.exit(1);
        }
         System.exit(0);
    }
   
    /**
     * Helper method that binds the a non serializable object to the JNDI tree.
     *
     * @param jndiName Name under which the object must be bound
     * @param who Object to bind in JNDI
     * @param classType Class type under which should appear the bound object
     * @param ctx Naming context under which we bind the object
     * @throws Exception Thrown if a naming exception occurs during binding
     */
    private static void bind(String jndiName, Object who, Class&lt;?&gt; classType, Context ctx) throws Exception {
       // Ah ! This service isn't serializable, so we use a helper class
       NonSerializableFactory.bind(jndiName, who);
       Name n = ctx.getNameParser("").parse(jndiName);
       while (n.size() &gt; 1) {
          String ctxName = n.get(0);
          try {
             ctx = (Context) ctx.lookup(ctxName);
          } catch (NameNotFoundException e) {
             System.out.println("Creating subcontext:" + ctxName);
             ctx = ctx.createSubcontext(ctxName);
          }
          n = n.getSuffix(1);
       }

       // The helper class NonSerializableFactory uses address type nns, we go on to
       // use the helper class to bind the service object in JNDI
       StringRefAddr addr = new StringRefAddr("nns", jndiName);
       Reference ref = new Reference(classType.getName(), addr, NonSerializableFactory.class.getName(), null);
       ctx.rebind(n.get(0), ref);
    }
   
    private static void unbind(String jndiName, Context ctx) throws Exception {
       NonSerializableFactory.unbind(jndiName);
       ctx.unbind(jndiName);
    }

}

</pre> </div> </div> <div class="paragraph"> <p>Adjust follwing 2 properties in your corresponding persistence.xml:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;property name="hibernate.jndi.class" value="org.jnp.interfaces.NamingContextFactory"/&gt;  
&lt;property name="hibernate.transaction.manager_lookup_class" value="com.atomikos.icatch.jta.hibernate3.TransactionManagerLookup"/&gt;
</pre> </div> </div> <div class="paragraph"> <p>And create a file named jta.properties in your classpath with following content:</p> </div> <div class="listingblock"> <div class="content"> <pre>
com.atomikos.icatch.service=com.atomikos.icatch.standalone.UserTransactionServiceFactory
com.atomikos.icatch.automatic_resource_registration=false
com.atomikos.icatch.console_log_level=WARN
com.atomikos.icatch.force_shutdown_on_vm_exit=true
com.atomikos.icatch.enable_logging=false</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645165"><a class="anchor" href="#sid-18645165"></a>38. Infinispan Maven Archetypes</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan currently has 2 separate Maven link:$$http://maven.apache.org/guides/introduction/introduction-to-archetypes.html$$[archetypes] you can use to create a skeleton project and get started using Infinispan.  This is an easy way to get started using Infinispan as the archetype generates sample code, a sample Maven pom.xml with necessary depedencies, etc.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>NOTE:  You don't need to have any experience with or knowledge of Maven's Archetypes to use this!  Just follow the simple steps below.</pre> </div> </div> <div class="paragraph"> <p>* *</p> </div> <div class="listingblock"> <div class="content"> <pre>WARNING: These archetypes have only been tested with &lt;a href="http://maven.apache.org/docs/3.0.1/release-notes.html"&gt;Maven 3&lt;/a&gt;.  Please report back if you have any success with using Maven 2.</pre> </div> </div> <div class="paragraph"> <p>Starting a new project</p> </div> <div class="paragraph"> <p>Use the newproject-archetype project.  The simple command below will get you started, and</p> </div> <div class="listingblock"> <div class="content"> <pre>$ mvn archetype:generate \
    -DarchetypeGroupId=org.infinispan.archetypes \
    -DarchetypeArtifactId=newproject-archetype \
    -DarchetypeVersion=1.0.9 \
    -DarchetypeRepository=http://repository.jboss.org/nexus/content/groups/public
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>You will be prompted for a few things, including the _artifactId_ , _groupId_ and _version_ of your new project.  And that's it - you're ready to go!</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645165_InfinispanMavenArchetypes-Playingwithyournewproject"><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-Playingwithyournewproject"></a>38.1. Playing with your new project</h3> <div class="literalblock"> <div class="content"> <pre>The skeleton project ships with a sample application class, interacting with Infinispan.  You should open this new project in your IDE - most good IDEs such as IntelliJ and Eclipse allow you to import Maven projects, see link:$$http://www.jetbrains.com/idea/webhelp/importing-maven-project.html$$[this guide] and link:$$http://m2eclipse.sonatype.org/$$[this guide] .  Once you open your project in your IDE, you should examine the generated classes and read through the comments.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645165_InfinispanMavenArchetypes-Onthecommandline..."><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-Onthecommandline..."></a>38.2. On the command line&#8230;</h3> <div class="paragraph"> <p>Try running</p> </div> <div class="listingblock"> <div class="content"> <pre>$ mvn install -Prun</pre> </div> </div> <div class="paragraph"> <p>in your newly generated project!  This runs the main() method in the generated application class.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645165_InfinispanMavenArchetypes-WritingatestcaseforInfinispan"><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-WritingatestcaseforInfinispan"></a>38.3. Writing a test case for Infinispan</h3> <div class="paragraph"> <p>This archetype is useful if you wish to contribute a test to the Infinispan project and helps you get set up to use Infinispan&#8217;s testing harness and related tools.</p> </div> <div class="paragraph"> <p>Use</p> </div> <div class="listingblock"> <div class="content"> <pre>$ mvn archetype:generate \
    -DarchetypeGroupId=org.infinispan.archetypes \
    -DarchetypeArtifactId=testcase-archetype \
    -DarchetypeVersion=1.0.9 \
    -DarchetypeRepository=http://repository.jboss.org/nexus/content/groups/public</pre> </div> </div> <div class="paragraph"> <p>As above, this will prompt you for project details and again as above, you should open this project in your IDE.  Once you have done so, you will see some sample tests written for Infinispan making use of Infinispan&#8217;s test harness and testing tools along with extensive comments and links for further reading.</p> </div> <div class="sect3"> <h4 id="sid-18645165_InfinispanMavenArchetypes-Onthecommandline...x"><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-Onthecommandline...x"></a>38.3.1. On the command line&#8230;</h4> <div class="paragraph"> <p>Try running</p> </div> <div class="listingblock"> <div class="content"> <pre>$ mvn test</pre> </div> </div> <div class="paragraph"> <p>in your newly generated project to run your tests.</p> </div> <div class="paragraph"> <p>The generated project has a few different profiles you can use as well, using Maven&#8217;s -P flag.  E.g.,</p> </div> <div class="listingblock"> <div class="content"> <pre>$ mvn test -Pudp</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645165_InfinispanMavenArchetypes-Availableprofiles"><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-Availableprofiles"></a>38.3.2. Available profiles</h4> <div class="paragraph"> <p>The profiles available in the generated sample project are:</p> </div> <div class="ulist"> <ul> <li> <p>udp: use UDP for network communications rather than TCP</p> </li> <li> <p>tcp: use TCP for network communications rather than UDP</p> </li> <li> <p>jbosstm: Use the embedded <a href="http://www.jboss.org/jbosstm">JBoss Transaction Manager</a> rather than Infinispan&#8217;s dummy test transaction manager</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="sid-18645165_InfinispanMavenArchetypes-ContributingtestsbacktoInfinispan"><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-ContributingtestsbacktoInfinispan"></a>38.3.3. Contributing tests back to Infinispan</h4> <div class="literalblock"> <div class="content"> <pre>If you have written a functional, unit or stress test for Infinispan and want to contribute this back to Infinispan, your best bet is to link:$$https://github.com/infinispan/infinispan$$[fork the Infinispan sources on GitHub] .  The test you would have prototyped and tested in an isolated project created using this archetype can be simply dropped in to Infinispan's test suite.  Make your changes, add your test, prove that it fails even on Infinispan's upstream source tree and issue a link:$$http://help.github.com/pull-requests/$$[pull request] .</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>TIP: New to working with Infinispan and GitHub?  Want to know how best to work with the repositories and contribute code?  Read &lt;a __default_attr="16089" __jive_macro_name="document" _modifiedtitle="Infinispan and GitHub" class="jive_macro jive_macro_document" href="javascript:;" modifiedtitle="Infinispan and GitHub" title="Infinispan and GitHub"&gt;&lt;/a&gt;</pre> </div> </div> <div class="paragraph"> <p>* * <a id="sid-18645165_InfinispanMavenArchetypes-Versions"></a></p> </div> </div> </div> <div class="sect2"> <h3 id="_versions"><a class="anchor" href="#_versions"></a>38.4. Versions</h3> <div class="paragraph"> <p>The archetypes generate poms with dependencies to specific versions of Infinispan.  You should edit these generated poms by hand to point to other versions of Infinispan that you are interested in.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645165_InfinispanMavenArchetypes-SourceCode"><a class="anchor" href="#sid-18645165_InfinispanMavenArchetypes-SourceCode"></a>38.5. Source Code</h3> <div class="literalblock"> <div class="content"> <pre>The source code used to generate these archetypes are link:$$https://github.com/infinispan/infinispan-archetypes$$[on GitHub] .  If you wish to enhance and contribute back to the project, fork away!</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645167"><a class="anchor" href="#sid-18645167"></a>39. Accessing data in Infinispan via RESTful interface</h2> <div class="sectionbody"> <div class="paragraph"> <div class="title">TODO Gliffy image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>_Standards_ Red Hat is working towards standardization of the REST API as a part of the link:$$http://www.rest-star.org$$[REST-*] effort.  To participate in this standard, please visit link:$$http://groups.google.com/group/reststar-caching$$[this Google Group]</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Puttingdatain"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Puttingdatain"></a>39.1. Putting data in</h3> <div class="literalblock"> <div class="content"> <pre>HTTP PUT and POST methods are used to place data in the cache - the data being the body of the request (the data can be anything you like). It is important that a Content-Type header is set.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-PUT%2F%5C%2F%5C"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-PUT%2F%5C%2F%5C"></a>39.1.1. PUT /{cachename}/{cachekey}</h4> <div class="literalblock"> <div class="content"> <pre>A PUT request of the above URL form will place the payload (body) in the given cache, with the given key (the named cache must exist on the server). For example link:$$http://someserver/hr/payRoll/3$$[] (in which case "hr" is the cache name, and "payRoll/3" is the key). Any existing data will be replaced, and Time-To-Live and Last-Modified values etc will updated (if applicable).</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-POST%2F%5C%2F%5C"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-POST%2F%5C%2F%5C"></a>39.1.2. POST /{cachename}/{cachekey}</h4> <div class="literalblock"> <div class="content"> <pre>Exactly the same as PUT, only if a value in a cache/key already exists, it will return a Http CONFLICT status (and the content will not be updated).</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Headers%3A"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Headers%3A"></a>39.1.3. Headers:</h4> <div class="ulist"> <ul> <li> <p>Content-Type : MANDATORY (use <a href="http://www.iana.org/assignments/media-types/">media/mime-types</a> for example: "application/json").</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Special case</div> <div class="literalblock"> <div class="content"> <pre>If you set the Content-Type to application/x-java-serialized-object , then it will be stored as a Java object</pre> </div> </div> </td> </tr> </table> </div> <div class="ulist"> <ul> <li> <p>performAsync : OPTIONAL true/false (if true, this will return immediately, and then replicate data to the cluster on its own. Can help with bulk data inserts/large clusters.)</p> </li> <li> <p>timeToLiveSeconds : OPTIONAL number (the number of seconds before this entry will automatically be deleted)</p> </li> <li> <p>If no parameter is sent, Infinispan assumes -1 as default value, which means that the entry will not expire as a result of ttl. Passing any negative value will have the same effect.</p> </li> <li> <p>maxIdleTimeSeconds : OPTIONAL number (the number of seconds after last usage of this entry when it will automatically be deleted)</p> </li> <li> <p>If no parameter is sent, Infinispan assumes -1 as default value, which means that the entry will not expire as a result of idle time. Passing any negative value will have the same effect.</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Passing 0 as parameter for timeToLiveSeconds and/or maxIdleTimeSeconds</div> <div class="ulist"> <ul> <li> <p>If both timeToLiveSeconds and maxIdleTimeSeconds are 0, the cache will use the default lifespan and maxIdle values configured in XML/programmatically</p> </li> <li> <p>If <em>only</em> maxIdleTimeSeconds is 0, it uses the timeToLiveSeconds value passed as parameter (or -1 if not present), and default maxIdle configured in XML/programmatically</p> </li> <li> <p>If <em>only</em> timeToLiveSeconds is 0, it uses 0 as timeToLiveSeconds meaning that it will expire immediately, and maxIdle is set whatever came as parameter (or -1 if not present)</p> </li> </ul> </div> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Gettingdatabackout"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Gettingdatabackout"></a>39.2. Getting data back out</h3> <div class="literalblock"> <div class="content"> <pre>HTTP GET and HEAD are used to retrieve data from entries.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-GET%2F%5C%2F%5C"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-GET%2F%5C%2F%5C"></a>39.2.1. GET /{cachename}/{cachekey}</h4> <div class="literalblock"> <div class="content"> <pre>This will return the data found in the given cacheName, under the given key - as the body of the response. A Content-Type header will be supplied which matches what the data was inserted as (other then if it is a Java object, see below). Browsers can use the cache directly of course (eg as a CDN). An link:$$http://en.wikipedia.org/wiki/HTTP_ETag$$[ETag] will be returned unique for each entry, as will the Last-Modified header field indicating the state of the data at the given URL. ETags allow browsers (and other clients) to ask for data only in the case where it has changed (to save on bandwidth) - this is standard HTTP and is honoured by Infinispan.</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-HEAD%2F%5C%2F%5C"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-HEAD%2F%5C%2F%5C"></a>39.2.2. HEAD /{cachename}/{cachekey}</h4> <div class="paragraph"> <p>The same as GET, only no content is returned (only the header fields). You will receive the same content that you stored. E.g., if you stored a String, this is what you get back. If you stored some XML or JSON, this is what you will receive. If you stored a binary (base 64 encoded) blob, perhaps a serialized; Java; object - you will need to; deserialize this yourself.</p> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="icon-warning" title="Warning"></i> </td> <td class="content"> <div class="title">Prior to Infinispan 4.2</div> <div class="literalblock"> <div class="content"> <pre>The behaivour was as follows: If the data in the grid is a Java object - there are a few options in how it can be returned, which use the HTTP Accept header:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>application/xml - the object will be serialized via XStream to XML representation</p> </li> <li> <p>application/json - the object will be sent via a JSON format (via Jackson)</p> </li> <li> <p>application/x-java-serialized-object - if the object is Serializable, you can use this and get a stream of the Java Serialization form of the object (obviously only makes sense for java clients with a suitable class loaded). If its not Serializable, you have to use one of the other options.</p> </li> </ul> </div> </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Removingdata"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-Removingdata"></a>39.3. Removing data</h3> <div class="paragraph"> <p>Data can be removed at the cache key/element level, or via a whole cache name using the HTTP delete method.</p> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-DELETE%2F%5C%2F%5C"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-DELETE%2F%5C%2F%5C"></a>39.3.1. DELETE /{cachename}/{cachekey}</h4> <div class="paragraph"> <p>Removes the given key name from the cache.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-DELETE%2F%5C"><a class="anchor" href="#sid-18645167_AccessingdatainInfinispanviaRESTfulinterface-DELETE%2F%5C"></a>39.3.2. DELETE /{cachename}</h4> <div class="paragraph"> <p>Removes ALL the entries in the given cache name (ie everything from that path down). If the operation is successful, it returns 200 code.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Make it quicker!</div> <div class="paragraph"> <p>Set the header performAsync to true to return immediately and let the removal happen in the background.</p> </div> </td> </tr> </table> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645168"><a class="anchor" href="#sid-18645168"></a>40. Infinispan Distributed Execution Framework</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Introduction"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Introduction"></a>40.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>link:$$http://labs.google.com/papers/mapreduce-osdi04.pdf$$[MapReduce] is a programming model and a framework for processing and generating large data sets. Users specify a map function that processes a key/value pair to generate a set of intermediate key/value pairs, and a reduce function that merges all intermediate values associated with the same intermediate k. MapReduce framework enables users to transparently parallelize their tasks and execute them on a large cluster of machines.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Scopeandobjectives"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Scopeandobjectives"></a>40.2. Scope and objectives</h3> <div class="paragraph"> <p>Infinispan&#8217;s distributed execution framework focuses on developing a simple distributed execution framework for tasks that are already defined as Callables as well as an adapted version of Google&#8217;s MapReduce framework for large computation tasks. The framework is defined as "adapted" because the input data for map reduce tasks is taken from Infinispan nodes themselves rather than using input files as it was defined by the original proposal.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Cachedataastaskinputdata"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Cachedataastaskinputdata"></a>40.3. Cache data as task input data</h3> <div class="paragraph"> <p>Infinispan&#8217;s distributed task execution and MapReduce frameworks use data from Infinispan nodes as input for execution tasks. Most other distributed frameworks do not have that leverage and users have to specify input for distributed tasks from some well known location. Furthermore, users of Infinispan distributed execution framework do not have to configure store for intermediate and final results thus removing another layer of complexity and maintenance.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Loadbalancedexecutionbuiltinbydefault"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Loadbalancedexecutionbuiltinbydefault"></a>40.4. Load balanced execution - built in by default</h3> <div class="paragraph"> <p>Our distributed execution framework capitalizes on the fact input data in Infinispan data grid is already load balanced (DIST Infinispan mode). Since input data is already balanced execution tasks will be automatically balanced as well; users do not have to explicitly assign work tasks to specific Infinispan nodes. However, our framework accommodates users to specify arbitrary subset of cache data as input for distributed execution tasks.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Distributedtasksinput"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Distributedtasksinput"></a>40.5. Distributed tasks input</h3> <div class="literalblock"> <div class="content"> <pre>After an execution task is assigned for execution to a specific Infinispan node our framework provides API to access local data on Infinispan node used as an input to a distributed execution task. Access to Infinispan cache runtime environment is provided by setEnvironment callback of link:$$https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/distexec/DistributedCallable.java$$[DistributedCallable] . Users can access cache whose data is used as an input for distributed task or any other cache using a familiar CacheManager API.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Distributedtaskfailoverandmigration"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Distributedtaskfailoverandmigration"></a>40.6. Distributed task failover and migration</h3> <div class="paragraph"> <p>Distributed execution framework will support task failover. There are two orthogonal issues related to task failover:</p> </div> <div class="paragraph"> <p>a) Failover due to node failure where task is executing</p> </div> <div class="paragraph"> <p>b) Failover due to task failure (e.g. Callable task throws Exception).</p> </div> <div class="paragraph"> <p>Distributed tasks, taking input data from Infinispan nodes themselves, can rely on Infinispan&#8217;s consistent hashing (CH) for failover of uncompleted tasks. CH based failover will migrate failed task T to cluster node(s) having a backup of input data that used to belong to failed node F. Task T executing on node F has to be re-spawned/migrated to node F' which is next to node F based on a hash wheel position. Task migration is continued until a running node - hash wheel neighbour of F is found. In another words, task migration continues until all hash wheel neghbours of F are exhausted or task completes successfully. Utilizing CH each newly spawned task migrated to node F' will be able to locate data that used to belong to failed node F. Implementation of a default node failover is planed for first release - time permitting. For distributed tasks that do not rely on pulling data from Infinispan nodes we can provide other policies: fail-fast, fail-slow etc etc.</p> </div> <div class="paragraph"> <p>Both node failover and task failover policy will be pluggable. Initial implementation will define interfaces to implement various node failover policies but we will provide only a simple policy that throws an exception if a node fails. In terms of task failure the default initial implementation will simply re-spawn the failed task until it reaches some failure threshold. Future implementations might migrate such a failing task to another node etc.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Distributedexecutionmodel"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Distributedexecutionmodel"></a>40.7. Distributed execution model</h3> <div class="literalblock"> <div class="content"> <pre>The main interfaces for distributed task execution are link:$$https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/distexec/DistributedCallable.java$$[DistributedCallable] and link:$$https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/distexec/DistributedExecutorService.java$$[DistributedExecutorService] . DistributedCallable is a subtype of the existing Callable from java.util.concurrent package; DistributedCallable can be executed in a remote JVM and receive input from Infinispan cache. Task's main algorithm could essentially remain unchanged, only the input source is changed. Exisiting Callable implementations most likely get its input in a form of some Java object/primitive while DistributedCallable gets its input from Infinispan cache. Therefore, users who have already implemented Callable interface to describe their task units would simply extend DistributedCallable and use keys from Infinispan execution environment as input for the task. Implentation of DistributedCallable can in fact continue to support implementation of an already existing Callable while simultaneously be ready for distribited execution by extending DistributedCallable.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>public interface DistributedCallable&lt;K, V, T&gt; extends Callable&lt;T&gt; {

   /**
    * Invoked by execution environment after DistributedCallable
    * has been migrated for execution to a specific Infinispan node.
    *
    * @param cache
    *           cache whose keys are used as input data for this
    *           DistributedCallable task
    * @param inputKeys
    *           keys used as input for this DistributedCallable task
    */
   public void setEnvironment(Cache&lt;K, V&gt; cache, Set&lt;K&gt; inputKeys);

}</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>DistributedExecutorService is a simple extension of a familiar ExecutorService from java.util.concurrent package. However, advantages of DistributedExecutorService are not to be overlooked. Existing Callable tasks, instead of being executed in JDK's ExecutorService, are also eligible for execution on Infinispan cluster. Infinispan execution environment would migrate a task to execution node(s), run the task and return the result(s) to the calling node. Of course, not all Callable tasks would benefit from parallel distributed execution. Excellent candidates are long running and computationally intensive tasks that can run concurrently and/or tasks using input data that can be processed concurrently. For more details about good candidates for parallel execution and parallel algorithms in general refer to link:$$https://computing.llnl.gov/tutorials/parallel_comp/$$[Introduction to Parallel Computing] .</pre> </div> </div> <div class="paragraph"> <p>The second advantage of the DistributedExecutorService is that it allows a quick and simple implementation of tasks that take input from Infinispan cache nodes, execute certain computation and return results to the caller. Users would specify which keys to use as input for specified DistributedCallable and submit that callable for execution on Infinispan cluster. Infinispan runtime would locate the appriate keys, migrate DistributedCallable to target execution node(s) and finally return a list of results for each executed Callable. Of course, users can omit specifying input keys in which case Infinispan would execute DistributedCallable on all keys for a specified cache.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-MapReducemodel"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-MapReducemodel"></a>40.8. MapReduce model</h3> <div class="paragraph"> <p>Infinispan&#8217;s own MapReduce model is an adaptation of Google&#8217;s original MapReduce. There are four main components in each map reduce task: Mapper, Reducer, Collator and MapReduceTask.</p> </div> <div class="paragraph"> <p>Implementation of a Mapper class is a component of a MapReduceTask invoked once for each input entry K,V. Every Mapper instance migrated to an Infinispan node, given a cache entry K,V input pair transforms that input pair into intermediate key/value pair emitted into a provided Collector. Intermediate results are further reduced using a Reducer.</p> </div> <div class="listingblock"> <div class="content"> <pre>public interface Mapper&lt;KIn, VIn, KOut, VOut&gt; extends Serializable {

   /**
    * Invoked once for each input cache entry KIn,VOut .
    */
   void map(KIn key, VIn value, Collector&lt;KOut, VOut&gt; collector);
}</pre> </div> </div> <div class="paragraph"> <p>The Reducer, as its name implies, reduces a list of intermediate results from map phase of MapReduceTask. Infinispan distributed execution environment creates one instance of Reducer per execution node.</p> </div> <div class="listingblock"> <div class="content"> <pre>public interface Reducer&lt;KOut, VOut&gt; extends Serializable {
   /**
    * Combines/reduces all intermediate values for a particular
    * intermediate key to a single value.
    * &lt;p&gt;
    *
    */
   VOut reduce(KOut reducedKey, Iterator&lt;VOut&gt; iter);

}</pre> </div> </div> <div class="paragraph"> <p>Collator coordinates results from Reducers executed on Infinispan cluster and assembles a final result returned to an invoker of MapReduceTask. Collator is applied to final Map&lt;KOut,VOut&gt; result of MapReduceTask.</p> </div> <div class="listingblock"> <div class="content"> <pre>public interface Collator&lt;KOut, VOut, R&gt; {
   /**
    * Collates all reduced results and returns R to invoker
    * of distributed task.
    *
    * @return final result of distributed task computation
    */
   R collate(Map&lt;KOut, VOut&gt; reducedResults);
}</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Finally, link:$$https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/distexec/mapreduce/MapReduceTask.java$$[MapReduceTask] is a distributed task uniting Mapper, Reducer and Collator into a cohesive large scale computation to be transparently parallelized across Infinispan cluster nodes. Users of MapReduceTask need to provide a cache whose data is used as input for this task. Infinispan execution environment will instantiate and migrate instances of provided mappers and reducers seamlessly across Infinispan nodes. Unless otherwise specified using onKeys method input keys filter all available key value pairs of a specified cache will be used as input data for this task.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645168_InfinispanDistributedExecutionFramework-Examples"><a class="anchor" href="#sid-18645168_InfinispanDistributedExecutionFramework-Examples"></a>40.9. Examples</h3> <div class="paragraph"> <p>Pi approximation can greatly benefit from parallel distributed execution in DistributedExecutorService. Recall that area of the square is Sa = 4r2 and area of the circle is Ca=pi*r2. Substituting r2 from the second equation into the first one it turns out that pi = 4 * Ca/Sa. Now, image that we can shoot very large number of darts into a square; if we take ratio of darts that land inside a circle over a total number of darts shot we will approximate Ca/Sa value. Since we know that pi = 4 * Ca/Sa we can easily derive approximate value of pi. The more darts we shoot the better approximation we get. In the example below we shoot 10 million darts but instead of "shooting" them serially we parallelize work of dart shooting across entire Infinispan cluster.</p> </div> <div class="listingblock"> <div class="content"> <pre>  public class PiAppx {

   public static void main (String [] arg){
      List&lt;Cache&gt; caches = ...;
      Cache cache = ...;

      int numPoints = 10000000;
      int numServers = caches.size();
      int numberPerWorker = numPoints / numServers;

      DistributedExecutorService des = new DefaultExecutorService(cache);
      long start = System.currentTimeMillis();
      CircleTest ct = new CircleTest(numberPerWorker);
      List&lt;Future&lt;Integer&gt;&gt; results = des.submitEverywhere(ct);
      int countCircle = 0;
      for (Future&lt;Integer&gt; f : results) {
         countCircle += f.get();
      }
      double appxPi = 4.0 * countCircle / numPoints;

      System.out.println("Distributed PI appx is " + appxPi +
      " completed in " + (System.currentTimeMillis() - start) + " ms");
   }

   private static class CircleTest implements Callable&lt;Integer&gt;, Serializable {

      /** The serialVersionUID */
      private static final long serialVersionUID = 3496135215525904755L;

      private final int loopCount;

      public CircleTest(int loopCount) {
         this.loopCount = loopCount;
      }

      @Override
      public Integer call() throws Exception {
         int insideCircleCount = 0;
         for (int i = 0; i &lt; loopCount; i++) {
            double x = Math.random();
            double y = Math.random();
            if (insideCircle(x, y))
               insideCircleCount++;
         }
         return insideCircleCount;
      }

      private boolean insideCircle(double x, double y) {
         return (Math.pow(x - 0.5, 2) + Math.pow(y - 0.5, 2))
         &lt;= Math.pow(0.5, 2);
      }
   }
}</pre> </div> </div> <div class="paragraph"> <p>Word count is a classic, if not overused, example of map/reduce paradigm. Assume we have a mapping of key--&gt;sentence stored on Infinispan nodes. Key is a String, each sentence is also a String, and we have to count occurrence of all words in all sentences available. The implementation of such a distributed task could be defined as follows:</p> </div> <div class="listingblock"> <div class="content"> <pre>public class WordCountExample {

   /**
    * In this example replace c1 and c2 with
    * real Cache references
    *
    * @param args
    */
   public static void main(String[] args) {
      Cache c1 = null;
      Cache c2 = null;

      c1.put("1", "Hello world here I am");
      c2.put("2", "Infinispan rules the world");
      c1.put("3", "JUDCon is in Boston");
      c2.put("4", "JBoss World is in Boston as well");
      c1.put("12","JBoss Application Server");
      c2.put("15", "Hello world");
      c1.put("14", "Infinispan community");
      c2.put("15", "Hello world");

      c1.put("111", "Infinispan open source");
      c2.put("112", "Boston is close to Toronto");
      c1.put("113", "Toronto is a capital of Ontario");
      c2.put("114", "JUDCon is cool");
      c1.put("211", "JBoss World is awesome");
      c2.put("212", "JBoss rules");
      c1.put("213", "JBoss division of RedHat ");
      c2.put("214", "RedHat community");

      MapReduceTask&lt;String, String, String, Integer&gt; t =
         new MapReduceTask&lt;String, String, String, Integer&gt;(c1);
      t.mappedWith(new WordCountMapper())
         .reducedWith(new WordCountReducer());
      Map&lt;String, Integer&gt; wordCountMap = t.execute();
   }

   static class WordCountMapper implements Mapper&lt;String,String,String,Integer&gt; {
      /** The serialVersionUID */
      private static final long serialVersionUID = -5943370243108735560L;

      @Override
      public void map(String key, String value, Collector&lt;String, Integer&gt; c) {
         StringTokenizer tokens = new StringTokenizer(value);
         while (tokens.hasMoreElements()) {
            String s = (String) tokens.nextElement();
            c.emit(s, 1);
         }        
      }
   }

   static class WordCountReducer implements Reducer&lt;String, Integer&gt; {
      /** The serialVersionUID */
      private static final long serialVersionUID = 1901016598354633256L;

      @Override
      public Integer reduce(String key, Iterator&lt;Integer&gt; iter) {
         int sum = 0;
         while (iter.hasNext()) {
            Integer i = (Integer) iter.next();
            sum += i;
         }
         return sum;
      }
   }
}</pre> </div> </div> <div class="paragraph"> <p>As we have seen it is relatively easy to specify map reduce task counting number of occurrences for each word in all sentences. Best of all result is returned to task invoker in the form of Map&lt;KOut,VOut&gt; rather than being written to a stream.</p> </div> <div class="paragraph"> <p>What if we need to find the most frequent word in our word count example? All we have to do is to define a Collator that will transform the result of MapReduceTask Map&lt;KOut,VOut&gt; into a String which in turn is returned to a task invoker. We can think of Collator as transformation function applied to a final result of MapReduceTask.</p> </div> <div class="listingblock"> <div class="content"> <pre>MapReduceTask&lt;String, String, String, Integer&gt; t =
      new MapReduceTask&lt;String, String, String, Integer&gt;(cache);
t.mappedWith(new WordCountMapper()).reducedWith(new WordCountReducer());
String mostFrequentWord = t.execute(
      new Collator&lt;String,Integer,String&gt;() {

         @Override
         public String collate(Map&lt;String, Integer&gt; reducedResults) {
            String mostFrequent = "";
            int maxCount = 0;
            for (Entry&lt;String, Integer&gt; e : reducedResults.entrySet()) {
               Integer count = e.getValue();
               if(count &gt; maxCount) {
                  maxCount = count;
                  mostFrequent = e.getKey();
               }             
            }
         return mostFrequent;
         }        

      });
System.out.println("The most frequent word is " + mostFrequentWord);

</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645169"><a class="anchor" href="#sid-18645169"></a>41. Listeners and Notifications</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan offers a listener API, where clients can register for and get notified when events take place. This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p> </div> <div class="literalblock"> <div class="content"> <pre>Events trigger a notification which are dispatched to listeners.   Listeners are simple link:$$http://en.wikipedia.org/wiki/Plain_Old_Java_Object$$[POJO] s annotated with link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/notifications/Listener.html$$[@Listener] and registered using the methods defined in the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/notifications/Listenable.html$$[Listenable] interface.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications.
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For example, the following class defines a listener to print out some information every time a new entry is added to the cache:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>@Listener
public class PrintWhenAdded {

  @CacheEntryCreated
  public void print(CacheEntryCreatedEvent event) {
    System.out.println("New entry " + event.getKey() + " created in the cache");
  }

}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For more comprehensive examples, please see the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/notifications/Listener.html$$[Javadocs for @Listener] .</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645169_ListenersandNotifications-Cachelevelnotifications"><a class="anchor" href="#sid-18645169_ListenersandNotifications-Cachelevelnotifications"></a>41.1. Cache-level notifications</h3> <div class="paragraph"> <p>Cache-level events occur on a per-cache basis, and is global and cluster-wide. Examples of cache-level events are entries being added, removed, modified, etc. These events trigger notifications to listeners registered to a specific cache.</p> </div> <div class="literalblock"> <div class="content"> <pre>Please see the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html$$[Javadocs on the org.infinispan.notifications.cachelistener.annotation package] for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>NOTE: In Infinispan 5.0, additional events were added.  Please refer to the &lt;a href="http://docs.jboss.org/infinispan/5.0/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html"&gt;Javadocs on the org.infinispan.notifications.cachelistener.annotation package&lt;/a&gt; for Infinispan 5.0 for the list of cache-level notifications available in Infinispan 5.0.
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645169_ListenersandNotifications-Cachemanagerlevelnotifications"><a class="anchor" href="#sid-18645169_ListenersandNotifications-Cachemanagerlevelnotifications"></a>41.2. Cache manager-level notifications</h3> <div class="paragraph"> <p>Cache manager-level events occur on a cache manager. These too are global and cluster-wide, but involve events that affect all caches created by a single cache manager. Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p> </div> <div class="literalblock"> <div class="content"> <pre>Please see the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html$$[Javadocs  on the org.infinispan.notifications.cachemanagerlistener.annotation package] for a comprehensive list of all cache manager-level notifications,  and their respective method-level annotations.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645169_ListenersandNotifications-Synchronicity"><a class="anchor" href="#sid-18645169_ListenersandNotifications-Synchronicity"></a>41.3. Synchronicity</h3> <div class="literalblock"> <div class="content"> <pre>By default, all notifications are dispatched in the same thread that generates the event.  This means that you _must_ write your listener such that it does not block or do anything that takes too long, as it would prevent the thread from progressing.  Alternatively, you could annotate your listener as _asynchronous_ , in which case a separate thread pool will be used to dispatch the notification and prevent blocking the event originating thread.  To do this, simply annotate your listener such:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>@Listener (sync = false)
public class MyAsyncListener { .... }
</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645169_ListenersandNotifications-Asynchronousthreadpool"><a class="anchor" href="#sid-18645169_ListenersandNotifications-Asynchronousthreadpool"></a>41.3.1. Asynchronous thread pool</h4> <div class="literalblock"> <div class="content"> <pre>To tune the thread pool used to dispatch such asynchronous notifications, use the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/config.html#ce_global_asyncListenerExecutor$$[&amp;lt;asyncListenerExecutor /&amp;gt;] XML element in your configuration file.</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645169_ListenersandNotifications-ListenersonRemoteCacheManager"><a class="anchor" href="#sid-18645169_ListenersandNotifications-ListenersonRemoteCacheManager"></a>41.4. Listeners on RemoteCacheManager</h3> <div class="literalblock"> <div class="content"> <pre>At the moment there is no support for registering listeners for the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html$$[RemoteCacheManager] . Whenever calling one of the add/remove/getListener methods on the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html$$[RemoteCacheManager] an UnsupportedOperationException will be thrown. There are plans to support remote listeners in future versions; in order to be notified when this feature will be added you can watch/vote for link:$$https://issues.jboss.org/browse/ISPN-374$$[ISPN-374] .</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645170"><a class="anchor" href="#sid-18645170"></a>42. Eviction</h2> <div class="sectionbody"> <div class="paragraph"> <p>Infinispan supports eviction of entries, such that you do not run out of memory. Eviction is typically used in conjunction with a cache store, so that entries are not permanently lost when evicted, since eviction only removes entries from memory and not from cache stores or the rest of the cluster.</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Passivation is also a popular option when using eviction, so that only a single copy of an entry is maintained - either in memory or in a cache store, but not both. The main benefit of using passivation over a regular cache store is that updates to entries which exist in memory are cheaper since the update doesn&#8217;t need to be made to the cache store as well.</p> </div> </td> </tr> </table> </div> <div class="literalblock"> <div class="content"> <pre>Note that eviction occurs on a _local_ basis, and is not cluster-wide.  Each node runs an eviction thread to analyse the contents of its in-memory container and decide what to evict. Eviction does not take into account the amount of free memory in the JVM as threshold to  starts evicting entries. You have to set maxEntries attribute of the eviction element to be greater than zero in order for eviction to be turned on. If maxEntries is too large you can run out of memory. maxEntries attribute will probably take some tuning in each use case.</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645170_Eviction-Evictionin4.0"><a class="anchor" href="#sid-18645170_Eviction-Evictionin4.0"></a>42.1. Eviction in 4.0</h3> <div class="literalblock"> <div class="content"> <pre>Eviction is configured by adding the link:$$http://docs.jboss.org/infinispan/5.1/configdocs/urn_infinispan_config_5.1/complexType/configuration.eviction.html$$[&amp;lt;eviction /&amp;gt;] element to your &amp;lt;default /&amp;gt; or &amp;lt;namedCache /&amp;gt; configuration sections.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645170_Eviction-NONE"><a class="anchor" href="#sid-18645170_Eviction-NONE"></a>42.1.1. NONE</h4> <div class="paragraph"> <p>This eviction strategy effectively disables the eviction thread.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645170_Eviction-UNORDERED"><a class="anchor" href="#sid-18645170_Eviction-UNORDERED"></a>42.1.2. UNORDERED</h4> <div class="literalblock"> <div class="content"> <pre>_New in Infinispan 4.1_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>This eviction strategy means that a simple, un-ordered data container is used. The eviction thread still runs and maintains the size of the data container within certain limits, but it selects entries for eviction in an indeterminate fashion. The benefit of this eviction strategy is that you get an efficient link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/container/SimpleDataContainer.html$$[SimpleDataContainer] which does not incur the ordering costs of FIFO or LRU, as most operations are performed in constant-time.</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645170_Eviction-FIFO"><a class="anchor" href="#sid-18645170_Eviction-FIFO"></a>42.1.3. FIFO</h4> <div class="literalblock"> <div class="content"> <pre>This strategy means that entries are selected for eviction using a first-in-first-out pattern.  See the Javadocs on the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/container/FIFOSimpleDataContainer.html$$[FIFOSimpleDataContainer] for information on the algorithm used and the performance tradeoffs involved.</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>FIFO has been deprecated as of 5.0. LRU will be used instead</p> </div> </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="sid-18645170_Eviction-LRU"><a class="anchor" href="#sid-18645170_Eviction-LRU"></a>42.1.4. LRU</h4> <div class="literalblock"> <div class="content"> <pre>This strategy means that entries are selected for eviction using a least-recently-used pattern.  See the Javadocs on the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/container/LRUSimpleDataContainer.html$$[LRUSimpleDataContainer] for information on the algorithm used and the  performance tradeoffs involved.</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645170_Eviction-Tuningtheevictionthread"><a class="anchor" href="#sid-18645170_Eviction-Tuningtheevictionthread"></a>42.1.5. Tuning the eviction thread</h4> <div class="literalblock"> <div class="content"> <pre>Eviction makes use of a link:$$http://java.sun.com/javase/6/docs/api/java/util/concurrent/ScheduledExecutorService.html$$[SheduledExecutorService] to kick in periodically and inspect the data container for size, and evict entries as needed. This can be tuned using the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/config.html#ce_global_evictionScheduledExecutor$$[&amp;lt;evictionScheduledExecutor /&amp;gt;] configuration element.</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645170_Eviction-Evictionin4.1%2C4.2and5.x"><a class="anchor" href="#sid-18645170_Eviction-Evictionin4.1%2C4.2and5.x"></a>42.2. Eviction in 4.1, 4.2 and 5.x</h3> <div class="literalblock"> <div class="content"> <pre>In Infinispan release 4.1 and later releases we have revamped DataContainer abstraction in order to support a more scalable, low lock contention data container structure. In addition to old eviction approaches you can now select link:$$http://infinispan.blogspot.com/2010/03/infinispan-eviction-batching-updates.html$$[LIRS] eviction algorithm. LRU remains the default and should be an excellent fit in many deployment scenarios. However, note that LRU eviction algorithm, although simple and easy to understand, under performs in some special cases of so called weak access locality (one time access entries are not timely replaced, entries to be accessed soonest are unfortunately replaced, and so on).</pre> </div> </div> <div class="paragraph"> <p>Starting with 4.1 release all cache entry eviction is done in piggyback fashion. Piggyback eviction thread policy, as it name implies, does eviction by piggybacking on user threads that are hitting the data container. Default eviction done on a dedicated EvictionManager thread has been deprecated and even though default eviction thread policy has been chosen in configuration it will fall back to piggyback style. Dedicated EvictionManager has not been completely removed; it is used to prune expired cache entries from cache.</p> </div> <div class="paragraph"> <p>Also note that Infinispan 4.1 release considers only immortal entries for eviction. By default all entries are immortal, that is, their expiration and lifespan are -1. As soon as cache entries are not immortal they are not subject to eviction policies and container size can potentially grow above limit specified in maxEntries. Starting with Infinispan 4.2 and beyond, 5.0 all container entries regardless of their type are considered as eviction candidates.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645170_Eviction-AdvancedEvictionInternals"><a class="anchor" href="#sid-18645170_Eviction-AdvancedEvictionInternals"></a>42.3. Advanced Eviction Internals</h3> <div class="literalblock"> <div class="content"> <pre>Implementing eviction in a scalable, low lock contention  approach while  at the same time doing meaningful selection of entries for eviction is  not an easy feat. Data container needs to be locked until appropriate  eviction entries are selected. Having  such a lock protected data  container in turn causes high lock contention  offsetting any eviction  precision gained by sophisticated eviction  algorithms. In order to get  superior throughput while retaining high  eviction precision both low  lock contention data container and  high precision eviction algorithm  implementation are needed. Infinispan evicts entries from cache on a  segment level (segments  similar to ConcurrentHashMap), once segment is  full entries are evicted  according to eviction algorithm. However,  there are two drawbacks with this approach. Entries might get evicted  from cache even though maxEntries has not been reached yet and  maxEntries is a theoretical  limit for cache size but in practical   terms it will be slightly less  than maxEntries. For more details refer to link:$$http://infinispan.blogspot.com/2010/03/infinispan-eviction-batching-updates.html$$[Infinispan eviction design] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645170_Eviction-Expiration"><a class="anchor" href="#sid-18645170_Eviction-Expiration"></a>42.4. Expiration</h3> <div class="paragraph"> <p>Similar to, but unlike eviction, is expiration. Expiration allows you to attach lifespan and/or maximum idle times to entries. Entries that exceed these times are treated as invalid and are removed. When removed expired entries are not passivated like evicted entries (if passivation is turned on).</p> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="paragraph"> <p>Unlike eviction, expired entries are removed globally - from memory, cache stores, and cluster-wide.</p> </div> </td> </tr> </table> </div> <div class="literalblock"> <div class="content"> <pre>By default entries created are immortal and do not have a lifespan or maximum idle time.  Using the cache API, mortal entries can be created with lfiespans and/or maximum idle times.  Further, default lifespans and/or maximum idle times can be configured by adding the link:$$http://docs.jboss.org/infinispan/5.1/configdocs/urn_infinispan_config_5.1/complexType/configuration.expiration.html$$[&amp;lt;expiration /&amp;gt;] element to your &amp;lt;default /&amp;gt; or &amp;lt;namedCache /&amp;gt; configuration sections.</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645171"><a class="anchor" href="#sid-18645171"></a>43. ServerHinting</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645171_ServerHinting-Whatisserverhinting%3F"><a class="anchor" href="#sid-18645171_ServerHinting-Whatisserverhinting%3F"></a>43.1. What is server hinting?</h3> <div class="paragraph"> <p>The motivations behind this feature is to ensure when using distribution, backups are not picked to reside on the same physical server, rack or data centre. For obvious reasons it doesn&#8217;t work with total replication.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645171_ServerHinting-Version"><a class="anchor" href="#sid-18645171_ServerHinting-Version"></a>43.2. Version</h3> <div class="paragraph"> <p>Server hinting was added in Infinspan 4.2.0 "Ursus". You&#8217;ll need this release or later in order to use it.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645171_ServerHinting-Configuration"><a class="anchor" href="#sid-18645171_ServerHinting-Configuration"></a>43.3. Configuration</h3> <div class="literalblock"> <div class="content"> <pre>The hints are configured at transport level:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre> &lt;transport     clusterName = "MyCluster"
     machineId = "LinuxServer01"
     rackId = "Rack01"
     siteId = "US-WestCoast" /&gt;
</pre> </div> </div> <div class="paragraph"> <p>Following topology hints can be specified:</p> </div> <div class="ulist"> <ul> <li> <p>machineId - this is probably the most useful, to disambiguate between multiple JVM instances on the same node, or even multiple virtual hosts on the same physical host.</p> </li> <li> <p>rackId - in larger clusters with nodes occupying more than a single rack, this setting would help prevent backups being stored on the same rack.</p> </li> <li> <p>siteId - to differentiate between nodes in different data centres replicating to each other.    All of the above are optional, and if not provided, the distribution algorithms provide no guarantees that backups will not be stored in instances on the same host/rack/site.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645171_ServerHinting-Algorithm"><a class="anchor" href="#sid-18645171_ServerHinting-Algorithm"></a>43.4. Algorithm</h3> <div class="paragraph"> <p>This is an advanced topic, useful e.g. if you need to change distribution behaviour.</p> </div> <div class="paragraph"> <p>The consistent hash beyond this implementation is wheel based. Conceptually this works as follows: each node is placed on a wheel ordered by the hash code of its address. When an entry is added its owners are chosen using this algorithm:</p> </div> <div class="ulist"> <ul> <li> <p>key&#8217;s hash code is calculated</p> </li> <li> <p>the first node on the wheel with a value grater than key&#8217;s hash code is the first owner</p> </li> <li> <p>for subsequent nodes, walk clockwise and pick nodes that have a different site id</p> </li> <li> <p>if not enough nodes found repeat walk again and pick nodes that have different site id and rack id</p> </li> <li> <p>if not enough nodes found repeat walk again and pick nodes that have different site id, rack id and machine id</p> </li> <li> <p>Ultimately cycle back to the first node selected, don&#8217;t discard any nodes, regardless of machine id/rack</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645172"><a class="anchor" href="#sid-18645172"></a>44. Java Hot Rod client</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Introduction"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Introduction"></a>44.1. Introduction</h3> <div class="paragraph"> <p>Hot Rod is a binary, language neutral protocol. This article explains how a Java client can interact with a server via the Hot Rod protocol. A reference implementation of the protocol written in Java can be found in all Infinispan distributions since 4.1, and this article focuses on the capabilities of this java client.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-BasicAPI"><a class="anchor" href="#sid-18645172_JavaHotRodclient-BasicAPI"></a>44.2. Basic API</h3> <div class="paragraph"> <p>Bellow is a sample code snippet on how the client API can be used to store or retrieve information from a Hot Rod server using the Java Hot Rod client. It assumes that a Hot Rod server has been started bound to the default location (localhost:11222)</p> </div> <div class="listingblock"> <div class="content"> <pre>//API entry point, by default it connects to localhost:11222
CacheContainer cacheContainer = new RemoteCacheManager();

//obtain a handle to the remote default cache
Cache&lt;String, String&gt; cache = cacheContainer.getCache();

//now add something to the cache and make sure it is there
cache.put("car", "ferrari");
assert cache.get("car").equals("ferrari");

//remove the data
cache.remove("car");
assert !cache.containsKey("car") : "Value must have been removed!";
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The client API maps the local API: link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html$$[RemoteCacheManager] corresponds to link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/manager/DefaultCacheManager.html$$[DefaultCacheManager] (both implement link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/manager/CacheContainer.html$$[CacheContainer] ). This common API facilitates an easy migration from local calls to remote calls through Hot Rod: all one needs to do is switch between link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/manager/DefaultCacheManager.html$$[DefaultCacheManager] and link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html$$[RemoteCacheManager] - which is further simplified by the common link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/manager/CacheContainer.html$$[CacheContainer] interface that both inherit.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-VersionedAPI"><a class="anchor" href="#sid-18645172_JavaHotRodclient-VersionedAPI"></a>44.3. Versioned API</h3> <div class="literalblock"> <div class="content"> <pre>A RemoteCacheManager provides instances of link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html$$[RemoteCache] interface that represents a handle to the named or default cache on the remote cluster. API wise, it extends the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html$$[Cache] interface to which it also adds some new methods, including the so called versioned API. Please find below some examples of this API link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737101$$[but to understand the motivation behind it, make sure you read this article] .</pre> </div> </div> <div class="paragraph"> <p>The code snippet bellow depicts the usage of these versioned methods:</p> </div> <div class="listingblock"> <div class="content"> <pre>// To use the versioned API, remote classes are specifically needed
RemoteCacheManager remoteCacheManager = new RemoteCacheManager();
RemoteCache&lt;String, String&gt; cache = remoteCacheManager.getCache();

remoteCache.put("car", "ferrari");
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned("car");

// removal only takes place only if the version has not been changed
// in between. (a new version is associated with 'car' key on each change)
assert remoteCache.remove("car", valueBinary.getVersion());
assert !cache.containsKey("car");
</pre> </div> </div> <div class="paragraph"> <p>In a similar way, for replace:</p> </div> <div class="listingblock"> <div class="content"> <pre>remoteCache.put("car", "ferrari");
RemoteCache.VersionedValue valueBinary = remoteCache.getVersioned("car");
assert remoteCache.replace("car", "lamborghini", valueBinary.getVersion());
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>For more details on versioned operations refer to link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html$$[RemoteCache] 's javadoc.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-AsyncAPI"><a class="anchor" href="#sid-18645172_JavaHotRodclient-AsyncAPI"></a>44.4. Async API</h3> <div class="literalblock"> <div class="content"> <pre>This cool feature is "borrowed" from the Infinispan core and it is largely discussed link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737045$$[here] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Unsupportedmethods"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Unsupportedmethods"></a>44.5. Unsupported methods</h3> <div class="literalblock"> <div class="content"> <pre>Some of the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html$$[Cache] methods are not being supported by the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html$$[RemoteCache] . Calling one of these methods results in an link:$$http://download.oracle.com/javase/6/docs/api/java/lang/UnsupportedOperationException.html$$[UnsupportedOperationException] being thrown. Most of these methods do not make sense on the remote cache (e.g. listener management operations), or correspond to methods that are not supported by local cache as well (e.g. containsValue). Another set of unsupported operations are some of the atomic operations inherited from link:$$http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/ConcurrentMap.html$$[ConcurrentMap] :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>boolean remove(Object key, Object value);
boolean replace(Object key, Object value);
boolean replace(Object key, Object oldValue, Object value);
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html$$[RemoteCache] offers alternative versioned methods for these atomic operations, that are also network friendly, by not sending the whole value object over the network, but a version identifier. See the section on versioned API.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Each one of these unsupported operation is documented in the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html$$[RemoteCache] javadoc.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Returnvalues"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Returnvalues"></a>44.6. Return values</h3> <div class="paragraph"> <p>There is a set of methods that alter an cached entry and return the previous existing value, e.g.:</p> </div> <div class="listingblock"> <div class="content"> <pre>V remove(Object key);
V put(K key, V value);</pre> </div> </div> <div class="paragraph"> <p>By default on RemoteCache, these operations return null even if such a previous value exists. This approach reduces the amount of data sent over the network. However, if these return values are needed they can be enforced on an per invocation basis using flags:</p> </div> <div class="listingblock"> <div class="content"> <pre>cache.put("aKey", "initialValue");
assert null == cache.put("aKey", "aValue");
assert "aValue".equals(cache.withFlags(Flag.FORCE_RETURN_VALUE).put("aKey",
   "newValue"));
</pre> </div> </div> <div class="paragraph"> <p>This default behaviour can can be changed through force-return-value=true configuration parameter (see configuration section bellow).</p> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Intelligence"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Intelligence"></a>44.7. Intelligence</h3> <div class="paragraph"> <p>HotRod defines three level of intelligence for the clients:</p> </div> <div class="ulist"> <ul> <li> <p>basic client, interested in neither cluster nor hash information</p> </li> <li> <p>topology-aware client, interested in cluster information</p> </li> <li> <p>hash-distribution-aware client, that is interested in both cluster and hash information</p> </li> </ul> </div> <div class="paragraph"> <p>The java client supports all 3 levels of intelligence. It is transparently notified whenever a new server is added/removed from the HotRod cluster. At startup it only needs to know the address of one HotRod server (ip:host). On connection to the server the cluster topology is piggybacked to the client, and all further requests are being dispatched to all available servers. Any further topology change is also piggybacked.</p> </div> <div class="paragraph"> <p>Hash-distribution-aware client is discussed in the next section.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Hashdistributionawareclient"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Hashdistributionawareclient"></a>44.8. distribution-aware client</h3> <div class="paragraph"> <p>Another aspect of the 3rd level of intelligence is the fact that it is hash-distribution-aware. This means that, for each operation, the client chooses the most appropriate remote server to go to: the data owner. As an example, for a put(k,v) operation, the client calculates k&#8217;s hash value and knows exactly on which server the data resides on. Then it picks up a tcp connection to that particular server and dispatches the operation to it. This means less burden on the server side which would otherwise need to lookup the value based on the key&#8217;s hash. It also results in a quicker response from the server, as an additional network roundtrip is skipped. This hash-distribution-aware aspect is only relevant to the distributed HotRod clusters and makes no difference for replicated server deployments.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-RequestBalancing"><a class="anchor" href="#sid-18645172_JavaHotRodclient-RequestBalancing"></a>44.9. Request Balancing</h3> <div class="paragraph"> <p>Request balancing is only relevant when the server side is configured with replicated infinispan cluster (on distributed clusters the hash-distribution-aware client logic is used, as discussed in the previos paragraph). Because the client is topology-aware, it knows the list of available servers at all the time. Request balancing has to do with how the client dispatches requests to the available servers.</p> </div> <div class="paragraph"> <p>The default strategy is round-robin: requests are being dispatched to all existing servers in a circular manner. E.g. given a cluster of servers {s1, s2, s3} here is how request will be dispatched:</p> </div> <div class="listingblock"> <div class="content"> <pre>CacheContainer cacheContainer = new RemoteCacheManager();
Cache&lt;String, String&gt; cache = cacheContainer.getCache();

cache.put("key1", "aValue"); //this goes to s1
cache.put("key2", "aValue"); //this goes to s2
String value = cache.get("key1"); //this goes to s3

cache.remove("key2"); //this is dispatched to s1 again, and so on...
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Custom types of balancing policies can defined by implementing the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/impl/transport/tcp/RequestBalancingStrategy.html$$[RequestBalancingStrategy] and by specifying it through the infinispan.client.hotrod.request-balancing-strategy configuration property. Please refer to configuration section for more details on this.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Persistentconnections"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Persistentconnections"></a>44.10. Persistent connections</h3> <div class="paragraph"> <p>In order to avoid creating a TCP connection on each request (which is a costly operation), the client keeps a pool of persistent connections to all the available servers and it reuses these connections whenever it is possible. The validity of the connections is checked using an async thread that iterates over the connections in the pool and sends a HotRod ping command to the server. By using this connection validation process the client is being proactive: there&#8217;s a hight chance for broken connections to be found while being idle in the pool and no on actual request from the application.</p> </div> <div class="literalblock"> <div class="content"> <pre>The number of connections per server, total number of connections, how long should a connection be kept idle in the pool before being closed - all these (and more) can be configured. Please refer to the javadoc of link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html$$[RemoteCacheManager] for a list of all possible configuration elements.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Marshallingdata"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Marshallingdata"></a>44.11. Marshalling data</h3> <div class="paragraph"> <p>The Hot Rod client allows one to plug in a custom marshaller for transforming user objects into byte arrays and the other way around. This transformation is needed because of Hot Rod&#8217;s binary nature - it doesn&#8217;t know about objects.</p> </div> <div class="literalblock"> <div class="content"> <pre>The marshaller can be plugged through the "marshaller" configuration element (see Configuration section): the value should be the fully qualified name of a class implementing the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/marshall/Marshaller.html$$[Marshaller] interface. This is a optional parameter, if not specified it defaults to the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/marshall/jboss/GenericJBossMarshaller.html$$[GenericJBossMarshaller] - a highly optimized implementation based on the link:$$http://www.jboss.org/jbossmarshalling$$[JBoss Marshalling] library.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Since version 5.0, there's a new marshaller available to Java Hot Rod clients based on Apache Avro which generates portable payloads. You can find more information about it &lt;&lt;sid-18645150,here&gt;&gt;</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Statistics"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Statistics"></a>44.12. Statistics</h3> <div class="literalblock"> <div class="content"> <pre>Various server usage statistics can be obtained through the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html$$[RemoteCache] .stats() method. This returns an link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/ServerStatistics.html$$[ServerStatistics] object - please refer to javadoc for details on the available statistics.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Configuration"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Configuration"></a>44.13. Configuration</h3> <div class="literalblock"> <div class="content"> <pre>All the configurations are passed to the RemoteCacheManager's constructor as key-value pairs, through an instance of link:$$http://download.oracle.com/javase/6/docs/api/java/util/Properties.html$$[java.util.Properties] or reference to a .properties file. Please refer to the javadoc of RemoteCacheManager for a exhaustive list of the possible configuration elements.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-MultiGetOperations"><a class="anchor" href="#sid-18645172_JavaHotRodclient-MultiGetOperations"></a>44.14. Multi-Get Operations</h3> <div class="literalblock"> <div class="content"> <pre>The Java Hot Rod client does not provide multi-get functionality out of the box but clients can build it themselves with the given APIs. More information on this topic can be found in the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083$$[Hot Rod protocol article] .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645172_JavaHotRodclient-Moreinfo"><a class="anchor" href="#sid-18645172_JavaHotRodclient-Moreinfo"></a>44.15. More info</h3> <div class="paragraph"> <p>It is highly recommended to read the following Javadocs (this is pretty much all the public API of the client):</p> </div> <div class="ulist"> <ul> <li> <p><a href="http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCacheManager.html">RemoteCacheManager</a></p> </li> <li> <p><a href="http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/client/hotrod/RemoteCache.html">RemoteCache</a></p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645173"><a class="anchor" href="#sid-18645173"></a>45. Configuring cache</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan offers both link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737097$$[Configuring Cache declaratively] and link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737033$$[Configuring cache programmatically] configuration approaches.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Declarative configuration comes in a form of XML document that adheres to a provided Infinispan configuration XML link:$$http://www.infinispan.org/schemas/infinispan-config-4.0.xsd$$[schema] .  Every aspect of Infinispan that can be configured declaratively can also be configured programmatically. In fact, declarative configuration, behind the scenes, invokes programmatic configuration API as the XML configuration file is being processed. One can even use combination of these approaches. For example, you can read static XML configuration files and at runtime programmatically tune that same configuration. Or you can use a certain static configuration defined in XML as a starting point or template for defining additional configurations in runtime.</pre> </div> </div> <div class="paragraph"> <p>There are two main configuration abstractions in Infinispan: global and default configuration.</p> </div> <div class="literalblock"> <div class="content"> <pre>Global cache configuration defines global settings shared among all cache instances created by a single link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/manager/CacheManager.html$$[CacheManager] . Shared resources like thread pools, serialization/marshalling settings, transport and network settings, JMX domains are all part of global configuration.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Default cache configuration is more specific to actual caching domain itself. It specifies eviction, locking, transaction, clustering, cache store settings etc. The default cache can be retrieved via the CacheManager.getCache() API. However, the real power of default cache mechanism comes to light when used in conjuction with _named caches_ . Named caches have the same XML schema as the default cache. Whenever they are specified, named caches inherit settings from the default cache while additional behavior can be specified or overridden. Named caches are retrieved via CacheManager.getCache(String name) API. Therefore, note that the _name_ attribute of named cache is both mandatory and unique for every named cache specified.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Do not forget to refer to Infinispan configuration link:$$http://docs.jboss.org/infinispan/5.1/configdocs$$[reference] for more details.</pre> </div> </div> <div class="paragraph"> <p>For more details, refer to the following documents:</p> </div> <div class="ulist"> <ul> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737097">Configuring Cache declaratively</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737033">Configuring cache programmatically</a></p> </li> <li> <p><a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737098">Configuration Migration Tools</a></p> </li> </ul> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645174"><a class="anchor" href="#sid-18645174"></a>46. Write-Through And Write-Behind Caching</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645174_Write-ThroughAndWrite-BehindCaching-Introduction"><a class="anchor" href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-Introduction"></a>46.1. Introduction</h3> <div class="paragraph"> <p>Infinispan can optionally be configured with one or several cache stores allowing it to store data in a persistent location such as shared JDBC database, a local filesystem&#8230;etc. Infinispan can handle updates to the cache store in two different ways:</p> </div> <div class="ulist"> <ul> <li> <p>Write-Through (Synchronous)</p> </li> <li> <p>Write-Behind (Asynchronous)</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="sid-18645174_Write-ThroughAndWrite-BehindCaching-WriteThrough%28Synchronous%29"><a class="anchor" href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-WriteThrough%28Synchronous%29"></a>46.2. Write-Through (Synchronous)</h3> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, when clients update a cache entry, i.e. via a Cache.put() invocation, the call will not return until Infinispan has gone to the underlying cache store and has updated it. Normally, this means that updates to the cache store are done within the boundaries of the client thread.</p> </div> <div class="paragraph"> <p>The main advantage of this mode is that the cache store is updated at the same time as the cache, hence the cache store is consistent with the cache contents. On the other hand, using this mode reduces performance because the latency of having to access and update the cache store directly impacts the duration of the cache operation.</p> </div> <div class="paragraph"> <p>Configuring a write-through or synchronous cache store does not require any particular configuration option. By default, unless marked explicitly as write-behind or asynchronous, all cache stores are write-through or synchronous. Please find below a sample configuration file of a write-through unshared local file cache store:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;infinispan xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="urn:infinispan:config:5.0"&gt;
  &lt;global /&gt;
  &lt;default /&gt;
  &lt;namedCache name="persistentCache"&gt;
    &lt;loaders shared="false"&gt;
      &lt;loader
          class="org.infinispan.loaders.file.FileCacheStore"
          fetchPersistentState="true" ignoreModifications="false"
          purgeOnStartup="false"&gt;
        &lt;properties&gt;
          &lt;property name="location" value="${java.io.tmpdir}" /&gt;
        &lt;/properties&gt;
      &lt;/loader&gt;
    &lt;/loaders&gt;
  &lt;/namedCache&gt;
&lt;/infinispan&gt;
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645174_Write-ThroughAndWrite-BehindCaching-WriteBehind%28Asynchronous%29"><a class="anchor" href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-WriteBehind%28Asynchronous%29"></a>46.3. Write-Behind (Asynchronous)</h3> <div class="paragraph"> <p>In this mode, updates to the cache are asynchronously written to the cache store. Normally, this means that updates to the cache store are done by a separate thread to the client thread interacting with the cache.</p> </div> <div class="paragraph"> <p>One of the major advantages of this mode is that the performance of a cache operation does not get affected by the update of the underlying store. On the other hand, since the update happens asynchronously, there&#8217;s a time window during the which the cache store can contain stale data compared to the cache. Even within write-behind, there are different strategies that can be used to store data:</p> </div> </div> <div class="sect2"> <h3 id="sid-18645174_Write-ThroughAndWrite-BehindCaching-UnscheduledWriteBehindStrategy"><a class="anchor" href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-UnscheduledWriteBehindStrategy"></a>46.4. Unscheduled Write-Behind Strategy</h3> <div class="paragraph"> <p>In this mode, which is supported in version 4.0, Infinispan tries to store changes as quickly as possible by taking the pending changes and applying them in paralel. Normally, this means that there are several threads waiting for modifications to occur and once they&#8217;re available, they apply them to underlying cache store.</p> </div> <div class="paragraph"> <p>This strategy is suited for cache stores with low latency and cheap operation cost. One such example would a local unshared file based cache store, where the cache store is local to the cache itself. With this strategy, the window of inconsistency between the contents of the cache and the cache store are reduced to the lowest possible time. Please find below a sample configuration file of this strategy:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;infinispan xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="urn:infinispan:config:5.0"&gt;
  &lt;global /&gt;
  &lt;default /&gt;
  &lt;namedCache name="persistentCache"&gt;
    &lt;loaders shared="false"&gt;
      &lt;loader
          class="org.infinispan.loaders.file.FileCacheStore"
          fetchPersistentState="true" ignoreModifications="false"
          purgeOnStartup="false"&gt;
        &lt;properties&gt;
          &lt;property name="location" value="${java.io.tmpdir}" /&gt;
        &lt;/properties&gt;
        &lt;!-- write-behind configuration starts here --&gt;
        &lt;async enabled="true" threadPoolSize="10" /&gt;
        &lt;!-- write-behind configuration ends here --&gt;
      &lt;/loader&gt;
    &lt;/loaders&gt;
  &lt;/namedCache&gt;
&lt;/infinispan&gt;
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645174_Write-ThroughAndWrite-BehindCaching-ScheduledWriteBehindStrategy"><a class="anchor" href="#sid-18645174_Write-ThroughAndWrite-BehindCaching-ScheduledWriteBehindStrategy"></a>46.5. Scheduled Write-Behind Strategy</h3> <div class="literalblock"> <div class="content"> <pre>First of all, please note that this strategy is not included in version 4.0 but it will be implemented at a later stage. link:$$https://jira.jboss.org/jira/browse/ISPN-328$$[ISPN-328] has been created to track this feature request. If you want it implemented, please link:$$https://jira.jboss.org/jira/secure/ViewIssue.jspa?id=12402022&amp;amp;vote=true$$[vote for it] and don't forget to link:$$https://jira.jboss.org/jira/secure/ViewIssue.jspa?id=12402022&amp;amp;watch=true$$[watch it] to be notified of any changes. The following explanation refers to how we envision it to work.</pre> </div> </div> <div class="paragraph"> <p>In this mode, Infinispan would periodically store changes to the underlying cache store. The periodicity could be defined in seconds, minutes, days&#8230;etc.</p> </div> <div class="paragraph"> <p>Since this strategy is oriented at cache stores with high latency or expensive operation cost, it makes sense to coalesce changes, so that if there are multiple operations queued on the same key, only the latest value is applied to cache store. With this strategy, the window of inconsistency between the contents of the cache and the cache store depends on the delay or periodicity configured. The higher the periodicity, the higher the chance of inconsistency.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645175"><a class="anchor" href="#sid-18645175"></a>47. Using Hot Rod Server</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645175_UsingHotRodServer-Introduction"><a class="anchor" href="#sid-18645175_UsingHotRodServer-Introduction"></a>47.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Starting with version 4.1, Infinispan distribution contains a server module that implements link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083$$[Infinispan's custom binary protocol called Hot Rod] . The protocol was designed to enable faster client/server interactions compared to other existing text based protocols and to allow clients to make more intelligent decisions with regards to load balancing, failover and even data location operations.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645175_UsingHotRodServer-StartinganInfinispanHotRodserver"><a class="anchor" href="#sid-18645175_UsingHotRodServer-StartinganInfinispanHotRodserver"></a>47.2. Starting an Infinispan Hot Rod server</h3> <div class="paragraph"> <p>The simplest way to start up  Hot Rod  server is to simply unzip the all distribution and either run the startServer.bat or startServer.sh script passing <em>hotrod</em> as the protocol to run. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>[g@eq]~/infinispan-4.1.0-SNAPSHOT% ./bin/startServer.sh -r hotrod</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>When the script is called without any further parameters, the started Hot Rod server bounds to port 11222 (Infinispan 4.2.0.BETA1 or earlier listened on port 11311 by default) on localhost (127.0.0.1). If no further parameters is given at startup, this means that any cache instance queried will be based on the default cache instance which will be a local (unclustered) Infinispan cache instance configured with default values. Please visit the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/config.html$$[Configuration Reference Guide] for more information on these values. If you want to use non-default values, please check the next section on command line options.</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645175_UsingHotRodServer-CommandLineOptions"><a class="anchor" href="#sid-18645175_UsingHotRodServer-CommandLineOptions"></a>47.2.1. Command Line Options</h4> <div class="literalblock"> <div class="content"> <pre>You can optionally pass a set of parameters to the Hot Rod server that allow you to configure different parts of the server. You can find detailed information in the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737161$$[server command line options article] .</pre> </div> </div> <div class="paragraph"> <p>So, following the discussion earlier on configuring a Hot Rod server with a custom Infinispan configuration, you&#8217;d use -c parameter to pass the corresponding file. Hot Rod clients could then send requests to specific cache instances whose name match one of the names in the custom configuration file.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645175_UsingHotRodServer-PredefiningHotRodCaches"><a class="anchor" href="#sid-18645175_UsingHotRodServer-PredefiningHotRodCaches"></a>47.2.2. Predefining Hot Rod Caches</h4> <div class="paragraph"> <p>In order to provide a more consistent experience when interacting with Hot Rod servers and avoid issues related to lazily started cache instances, on startup, Hot Rod server starts all defined caches in the Infinispan configuration file including the default cache. If no configuration file was provided, only the default cache will be started. Any request to an undefined cache will be rejected by the server.</p> </div> <div class="literalblock"> <div class="content"> <pre>So, as user, this means that any caches you interact with must be defined in the Infinispan configuration file by providing a namedCache XML element entry for each of them. Besides, as explained the 'Cache Name' section of the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083$$[Hot Rod protocol] , you can also interact with the default cache by passing an empty cache name.</pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645176"><a class="anchor" href="#sid-18645176"></a>48. Cassandra CacheStore</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan's CassandraCacheStore leverages link:$$http://cassandra.apache.org/$$[Apache Cassandra] 's distributed database architecture to provide a virtually unlimited, horizontally scalable persistent store for Infinispan's caches.</pre> </div> </div> <div class="sect2"> <h3 id="sid-18645176_CassandraCacheStore-Version"><a class="anchor" href="#sid-18645176_CassandraCacheStore-Version"></a>48.1. Version</h3> <div class="paragraph"> <p>The Cassandra CacheStore was added in Infinspan 4.2.0 "Ursus". You&#8217;ll need this release or later in order to use it.</p> </div> <div id="sid-18645176_CassandraCacheStore-" class="paragraph"> <p>===</p> </div> <div class="paragraph"> <p>Configuration</p> </div> <div class="paragraph"> <p>In order to use this CacheStore you need to create an appropriate  keyspace on your Cassandra database. The following storage-conf.xml  excerpt shows the declaration of the keyspace:</p> </div> <div class="listingblock"> <div class="content"> <pre>{code:xml}&lt;Keyspace Name="Infinispan"&gt;
&lt;ColumnFamily CompareWith="BytesType" Name="InfinispanEntries" KeysCached="10%" /&gt;
      &lt;ColumnFamily CompareWith="LongType" Name="InfinispanExpiration" KeysCached="10%" ColumnType="Super" CompareSubcolumnsWith="BytesType"/&gt;
      &lt;ColumnFamily CompareWith="BytesType" Name="InfinispanEntries" KeysCached="0" /&gt;
      &lt;ColumnFamily CompareWith="LongType" Name="InfinispanExpiration" KeysCached="0" ColumnType="Super" CompareSubcolumnsWith="BytesType"/&gt;
      &lt;ReplicaPlacementStrategy&gt;org.apache.cassandra.locator.RackUnawareStrategy&lt;/ReplicaPlacementStrategy&gt;
      &lt;ReplicationFactor&gt;2&lt;/ReplicationFactor&gt;
      &lt;EndPointSnitch&gt;org.apache.cassandra.locator.EndPointSnitch&lt;/EndPointSnitch&gt;

&lt;/Keyspace&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;p&gt;&lt;/p&gt;&lt;p&gt;The important bits are the CompareWith, ColumnType and CompareSubColumnsWith declarations. Everything else can be changed at will. You can also have more than one Keyspace to accomodate for multiple caches.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;You then need to add an appropriate cache declaration to your infinispan.xml (or whichever file you use to configure Infinispan):&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;namedCache name="cassandraCache"&gt;
        &lt;loaders passivation="false" shared="true" preload="false"&gt;
                &lt;loader
                        class="org.infinispan.loaders.cassandra.CassandraCacheStore"
                        fetchPersistentState="true" ignoreModifications="false"
                        purgeOnStartup="false"&gt;
                        &lt;properties&gt;
                                &lt;property name="host" value="localhost" /&gt;
                                &lt;property name="keySpace" value="Infinispan" /&gt;
                                &lt;property name="entryColumnFamily" value="InfinispanEntries" /&gt;
                                &lt;property name="expirationColumnFamily" value="InfinispanExpiration" /&gt;
                                &lt;property name="sharedKeyspace" value="false" /&gt;
                                &lt;property name="readConsistencyLevel" value="ONE" /&gt;
                                &lt;property name="writeConsistencyLevel" value="ONE" /&gt;
                                &lt;property name="configurationPropertiesFile" value="cassandrapool.properties" /&gt;         
                                &lt;property name="keyMapper" value="org.infinispan.loaders.keymappers.DefaultTwoWayKey2StringMapper" /&gt;


                        &lt;/properties&gt;



                &lt;/loader&gt;



        &lt;/loaders&gt;



&lt;/namedCache&gt;</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;It is important the the shared property on the loader element is set to true because all the Infinispan nodes will share the same Cassandra cluster.&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;Since the Cassandra client library doesn't provide connection pooling, a separate project has been created at &lt;a class="active_link" href="http://github.com/tristantarrant/cassandra-connection-pool"&gt;http://github.com/tristantarrant/cassandra-connection-pool&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;Configuration of the connection pool can be done by creating an appropriate properties file and specifying its name in the configuration (&lt;strong&gt;configurationPropertiesFile&lt;/strong&gt;).&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;The following is an example file:&lt;/p&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>socketTimeout = 5000 initialSize = 10 maxActive = 100 maxIdle = 20 minIdle = 10 maxWait = 30000testOnBorrow = false testOnReturn = false testWhileIdle = false timeBetweenEvictionRunsMillis = 5000removeAbandoned = false removeAbandonedTimeout = 60 logAbandoned = false {code} Here is a description of the various properties which can be configured: _Header 1_ _Header 2_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">host</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">a hostname (or a comma-separated list of hostnames)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the thrift port (usually 9160)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">keySpace</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the keyspace to use (defaults to Infinispan)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">entryColumnFamily</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the column family where entry values will be stored. Make sure you configure your keyspace accordingly (defaults to InfinispanEntries)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">expirationColumnFamily</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">the column family where element expiration information is stored. Make sure your  (defaults to InfinispanExpiration)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">sharedKeyspace</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">whether multiple caches are to be stored in a single keyspace. In this case the cache name is prefixed to the key entries (defaults to false).</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">readConsistencyLevel</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The consistency level to use when reading from Cassandra. Possible values are ONE, QUORUM, DCQUORUM, ALL. For an explanation of these refer to the <a href="http://wiki.apache.org/cassandra/API">Cassandra API documentation.</a> (defaults to ONE)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">writeConsistencyLevel</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The consistency level to use when writing to Cassandra. Possible values are ZERO, ANY, ONE, QUORUM, DCQUORUM, ALL. For an explanation of these refer to the <a href="http://wiki.apache.org/cassandra/API">Cassandra API documentation.</a> (defaults to ONE)</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">keyMapper</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">A class which implements Infinispan&#8217;s TwoWayKey2StringMapper interface for mapping cache keys to Cassandra row keys (defaults to org.infinispan.loaders.keymappers.DefaultTwoWayKey2StringMapper)</p></td> </tr> </tbody> </table> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645177"><a class="anchor" href="#sid-18645177"></a>49. Infinispan Custom Interceptors</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645177_InfinispanCustomInterceptors-Introduction"><a class="anchor" href="#sid-18645177_InfinispanCustomInterceptors-Introduction"></a>49.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>It is possible to add custom interceptors to Infinispan, both declaratively and programatically. Custom interceptors are an way of extending Infinispan by being able to influence or respond to any modifications to cache. Example of such modifications are: elements are added/removed/updated or transactions are committed. For a detailed list refer to link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/interceptors/base/CommandInterceptor.html$$[CommandInterceptor] API.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645177_InfinispanCustomInterceptors-Addingcustominterceptorsdeclaratively"><a class="anchor" href="#sid-18645177_InfinispanCustomInterceptors-Addingcustominterceptorsdeclaratively"></a>49.2. Adding custom interceptors declaratively</h3> <div class="paragraph"> <p>Custom interceptors can be added on a per named cache basis. This is because each named cache have it&#8217;s own interceptor stack. Following xml snippet depicts the ways in which an custom interceptor can be added.</p> </div> <div class="listingblock"> <div class="content"> <pre>   &lt;namedCache name="cacheWithCustomInterceptors"&gt;
      &lt;!--
      Define custom interceptors.  All custom interceptors need to extend org.jboss.cache.interceptors.base.CommandInterceptor
      --&gt;
      &lt;customInterceptors&gt;
         &lt;interceptor position="FIRST" class="com.mycompany.CustomInterceptor1"&gt;
            &lt;properties&gt;
               &lt;property name="attributeOne" value="value1" /&gt;
               &lt;property name="attributeTwo" value="value2" /&gt;
            &lt;/properties&gt;
         &lt;/interceptor&gt;
         &lt;interceptor position="LAST" class="com.mycompany.CustomInterceptor2"/&gt;
         &lt;interceptor index="3" class="com.mycompany.CustomInterceptor1"/&gt;
         &lt;interceptor before="org.infinispanpan.interceptors.CallInterceptor" class="com.mycompany.CustomInterceptor2"/&gt;
         &lt;interceptor after="org.infinispanpan.interceptors.CallInterceptor" class="com.mycompany.CustomInterceptor1"/&gt;
      &lt;/customInterceptors&gt;
   &lt;/namedCache&gt;

</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Adding custom interceptors programatically_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In order to do that one needs to obtain a reference to the link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/AdvancedCache.html$$[AdvancedCache] . This can be done ass follows:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>CacheManager cm = getCacheManager();//magic
Cache aCache = cm.getCache("aName");
AdvancedCache advCache = aCache.getAdvancedCache();
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Then one of the _addInterceptor()_ methods should be used to add the actual interceptor. For further documentation refer to link:$$http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/AdvancedCache.html$$[AdvancedCache] javadoc.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645177_InfinispanCustomInterceptors-Custominterceptordesign"><a class="anchor" href="#sid-18645177_InfinispanCustomInterceptors-Custominterceptordesign"></a>49.3. Custom interceptor design</h3> <div class="ulist"> <ul> <li> <p>Custom interceptors must extend <a href="http://infinispan.sourceforge.net/4.0/apidocs/org/infinispan/interceptors/base/CommandInterceptor.html">CommandInterceptor</a></p> </li> <li> <p>Custom interceptors must declare a public, empty constructor to enable construction.</p> </li> <li> <p>Custom  interceptors will have setters for any property defined through property tag.</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645178"><a class="anchor" href="#sid-18645178"></a>50. Talking To Infinispan Memcached Servers From Non-Java Clients</h2> <div class="sectionbody"> <div class="paragraph"> <p>This wiki shows how to talk to Infinispan memcached server via non-java client, such as a python script.</p> </div> <div class="sect2"> <h3 id="sid-18645178_TalkingToInfinispanMemcachedServersFromNon-JavaClients-MultiClusteredServerTutorial"><a class="anchor" href="#sid-18645178_TalkingToInfinispanMemcachedServersFromNon-JavaClients-MultiClusteredServerTutorial"></a>50.1. Multi Clustered Server Tutorial</h3> <div class="paragraph"> <p>The second example showcases the distribution capabilities of Infinispan memcached severs that are not available in the original memcached implementation.</p> </div> <div class="ulist"> <ul> <li> <p>Start first Infinispan memcached server giving to it a port number and an Infinispan configuration supporting distribution. This configuration is the same one used for the GUI demo:</p> </li> </ul> </div> <div class="paragraph"> <p>*</p> </div> <div class="listingblock"> <div class="content"> <pre>./bin/startServer.sh -r memcached -c etc/config-samples/gui-demo-cache-config.xml -p 12211</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Start a second Infinispan memcached server passing to it a different port number:</p> </li> </ul> </div> <div class="paragraph"> <p>*</p> </div> <div class="listingblock"> <div class="content"> <pre>./bin/startServer.sh -r memcached -c etc/config-samples/gui-demo-cache-config.xml -p 13211</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Execute <a href="http://anonsvn.jboss.org/repos/infinispan/branches/4.1.x/server/memcached/src/test/resources/test_memcached_read.py">test_memcached_write.py</a> script which basically executes several write operations againts the Infinispan memcached server bound to port 12211. If the script is executed successfully, you should see an output similar to this:</p> </li> </ul> </div> <div class="paragraph"> <p>*</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;li&gt;Connecting to 127.0.0.1:12211&lt;/li&gt;&lt;li&gt;Testing set ['Simple_Key': Simple value] ... OK&lt;/li&gt;&lt;li&gt;Testing set ['Expiring_Key' : 999 : 3] ... OK&lt;/li&gt;&lt;li&gt;Testing increment 3 times ['Incr_Key' : starting at 1 ]&lt;/li&gt;&lt;li&gt;Initialise at 1 ... OK&lt;/li&gt;&lt;li&gt;Increment by one ... OK&lt;/li&gt;&lt;li&gt;Increment again ... OK&lt;/li&gt;&lt;li&gt;Increment yet again ... OK&lt;/li&gt;&lt;li&gt;Testing decrement 1 time ['Decr_Key' : starting at 4 ]&lt;/li&gt;&lt;li&gt;Initialise at 4 ... OK&lt;/li&gt;&lt;li&gt;Decrement by one ... OK&lt;/li&gt;&lt;li&gt;Testing decrement 2 times in one call ['Multi_Decr_Key' : 3 ]&lt;/li&gt;&lt;li&gt;Initialise at 3 ... OK&lt;/li&gt;&lt;li&gt;Decrement by 2 ... OK&lt;/li&gt;</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Execute <a href="http://anonsvn.jboss.org/repos/infinispan/branches/4.1.x/server/memcached/src/test/resources/test_memcached_read.py">test_memcached_read.py</a> script which connects to server bound to 127.0.0.1:13211 and verifies that it can read the data that was written by the writer script to the first server. If the script is executed successfully, you should see an output similar to this:</p> </li> </ul> </div> <div class="paragraph"> <p>*</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;li&gt;Connecting to 127.0.0.1:13211&lt;/li&gt;&lt;li&gt;Testing get ['Simple_Key'] should return Simple value ... OK&lt;/li&gt;&lt;li&gt;Testing get ['Expiring_Key'] should return nothing... OK&lt;/li&gt;&lt;li&gt;Testing get ['Incr_Key'] should return 4 ... OK&lt;/li&gt;&lt;li&gt;Testing get ['Decr_Key'] should return 3 ... OK&lt;/li&gt;&lt;li&gt;Testing get ['Multi_Decr_Key'] should return 1 ... OK&lt;/li&gt;</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645179"><a class="anchor" href="#sid-18645179"></a>51. Plugging Infinispan With User Defined Externalizers</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-Introduction"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-Introduction"></a>51.1. Introduction</h3> <div class="paragraph"> <p>One of the key aspects of Infinispan is that it often needs to marshall/unmarshall objects in order to provide some of its functionality. For example, if it needs to store objects in a write-through or write-behind cache store, the stored objects need marshalling. If a cluster of Infinispan nodes is formed, objects shipped around need marshalling. Even if you enable lazy deserialization, objects need to be marshalled so that they can be lazily unmarshalled with the correct classloader.</p> </div> <div class="literalblock"> <div class="content"> <pre>Using standard JDK serialization is slow and produces payloads that are too big and can affect bandwidth usage. On top of that, JDK serialization does not work well with objects that are supposed to be immutable. In order to avoid these issues, Infinispan uses link:$$http://jboss.org/jbossmarshalling$$[JBoss Marshalling] for marshalling/unmarshalling objects. JBoss Marshalling is fast, produces very space efficient payloads, and on top of that  during unmarshalling, it enables users to have full control over how to construct objects, hence allowing objects to carry on being immutable.</pre> </div> </div> <div class="paragraph"> <p>Starting with 5.0, users of Infinispan can now benefit from this marshalling framework as well, and they can provide their own externalizer implementations, but before finding out how to provide externalizers, let&#8217;s look at the benefits they bring.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-BenefitsofExternalizers"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-BenefitsofExternalizers"></a>51.2. Benefits of Externalizers</h3> <div class="literalblock"> <div class="content"> <pre>The JDK provides a simple way to serialize objects which, in its simplest form, is just a matter of extending link:$$http://download.oracle.com/javase/6/docs/api/java/io/Serializable.html$$[java.io.Serializable] , but as it's well known, this is known to be slow and it generates payloads that are far too big. An alternative way to do serialization, still relying on JDK serialization, is for your objects to extend link:$$http://download.oracle.com/javase/6/docs/api/java/io/Externalizable.html$$[java.io.Externalizable] . This allows for users to provide their own ways to marshall/unmarshall classes, but has some serious issues because, on top of relying on slow JDK serialization, it forces the class that you want to serialize to extend this interface, which has two side effects: The first is that you're forced to modify the source code of the class that you want to marshall/unmarshall which you might not be able to do because you either, don't own the source, or you don't even have it. Secondly, since Externalizable implementations do not control object creation, you're forced to add set methods in order to restore the state, hence potentially forcing your immutable objects to become mutable.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Instead of relying on JDK serialization, Infinispan uses JBoss Marshalling to serialize objects and requires any classes to be serialized to be associated with an link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/marshall/Externalizer.html$$[Externalizer] interface implementation that knows how to transform an object of a particular class into a serialized form and how to read an object of that class from a given input. Infinispan does not force the objects to be serialized to implement Externalizer. In fact, it is recommended that a separate class is used to implement the Externalizer interface because, contrary to JDK serialization, Externalizer implementations control how objects of a particular class are created when trying to read an object from a stream. This means that readObject() implementations are responsible of creating object instances of the target class, hence giving users a lot of flexibility on how to create these instances (whether direct instantiation, via factory or reflection), and more importantly, allows target classes to carry on being immutable. This type of externalizer architecture promotes good OOP designs principles, such as the principle of link:$$http://en.wikipedia.org/wiki/Single_responsibility_principle$$[single responsibility] .</pre> </div> </div> <div class="paragraph"> <p>It&#8217;s quite common, and in general recommended, that Externalizer implementations are stored as inner static public classes within classes that they externalize. The advantages of doing this is that related code stays together, making it easier to maintain. In Infinispan, there are two ways in which Infinispan can be plugged with user defined externalizers:</p> </div> <div class="sect3"> <h4 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-UserFriendlyExternalizers"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-UserFriendlyExternalizers"></a>51.2.1. User Friendly Externalizers</h4> <div class="literalblock"> <div class="content"> <pre>In the simplest possible form, users just need to provide an link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/marshall/Externalizer.html$$[Externalizer] implementation for the type that they want to marshall/unmarshall, and then annotate the marshalled type class with {@link SerializeWith} annotation indicating the externalizer class to use. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.marshall.Externalizer;
import org.infinispan.marshall.SerializeWith;

@SerializeWith(Person.PersonExternalizer.class)
public class Person {

   final String name;
   final int age;

   public Person(String name, int age) {
      this.name = name;
      this.age = age;
   }

   public static class PersonExternalizer implements Externalizer&lt;Person&gt; {
      @Override
      public void writeObject(ObjectOutput output, Person person)
            throws IOException {
         output.writeObject(person.name);
         output.writeInt(person.age);
      }

      @Override
      public Person readObject(ObjectInput input)
            throws IOException, ClassNotFoundException {
         return new Person((String) input.readObject(), input.readInt());
      }
   }
}
</pre> </div> </div> <div class="paragraph"> <p>At runtime JBoss Marshalling will inspect the object and discover that&#8217;s marshallable thanks to the annotation and so marshall it using the externalizer class passed. To make externalizer implementations easier to code and more typesafe, make sure you define type &lt;T&gt; as the type of object that&#8217;s being marshalled/unmarshalled.</p> </div> <div class="paragraph"> <p>Even though this way of defining externalizers is very user friendly, it has some disadvantages:</p> </div> <div class="ulist"> <ul> <li> <p>Due to several constraints of the model, such as support different versions of the same class or the need to marshall the Externalizer class, the payload sizes generated via this method are not the most efficient.</p> </li> <li> <p>This model requires for the marshalled class to be annotated with {@link SerializeWith} but a user might need to provide an Externalizer for a class for which source code is not available, or for any other constraints, it cannot be modified.</p> </li> <li> <p>The use of annotations by this model might be limiting for framework developers or service providers that try to abstract lower level details, such as the marshalling layer, away from the user.</p> </li> </ul> </div> <div class="paragraph"> <p>If you&#8217;re affected by any of these disadvantages, an alternative method to provide externalizers is available via more advanced externalizers:</p> </div> </div> <div class="sect3"> <h4 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-AdvancedExternalizers"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-AdvancedExternalizers"></a>51.2.2. Advanced Externalizers</h4> <div class="literalblock"> <div class="content"> <pre>link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/marshall/AdvancedExternalizer.html$$[AdvancedExternalizer] provides an alternative way to provide externalizers for marshalling/unmarshalling user defined classes that overcome the deficiencies of the more user-friendly externalizer definition model explained in Externalizer. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.marshall.AdvancedExternalizer;

public class Person {

   final String name;
   final int age;

   public Person(String name, int age) {
      this.name = name;
      this.age = age;
   }

   public static class PersonExternalizer implements AdvancedExternalizer&lt;Person&gt; {
      @Override
      public void writeObject(ObjectOutput output, Person person)
            throws IOException {
         output.writeObject(person.name);
         output.writeInt(person.age);
      }

      @Override
      public Person readObject(ObjectInput input)
            throws IOException, ClassNotFoundException {
         return new Person((String) input.readObject(), input.readInt());
      }

      @Override
      public Set&lt;Class&lt;? extends Person&gt;&gt; getTypeClasses() {
         return Util.&lt;Class&lt;? extends Person&gt;&gt;asSet(Person.class);
      }

      @Override
      public Integer getId() {
         return 2345;
      }
   }
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The first noticeable difference is that this method does not require user classes to be annotated in anyway, so it can be used with classes for which source code is not available or that cannot be modified. The bound between the externalizer and the classes that are marshalled/unmarshalled is set by providing an implementation for link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/marshall/AdvancedExternalizer.html#getTypeClasses()$$[getTypeClasses()] which should return the list of classes that this externalizer can marshall:</pre> </div> </div> <div class="sect4"> <h5 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-LinkingExternalizerswithMarshallerClasses"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-LinkingExternalizerswithMarshallerClasses"></a>Linking Externalizers with Marshaller Classes</h5> <div class="paragraph"> <p>Once the Externalizer&#8217;s readObject() and writeObject() methods have been implemented, it&#8217;s time to link them up together with the type classes that they externalize. To do so, the Externalizer implementation must provide a getTypeClasses() implementation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.util.Util;
...
@Override
public Set&lt;Class&lt;? extends ReplicableCommand&gt;&gt; getTypeClasses() {
  return Util.asSet(LockControlCommand.class, RehashControlCommand.class,
      StateTransferControlCommand.class, GetKeyValueCommand.class,
      ClusteredGetCommand.class, MultipleRpcCommand.class,
      SingleRpcCommand.class, CommitCommand.class,
      PrepareCommand.class, RollbackCommand.class,
      ClearCommand.class, EvictCommand.class,
      InvalidateCommand.class, InvalidateL1Command.class,
      PutKeyValueCommand.class, PutMapCommand.class,
      RemoveCommand.class, ReplaceCommand.class);
}
</pre> </div> </div> <div class="paragraph"> <p>In the code above, ReplicableCommandExternalizer indicates that it can externalize several type of commands. In fact, it marshalls all commands that extend ReplicableCommand interface, but currently the framework only supports class equality comparison and so, it&#8217;s not possible to indicate that the classes to marshalled are all children of a particular class/interface.</p> </div> <div class="paragraph"> <p>However there might sometimes when the classes to be externalized are private and hence it&#8217;s not possible to reference the actual class instance. In this situations, users can attempt to look up the class with the given fully qualified class name and pass that back. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>@Override
public Set&lt;Class&lt;? extends List&gt;&gt; getTypeClasses() {
  return Util.&lt;Class&lt;? extends List&gt;&gt;asSet(
         Util.loadClass("java.util.Collections$SingletonList"));
}
</pre> </div> </div> </div> <div class="sect4"> <h5 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-ExternalizerIdentifier"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-ExternalizerIdentifier"></a>Externalizer Identifier</h5> <div class="literalblock"> <div class="content"> <pre>Secondly, in order to save the maximum amount of space possible in the payloads generated, advanced externalizers require externalizer implementations to provide a positive identified via link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/marshall/AdvancedExternalizer.html#getId()$$[getId()] implementations or via XML/programmatic configuration that identifies the externalizer when unmarshalling a payload.  In order for this to work however, advanced externalizers require externalizers to be registered on cache manager creation time via XML or programmatic configuration which will be explained in next section. On the contrary, externalizers based on Externalizer and SerializeWith require no pre-registration whatsoever. Internally, Infinispan uses this advanced externalizer mechanism in order to marshall/unmarshall internal classes.</pre> </div> </div> <div class="paragraph"> <p>So, getId() should return a positive integer that allows the externalizer to be identified at read time to figure out which Externalizer should read the contents of the incoming buffer, or it can return null. If getId() returns null, it is indicating that the id of this advanced externalizer will be defined via XML/programmatic configuration, which will be explained in next section.</p> </div> <div class="paragraph"> <p>Regardless of the source of the the id, using a positive integer allows for very efficient variable length encoding of numbers, and it&#8217;s much more efficient than shipping externalizer implementation class information or class name around. Infinispan users can use any positive integer as long as it does not clash with any other identifier in the system. It&#8217;s important to understand that a user defined externalizer can even use the same numbers as the externalizers in the Infinispan Core project because the internal Infinispan Core externalizers are special and they use a different number space to the user defined externalizers. On the contrary, users should avoid using numbers that are within the pre-assigned identifier ranges which can be found at the end of this article. Infinispan checks for id duplicates on startup, and if any are found, startup is halted with an error.</p> </div> <div class="paragraph"> <p>When it comes to maintaining which ids are in use, it&#8217;s highly recommended that this is done in a centralized way. For example, getId() implementations could reference a set of statically defined identifiers in a separate class or interface. Such class/interface would give a global view of the identifiers in use and so can make it easier to assign new ids.</p> </div> </div> <div class="sect4"> <h5 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-RegisteringAdvancedExternalizers"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-RegisteringAdvancedExternalizers"></a>Registering Advanced Externalizers</h5> <div class="paragraph"> <p>The following example shows the type of configuration required to register an advanced externalizer implementation for Person object shown earlier stored as a static inner class within it:</p> </div> <div class="paragraph"> <p>XML:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;infinispan&gt;
  &lt;global&gt;
    &lt;serialization&gt;
      &lt;advancedExternalizers&gt;
        &lt;advancedExternalizer externalizerClass="Person$PersonExternalizer"/&gt;
      &lt;/advancedExternalizers&gt;
    &lt;/serialization&gt;
  &lt;/global&gt;
  ...
&lt;/infinispan&gt;
</pre> </div> </div> <div class="paragraph"> <p>Programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfigurationBuilder builder = ...
builder.serialization()
   .addAdvancedExternalizer(new Person.PersonExternalizer());
</pre> </div> </div> <div class="paragraph"> <p>As mentioned earlier, when listing these externalizer implementations, users can optionally provide the identifier of the externalizer via XML or programmatically instead of via getId() implementation. Again, this offers a centralized way to maintain the identifiers but it&#8217;s important that the rules are clear: An AdvancedExternalizer implementation, either via XML/programmatic configuration or via annotation, needs to be associated with an identifier. If it isn&#8217;t, Infinispan will throw an error and abort startup. If a particular AdvancedExternalizer implementation defines an id both via XML/programmatic configuration and annotation, the value defined via XML/programmatically is the one that will be used. Here&#8217;s an example of an externalizer whose id is defined at registration time:</p> </div> <div class="listingblock"> <div class="content"> <pre>&lt;infinispan&gt;
  &lt;global&gt;
    &lt;serialization&gt;
      &lt;advancedExternalizers&gt;
        &lt;advancedExternalizer id="123"
                              externalizerClass="Person$PersonExternalizer"/&gt;
      &lt;/advancedExternalizers&gt;
    &lt;/serialization&gt;
  &lt;/global&gt;
  ...
&lt;/infinispan&gt;
</pre> </div> </div> <div class="paragraph"> <p>Programmatically:</p> </div> <div class="listingblock"> <div class="content"> <pre>GlobalConfigurationBuilder builder = ...
builder.serialization()
   .addAdvancedExternalizer(123, new Person.PersonExternalizer());
</pre> </div> </div> <div class="paragraph"> <p>Finally, a couple of notes about the programmatic configuration. GlobalConfiguration.addExternalizer() takes varargs, so it means that it is possible to register multiple externalizers in just one go, assuming that their ids have already been defined via @Marshalls annotation. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre>builder.serialization()
   .addAdvancedExternalizer(new Person.PersonExternalizer(),
                            new Address.AddressExternalizer());
</pre> </div> </div> </div> <div class="sect4"> <h5 id="sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-PreassignedExternalizerIdRanges"><a class="anchor" href="#sid-18645179_PluggingInfinispanWithUserDefinedExternalizers-PreassignedExternalizerIdRanges"></a>Preassigned Externalizer Id Ranges</h5> <div class="paragraph"> <p>This is the list of Externalizer identifiers that are used by Infinispan based modules or frameworks. Infinispan users should avoid using ids within these ranges. (RANGES to be finalised yet!)</p> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Tree Module:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1000 - 1099</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Server Modules:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1100 - 1199</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Infinispan Second Level Cache:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1200 - 1299</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Infinispan Lucene Directory:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1300 - 1399</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate OGM:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1400 - 1499</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hibernate Search:</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">1500 - 1599</p></td> </tr> </tbody> </table> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645180"><a class="anchor" href="#sid-18645180"></a>52. Using the Cache API</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645180_UsingtheCacheAPI-TheCacheinterface"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-TheCacheinterface"></a>52.1. The Cache interface</h3> <div class="literalblock"> <div class="content"> <pre>Infinispan exposes a simple, link:$$http://jcp.org/en/jsr/detail?id=107$$[JSR-107] compliant link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html$$[Cache] interface.</pre> </div> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>The Cache interface exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface.  Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p> </div> <div class="listingblock"> <div class="content"> <pre>Note: For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan's Cache should be trivial.
</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645180_UsingtheCacheAPI-LimitationsofCertainMapMethods"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-LimitationsofCertainMapMethods"></a>52.1.1. Limitations of Certain Map Methods</h4> <div class="literalblock"> <div class="content"> <pre>Certain methods exposed in Map have certain limitations when used with Infinispan, such as link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#size%28%29$$[size()] , link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#values%28%29$$[values()] , link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#keySet%28%29$$[keySet()] and link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#entrySet%28%29$$[entrySet()] .  Specifically, these methods are _unreliable_ and only provide a best-effort guess.  They do not acquire locks, either local or global, and concurrent modifications, additions and removals will not be considered in the result of any of these calls.  Further, they only operate on the local data container, and as such, do not give you a global view of state.</pre> </div> </div> <div class="paragraph"> <p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck.  As such, these methods should only be used for informational or debugging purposes only.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645180_UsingtheCacheAPI-MortalandImmortalData"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-MortalandImmortalData"></a>52.1.2. Mortal and Immortal Data</h4> <div class="literalblock"> <div class="content"> <pre>Further to simply storing entries, Infinispan's cache API allows you to attach mortality information to data.  For example, simply using link:$$http://java.sun.com/javase/6/docs/api/java/util/Map.html#put%28K,%20V%29$$[put(key, value)] would create an _immortal_ entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory).  If, however, you put data in the cache using link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html#put%28K,%20V,%20long,%20java.util.concurrent.TimeUnit%29$$[put(key, value, lifespan, timeunit)] , this creates a _mortal_ entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In addition to _lifespan_ , Infinispan also supports _maxIdle_ as an additional metric with which to determine expiration.  Any combination of lifespans or maxIdles can be used.</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645180_UsingtheCacheAPI-ExampleofUsingExpiryandMortalData"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-ExampleofUsingExpiryandMortalData"></a>52.1.3. Example of Using Expiry and Mortal Data</h4> <div class="literalblock"> <div class="content"> <pre>See link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737114$$[this page] for an example of using mortal data with Infinispan</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645180_UsingtheCacheAPI-%7B%7BputForExternalRead%7D%7Doperation"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-%7B%7BputForExternalRead%7D%7Doperation"></a>52.1.4. putForExternalRead operation</h4> <div class="literalblock"> <div class="content"> <pre>Infinispan's link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/Cache.html$$[Cache] class contains a peculiar 'put' operation called link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)$$[putForExternalRead] . This operation is particularly useful when Infinispan is used as cache to store data that's frequently read, which originates in another data store. The aim of this operation is to deal with concurrent storage of data, which originates in the data store, in the cache in the most efficient way. To achieve this, putForExternalRead is used as a put operation that is fast, only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>To understand how to use this operation, let's look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)$$[putForExternalRead] within the context of this example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
// Id of the person to look up, provided by the application
PersonId id = ...;

// Get a reference to the cache where person instances will be stored
Cache&lt;PersonId, Person&gt; cache = ...;

// First, check whether the cache contains the person instance
// associated with with the given id
Person cachedPerson = cache.get(id);

if (cachedPerson == null) {
   // The person is not cached yet, so query the data store with the id
   Person person = dataStore.lookup(id);

   // Cache the person along with the id so that future requests can
   // retrieve it from memory rather than going to the data store
   cache.putForExternalRead(id, person);
} else {
   // The person was found in the cache, so return it to the application
   return cachedPerson;
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Please note that link:$$http://docs.jboss.org/infinispan/5.1/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)$$[putForExternalRead] should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person's address). When updating cached values, please use the standard link:$$http://java.sun.com/javase/6/docs/api/java/util/Map.html?is-external=true#put(K, V)$$[put] operation, otherwise the possibility of caching corrupt data is likely.</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645180_UsingtheCacheAPI-TheAdvancedCacheinterface"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-TheAdvancedCacheinterface"></a>52.2. The AdvancedCache interface</h3> <div class="literalblock"> <div class="content"> <pre>In addition to the simple Cache interface, Infinispan offers an link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/AdvancedCache.html$$[AdvancedCache] interface, geared towards extension authors.  The AdvancedCache offers the ability to inject custom interceptors, access certain internal components and to apply flags to alter the default behavior of certain cache methods.  The following code snippet depicts how an AdvancedCache can be obtained:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>AdvancedCache advancedCache = cache.getAdvancedCache();
</pre> </div> </div> <div class="sect3"> <h4 id="sid-18645180_UsingtheCacheAPI-Flags"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-Flags"></a>52.2.1. Flags</h4> <div class="literalblock"> <div class="content"> <pre>Flags are applied to regular cache methods to alter the behavior of certain methods.  For a list of all available flags, and their effects, see the link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/context/Flag.html$$[Flag] enumeration.  Flags are applied using link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag...%29$$[AdvancedCache.withFlags()] .  This builder method can be used to apply any number of flags to a cache invocation, for example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
   .withFlags(Flag.FORCE_SYNCHRONOUS)
   .put("hello", "world");

</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645180_UsingtheCacheAPI-CustomInterceptors"><a class="anchor" href="#sid-18645180_UsingtheCacheAPI-CustomInterceptors"></a>52.2.2. Custom Interceptors</h4> <div class="paragraph"> <p>The AdvancedCache interface also offers advanced developers a mechanism with which to attach custom interceptors.  Custom interceptors allow developers to alter the behavior of the cache API methods, and the AdvancedCache interface allows developers to attach these interceptors programmatically, at run-time.  See the AdvancedCache Javadocs for more details.</p> </div> <div class="literalblock"> <div class="content"> <pre>For more information on writing custom interceptors, see link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737149$$[/javascript:;]</pre> </div> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645181"><a class="anchor" href="#sid-18645181"></a>53. Local mode cache</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>_Introduction_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Even though Infinispan's biggest potential is as distributed, in-memory data grid platform, one aspect of it often gets overlooked - it can be used as a standalone cache node. But why would anyone use Infinispan over, say, a link:$$http://java.sun.com/javase/6/docs/api/java/util/concurrent/ConcurrentHashMap.html$$[ConcurrentHashMap] ? Here are some reasons: _$$__$$_</pre> </div> </div> <div class="ulist"> <ul> <li> <p><em>Eviction.</em> Built-in eviction ensures you don&#8217;t run out of memory.</p> </li> <li> <p><em>Write-through and write-behind caching.</em> Going beyond memory and onto disk (or any other pluggable <a href="http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/loaders/CacheStore.html">CacheStore</a> ) means that your state survives restarts, and preloaded hot caches can be configured.</p> </li> <li> <p><em>JTA support and XA compliance.</em> Participate in ongoing transactions with any <a href="http://java.sun.com/javaee/technologies/jta/index.jsp">JTA</a> -compliant transaction manager.</p> </li> <li> <p><em>MVCC-based concurrency.</em> Highly optimized for fast, non-blocking readers.</p> </li> <li> <p><em>Manageability.</em> <a href="http://docs.jboss.org/infinispan/4.0/apidocs/jmxComponents.html">Simple JMX</a> or rich GUI management console via <a href="http://community.jboss.org/docs/DOC-13721">JOPR</a> , you have a choice.</p> </li> <li> <p><em>Not just for the JVM.</em> <a href="http://community.jboss.org/docs/DOC-14095">RESTful API</a> , and upcoming <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3736765">client/server modules</a> speaking Memcached and <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083">HotRod</a> protocols help non-JVM platforms use Infinispan.</p> </li> <li> <p><em>Cluster-ready.</em> Should the need arise. <em>__</em> So how do you get started with Infinispan in local mode? The simplest configuration file containing just</p> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;infinispan/&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>is enough to get you started, or you can create DefaultCacheManager with _no_ - _argument_ constructor. Either approach creates local default cache.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>All the features above are exposed via an easy-to-use link:$$http://docs.jboss.org/infinispan/4.0/apidocs/org/infinispan/Cache.html$$[Cache] interface, which extends link:$$http://java.sun.com/javase/6/docs/api/java/util/concurrent/ConcurrentMap.html$$[ConcurrentMap] and is compatible with many other cache systems. Infinispan even ships with link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737098$$[migration tools] to help you move off other cache solutions onto Infinispan, whether you need a cache to store data retrieved remotely or simply as a link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737110$$[2nd level cache for Hibernate] .</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Performance_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In the process of testing and tuning Infinispan on very large clusters, we have started to put together a link:$$http://cachebenchfwk.sourceforge.net/$$[benchmarking framework] . As a part of this framework, we have the ability to measure cache performance in standalone, local mode. We compared Infinispan 4.0 in local mode against the latest JBoss Cache release (3.2.2.GA) and EHCache (1.7.2). Some background on the tests:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>Used a latest snapshot of the <a href="http://cachebenchfwk.sourceforge.net/">CacheBenchFwk</a></p> </li> <li> <p>Run on a <a href="http://www.redhat.com/rhel/">RHEL</a> 5 server with 4 Intel Xeon cores, 4GB of RAM</p> </li> <li> <p>Sun JDK 1.6.0_18, with -Xms1g -Xmx1g</p> </li> <li> <p>Test run on a single node, with 25 concurrent threads, using randomly generated Strings as keys and values and a 1kb payload for each entry, with a 80/20 read/write ratio.</p> </li> <li> <p>Performance measured in transactions per second (higher = better).</p> </li> </ul> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="paragraph"> <p>In summary, what we have here is that when run in local mode, Infinispan is a high-performance standalone caching engine which offers a rich set of features while still being trivially simple to configure and use.</p> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645182"><a class="anchor" href="#sid-18645182"></a>54. Infinispan Command-line Console</h2> <div class="sectionbody"> <div class="paragraph"> <p>Documentation for ispncon version 0.8.1</p> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Whatisispncon%3F"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Whatisispncon%3F"></a>54.1. What is ispncon ?</h3> <div class="literalblock"> <div class="content"> <pre>Ispncon (Infinispan Command-Line Console) is a simple command-line interface to infinispan cache written in python. It accesses the cache in client/server fashion, whereby infinispan link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737048$$[server modules] ( link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146$$[Hot Rod] , link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737037$$[Memcached] , link:$$http://community.jboss.org/docs/DOC-14095$$[REST] ) have to be properly configured. Once you have a running instance of infinispan with one of the server modules, you can issue simple cache requests via command line, like:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>$ ispncon put keyA "Sample value under keyA"
$ ispncon get keyA
$ ispncon delete keyA
</pre> </div> </div> <div class="paragraph"> <p>Furthermore it creates an abstraction above the specifics of the client/server protocol you use to access the cache. The basic commands look the same whether you use Hot Rod, memcached or REST. The client/protocol specifics are handled via protocol-specific configuration options or command arguments.</p> </div> <div class="paragraph"> <p>Your shell scripts should look basically the same for all the client modes, if you don&#8217;t use any protocol specific features.</p> </div> <div class="paragraph"> <p>Behind the scenes the console tool uses existing python clients to handle the communication with particular server modules. The implementations are listed in the following table:</p> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Client</em></th> <th class="tableblock halign-left valign-top"><em>Client implementation</em></th> <th class="tableblock halign-left valign-top"><em>Web</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Hot Rod</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">python-client for hotrod</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/infinispan/python-client">https://github.com/infinispan/python-client</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">Memcached</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">python-memcached</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://launchpad.net/python-memcached">https://launchpad.net/python-memcached</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">REST</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">httplib (standard module for python)</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://docs.python.org/library/httplib.html">http://docs.python.org/library/httplib.html</a></p></td> </tr> </tbody> </table> <div class="literalblock"> <div class="content"> <pre>The source code and issue reporting for ispncon can be found here: link:$$https://github.com/infinispan/ispncon$$[]</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Installation"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Installation"></a>54.2. Installation</h3> <div class="paragraph"> <p>Ispncon requires</p> </div> <div class="ulist"> <ul> <li> <p>python 2.6</p> </li> <li> <p>python modules: python-devel, setuptools, infinispan, python-memcached</p> <div class="literalblock"> <div class="content"> <pre>Installation steps:</pre> </div> </div> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>$ git clone &lt;a class="jive-link-external-small" href="https://github.com/infinispan/ispncon.git" target="_blank"&gt;https://github.com/infinispan/ispncon.git&lt;/a&gt;
$ cd ispncon/src
$ sudo python setup.py install
</pre> </div> </div> <div class="paragraph"> <p>Make this part of your .bashrc or whatever so you have ispncon command on path</p> </div> <div class="listingblock"> <div class="content"> <pre>export ISPNCON_HOME=/path/to/ispncon
export PATH=$ISPNCON_HOME/bin:$PATH
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Basicusage"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Basicusage"></a>54.3. Basic usage</h3> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>ispncon [options] &lt;operation&gt; [operation_options] &lt;op_arguments&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Options_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-c --client</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Client to use, possible values: memcached, rest, hotrod (default) Configuration key: ispncon.client_type</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-h --host &lt;host&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Host/ip address to connect to. Default: localhost. Configuration key: ispncon.host</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-p --port &lt;port&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Port to connect to. Default: 11222 (hotrod default port) Configuration key: ispncon.port</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-C --cache-name &lt;name&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Named cache to use. Default: use default cache (no value) Configuration key: ispncon.cache</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Print ispncon version and exit</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-e --exit-on-error</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If true and operation fails, then fail with an exit code. If false just print ERROR message and continue. This mostly makes sense for batch files.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-P --config "&lt;key&gt; &lt;value&gt;"</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">override configuration option &lt;key&gt; with value &lt;value&gt;. NOTE: the quotes are necessary, because getopt parser needs to get these as one string.</p></td> </tr> </tbody> </table> <div class="literalblock"> <div class="content"> <pre>The possible Operations are _put, get, delete, clear, exists, help, config, include_ and each one is described in the sections _Cache operations_ and _Other commands_ .</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Configuration"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Configuration"></a>54.4. Configuration</h3> <div class="paragraph"> <p>On start-up ispncon reads the file ~/.ispncon to configure some of the default values to use, so that the user doesn&#8217;t have to enter the options like host, port, client type and cache name everytime he types a cache command.</p> </div> <div class="paragraph"> <p>The format of the config file is like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>[ispncon]
host = localhost
port = 8080
client_type = rest
cache =
exit_on_error = False
default_codec = None
[rest]
server_url = /infinispan-server-rest/rest
content_type = text/plain
[hotrod]
use_river_string_keys = True
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The config parameters in the section _ispncon_ are described in the_Basic usage_  section. The rest is described here:</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Config key</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">rest.server_url</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">location of the REST server service, in the above example the HTTP requests would be sent to <a href="http://localhost:8080/infinispan-server-rest/rest">http://localhost:8080/infinispan-server-rest/rest</a></p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">rest.content_type</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">default MIME content type for entries stored via REST interface</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">default_codec</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Default codec to use to encode/decode values. Possible values: None, RiverString, RiverByteArray see section Interoperability with java clients for further info</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">hotrod.use_river_string_keys</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If set to True, hotrod client will encode keys with RiverString codec - this is necessary to be able to access the same data as via Java HotRod Client using the same string keys. see section Interoperability with java clients for further info</p></td> </tr> </tbody> </table> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Cacheoperations"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Cacheoperations"></a>54.5. Cache operations</h3> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-put"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-put"></a>54.5.1. put</h4> <div class="paragraph"> <p>Put data under a specified key.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>put [options] &lt;key&gt; &lt;value&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Options_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <caption class="title">Table 1. Return values</caption> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-i --input-filename &lt;filename&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Don&#8217;t specify the value, instead put the contents of the specified file.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version &lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Put only if version equals version given. Version format differs between protocols: HotRod: 64-bit integer version number Memcached: 64-bit integer unique version id REST: ETag string Not yet implemented for REST client in infinispan, watch <a href="https://issues.jboss.org/browse/ISPN-1084">ISPN-1084</a> for more info.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-l --lifespan &lt;seconds&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies lifespan of the entry. Integer, number of seconds.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-I --max-idle &lt;seconds&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Specifies max idle time for the entry. Integer, number of seconds.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-a --put-if-absent</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Return CONFLICT if value already exists and don&#8217;t put anything in that case</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-e --encode &lt;codec&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Encode value using the specified codec</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">STORED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry was stored sucessfully</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-v option was used and entry doesn&#8217;t exist</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CONFLICT</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">-a option was used and the entry already exists, or -v was used and versions don&#8217;t match</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> memcached client won&#8217;t distinguish between states NOT_FOUND, CONFLICT and ERROR and always will return ERROR if operation wasn&#8217;t successfull. this is a limitation of python-memcached client. </td> </tr> </table> </div> <div class="paragraph"> <p>see issues:</p> </div> <div class="literalblock"> <div class="content"> <pre>link:$$https://bugs.launchpad.net/python-memcached/+bug/684689$$[]</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>link:$$https://bugs.launchpad.net/python-memcached/+bug/684690$$[]</pre> </div> </div> <div class="paragraph"> <p>for discussion.</p> </div> <div class="paragraph"> <p>In later ispncon versions python-memcached client might get replaced by a customized version.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-get"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-get"></a>54.5.2. get</h4> <div class="paragraph"> <p>Get the data stored under the specified key.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>get [options] &lt;key&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Options_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <caption class="title">Table 2. Return values</caption> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-o --output-filename &lt;filename&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Stores the output of the get operation into the file specified.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Get version along with the data. Version format differs between protocols: HotRod: 64-bit integer version number Memcached: 64-bit integer unique version id REST: ETag string</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-d --decode &lt;codec&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Decode the value using the specified codec.</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">In case no filename was specified: &lt;data, possibly multi-line&gt; (NOTE: the data might contain binary content, that is not suitable for reading in terminal) In case a filename was specified, nothing is printed on standard output. In case -v was specified, the output is prepended with one line: VERSION &lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry was found and is returned.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Requested entry wasn&#8217;t found in the cache</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-delete"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-delete"></a>54.5.3. delete</h4> <div class="paragraph"> <p>Delete the entry with the specified key.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>delete [options] &lt;key&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Options_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <caption class="title">Table 3. Return values</caption> <colgroup> <col style="width:50%;"> <col style="width:50%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Option</em></th> <th class="tableblock halign-left valign-top"><em>Meaning</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">-v --version &lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Deletes only if the specified version matches the version in the cache NOTE: versioned delete is not supported with memcached client. attempt to delete with -v flag will end in ERROR message. with REST client the situation is different, the protocol allows this, but it&#8217;s not yet implemented in infinispan, watch <a href="https://issues.jboss.org/browse/ISPN-1084">ISPN-1084</a> for more info</p></td> </tr> </tbody> </table> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">DELETED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry was successfully deleted</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry wasn&#8217;t found in the cache.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">CONFLICT</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Option -v was used and versions don&#8217;t match</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-clear"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-clear"></a>54.5.4. clear</h4> <div class="paragraph"> <p>Clear the cache</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>clear
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Return values_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">DELETED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Cache was sucessfully cleared</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-exists"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-exists"></a>54.5.5. exists</h4> <div class="paragraph"> <p>Verify if the entry exists in the cache</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>exists &lt;key&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Return values_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">EXISTS</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry with the given key exists</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Entry with the given key wasn&#8217;t found in the cache</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> memcached protocol doesn&#8217;t support querying for existence of an entry in the cache so exists operation is implemented (inefficiently) by get opeartion, that gets the whole entry with all the data from the server. </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-version"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-version"></a>54.5.6. version</h4> <div class="paragraph"> <p>Get version of the entry. Version format differs between protocols:</p> </div> <div class="paragraph"> <p>HotRod: 64-bit integer version number</p> </div> <div class="paragraph"> <p>Memcached: 64-bit integer unique version id</p> </div> <div class="paragraph"> <p>REST: ETag string</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> The purpose of this command is to facilitate the parsing of the version string. HotRod and Memcached client don&#8217;t support efficient implementation of this operation. They transfer the whole entry from the server to determine the version, so if applicable you are encouraged to use "get -v" command to obtain version together with the data. </td> </tr> </table> </div> <div class="paragraph"> <p>REST client implements this operation efficiently by executing HEAD method.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>version &lt;key&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Return values_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">&lt;version&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If the entry exists.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">NOT_FOUND</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">Requested entry wasn&#8217;t found in the cache</p></td> </tr> </tbody> </table> </div> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Othercommands"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Othercommands"></a>54.6. Other commands</h3> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-help"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-help"></a>54.6.1. help</h4> <div class="paragraph"> <p>Print help about an operation</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>help &lt;operation&gt;
</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> if no operation is supplied, prints list of supported operations </td> </tr> </table> </div> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-config"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-config"></a>54.6.2. config</h4> <div class="paragraph"> <p>Change internal state/config of the client. This opeartion has only client-side effect.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>config                - to print current config
config save           - to save config to ~/.ispncon
config &lt;key&gt; &lt;value&gt;  - to change config for currently running session
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Configuration values_</pre> </div> </div> <div class="paragraph"> <p>see section Configuration for the meaning of different configuration options. Currently supported keys are:</p> </div> <div class="ulist"> <ul> <li> <p>cache</p> </li> <li> <p>host</p> </li> <li> <p>port</p> </li> <li> <p>client_type</p> </li> <li> <p>exit_on_error</p> </li> <li> <p>rest.server_url</p> </li> <li> <p>rest.content_type</p> <div class="literalblock"> <div class="content"> <pre>These values directly correspond to the keys in the ~/.ispncon config file. The format of the key is</pre> </div> </div> </li> </ul> </div> <div class="listingblock"> <div class="content"> <pre>&lt;section&gt;.&lt;config_key&gt;
</pre> </div> </div> <div class="paragraph"> <p>If no section is given, "ispncon" is implied.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Return values_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">STORED</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If configuration/client state was updated successfully.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">multi-line output with config values</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">If config command with no parameters was entered.</p></td> </tr> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">ERROR &lt;msg&gt;</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">General error occurred</p></td> </tr> </tbody> </table> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-include"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-include"></a>54.6.3. include</h4> <div class="paragraph"> <p>Process cache commands from the specified batch file. The commands will be processed line by line.</p> </div> <div class="literalblock"> <div class="content"> <pre>_Format_</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>include &lt;filename&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_Return values_</pre> </div> </div> <table class="tableblock frame-all grid-all" style="width:100%; "> <colgroup> <col style="width:33%;"> <col style="width:33%;"> <col style="width:33%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top"><em>Exit code</em></th> <th class="tableblock halign-left valign-top"><em>Output</em></th> <th class="tableblock halign-left valign-top"><em>Result description</em></th> </tr> </thead> <tbody> <tr> <td class="tableblock halign-left valign-top"><p class="tableblock">exit code of the last command in the file.</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">The output depends on the commands present in the input file</p></td> <td class="tableblock halign-left valign-top"><p class="tableblock">depends on the commands in the batch file</p></td> </tr> </tbody> </table> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> The name of this command and it&#8217;s behaviour is going to change in the next version. </td> </tr> </table> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645182_InfinispanCommand-lineConsole-Interoperabilitywithjavaclients"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-Interoperabilitywithjavaclients"></a>54.7. Interoperability with java clients</h3> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-HTTPclients"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-HTTPclients"></a>54.7.1. HTTP clients</h4> <div class="paragraph"> <p>when exchanging data via REST interface, the values are interpreted by any client as sequence of bytes. The meaning is given to this byte-sequence by using MIME type specified via "Content-Type" HTTP header. No special interoperability measures are needed here.</p> </div> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-HotRodJavaClient"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-HotRodJavaClient"></a>54.7.2. Hot Rod Java Client</h4> <div class="literalblock"> <div class="content"> <pre>If we want to read in ispncon the entries that were put with Hot Rod Java client, we need to use a special option _$$hotrod.use_river_string_keys = True$$_ . This will cause the string keys to be encoded the same way the Java client does it.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Using _$$hotrod.use_river_string_keys = True$$_ we're able to access the data that has been writen by the java client, but we still see the raw binary values. To be able to see a value that has been put by Hot Rod java client in a readable form and vice versa - to be able to see in Hot Rod Java client what we've put via ispncon we need to use a _codec_ . Currently there are two types of codecs: _RiverString_ and _RiverByteArray_</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_RiverString_ - will decode a value that has been put as java.lang.String and vice versa - a value encoded with this codec will be returned as java.lang.String on the java side</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>_RiverByteArray_ - analogous to RiverString but works with byte[] (java byte array)</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Codecs can be used either by specifying a _$$default_codec$$_ option in the ~/.ispncon config file (in section ispncon) or by specifying a codec on each put resp get using _-e (--encode)_ resp _-d (--decode) options_ .</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645182_InfinispanCommand-lineConsole-SpyMemcachedJavaClient"><a class="anchor" href="#sid-18645182_InfinispanCommand-lineConsole-SpyMemcachedJavaClient"></a>54.7.3. SpyMemcached Java Client</h4> <div class="literalblock"> <div class="content"> <pre>Tested with link:$$http://code.google.com/p/spymemcached/$$[spymemcached] 2.7.</pre> </div> </div> <div class="paragraph"> <p>Value that is put by ispncon is interpreted as an UTF-8 string. meaning if we supply some bytes, on the java side it will be recreated as new java.lang.String(bytes, "UTF-8")</p> </div> <div class="paragraph"> <p>This also works reversely: values put by java side as java.lang.String will be returned as UTF-8 bytes in ispncon</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645183"><a class="anchor" href="#sid-18645183"></a>55. Server Command Line Options</h2> <div class="sectionbody"> <div class="literalblock"> <div class="content"> <pre>Infinispan ships several link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737048$$[server modules] , some of which can be started via calling startServer.sh or startServer.bat scripts from command line. These currently include link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146$$[Hot Rod] , link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737037$$[Memcached] and link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737036$$[Web Socket] servers. Please find below the set of common command line parameters that can be passed to these servers:</pre> </div> </div> <div class="paragraph"> <div class="title">TODO Gliffy image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>Note that starting with Infinispan 4.2.0.CR1, default Hot Rod port has changed from 11311 to 11222.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>[g@eq]~/infinispan-4.1.0-SNAPSHOT% ./bin/startServer.sh -h
usage: startServer [options]

options:
  -h, --help                        
        Show this help message

  -V, --version
        Show version information

  --                 
        Stop processing options

  -p, --port=&lt;num&gt;                  
        TCP port number to listen on
        (default: 11211 for Memcached, 11222 for Hot Rod
        and 8181 for WebSocket server)

  -l, --host=&lt;host or ip&gt;
        Interface to listen on
        (default: 127.0.0.1, localhost)

  -m, --master_threads=&lt;num&gt;
        Number of threads accepting incoming connections
        (default: unlimited while resources are available)

  -t, --work_threads=&lt;num&gt;
        Number of threads processing incoming requests and sending responses
        (default: unlimited while resources are available)

  -c, --cache_config=&lt;filename&gt;
        Cache configuration file
        (default: creates cache with default values)

  -r, --protocol=[memcached|hotrod|websocket]
        Protocol to understand by the server.
        This is a mandatory option and you should choose one of these options         

  -i, --idle_timeout=&lt;num&gt;
        Idle read timeout, in seconds, used to detect stale connections
        (default: -1)
        If no new messages have been read within this time,
        the server disconnects the channel.
        Passing -1 disables idle timeout.

  -n, --tcp_no_delay=[true|false]
        TCP no delay flag switch (default: true)

  -s, --send_buf_size=&lt;num&gt;
        Send buffer size (default: as defined by the OS).

  -e, --recv_buf_size=&lt;num&gt;
        Receive buffer size (default: as defined by the OS).

  -o, --proxy_host=&lt;host or ip&gt;
        Host address to expose in topology information sent to clients.
        If not present, it defaults to configured host.
        Servers that do not transmit topology information ignore this setting.

  -x, --proxy_port=&lt;num&gt;
        Port to expose in topology information sent to clients.
        If not present, it defaults to configured port.
        Servers that do not transmit topology information ignore this setting.

  -k, --topo_lock_timeout=&lt;num&gt;
        Controls lock timeout (in milliseconds) for those servers that maintain
        the topology information in an internal cache.

  -u, --topo_repl_timeout=&lt;num&gt;
        Sets the maximum replication time (in milliseconds) for transfer of
        topology information between servers.
        If state transfer is enabled, this setting also controls the topology
        cache state transfer timeout.
        If state transfer is disabled, it controls the amount of time to wait
        for this topology data to be lazily loaded from a different node when
        not present locally.

  -a, --topo_state_trasfer=[true|false]
        Enabling topology information state transfer means that when a server
        starts it retrieves this information from a different node.
        Otherwise, if set to false, the topology information is lazily loaded
        if not available locally.

  -D&lt;name&gt;[=&lt;value&gt;]
        Set a system property

</pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645184"><a class="anchor" href="#sid-18645184"></a>56. Interacting With Hot Rod Server From Within Same JVM</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-Introduction"><a class="anchor" href="#sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-Introduction"></a>56.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Normally, a link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737146$$[Hot Rod server] is accessed via a Hot Rod protocol client such as the link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142$$[Java Hot Rod client] . However, there might be situations where not only do you want to access the Hot Rod server remotely, you might also want to access it locally from within the same JVM that the Hot Rod server is running. For example, you might have an Infinispan cache pushing changes link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737163$$[via the RemoteCacheStore to a Hot Rod server] , and if the cache goes down, you might want to access the data directly from the Hot Rod server itself.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In this situations, we have to remember that link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083$$[the Hot Rod protocol] specifies that keys and values are stored as byte arrays. This means that if the client code, using an existing Hot Rod client, stored Strings or Integers, or any other complex serializable or externalizable object, you won't be able to retrieve these objects straight from the cache that the Hot Rod server uses.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>To actually get the fully constructed objects that you're after, you're gonna need to take the byte arrays stored within the Hot Rod server and unmarshall them into something that you can use. In the future, this is something that might be done for you, as suggested in link:$$https://jira.jboss.org/browse/ISPN-706$$[ISPN-706] , but for the time being, clients wanting to access Hot Rod server data will have to do it themselves.</pre> </div> </div> <div class="paragraph"> <p>Two different use cases need to be differentiated at this stage and to explain how to transform the Hot Rod server data into something usable, we&#8217;ll assume that the clients are java clients:</p> </div> </div> <div class="sect2"> <h3 id="sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-DataStoredDirectlyViaAHotRodClient"><a class="anchor" href="#sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-DataStoredDirectlyViaAHotRodClient"></a>56.2. Data Stored Directly Via A Hot Rod Client</h3> <div class="literalblock"> <div class="content"> <pre>The most common case is for a client to use a Hot Rod client library directly to store data in the Hot Rod server. In this case, assuming that the client used the existing link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737142$$[Java Hot Rod client] , the default marshaller used to marshall objects into byte arrays is the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/marshall/jboss/GenericJBossMarshaller.html$$[GenericJBossMarshaller] . So, if a user wants to read data from the Hot Rod server directly, it would need to execute something along the lines of:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.marshall.jboss.GenericJBossMarshaller;
import org.infinispan.util.ByteArrayKey;
import org.infinispan.server.core.CacheValue;
...

// Create a new instance of the marshaller:
GenericJBossMarshaller marshaller = new GenericJBossMarshaller();
Object key = ...

// Take the cache key and convert into a byte array,
// and wrap it with an instance of ByteArrayKey
ByteArrayKey bytesKey = new ByteArrayKey(marshaller.objectToByteBuffer(key));

// Internally, Hot Rod stores values wrapped in a CacheValue, so retrieve it
CacheValue cacheValue = (CacheValue) cache.get(bytesKey);

// Take the data part which is byte array and unmarshall it to retrieve the value
Object value = marshaller.objectFromByteBuffer(cacheValue.data());
</pre> </div> </div> <div class="paragraph"> <p>If you want to store data directly in the HotRod server, you&#8217;d have to execute something like this:</p> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.marshall.jboss.GenericJBossMarshaller;
import org.infinispan.util.ByteArrayKey;
import org.infinispan.server.core.CacheValue;
...

// Create a new instance of the marshaller:
GenericJBossMarshaller marshaller = new GenericJBossMarshaller();
Object key = ...
Object value = ...

// Take the cache key and convert into a byte array,
// and wrap it with an instance of ByteArrayKey
ByteArrayKey bytesKey = new ByteArrayKey(marshaller.objectToByteBuffer(key));

// Internally, Hot Rod stores values wrapped in a CacheValue, so create instance
// Remember that you need to give it a version number, so either:
// 1. Increment previous value's version
// 2. Or generate a new version number that minimises potential clash
//    with a concurrent update to the same key in the cluster
CacheValue cacheValue = new CacheValue(marshaller.objectToByteBuffer(value), 1)

// Finally, store it in the cache
cache.put(bytesKey, cacheValue);
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-DataStoredViaRemoteCacheStore"><a class="anchor" href="#sid-18645184_InteractingWithHotRodServerFromWithinSameJVM-DataStoredViaRemoteCacheStore"></a>56.3. Data Stored Via Remote Cache Store</h3> <div class="literalblock"> <div class="content"> <pre>Other times, Hot Rod server might be storing data coming from a link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737163$$[RemoteCacheStore] , rather than user code. In this case, there're a couple of differences to the code above. First of all, the marshaller is slightly different. Instead, the RemoteCacheStore uses the link:$$http://docs.jboss.org/infinispan/4.1/apidocs/org/infinispan/marshall/VersionAwareMarshaller.html$$[VersionAwareMarshaller] which all it does is add Infinispan version information to the byte array generated. The second difference is that RemoteCacheStore stores internal cache entry classes, which apart from the value part, they contain other extra information. So, any code trying to read these directly from the Hot Rod server would need to take in account. For example, to read data from such Hot Rod server:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.marshall.VersionAwareMarshaller;
import org.infinispan.util.ByteArrayKey;
import org.infinispan.server.core.CacheValue;
import org.infinispan.container.entries.CacheEntry;
...

// Create a new instance of the marshaller
VersionAwareMarshaller marshaller = new VersionAwareMarshaller();
Object key = ...

// Take the cache key and convert into a byte array,
// and wrap it with an instance of ByteArrayKey
ByteArrayKey bytesKey = new ByteArrayKey(marshaller.objectToByteBuffer(key));

// Internally, Hot Rod stores values wrapped in a CacheValue, so retrieve it
CacheValue cacheValue = (CacheValue) cache.get(bytesKey);

// However, in this case the data part of CacheValue does not contain directly
// the value Instead, it contains an instance of CacheEntry, so we need to
// unmarshall that and then get the actual value
CacheEntry cacheEntry = (CacheEntry)
   marshaller.objectFromByteBuffer(cacheValue.data());
Object value = cacheEntry.getValue();
</pre> </div> </div> <div class="paragraph"> <p>And to actually write data back into the Hot Rod server directly:</p> </div> <div class="listingblock"> <div class="content"> <pre>import org.infinispan.marshall.VersionAwareMarshaller;
import org.infinispan.util.ByteArrayKey;
import org.infinispan.server.core.CacheValue;
import org.infinispan.container.entries.CacheEntry;
import org.infinispan.container.entries.InternalEntryFactory;
...

// Create a new instance of the marshaller:
VersionAwareMarshaller marshaller = new VersionAwareMarshaller();
Object key = ...
Object value = ...

// Take the cache key and convert into a byte array
ByteArrayKey bytesKey = new ByteArrayKey(marshaller.objectToByteBuffer(key));

// With the value to store, a new CacheEntry instance needs to be created:
CacheEntry cacheEntry = InternalEntryFactory.create(bytesKey, value, ...)

// Internally, Hot Rod stores values wrapped in a CacheValue, so create instance
// Remember that you need to give it a version number, so either:
// 1. Increment previous value's version
// 2. Or generate a new version number that minimises potential clash
//    with a concurrent update to the same key in the cluster
CacheValue cacheValue = new CacheValue(
   marshaller.objectToByteBuffer(cacheEntry), 1)

// Finally, store it in the cache
cache.put(bytesKey, cacheValue);
</pre> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645185"><a class="anchor" href="#sid-18645185"></a>57. Multiple Tiers of Caches</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645185_MultipleTiersofCaches-Introduction"><a class="anchor" href="#sid-18645185_MultipleTiersofCaches-Introduction"></a>57.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>The introduction of link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083$$[HotRod] protocol and link:$$http://community.jboss.org/docs/DOC-14893?uniqueTitle=false#Remote_cache_loader$$[RemoteCacheLoader] opened the way for a set of new architectures in Infinispan, where layers of caches can exists and interact. This article takes a look at such an layered architecture.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645185_MultipleTiersofCaches-Buildingblocks"><a class="anchor" href="#sid-18645185_MultipleTiersofCaches-Buildingblocks"></a>57.2. Building blocks</h3> <div class="literalblock"> <div class="content"> <pre>link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=9470083$$[HotRod] is a binary protocol defined for exposing an Infinispan cluster as an caching server to multiple platforms. It has support for load balancing and smart routing.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>link:$$http://community.jboss.org/docs/DOC-14893?uniqueTitle=false#Remote_cache_loader$$[RemoteCacheLoader] is a cache loader that knows how to read/store data in a remote infinispan cluster. For that it makes use of the java hotrod client.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645185_MultipleTiersofCaches-Samplearchitecture%2Fnearcaching"><a class="anchor" href="#sid-18645185_MultipleTiersofCaches-Samplearchitecture%2Fnearcaching"></a>57.3. Sample architecture/near caching</h3> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>The diagram above shows an Infinispan server cluster running 3 hotrod servers. This cluster is accessed remotely, through HotRod, by another infinispan cluster:  client cluster (upper part of the image). All the nodes in the server cluster are configured to run HotRod servers, so requests from remote loader are being balanced between them. The client cluster is is configured with a link:$$http://community.jboss.org/wiki/CacheLoaders#Cluster_cache_loader$$[ClusterCacheLoader] to acess data stored in the server cluster and with invalidation. Application data is held on the server cluster which runs in DIST mode for scalability.</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>In this deployment the client code, running in same address space with the client cluster,  holds all its data in the server cluster. Client cluster acts as an _near-cache_ for freqeuntly accessed entries.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645185_MultipleTiersofCaches-Wanttoknowmore%3F"><a class="anchor" href="#sid-18645185_MultipleTiersofCaches-Wanttoknowmore%3F"></a>57.4. Want to know more?</h3> <div class="literalblock"> <div class="content"> <pre>On the link:$$http://community.jboss.org/infinispan$$[documentation  main page] :</pre> </div> </div> <div class="ulist"> <ul> <li> <p>cache loaders are described in the "Cache loaders" section</p> </li> <li> <p>Hotrod&#8217;s specification, server and client in the "Hot Rod" section</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645187"><a class="anchor" href="#sid-18645187"></a>58. Infinispan REST Server</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645187_InfinispanRESTServer-Introduction"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Introduction"></a>58.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>This server provides easy to use link:$$http://en.wikipedia.org/wiki/Representational_State_Transfer$$[RESTful] HTTP access to the Infinispan data grid, build on RESTEasy.  This application is delivered (currently) as a war, which you can deploy to a servlet container (as many instances as you need).</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645187_InfinispanRESTServer-Configuration"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Configuration"></a>58.2. Configuration</h3> <div class="paragraph"> <p>Out of the box, Infinispan will create and use a new LOCAL mode cache. To set a custom configuration:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Unzip the REST WAR file (or use an <a href="http://community.jboss.org/docs/DOC-9719">exploded</a> deployment)</p> </li> <li> <p>Create an Infinispan <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737143">configuration XML file</a> and name this infinispan.xml</p> </li> <li> <p>Place this file in infinispan-server-rest.war/WEB-INF/classes</p> </li> </ol> </div> <div class="paragraph"> <p>Alternatively, you could:</p> </div> <div class="olist arabic"> <ol class="arabic"> <li> <p>Unzip the REST WAR file (or use an <a href="http://community.jboss.org/docs/DOC-9719">exploded</a> deployment)</p> </li> <li> <p>Create an Infinispan <a href="https://docs.jboss.org/author/pages/viewpage.action?pageId=3737143">configuration XML file</a> , call it whatever you want and place it wherever you want</p> </li> <li> <p>Edit infinispan-server-rest.war/WEB-INF/web.xml and look for the infinispan.config init-param. Change the value of this init-param to the full path to your Infinispan configuration.</p> </li> </ol> </div> <div class="paragraph"> <div class="title">TODO InformalFigure image title empty</div> <p>image::[]</p> </div> <div class="literalblock"> <div class="content"> <pre>Please note that the REST server only allows interaction with either the default cache (named ___defaultcache ) or one of the named caches in the configuration file. This is because the REST server starts the default and pre-defined caches on startup in order to provide consistent behaivor.</pre> </div> </div> <div class="admonitionblock warning"> <table> <tr> <td class="icon"> <i class="icon-warning" title="Warning"></i> </td> <td class="content"> <div class="title">Warning</div> <div class="paragraph"> <p>Creation of new named caches on the fly is not supported.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>As a result, if you don&#8217;t use a custom configuration file, you&#8217;ll only be able to interact with the default cache. To interact with more caches, use a configuration file with the desired named caches.</p> </div> </div> <div class="sect2"> <h3 id="sid-18645187_InfinispanRESTServer-AccessingDataviaURLs"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-AccessingDataviaURLs"></a>58.3. Accessing Data - via URLs</h3> <div class="literalblock"> <div class="content"> <pre>HTTP PUT and POST methods are used to place data in the cache, with URLs to address the cache name and key(s) - the data being the body of the request (the data can be anything you like). It is important that a Content-Type header is set. GET/HEAD are used to retrieve data link:$$https://docs.jboss.org/author/pages/viewpage.action?pageId=3737132$$[Please see here for the details] . Other headers are used to control the cache settings and behaviour (detailed in that link).</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645187_InfinispanRESTServer-Clientsidecode"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Clientsidecode"></a>58.4. Client side code</h3> <div class="paragraph"> <p>Part of the point of a RESTful service is that you don&#8217;t need to have tightly coupled client libraries/bindings. All you need is a HTTP client library. For Java, Apache HTTP Commons Client works just fine (and is used in the integration tests), or you can use java.net API.</p> </div> <div class="sect3"> <h4 id="sid-18645187_InfinispanRESTServer-Rubyclientcode%3A"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Rubyclientcode%3A"></a>58.4.1. Ruby client code:</h4> <div class="listingblock"> <div class="content"> <pre># Shows how to interact with Infinispan REST api from ruby.
# No special libraries, just standard net/http
#
# Author: Michael Neale
#
require 'net/http'

http = Net::HTTP.new('localhost', 8080)

#Create new entry
http.post('/infinispan/rest/MyData/MyKey', 'DATA HERE', {"Content-Type" =&gt; "text/plain"})

#get it back
puts http.get('/infinispan/rest/MyData/MyKey').body

#use PUT to overwrite
http.put('/infinispan/rest/MyData/MyKey', 'MORE DATA', {"Content-Type" =&gt; "text/plain"})

#and remove...
http.delete('/infinispan/rest/MyData/MyKey')

#Create binary data like this... just the same...
http.put('/infinispan/rest/MyImages/Image.png', File.read('/Users/michaelneale/logo.png'), {"Content-Type" =&gt; "image/png"})


#and if you want to do json...
require 'rubygems'
require 'json'

#now for fun, lets do some JSON !
data = {:name =&gt; "michael", :age =&gt; 42 }
http.put('/infinispan/rest/Users/data/0', data.to_json, {"Content-Type" =&gt; "application/json"})
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645187_InfinispanRESTServer-Pythonclientcode%3A"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Pythonclientcode%3A"></a>58.4.2. Python client code:</h4> <div class="listingblock"> <div class="content"> <pre>
# Sample python code using the standard http lib only
#

import httplib


#putting data in
conn = httplib.HTTPConnection("localhost:8080")
data = "SOME DATA HERE \!" #could be string, or a file...
conn.request("POST", "/infinispan/rest/Bucket/0", data, {"Content-Type": "text/plain"})
response = conn.getresponse()
print response.status

#getting data out
import httplib
conn = httplib.HTTPConnection("localhost:8080")
conn.request("GET", "/infinispan/rest/Bucket/0")
response = conn.getresponse()
print response.status
print response.read()
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645187_InfinispanRESTServer-Javaclientcode%3A"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Javaclientcode%3A"></a>58.4.3. Java client code:</h4> <div class="listingblock"> <div class="content"> <pre>
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.HttpURLConnection;
import java.net.URL;

/**
 * Rest example accessing Infinispan Cache.
 * @author Samuel Tauil (samuel@redhat.com)
 *
 */
public class RestExample {

   /**
    * Method that puts a String value in cache.
    * @param urlServerAddress
    * @param value
    * @throws IOException
    */
   public void putMethod(String urlServerAddress, String value) throws IOException {
      System.out.println("----------------------------------------");
      System.out.println("Executing PUT");
      System.out.println("----------------------------------------");
      URL address = new URL(urlServerAddress);
      System.out.println("executing request " + urlServerAddress);
      HttpURLConnection connection = (HttpURLConnection) address.openConnection();
      System.out.println("Executing put method of value: " + value);
      connection.setRequestMethod("PUT");
      connection.setRequestProperty("Content-Type", "text/plain");
      connection.setDoOutput(true);

      OutputStreamWriter outputStreamWriter = new OutputStreamWriter(connection.getOutputStream());
      outputStreamWriter.write(value);
         
      connection.connect();
      outputStreamWriter.flush();
       
      System.out.println("----------------------------------------");
      System.out.println(connection.getResponseCode() + " " + connection.getResponseMessage());
      System.out.println("----------------------------------------");
         
      connection.disconnect();
   }

   /**
    * Method that gets an value by a key in url as param value.
    * @param urlServerAddress
    * @return String value
    * @throws IOException
    */
   public String getMethod(String urlServerAddress) throws IOException {
      String line = new String();
      StringBuilder stringBuilder = new StringBuilder();

      System.out.println("----------------------------------------");
      System.out.println("Executing GET");
      System.out.println("----------------------------------------");

      URL address = new URL(urlServerAddress);
      System.out.println("executing request " + urlServerAddress);

      HttpURLConnection connection = (HttpURLConnection) address.openConnection();
      connection.setRequestMethod("GET");
      connection.setRequestProperty("Content-Type", "text/plain");
      connection.setDoOutput(true);

      BufferedReader&amp;nbsp; bufferedReader = new BufferedReader(new InputStreamReader(connection.getInputStream()));

      connection.connect();

      while ((line = bufferedReader.readLine()) \!= null) {
         stringBuilder.append(line + '\n');
      }

      System.out.println("Executing get method of value: " + stringBuilder.toString());

      System.out.println("----------------------------------------");
      System.out.println(connection.getResponseCode() + " " + connection.getResponseMessage());
      System.out.println("----------------------------------------");

      connection.disconnect();

      return stringBuilder.toString();
   }

   /**
    * Main method example.
    * @param args
    * @throws IOException
    */
   public static void main(String\[\] args) throws IOException {
      //Attention to the cache name "cacheX" it was configured in xml file with tag &lt;namedCache name="cacheX"&gt;
      RestExample restExample = new RestExample();
      restExample.putMethod("http://localhost:8080/infinispan/rest/cacheX/1", "Infinispan REST Test");
      restExample.getMethod("http://localhost:8080/infinispan/rest/cacheX/1");         
   }
}
</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645187_InfinispanRESTServer-Future%3A"><a class="anchor" href="#sid-18645187_InfinispanRESTServer-Future%3A"></a>58.5. Future:</h3> <div class="ulist"> <ul> <li> <p>Sample persistence options to make this a long term data grid</p> </li> <li> <p>Query and indexing (of known MIME types, and JSON, XML etc)</p> </li> <li> <p>Returning both lists of buckets + entries as &lt;link&gt; relations (where it makes sense)</p> </li> <li> <p>Monitoring of stats via Web interface</p> </li> <li> <p>(optional: WADL?)</p> </li> </ul> </div> </div> </div> </div> <div class="sect1"> <h2 id="sid-18645188"><a class="anchor" href="#sid-18645188"></a>59. CDI Support</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="sid-18645188_CDISupport-Introduction"><a class="anchor" href="#sid-18645188_CDISupport-Introduction"></a>59.1. Introduction</h3> <div class="literalblock"> <div class="content"> <pre>Infinispan includes integration with CDI in the infinispan-cdi module. Configuration and injection of the Inifispan's Cache API is provided, and it is planned to bridge Cache listeners to the CDI event system. The module also provide partial support of the JCache (JSR-107) caching annotations - for further details see link:$$https://docs.google.com/document/d/1YZ-lrH6nW871Vd9Z34Og_EqbX_kxxJi55UrSn4yL2Ak/edit?hl=en&amp;amp;pli=1#heading=h.jdfazu3s6oly$$[Chapter 8] of the JCACHE specification.</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645188_CDISupport-MavenDependencies"><a class="anchor" href="#sid-18645188_CDISupport-MavenDependencies"></a>59.2. Maven Dependencies</h3> <div class="literalblock"> <div class="content"> <pre>All you need is org.infinispan:infinispan-cdi</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;dependency&gt;
    &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
    &lt;artifactId&gt;infinispan-cdi&lt;/artifactId&gt;
    &lt;version&gt;${infinispan.version}&lt;/version&gt;
&lt;/dependency&gt;
</pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Which version of Infinispan should I use?</div> <div class="literalblock"> <div class="content"> <pre>We recommend using the latest final version of the infinispan-cdi module. This module is available since Infinispan version 5.0.0.CR8 .</pre> </div> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="sid-18645188_CDISupport-Embeddedcacheintegration"><a class="anchor" href="#sid-18645188_CDISupport-Embeddedcacheintegration"></a>59.3. Embedded cache integration</h3> <div class="sect3"> <h4 id="sid-18645188_CDISupport-Injectanembeddedcache"><a class="anchor" href="#sid-18645188_CDISupport-Injectanembeddedcache"></a>59.3.1. Inject an embedded cache</h4> <div class="paragraph"> <p>By default you can inject the default Infinispan cache. Let&#8217;s look at the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre>
...
import javax.inject.Inject;

public class GreetingService {
    @Inject
    private Cache&lt;String, String&gt; cache;

    public String greet(String user) {
        String cachedValue = cache.get(user);
        if (cachedValue == null) {
            cachedValue = "Hello " + user;
            cache.put(user, cachedValue);
        }
        return cachedValue;
    }
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>If you want to use a specific cache you just have to provide your own cache configuration and cache qualifier. For example, if you want to use a custom cache for the GreetingService you should write your own qualifier (here GreetingCache ) and define its configuration:</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">The new configuration system is used since 5.1.0.CR2</div> <div class="literalblock"> <div class="content"> <pre>As you probably know Infinispan 5.1.0 comes with a new way to configure your cache programmatically and a bit more (more information are available link:$$http://infinispan.blogspot.com/2012/01/configuration-changes-in-infinispan.html$$[here] ). Now to configure a cache you must use this new configuration system.</pre> </div> </div> </td> </tr> </table> </div> <div class="listingblock"> <div class="content"> <pre>
...
import javax.inject.Qualifier;

@Qualifier
@Target({ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface GreetingCache {
}
</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
...
import org.infinispan.configuration.cache.Configuration;
import org.infinispan.configuration.cache.ConfigurationBuilder;
import org.infinispan.cdi.ConfigureCache;
import javax.enterprise.inject.Produces;

public class Config {
    @ConfigureCache("greeting-cache") // This is the cache name.
    @GreetingCache // This is the cache qualifier.
    @Produces
    public Configuration greetingCacheConfiguration() {
        return new ConfigurationBuilder()
                    .eviction()
                        .strategy(EvictionStrategy.FIFO)
                        .maxEntries(4)
                    .build();
    }

    // The same example without providing a custom configuration.
    // In this case the default cache configuration will be used.
    @ConfigureCache("greeting-cache")
    @GreetingCache
    @Produces
    public Configuration greetingCacheConfiguration;
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>To use this cache in the GreetingService add the @GeetingCache qualifier on your cache injection point. Simple!</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645188_CDISupport-Overridethedefaultembeddedcachemanagerandconfiguration"><a class="anchor" href="#sid-18645188_CDISupport-Overridethedefaultembeddedcachemanagerandconfiguration"></a>59.3.2. Override the default embedded cache manager and configuration</h4> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Since 5.1.0.CR1 @OverrideDefault is deprecated</div> <div class="paragraph"> <p>To migrate your code remove this annotation from your producers as detailed in the following section.</p> </div> </td> </tr> </table> </div> <div class="literalblock"> <div class="content"> <pre>You can override the default cache configuration used by the default embedded cache manager. For that, you just have to create one Configuration producer with the @Default qualifier as illustrated in the following snippet:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
public class Config {
    // By default CDI adds the @Default qualifier if no other qualifier is provided.
    @Produces
    public Configuration defaultEmbeddedCacheConfiguration() {
        return new ConfigurationBuilder()
                    .eviction()
                        .strategy(EvictionStrategy.FIFO)
                        .maxEntries(4)
                    .build();
    }
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>It's also possible to override the default embedded cache manager used. The new default cache manager produced must have the @Default qualifier and the scope @ApplicationScoped .</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
...
import javax.enterprise.context.ApplicationScoped;

public class Config {
    @Produces
    @ApplicationScoped
    public EmbeddedCacheManager defaultEmbeddedCacheManager() {
      return new DefaultCacheManager(new ConfigurationBuilder()
                                          .eviction()
                                              .strategy(EvictionStrategy.FIFO)
                                              .maxEntries(4)
                                          .build());
   }
}
</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645188_CDISupport-Configurethetransportforclustereduse"><a class="anchor" href="#sid-18645188_CDISupport-Configurethetransportforclustereduse"></a>59.3.3. Configure the transport for clustered use</h4> <div class="literalblock"> <div class="content"> <pre>To use Infinispan in a clustered mode you have to configure the transport with the GlobalConfiguration . To achieve that override the default cache manager as explained in the previous section. Look at the following snippet:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
...
package org.infinispan.configuration.global.GlobalConfigurationBuilder;

@Produces
@ApplicationScoped
public EmbeddedCacheManager defaultClusteredCacheManager() {
    return new DefaultCacheManager(
        new GlobalConfigurationBuilder().transport().defaultTransport().build(),
        new ConfigurationBuilder().eviction().maxEntries(7).build()
    );
}
</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645188_CDISupport-Remotecacheintegration"><a class="anchor" href="#sid-18645188_CDISupport-Remotecacheintegration"></a>59.4. Remote cache integration</h3> <div class="sect3"> <h4 id="sid-18645188_CDISupport-Injectaremotecache"><a class="anchor" href="#sid-18645188_CDISupport-Injectaremotecache"></a>59.4.1. Inject a remote cache</h4> <div class="literalblock"> <div class="content"> <pre>With the CDI integration it's also possible to use a remote cache. For example you can inject the default RemoteCache as illustrated in the following snippet:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
public class GreetingService {
    @Inject
    private RemoteCache&lt;String, String&gt; cache;

    public String greet(String user) {
        String cachedValue = cache.get(user);
        if (cachedValue == null) {
            cachedValue = "Hello " + user;
            cache.put(user, cachedValue);
        }
        return cachedValue;
    }
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>If you want to use another cache, for example the greeting-cache, add the @Remote qualifier on the cache injection point which contains the cache name.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
public class GreetingService {
    @Inject @Remote("greeting-cache")
    private RemoteCache&lt;String, String&gt; cache;

    ...
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>Adding the @Remote cache qualifier on each injection point might be error prone. That's why the remote cache integration provides another way to achieve the same goal. For that you have to create your own qualifier annotated with @Remote :</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
@Remote("greeting-cache")
@Qualifier
@Target({ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RemoteGreetingCache {
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>To use this cache in the GreetingService add the qualifier @RemoteGreetingCache qualifier on your cache injection.</pre> </div> </div> </div> <div class="sect3"> <h4 id="sid-18645188_CDISupport-Overridethedefaultremotecachemanager"><a class="anchor" href="#sid-18645188_CDISupport-Overridethedefaultremotecachemanager"></a>59.4.2. Override the default remote cache manager</h4> <div class="paragraph"> <p>Like the embedded cache integration, the remote cache integration comes with a default remote cache manager producer. This default remote cache manager can be overridden as illustrated in the following snippet:</p> </div> <div class="listingblock"> <div class="content"> <pre>
public class Config {
    @Produces
    @ApplicationScoped
    public RemoteCacheManager defaultRemoteCacheManager() {
        return new RemoteCacheManager(localhost, 1544);
    }
}
</pre> </div> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645188_CDISupport-Useacustomremote%2Fembeddedcachemanagerforoneormorecache"><a class="anchor" href="#sid-18645188_CDISupport-Useacustomremote%2Fembeddedcachemanagerforoneormorecache"></a>59.5. Use a custom remote/embedded cache manager for one or more cache</h3> <div class="paragraph"> <p>It&#8217;s possible to use a custom cache manager for one or more cache. You just need to annotate the cache manager producer with the cache qualifiers. Look at the following example:</p> </div> <div class="listingblock"> <div class="content"> <pre>
public class Config {
   @GreetingCache
   @Produces
   @ApplicationScoped
   public EmbeddedCacheManager specificEmbeddedCacheManager() {
      return new DefaultCacheManager(new ConfigurationBuilder()
                                          .expiration()
                                              .lifespan(60000l)
                                          .build());
   }

   @RemoteGreetingCache
   @Produces
   @ApplicationScoped
   public RemoteCacheManager specificRemoteCacheManager() {
       return new RemoteCacheManager("localhost", 1544);
   }
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>With the above code the GreetingCache or the RemoteGreetingCache will be associated with the produced cache manager.</pre> </div> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Producer method scope</div> <div class="literalblock"> <div class="content"> <pre>To work properly the producers must have the scope @ApplicationScoped . Otherwise each injection of cache will be associated to a new instance of cache manager.</pre> </div> </div> </td> </tr> </table> </div> </div> <div class="sect2"> <h3 id="sid-18645188_CDISupport-UseaJBossAS7configuredcache"><a class="anchor" href="#sid-18645188_CDISupport-UseaJBossAS7configuredcache"></a>59.6. Use a JBoss AS 7 configured cache</h3> <div class="literalblock"> <div class="content"> <pre>With JBoss AS 7, you can setup an Infinispan cache manager in the server configuration file. This allows you to externalize your Infinispan configuration and also to lookup the cache manager from JNDI, normally with the @Resource annotation.</pre> </div> </div> <div class="paragraph"> <p>As we mentioned earlier, you can override the default cache manager used by the Infinispan CDI extension. To use a JBoss AS 7 configured cache, you need to use the cache manager defined in JBoss AS 7. You only need to annotate the default cache manager producer with @Resource. The following example shows how use an embedded cache manager configured in JBoss AS 7.</p> </div> <div class="listingblock"> <div class="content"> <pre>
...
import javax.annotation.Resource;

public class Config {
    @Produces
    @ApplicationScoped
    @Resource(lookup="java:jboss/infinispan/my-container-name")
    private EmbeddedCacheManager defaultCacheManager;
}
</pre> </div> </div> </div> <div class="sect2"> <h3 id="sid-18645188_CDISupport-UseJCachecachingannotations"><a class="anchor" href="#sid-18645188_CDISupport-UseJCachecachingannotations"></a>59.7. Use JCache caching annotations</h3> <div class="literalblock"> <div class="content"> <pre>The infinispan-cdi module provides a partial support of JCache caching annotations. These annotations provide a simple way to handle common use cases. The following caching annotations are defined in this specification:</pre> </div> </div> <div class="ulist"> <ul> <li> <p>@CacheResult caches the result of a method call</p> </li> <li> <p>@CachePut caches a method parameter</p> </li> <li> <p>@CacheRemoveEntry removes an entry from a cache</p> </li> <li> <p>@CacheRemoveAll removes all entries from a cache</p> </li> </ul> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="icon-note" title="Note"></i> </td> <td class="content"> <div class="title">Annotations target type</div> <div class="paragraph"> <p>These annotations must only be used on methods.</p> </div> </td> </tr> </table> </div> <div class="literalblock"> <div class="content"> <pre>To use these annotations the following interceptors must be declared in your application beans.xml .</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
&lt;beans xmlns="http://java.sun.com/xml/ns/javaee"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/beans_1_0.xsd"&gt;
    &lt;interceptors&gt;
        &lt;class&gt;org.infinispan.cdi.interceptor.CacheResultInterceptor&lt;/class&gt;
        &lt;class&gt;org.infinispan.cdi.interceptor.CachePutInterceptor&lt;/class&gt;
        &lt;class&gt;org.infinispan.cdi.interceptor.CacheRemoveEntryInterceptor&lt;/class&gt;
        &lt;class&gt;org.infinispan.cdi.interceptor.CacheRemoveAllInterceptor&lt;/class&gt;
    &lt;/interceptors&gt;
&lt;/beans&gt;
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The following snippet of code illustrates the use of @CacheResult annotation. As you can see it simplifies the caching of the Greetingservice#greet method results.</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
import javax.cache.interceptor.CacheResult;

public class GreetingService {
    @CacheResult
    public String greet(String user) {
        return "Hello" + user;
    }
}
</pre> </div> </div> <div class="literalblock"> <div class="content"> <pre>The first version of the GreetingService and the above version have exactly the same behavior. The only difference is the cache used. By default it's the fully qualified name of the annotated method with its parameter types (e.g. org.infinispan.example.GreetingService.greet(java.lang.String) ).</pre> </div> </div> <div class="admonitionblock tip"> <table> <tr> <td class="icon"> <i class="icon-tip" title="Tip"></i> </td> <td class="content"> <div class="title">Can I use a different cache?</div> <div class="literalblock"> <div class="content"> <pre>To use another cache specify its name with the cacheName attribute of the cache annotation. For example:</pre> </div> </div> <div class="listingblock"> <div class="content"> <pre>
@CacheResult(cacheName = "greeting-cache")
</pre> </div> </div> </td> </tr> </table> </div> </div> </div> </div> </div> <div id="footer"> <div id="footer-text"> Last updated 2013-09-11 18:23:21 BST </div> </div> </body> </html>